---
export const prerender = false;
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabaseServiceRoleKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY || '';

let userData: any = null;
let redirectUrl = '/';
let perfilIncompleto = false;
let esNuevo = false;
let serverError = '';

// Leer la cookie temporal con los tokens OAuth
const tempCookie = Astro.cookies.get('temp_oauth')?.value;

if (!tempCookie) {
  serverError = 'No se encontraron datos de autenticaci√≥n. Int√©ntalo de nuevo.';
} else {
  try {
    // Decodificar tokens
    const decoded = Buffer.from(tempCookie, 'base64').toString('utf-8');
    const { at: access_token, rt: refresh_token } = JSON.parse(decoded);

    if (!access_token) {
      serverError = 'Token de acceso no v√°lido';
    } else {
      // Verificar el token con Supabase
      const supabaseWithToken = createClient(supabaseUrl, supabaseAnonKey, {
        global: { headers: { Authorization: `Bearer ${access_token}` } }
      });

      const { data: { user: authUser }, error: userError } = await supabaseWithToken.auth.getUser(access_token);

      if (userError || !authUser) {
        console.error('Error verificando token OAuth en finish:', userError);
        serverError = 'Token inv√°lido o expirado. Int√©ntalo de nuevo.';
      } else {
        const email = authUser.email || '';
        const nombre = authUser.user_metadata?.full_name
          || authUser.user_metadata?.name
          || email.split('@')[0]
          || 'Usuario';

        console.log('üîê OAuth finish - Usuario verificado:', email);

        // Cliente admin para operaciones en BD
        const supabaseAdmin = supabaseServiceRoleKey && supabaseServiceRoleKey.startsWith('eyJ')
          ? createClient(supabaseUrl, supabaseServiceRoleKey, {
              auth: { autoRefreshToken: false, persistSession: false }
            })
          : createClient(supabaseUrl, supabaseAnonKey);

        // Buscar usuario existente
        const { data: existingUser } = await supabaseAdmin
          .from('usuarios')
          .select('id, nombre, email, rol, activo, telefono, direccion')
          .eq('email', email)
          .single();

        if (existingUser) {
          if (!existingUser.activo) {
            serverError = 'Tu cuenta ha sido desactivada. Contacta con soporte.';
          } else {
            userData = existingUser;
            console.log('‚úÖ Usuario existente:', existingUser.nombre);
          }
        } else {
          // Crear nuevo usuario
          console.log('üÜï Creando usuario en tabla usuarios');
          const { data: newUser, error: insertError } = await supabaseAdmin
            .from('usuarios')
            .insert({
              id: authUser.id,
              nombre,
              email,
              rol: 'cliente',
              activo: true,
            })
            .select('id, nombre, email, rol, telefono, direccion')
            .single();

          if (insertError) {
            console.error('Error creando usuario:', insertError);
            // Reintentar b√∫squeda
            const { data: retryUser } = await supabaseAdmin
              .from('usuarios')
              .select('id, nombre, email, rol, telefono, direccion')
              .eq('email', email)
              .single();
            if (retryUser) {
              userData = retryUser;
            } else {
              serverError = 'No se pudo crear la cuenta';
            }
          } else {
            userData = newUser;
            esNuevo = true;
            console.log('‚úÖ Nuevo usuario creado:', newUser?.nombre);
          }
        }

        if (userData) {
          // Detectar HTTPS para cookies seguras
          const isSecure = Astro.url.protocol === 'https:';

          // Establecer cookies httpOnly de autenticaci√≥n
          Astro.cookies.set('auth_token', access_token, {
            httpOnly: true,
            secure: isSecure,
            sameSite: 'lax',
            maxAge: 60 * 60 * 24 * 7,
            path: '/',
          });
          Astro.cookies.set('sb-access-token', access_token, {
            httpOnly: true,
            secure: isSecure,
            sameSite: 'lax',
            maxAge: 60 * 60 * 24 * 365,
            path: '/',
          });
          if (refresh_token) {
            Astro.cookies.set('sb-refresh-token', refresh_token, {
              httpOnly: true,
              secure: isSecure,
              sameSite: 'lax',
              maxAge: 60 * 60 * 24 * 365,
              path: '/',
            });
          }
          Astro.cookies.set('user_id', userData.id, {
            httpOnly: false,
            secure: isSecure,
            sameSite: 'lax',
            maxAge: 60 * 60 * 24 * 7,
            path: '/',
          });
          Astro.cookies.set('user_role', userData.rol, {
            httpOnly: false,
            secure: isSecure,
            sameSite: 'lax',
            maxAge: 60 * 60 * 24 * 7,
            path: '/',
          });
          Astro.cookies.set('user_name', userData.nombre, {
            httpOnly: false,
            secure: isSecure,
            sameSite: 'lax',
            maxAge: 60 * 60 * 24 * 7,
            path: '/',
          });

          // Eliminar cookie temporal
          Astro.cookies.delete('temp_oauth', { path: '/' });

          console.log('üç™ Cookies OAuth establecidas via finish.astro (secure:', isSecure, ')');

          redirectUrl = userData.rol === 'admin' ? '/admin/dashboard' : '/productos';
          perfilIncompleto = esNuevo || !userData.telefono || !userData.direccion;
        }
      }
    }
  } catch (e) {
    console.error('Error en /auth/finish:', e);
    serverError = e instanceof Error ? e.message : 'Error desconocido';
  }
}
---
<html>
<head>
  <meta charset="UTF-8">
  <title>Completando inicio de sesi√≥n...</title>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #faf8f5;
      color: #333;
    }
    .loading { text-align: center; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e0d6cc;
      border-top: 4px solid #c0392b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="loading">
    <div class="spinner"></div>
    <p>Completando inicio de sesi√≥n...</p>
  </div>
  <script is:inline define:vars={{ userData, redirectUrl, perfilIncompleto, esNuevo, serverError }}>
    // Limpiar cookie temporal del navegador
    document.cookie = 'temp_oauth=; path=/; max-age=0';

    if (serverError) {
      console.error('Error OAuth:', serverError);
      window.location.href = '/login?error=' + encodeURIComponent(serverError);
    } else if (userData) {
      // Guardar en localStorage (igual que el login normal)
      localStorage.setItem('auth_token', userData.id);
      localStorage.setItem('user_role', userData.rol);
      localStorage.setItem('user_id', userData.id);
      localStorage.setItem('user_name', userData.nombre);
      localStorage.setItem('user_email', userData.email);

      if (perfilIncompleto || esNuevo) {
        localStorage.setItem('perfil_incompleto', 'true');
      } else {
        localStorage.removeItem('perfil_incompleto');
      }

      // Limpiar flag de logout
      sessionStorage.removeItem('just_logged_out');

      // Redirigir al destino final
      window.location.href = redirectUrl;
    } else {
      window.location.href = '/login';
    }
  </script>
</body>
</html>
