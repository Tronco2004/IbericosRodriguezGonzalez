---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <style>
    .reset-page {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .reset-container {
      max-width: 450px;
      width: 100%;
    }
    .reset-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .reset-title {
      color: var(--text-primary);
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    .reset-subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
    }
    .reset-form {
      background: var(--bg-tertiary);
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
      background: var(--bg-input);
      color: var(--text-primary);
    }
    .form-input::placeholder {
      color: var(--text-muted);
    }
    .code-input {
      text-align: center;
      font-size: 1.5rem;
      letter-spacing: 8px;
      font-weight: 700;
      padding: 1rem;
    }
    .submit-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--gradient-cta);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow-medium);
    }
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .message {
      display: none;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-top: 1rem;
    }
    .message-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .message-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0.25rem 0 0 0;
    }
    .resend-link {
      display: block;
      text-align: center;
      color: var(--color-accent);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      text-decoration: underline;
    }
    .resend-link:disabled {
      color: var(--text-muted);
      cursor: not-allowed;
      text-decoration: none;
    }
    .back-link {
      display: block;
      text-align: center;
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      margin-top: 1.5rem;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>

  <div class="reset-page">
    <div class="reset-container">
      <div class="reset-header">
        <h1 class="reset-title">Nueva Contraseña</h1>
        <p class="reset-subtitle">Introduce el código de 6 dígitos que te hemos enviado al email y tu nueva contraseña</p>
      </div>

      <form id="newPasswordForm" class="reset-form">
        <div class="form-group">
          <label class="form-label">Código de recuperación</label>
          <input 
            type="text" 
            name="otpCode" 
            required 
            placeholder="000000"
            class="form-input code-input"
            id="otpCodeInput"
            maxlength="6"
            inputmode="numeric"
            autocomplete="one-time-code"
          />
          <button type="button" class="resend-link" id="resendBtn">¿No recibiste el código? Reenviar</button>
        </div>

        <div class="form-group">
          <label class="form-label">Nueva contraseña</label>
          <input 
            type="password" 
            name="password" 
            required 
            placeholder="Mínimo 6 caracteres"
            class="form-input"
            id="passwordInput"
            minlength="6"
          />
          <p class="hint">Mínimo 6 caracteres</p>
        </div>

        <div class="form-group">
          <label class="form-label">Confirmar contraseña</label>
          <input 
            type="password" 
            name="confirmPassword" 
            required 
            placeholder="Repite tu nueva contraseña"
            class="form-input"
            id="confirmPasswordInput"
            minlength="6"
          />
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          Restablecer contraseña
        </button>

        <div id="successMessage" class="message message-success"></div>
        <div id="errorMessage" class="message message-error"></div>
      </form>

      <a href="/recuperar-contrasena" class="back-link">Volver a solicitar código</a>
    </div>
  </div>

  <script>
    import { createClient } from '@supabase/supabase-js';

    const supabase = createClient(
      import.meta.env.PUBLIC_SUPABASE_URL,
      import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
      { auth: { flowType: 'implicit' } }
    );

    const form = document.getElementById('newPasswordForm') as HTMLFormElement | null;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;
    const successMsg = document.getElementById('successMessage');
    const errorMsg = document.getElementById('errorMessage');
    const resendBtn = document.getElementById('resendBtn') as HTMLButtonElement | null;

    // Obtener email de la página anterior
    const recoveryEmail = sessionStorage.getItem('recovery_email') || '';

    if (!recoveryEmail) {
      window.location.href = '/recuperar-contrasena';
    }

    // ── Reenviar código ──
    resendBtn?.addEventListener('click', async () => {
      if (!recoveryEmail) {
        window.location.href = '/recuperar-contrasena';
        return;
      }

      if (resendBtn) {
        resendBtn.disabled = true;
        resendBtn.textContent = 'Enviando...';
      }

      try {
        await supabase.auth.resetPasswordForEmail(recoveryEmail);
        if (successMsg) {
          successMsg.textContent = 'Código reenviado. Revisa tu bandeja de entrada.';
          successMsg.style.display = 'block';
        }
      } catch (e) {
        // Silenciar por seguridad
      }

      // Cooldown de 60 segundos
      let seconds = 60;
      const interval = setInterval(() => {
        seconds--;
        if (resendBtn) resendBtn.textContent = `Reenviar en ${seconds}s`;
        if (seconds <= 0) {
          clearInterval(interval);
          if (resendBtn) {
            resendBtn.disabled = false;
            resendBtn.textContent = '¿No recibiste el código? Reenviar';
          }
        }
      }, 1000);
    });

    // ── Enviar formulario ──
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const otpInput = document.getElementById('otpCodeInput') as HTMLInputElement | null;
      const passwordInput = document.getElementById('passwordInput') as HTMLInputElement | null;
      const confirmInput = document.getElementById('confirmPasswordInput') as HTMLInputElement | null;
      const otpCode = otpInput?.value.trim() || '';
      const password = passwordInput?.value || '';
      const confirmPassword = confirmInput?.value || '';

      if (successMsg) successMsg.style.display = 'none';
      if (errorMsg) errorMsg.style.display = 'none';

      // Validaciones
      if (!otpCode || otpCode.length !== 6) {
        if (errorMsg) {
          errorMsg.textContent = 'Introduce el código de 6 dígitos que recibiste por email';
          errorMsg.style.display = 'block';
        }
        return;
      }

      if (password.length < 6) {
        if (errorMsg) {
          errorMsg.textContent = 'La contraseña debe tener al menos 6 caracteres';
          errorMsg.style.display = 'block';
        }
        return;
      }

      if (password !== confirmPassword) {
        if (errorMsg) {
          errorMsg.textContent = 'Las contraseñas no coinciden';
          errorMsg.style.display = 'block';
        }
        return;
      }

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verificando código...';
      }

      try {
        // 1) Verificar el código OTP de Supabase
        const { data: verifyData, error: verifyError } = await supabase.auth.verifyOtp({
          email: recoveryEmail,
          token: otpCode,
          type: 'recovery',
        });

        if (verifyError) {
          throw new Error(verifyError.message === 'Token has expired or is invalid' 
            ? 'El código ha expirado o no es válido. Solicita uno nuevo.'
            : verifyError.message);
        }

        // 2) Con la sesión de recovery activa, actualizar la contraseña
        const { error: updateError } = await supabase.auth.updateUser({
          password: password,
        });

        if (updateError) throw updateError;

        // Limpiar
        sessionStorage.removeItem('recovery_email');

        if (successMsg) {
          successMsg.textContent = 'Contraseña restablecida correctamente. Redirigiendo al login...';
          successMsg.style.display = 'block';
        }
        form?.reset();

        // Cerrar sesión de recovery y redirigir al login
        setTimeout(async () => {
          await supabase.auth.signOut();
          window.location.href = '/login';
        }, 2500);
      } catch (err) {
        if (errorMsg) {
          errorMsg.textContent = err instanceof Error 
            ? err.message 
            : 'Error al restablecer la contraseña. Verifica el código e inténtalo de nuevo.';
          errorMsg.style.display = 'block';
        }
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Restablecer contraseña';
        }
      }
    });
  </script>
</Layout>
