---
import ProtectedLayout from '../layouts/ProtectedLayout.astro';
---

<ProtectedLayout>
  <style>
    .perfil-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    @media (max-width: 768px) {
      .perfil-grid {
        grid-template-columns: 1fr;
      }
      
      .perfil-header h1 {
        font-size: 2rem !important;
      }
      
      .perfil-card {
        padding: 1.5rem !important;
      }
    }
  </style>
  
  <div style="max-width: 1000px; margin: 0 auto; padding: 2rem 1rem;">
    <!-- Header -->
    <div class="perfil-header" style="margin-bottom: 3rem;">
      <h1 style="font-size: 3rem; margin: 0 0 0.5rem 0; color: var(--color-primary); font-weight: 800; letter-spacing: -1px;">Mi Perfil</h1>
      <div style="width: 80px; height: 3px; background: linear-gradient(90deg, var(--color-accent), var(--color-accent-light)); border-radius: 10px; margin-bottom: 1.5rem;"></div>
      <p style="color: var(--text-muted); font-size: 1.05rem; margin: 0;">Gestiona tu informaci√≥n personal y seguridad</p>
    </div>

    <div class="perfil-grid">
      <!-- Columna izquierda: Informaci√≥n Personal -->
      <div>
        <!-- Tarjeta de Informaci√≥n Personal -->
        <div class="perfil-card" style="background: var(--bg-card); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color); box-shadow: 0 4px 12px var(--shadow-color, rgba(0,0,0,0.05));">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <span style="color: white; font-weight: 700; font-size: 1.2rem; font-style: italic;">i</span>
            </div>
            <h2 style="margin: 0; font-size: 1.2rem; color: var(--text-primary); font-weight: 700;">Informaci√≥n Personal</h2>
          </div>
          
          <form id="formularioPerfil" style="display: grid; gap: 1.25rem;">
            <!-- Nombre -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="nombreInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Nombre</label>
              <input 
                id="nombreInput"
                type="text"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>
            
            <!-- Email (solo lectura) -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Email</label>
              <p id="emailDisplay" style="margin: 0; font-size: 1.1rem; color: var(--text-primary); font-weight: 600;">Cargando...</p>
            </div>
            
            <!-- Tel√©fono -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="telefonoInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Tel√©fono</label>
              <input 
                id="telefonoInput"
                type="tel"
                placeholder="Tu n√∫mero de tel√©fono"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>
            
            <!-- Direcci√≥n -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="direccionInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Direcci√≥n</label>
              <input 
                id="direccionInput"
                type="text"
                placeholder="Tu direcci√≥n de env√≠o"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>

            <div id="mensajePerfilEstado" style="display: none; padding: 1rem; border-radius: 8px; font-size: 0.95rem; margin-top: 0.5rem; border-left: 4px solid var(--color-accent);"></div>
            
            <button 
              type="submit"
              style="width: 100%; padding: 0.85rem; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; margin-top: 1rem; box-shadow: 0 4px 12px rgba(168, 153, 104, 0.2);"
            >
              Guardar Cambios
            </button>
          </form>
        </div>
      </div>

      <!-- Columna derecha: Contrase√±a -->
      <div>
        <!-- Tarjeta de Seguridad -->
        <div class="perfil-card" style="background: var(--bg-card); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color); box-shadow: 0 4px 12px var(--shadow-color, rgba(0,0,0,0.05));">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <span style="color: white; font-weight: 700; font-size: 1.2rem;">S</span>
            </div>
            <h2 style="margin: 0; font-size: 1.2rem; color: var(--text-primary); font-weight: 700;">Seguridad</h2>
          </div>

          <!-- Info provider (visible para usuarios OAuth) -->
          <div id="providerInfo" style="display: none; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
              <strong>üîó Cuenta vinculada con <span id="providerName">Google</span></strong><br>
              <span style="font-size: 0.85rem; color: var(--text-muted);">Puedes establecer una contrase√±a para tambi√©n iniciar sesi√≥n con email y contrase√±a.</span>
            </p>
          </div>

          <!-- Formulario CAMBIAR contrase√±a (para usuarios con password) -->
          <form id="cambiarContrasenaForm" style="display: grid; gap: 1rem;">
            <!-- Contrase√±a Actual -->
            <div id="campoContrasenaActual" style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="contrasenaActual" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Contrase√±a Actual</label>
              <input 
                id="contrasenaActual"
                type="password" 
                placeholder="Ingresa tu contrase√±a actual"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>
            
            <!-- Contrase√±a Nueva -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="contrasenaNueva" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Contrase√±a Nueva</label>
              <input 
                id="contrasenaNueva"
                type="password" 
                required
                placeholder="M√≠nimo 6 caracteres"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
              <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: var(--text-muted);">M√≠nimo 6 caracteres</p>
            </div>
            
            <!-- Confirmar Contrase√±a -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="contrasenaConfirm" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Confirmar Contrase√±a</label>
              <input 
                id="contrasenaConfirm"
                type="password" 
                required
                placeholder="Confirma tu nueva contrase√±a"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>

            <div id="mensajeEstado" style="display: none; padding: 1rem; border-radius: 8px; font-size: 0.95rem; margin-top: 0.5rem; border-left: 4px solid var(--color-accent);"></div>
            
            <button 
              id="btnContrasena"
              type="submit"
              style="width: 100%; padding: 0.85rem; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; margin-top: 1rem; box-shadow: 0 4px 12px rgba(168, 153, 104, 0.2);"
            >
              Cambiar Contrase√±a
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    input:focus {
      outline: none;
      border-color: var(--color-accent) !important;
      box-shadow: 0 0 0 3px rgba(168, 153, 104, 0.1) !important;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--color-accent-dark), var(--color-accent-dark)) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(168, 153, 104, 0.3) !important;
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>

  <script>
    async function cargarDatosUsuario() {
      try {
        let userId = localStorage.getItem('user_id');
        console.log('üîç userId desde localStorage:', userId);
        
        // Si no hay userId en localStorage, intentar obtenerlo del endpoint
        if (!userId || userId === 'null' || userId === 'undefined') {
          console.log('üîÑ Intentando obtener usuario desde /api/auth/me');
          try {
            const meResponse = await fetch('/api/auth/me', {
              credentials: 'include'
            });
            if (meResponse.ok) {
              const meData = await meResponse.json();
              if (meData.success && meData.usuario) {
                userId = meData.usuario.id;
                console.log('‚úÖ Usuario obtenido del endpoint:', userId);
                localStorage.setItem('user_id', userId);
              }
            }
          } catch (e) {
            console.log('‚ö†Ô∏è No se pudo obtener usuario del endpoint');
          }
        }
        
        const response = await fetch('/api/auth/me', {
          credentials: 'include',
          headers: {
            ...(userId && userId !== 'null' && { 'x-user-id': userId })
          }
        });
        
        console.log('üì° Response status:', response.status);
        const data = await response.json();
        console.log('üì¶ Data recibida:', data);
        
        if (data.success && data.usuario) {
          document.getElementById('nombreInput').value = data.usuario.nombre || '';
          document.getElementById('emailDisplay').textContent = data.usuario.email || '-';
          document.getElementById('telefonoInput').value = data.usuario.telefono || '';
          document.getElementById('direccionInput').value = data.usuario.direccion || '';
          
          // Detectar si el usuario viene de OAuth (sin contrase√±a)
          if (!data.usuario.tienePassword) {
            // Mostrar info del provider
            const providerInfo = document.getElementById('providerInfo');
            const providerName = document.getElementById('providerName');
            providerInfo.style.display = 'block';
            
            const providerLabels = { google: 'Google', apple: 'Apple', facebook: 'Facebook' };
            providerName.textContent = providerLabels[data.usuario.provider] || data.usuario.provider;
            
            // Ocultar campo de contrase√±a actual (no tiene)
            document.getElementById('campoContrasenaActual').style.display = 'none';
            
            // Cambiar texto del bot√≥n
            document.getElementById('btnContrasena').textContent = 'Establecer Contrase√±a';
            
            // Marcar formulario como "establecer" en vez de "cambiar"
            document.getElementById('cambiarContrasenaForm').dataset.modo = 'establecer';
          }
          
          console.log('‚úÖ Datos cargados correctamente');
        } else {
          console.error('‚ùå Error en respuesta:', data.error);
          document.getElementById('emailDisplay').textContent = 'Error: ' + (data.error || 'No autorizado');
        }
      } catch (error) {
        console.error('‚ùå Error cargando datos del usuario:', error);
        document.getElementById('emailDisplay').textContent = 'Error de conexi√≥n';
      }
    }

    async function guardarPerfil(e) {
      e.preventDefault();
      
      const nombre = document.getElementById('nombreInput').value;
      const telefono = document.getElementById('telefonoInput').value;
      const direccion = document.getElementById('direccionInput').value;
      const mensajeEstado = document.getElementById('mensajePerfilEstado');
      const boton = e.target.querySelector('button[type="submit"]');

      // Limpiar mensaje anterior
      mensajeEstado.style.display = 'none';

      // Validar nombre
      if (!nombre || nombre.trim().length === 0) {
        mostrarMensaje('El nombre es requerido', 'error', mensajeEstado, true);
        return;
      }

      try {
        boton.disabled = true;
        boton.textContent = 'Guardando...';

        const response = await fetch('/api/auth/actualizar-perfil', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': localStorage.getItem('user_id') || ''
          },
          body: JSON.stringify({
            nombre: nombre.trim(),
            telefono: telefono?.trim() || null,
            direccion: direccion?.trim() || null
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          mostrarMensaje('‚úÖ Perfil actualizado exitosamente', 'exito', mensajeEstado, true);
          setTimeout(() => {
            mensajeEstado.style.display = 'none';
          }, 5000);
        } else {
          mostrarMensaje('‚ùå ' + (data.message || 'Error al guardar'), 'error', mensajeEstado, true);
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('‚ùå Error de conexi√≥n', 'error', mensajeEstado, true);
      } finally {
        boton.disabled = false;
        boton.textContent = 'Guardar Cambios';
      }
    }

    async function cambiarContrasena(e) {
      e.preventDefault();
      
      const form = document.getElementById('cambiarContrasenaForm');
      const modo = form.dataset.modo || 'cambiar'; // 'cambiar' o 'establecer'
      const contrasenaActual = document.getElementById('contrasenaActual').value;
      const contrasenaNueva = document.getElementById('contrasenaNueva').value;
      const contrasenaConfirm = document.getElementById('contrasenaConfirm').value;
      const mensajeEstado = document.getElementById('mensajeEstado');
      const boton = document.getElementById('btnContrasena');

      // Limpiar mensaje anterior
      mensajeEstado.style.display = 'none';

      // Validaciones del lado del cliente
      if (modo === 'cambiar' && contrasenaActual.length === 0) {
        mostrarMensaje('Por favor ingresa tu contrase√±a actual', 'error', mensajeEstado);
        return;
      }

      if (contrasenaNueva.length < 6) {
        mostrarMensaje('La contrase√±a debe tener al menos 6 caracteres', 'error', mensajeEstado);
        return;
      }

      if (contrasenaNueva !== contrasenaConfirm) {
        mostrarMensaje('Las contrase√±as no coinciden', 'error', mensajeEstado);
        return;
      }

      try {
        boton.disabled = true;
        boton.textContent = modo === 'establecer' ? 'Estableciendo...' : 'Cambiando contrase√±a...';

        // Elegir endpoint seg√∫n el modo
        const endpoint = modo === 'establecer' 
          ? '/api/auth/establecer-contrasena' 
          : '/api/auth/cambiar-contrasena';
        
        const bodyData = modo === 'establecer'
          ? { contrasenaNueva, contrasenaConfirm }
          : { contrasenaActual, contrasenaNueva, contrasenaConfirm };

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': localStorage.getItem('user_id') || ''
          },
          body: JSON.stringify(bodyData)
        });

        const data = await response.json();

        if (response.ok && data.success) {
          mostrarMensaje('‚úÖ ' + data.message, 'exito', mensajeEstado);
          form.reset();
          
          // Si estableci√≥ contrase√±a, mostrar ahora el campo de contrase√±a actual
          if (modo === 'establecer') {
            document.getElementById('campoContrasenaActual').style.display = 'block';
            boton.textContent = 'Cambiar Contrase√±a';
            form.dataset.modo = 'cambiar';
            // Actualizar el info
            document.getElementById('providerInfo').innerHTML = `
              <p style="margin: 0; font-size: 0.9rem; color: #065f46;">
                <strong>‚úÖ ¬°Contrase√±a establecida!</strong><br>
                <span style="font-size: 0.85rem;">Ahora puedes iniciar sesi√≥n con email y contrase√±a o con tu cuenta social.</span>
              </p>
            `;
            document.getElementById('providerInfo').style.background = '#d1fae5';
            document.getElementById('providerInfo').style.borderColor = '#6ee7b7';
          }
          
          setTimeout(() => {
            mensajeEstado.style.display = 'none';
          }, 5000);
        } else {
          mostrarMensaje('‚ùå ' + (data.message || 'Error'), 'error', mensajeEstado);
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('‚ùå Error de conexi√≥n', 'error', mensajeEstado);
      } finally {
        boton.disabled = false;
        if (form.dataset.modo !== 'cambiar' || modo === 'establecer') return;
        boton.textContent = 'Cambiar Contrase√±a';
      }
    }

    function mostrarMensaje(texto, tipo, elemento, separado = false) {
      elemento.textContent = texto;
      elemento.style.display = 'block';
      elemento.style.background = tipo === 'exito' ? '#d1fae5' : '#fee2e2';
      elemento.style.color = tipo === 'exito' ? '#065f46' : '#991b1b';
      elemento.style.borderLeftColor = tipo === 'exito' ? '#10b981' : '#ef4444';
    }

    // Cargar datos del usuario cuando carga la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      cargarDatosUsuario();
      document.getElementById('formularioPerfil').addEventListener('submit', guardarPerfil);
      document.getElementById('cambiarContrasenaForm').addEventListener('submit', cambiarContrasena);
    });
  </script>
</ProtectedLayout>
