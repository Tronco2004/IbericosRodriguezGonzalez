---
import ProtectedLayout from '../layouts/ProtectedLayout.astro';
---

<ProtectedLayout>
  <style>
    .perfil-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }
    
    @media (max-width: 768px) {
      .perfil-grid {
        grid-template-columns: 1fr;
      }
      
      .perfil-header h1 {
        font-size: 2rem !important;
      }
      
      .perfil-card {
        padding: 1.5rem !important;
      }
    }
  </style>
  
  <div style="max-width: 560px; margin: 0 auto; padding: 2rem 1rem;">
    <!-- Header -->
    <div class="perfil-header" style="margin-bottom: 3rem;">
      <h1 style="font-size: 3rem; margin: 0 0 0.5rem 0; color: var(--color-primary); font-weight: 800; letter-spacing: -1px;">Mi Perfil</h1>
      <div style="width: 80px; height: 3px; background: linear-gradient(90deg, var(--color-accent), var(--color-accent-light)); border-radius: 10px; margin-bottom: 1.5rem;"></div>
      <p style="color: var(--text-muted); font-size: 1.05rem; margin: 0;">Gestiona tu informaci√≥n personal y seguridad</p>
    </div>

    <div class="perfil-grid">
      <!-- Informaci√≥n Personal -->
      <div>
        <!-- Tarjeta de Informaci√≥n Personal -->
        <div class="perfil-card" style="background: var(--bg-card); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color); box-shadow: 0 4px 12px var(--shadow-color, rgba(0,0,0,0.05));">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <span style="color: white; font-weight: 700; font-size: 1.2rem; font-style: italic;">i</span>
            </div>
            <h2 style="margin: 0; font-size: 1.2rem; color: var(--text-primary); font-weight: 700;">Informaci√≥n Personal</h2>
          </div>
          
          <form id="formularioPerfil" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
            <!-- Nombre (full width) -->
            <div style="grid-column: 1 / -1; background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="nombreInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Nombre</label>
              <input 
                id="nombreInput"
                type="text"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>
            
            <!-- Email (full width) -->
            <div style="grid-column: 1 / -1; background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Email</label>
              <p id="emailDisplay" style="margin: 0; font-size: 1.1rem; color: var(--text-primary); font-weight: 600;">Cargando...</p>
            </div>
            
            <!-- Tel√©fono (left) -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="telefonoInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Tel√©fono</label>
              <input 
                id="telefonoInput"
                type="tel"
                placeholder="Tu n√∫mero de tel√©fono"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>
            
            <!-- C√≥digo Postal (right) -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="codigoPostalInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">C√≥digo Postal *</label>
              <input 
                id="codigoPostalInput"
                type="text"
                placeholder="Ej: 28001"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>
            
            <!-- Direcci√≥n (left) -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="direccionInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Direcci√≥n *</label>
              <input 
                id="direccionInput"
                type="text"
                placeholder="Ej: Calle Mayor 12"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>

            <!-- Piso (right) -->
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">
              <label for="pisoInput" style="display: block; font-size: 0.8rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">Piso / Puerta *</label>
              <input 
                id="pisoInput"
                type="text"
                placeholder="Ej: 2¬∫B"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; background: var(--bg-input); color: var(--text-primary);"
              />
            </div>

            <div id="mensajePerfilEstado" style="display: none; grid-column: 1 / -1; padding: 1rem; border-radius: 8px; font-size: 0.95rem; margin-top: 0.5rem; border-left: 4px solid var(--color-accent);"></div>
            
            <button 
              type="submit"
              style="grid-column: 1 / -1; width: 100%; padding: 0.85rem; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark)); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; margin-top: 1rem; box-shadow: 0 4px 12px rgba(168, 153, 104, 0.2);"
            >
              Guardar Cambios
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    input:focus {
      outline: none;
      border-color: var(--color-accent) !important;
      box-shadow: 0 0 0 3px rgba(168, 153, 104, 0.1) !important;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--color-accent-dark), var(--color-accent-dark)) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(168, 153, 104, 0.3) !important;
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      #formularioPerfil {
        grid-template-columns: 1fr !important;
      }
    }
  </style>

  <script>
    async function cargarDatosUsuario() {
      try {
        let userId = localStorage.getItem('user_id');
        console.log('üîç userId desde localStorage:', userId);
        
        // Si no hay userId en localStorage, intentar obtenerlo del endpoint
        if (!userId || userId === 'null' || userId === 'undefined') {
          console.log('üîÑ Intentando obtener usuario desde /api/auth/me');
          try {
            const meResponse = await fetch('/api/auth/me', {
              credentials: 'include'
            });
            if (meResponse.ok) {
              const meData = await meResponse.json();
              if (meData.success && meData.usuario) {
                userId = meData.usuario.id;
                console.log('‚úÖ Usuario obtenido del endpoint:', userId);
                if (userId) localStorage.setItem('user_id', userId);
              }
            }
          } catch (e) {
            console.log('‚ö†Ô∏è No se pudo obtener usuario del endpoint');
          }
        }
        
        const response = await fetch('/api/auth/me', {
          credentials: 'include',
          headers: {
            ...(userId && userId !== 'null' && { 'x-user-id': userId })
          }
        });
        
        console.log('üì° Response status:', response.status);
        const data = await response.json();
        console.log('üì¶ Data recibida:', data);
        
        if (data.success && data.usuario) {
          (document.getElementById('nombreInput') as HTMLInputElement).value = data.usuario.nombre || '';
          const emailDisplay = document.getElementById('emailDisplay');
          if (emailDisplay) emailDisplay.textContent = data.usuario.email || '-';
          (document.getElementById('telefonoInput') as HTMLInputElement).value = data.usuario.telefono || '';
          
          // Parsear direcci√≥n concatenada (formato: "Direcci√≥n | C√≥digo Postal | Piso")
          const direccionCompleta = data.usuario.direccion || '';
          const partes = direccionCompleta.split('|').map((p: string) => p.trim());
          (document.getElementById('direccionInput') as HTMLInputElement).value = partes[0] || '';
          (document.getElementById('codigoPostalInput') as HTMLInputElement).value = partes[1] || '';
          (document.getElementById('pisoInput') as HTMLInputElement).value = partes[2] || '';
          
          // Detectar si el usuario viene de OAuth
          if (!data.usuario.tienePassword && data.usuario.provider !== 'email') {
            console.log('Usuario OAuth sin contrase√±a local');
          }
          
          console.log('‚úÖ Datos cargados correctamente');
        } else {
          console.error('‚ùå Error en respuesta:', data.error);
          const emailDisplay = document.getElementById('emailDisplay');
          if (emailDisplay) emailDisplay.textContent = 'Error: ' + (data.error || 'No autorizado');
        }
      } catch (error) {
        console.error('‚ùå Error cargando datos del usuario:', error);
        const emailDisplay = document.getElementById('emailDisplay');
        if (emailDisplay) emailDisplay.textContent = 'Error de conexi√≥n';
      }
    }

    async function guardarPerfil(e: Event) {
      e.preventDefault();
      
      const nombre = (document.getElementById('nombreInput') as HTMLInputElement)?.value || '';
      const telefono = (document.getElementById('telefonoInput') as HTMLInputElement)?.value || '';
      const direccion = (document.getElementById('direccionInput') as HTMLInputElement)?.value?.trim() || '';
      const codigoPostal = (document.getElementById('codigoPostalInput') as HTMLInputElement)?.value?.trim() || '';
      const piso = (document.getElementById('pisoInput') as HTMLInputElement)?.value?.trim() || '';
      const mensajeEstado = document.getElementById('mensajePerfilEstado');
      const boton = (e.target as HTMLFormElement)?.querySelector('button[type="submit"]') as HTMLButtonElement | null;

      // Limpiar mensaje anterior
      if (mensajeEstado) mensajeEstado.style.display = 'none';

      // Validar nombre
      if (!nombre || nombre.trim().length === 0) {
        mostrarMensaje('El nombre es requerido', 'error', mensajeEstado, true);
        return;
      }

      // Validar direcci√≥n completa
      if (!direccion) {
        mostrarMensaje('La direcci√≥n es requerida', 'error', mensajeEstado, true);
        return;
      }

      if (!codigoPostal) {
        mostrarMensaje('El c√≥digo postal es requerido', 'error', mensajeEstado, true);
        return;
      }

      if (!piso) {
        mostrarMensaje('El piso/puerta es requerido', 'error', mensajeEstado, true);
        return;
      }

      // Concatenar direcci√≥n en formato "Direcci√≥n | C√≥digo Postal | Piso"
      const direccionConcatenada = `${direccion} | ${codigoPostal} | ${piso}`;

      try {
        if (boton) {
          boton.disabled = true;
          boton.textContent = 'Guardando...';
        }

        const response = await fetch('/api/auth/actualizar-perfil', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            nombre: nombre.trim(),
            telefono: telefono?.trim() || null,
            direccion: direccionConcatenada
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          mostrarMensaje('‚úÖ Perfil actualizado exitosamente', 'exito', mensajeEstado, true);
          setTimeout(() => {
            if (mensajeEstado) mensajeEstado.style.display = 'none';
          }, 5000);
        } else {
          mostrarMensaje('‚ùå ' + (data.message || 'Error al guardar'), 'error', mensajeEstado, true);
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('‚ùå Error de conexi√≥n', 'error', mensajeEstado, true);
      } finally {
        if (boton) {
          boton.disabled = false;
          boton.textContent = 'Guardar Cambios';
        }
      }
    }

    function mostrarMensaje(texto: string, tipo: string, elemento: HTMLElement | null, separado = false) {
      if (!elemento) return;
      elemento.textContent = texto;
      elemento.style.display = 'block';
      elemento.style.background = tipo === 'exito' ? '#d1fae5' : '#fee2e2';
      elemento.style.color = tipo === 'exito' ? '#065f46' : '#991b1b';
      elemento.style.borderLeftColor = tipo === 'exito' ? '#10b981' : '#ef4444';
    }

    // Cargar datos del usuario cuando carga la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      cargarDatosUsuario();
      document.getElementById('formularioPerfil')?.addEventListener('submit', guardarPerfil);
    });
  </script>
</ProtectedLayout>
