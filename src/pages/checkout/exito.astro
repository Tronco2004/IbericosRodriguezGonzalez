---
import Layout from '../../layouts/Layout.astro';

const params = Astro.url.searchParams;
const sessionId = params.get('session_id');
const success = params.get('status') === 'success';
---

<style>
  @keyframes scaleIn {
    from {
      transform: scale(0.5);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes progress {
    0%, 100% {
      width: 33%;
    }
    50% {
      width: 66%;
    }
  }
</style>

<Layout>
  <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #faf9f7; padding: 2rem;">
    <div style="width: 100%; max-width: 500px;">
      {success || sessionId ? (
        <div style="display: flex; flex-direction: column; gap: 2rem;">
          <!-- Header con Ã­cono animado -->
          <div style="text-align: center;">
            <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(168, 153, 104, 0.25); animation: scaleIn 0.6s ease-out;">
              <svg style="width: 60px; height: 60px; stroke: #faf9f7; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 700; color: #001a33; margin: 0 0 0.75rem 0;">Â¡Pedido Confirmado!</h1>
            <p style="font-size: 1.125rem; color: #5c4a3d; margin: 0; font-weight: 500;">Tu compra ha sido procesada exitosamente</p>
          </div>

          <!-- Tarjeta principal -->
          <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e0d5c7; box-shadow: 0 2px 8px rgba(0, 26, 51, 0.08);">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <!-- Paso 1 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #faf9f7; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem;">âœ“</div>
                <div>
                  <p style="color: #001a33; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Pago confirmado</p>
                  <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">Tu transacciÃ³n ha sido procesada exitosamente</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #e0d5c7;"></div>

              <!-- Paso 2 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #faf9f7; display: flex; align-items: center; justify-content: center; font-weight: bold; animation: spin 2s linear infinite;">âš™</div>
                <div>
                  <p style="color: #001a33; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Preparando tu pedido</p>
                  <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">Estamos organizando tu compra</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #e0d5c7;"></div>

              <!-- Paso 3 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #d4ccc0; color: #5c4a3d; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                <div>
                  <p style="color: #5c4a3d; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">EnvÃ­o en camino</p>
                  <p style="color: #666; font-size: 0.875rem; margin: 0;">Pronto recibirÃ¡s tu pedido</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/mis-pedidos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(168, 153, 104, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 153, 104, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 153, 104, 0.3)'">
              Ver mis pedidos
            </a>

            <a href="/productos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: white; color: #001a33; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; border: 1px solid #e0d5c7; cursor: pointer;" onmouseover="this.style.background='#faf9f7'" onmouseout="this.style.background='white'">
              Continuar comprando
            </a>
          </div>

          <!-- Info de ayuda -->
          <div style="background: #e0d5c7; border: 1px solid #d4ccc0; border-radius: 8px; padding: 1rem; text-align: center;">
            <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">
              <strong>Â¿Necesitas ayuda?</strong><br/>
              ContÃ¡ctanos en <a href="mailto:ibericosrg@gmail.com" style="color: #a89968; text-decoration: none; font-weight: 600;">ibericosrg@gmail.com</a>
            </p>
          </div>

          <!-- Countdown -->
          <div style="text-align: center; color: #5c4a3d; font-size: 0.875rem;">
            Redirigiendo en <span id="countdown" style="font-weight: bold; color: #a89968;">5</span> segundos...
          </div>
        </div>
      ) : (
        <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e0d5c7; box-shadow: 0 2px 8px rgba(0, 26, 51, 0.08); text-align: center;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; border-radius: 50%; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);">
            <svg style="width: 50px; height: 50px; stroke: white; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
          <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: #001a33; margin: 0 0 0.5rem 0;">Pago Cancelado</h1>
          <p style="font-size: 1rem; color: #5c4a3d; margin: 0 0 2rem 0;">Tu pago no se pudo completar</p>

          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: left;">
            <p style="color: #dc2626; font-size: 0.875rem; margin: 0 0 0.75rem 0; font-weight: 600;">Posibles razones:</p>
            <ul style="color: #5c4a3d; font-size: 0.875rem; margin: 0; padding-left: 1.5rem;">
              <li>Fondos insuficientes</li>
              <li>Tarjeta expirada o bloqueada</li>
              <li>InformaciÃ³n incorrecta</li>
              <li>Problemas de conexiÃ³n</li>
            </ul>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/carrito" style="display: block; text-align: center; padding: 1rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Volver al Carrito
            </a>
            <a href="/productos" style="display: block; text-align: center; padding: 1rem; background: white; color: #001a33; text-decoration: none; border-radius: 8px; font-weight: 600; border: 1px solid #e0d5c7;" onmouseover="this.style.background='#faf9f7'" onmouseout="this.style.background='white'">
              Continuar Comprando
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  <script>
    function mostrarNotificacion(mensaje, tipo = 'error') {
      console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
      const notificacion = document.createElement('div');
      notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${tipo === 'exito' || tipo === 'success' ? '#28a745' : '#dc3545'};
        color: white;
        border-radius: 4px;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      notificacion.textContent = mensaje;
      document.body.appendChild(notificacion);

      setTimeout(() => {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notificacion.remove(), 300);
      }, 4000);
    }

    async function crearPedidoDesdeStripe() {
      try {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const codigoDescuento = params.get('codigo');
        const esInvitado = params.get('guest') === 'true';
        const userId = localStorage.getItem('user_id');

        console.log('=== Creando pedido ===');
        console.log('sessionId:', sessionId);
        console.log('userId:', userId);
        console.log('esInvitado:', esInvitado);
        console.log('codigoDescuento:', codigoDescuento);

        if (!sessionId) {
          console.error('Falta session_id');
          return;
        }

        // Si es invitado, usar datos del localStorage
        if (esInvitado || !userId) {
          await crearPedidoInvitado(sessionId, codigoDescuento);
          return;
        }

        // Flujo normal para usuarios logueados
        await crearPedidoUsuario(sessionId, codigoDescuento, userId);

      } catch (error) {
        console.error('Error creando pedido:', error);
        // No mostrar alerta para no molestar al usuario
      }
    }

    // Crear pedido para usuario logueado
    async function crearPedidoUsuario(sessionId, codigoDescuento, userId) {
      // Obtener datos del carrito
      const carritoResponse = await fetch('/api/carrito', {
        credentials: 'include',
        headers: { 'x-user-id': userId }
      });

      if (!carritoResponse.ok) {
        console.error('Error obteniendo carrito:', carritoResponse.status);
        return;
      }

      const carritoData = await carritoResponse.json();
      const items = carritoData.items || [];

      if (!items.length) {
        console.log('Carrito vacÃ­o - pedido ya creado o expirado');
        return;
      }

      console.log('ðŸ“¦ Items en carrito:', items.length);

      // Normalizar precios a CENTIMOS (algunos pueden estar mal guardados)
      const itemsNormalizados = items.map(item => {
        let precio = item.precio_unitario;
        
        console.log('ðŸ” Normalizando precio:', { original: precio });
        
        // Si el precio es > 10000, estÃ¡ x100 de centimos
        if (precio > 10000) {
          precio = precio / 100;
          console.log('  â†’ Estaba x100, dividido por 100');
        }
        // Si es <= 100, estÃ¡ en euros - multiplicar por 100 para convertir a centimos
        else if (precio <= 100) {
          precio = precio * 100;
          console.log('  â†’ Estaba en euros, multiplicado por 100');
        }
        // Si 100 < precio <= 10000, ya estÃ¡ en centimos - no tocar
        else {
          console.log('  â†’ Ya estÃ¡ en centimos');
        }
        
        console.log('  â†’ Final:', precio, '(centimos)');
        
        return {
          ...item,
          precio_unitario: precio
        };
      });

      // Formatear items para crear el pedido
      const cartItems = itemsNormalizados.map(item => ({
        producto_id: item.producto_id,
        producto_variante_id: item.producto_variante_id,
        nombre: item.productos?.nombre,
        precio: item.precio_unitario, // Ya normalizado a centimos
        cantidad: item.cantidad,
        peso_kg: item.peso_kg
      }));

      // Calcular totales (todo en centimos)
      const SHIPPING_COST = 500;
      const subtotal = itemsNormalizados.reduce((sum, item) => sum + (item.precio_unitario * item.cantidad), 0);
      const envio = SHIPPING_COST;

      // Calcular descuento si existe
      let descuentoAplicado = 0;
      if (codigoDescuento) {
        try {
          const validarResponse = await fetch('/api/codigos/validar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-user-id': userId
            },
            body: JSON.stringify({
              codigo: codigoDescuento,
              monto_carrito: (subtotal / 100)
            })
          });

          const validarData = await validarResponse.json();
          if (validarData.success) {
            descuentoAplicado = validarData.descuento;
          }
        } catch (error) {
          console.error('Error validando descuento:', error);
        }
      }

      const descuentoEnCentimos = Math.round(descuentoAplicado * 100);
      const totalConDescuentoCentimos = (subtotal + envio) - descuentoEnCentimos;

      // Crear el pedido
      const pedidoResponse = await fetch('/api/pedidos', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'x-user-id': userId,
          'x-envio': String(envio)
        },
        body: JSON.stringify({
          stripe_session_id: sessionId,
          cartItems,
          subtotal,
          envio,
          total: totalConDescuentoCentimos,
          descuento_aplicado: descuentoAplicado,
          es_invitado: false
        })
      });

      const pedidoData = await pedidoResponse.json();

      if (pedidoData.success) {
        console.log('âœ… Pedido creado:', pedidoData.numero_pedido);

        // Registrar uso del cÃ³digo si existe
        if (codigoDescuento) {
          await registrarUsoCodigo(codigoDescuento, pedidoData.pedido_id, userId);
        }

        // Limpiar localStorage
        localStorage.removeItem('carrito');
        localStorage.removeItem('carrito_invitado');
        localStorage.removeItem('checkout_invitado');
        
        console.log('âœ… Carrito limpiado de localStorage');
        console.log('âœ… Redirigiendo a /mis-pedidos en 2 segundos...');
        
        setTimeout(() => {
          window.location.href = '/mis-pedidos';
        }, 2000);
      } else {
        console.error('Error del API:', pedidoData.error);
        mostrarNotificacion('Error creando el pedido: ' + (pedidoData.error || 'Error desconocido'), 'error');
      }
    }

    // Crear pedido para invitado
    async function crearPedidoInvitado(sessionId, codigoDescuento) {
      // Obtener datos guardados en localStorage
      const checkoutData = localStorage.getItem('checkout_invitado');
      
      if (!checkoutData) {
        console.log('No hay datos de checkout invitado');
        return;
      }

      const datos = JSON.parse(checkoutData);
      const { nombre, email, telefono, cartItems, descuentoAplicado } = datos;

      if (!cartItems || cartItems.length === 0) {
        console.log('No hay items en el checkout de invitado');
        return;
      }

      console.log('ðŸ“¦ Creando pedido de invitado');
      console.log('Items:', cartItems.length);
      console.log('Email:', email);

      // Calcular totales
      const SHIPPING_COST = 500;
      const subtotal = cartItems.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
      const envio = SHIPPING_COST;
      const descuentoEnCentimos = Math.round((descuentoAplicado || 0) * 100);
      const total = (subtotal + envio) - descuentoEnCentimos;

      // Crear el pedido
      const pedidoResponse = await fetch('/api/pedidos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-envio': String(envio)
        },
        body: JSON.stringify({
          stripe_session_id: sessionId,
          cartItems,
          subtotal,
          envio,
          total,
          descuento_aplicado: descuentoAplicado || 0,
          es_invitado: true,
          nombre_cliente: nombre,
          email_cliente: email,
          telefono_cliente: telefono
        })
      });

      const pedidoData = await pedidoResponse.json();

      if (pedidoData.success) {
        console.log('âœ… Pedido de invitado creado:', pedidoData.numero_pedido);

        // Limpiar datos de invitado
        localStorage.removeItem('checkout_invitado');
        localStorage.removeItem('carrito_invitado');
        
        // Mostrar mensaje de Ã©xito y quedarse en la pÃ¡gina
        mostrarExitoInvitado(pedidoData.numero_pedido, email);
      } else {
        console.error('Error creando pedido invitado:', pedidoData.error);
      }
    }

    // Registrar uso de cÃ³digo de descuento
    async function registrarUsoCodigo(codigo, pedidoId, email, userId) {
      try {
        const registroResponse = await fetch('/api/codigos/registrar-uso', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': userId
          },
          body: JSON.stringify({
            codigo,
            pedido_id: pedidoId,
            email_usuario: email
          })
        });

        const registroData = await registroResponse.json();
        if (registroData.success) {
          console.log('CÃ³digo registrado correctamente');
        }
      } catch (error) {
        console.error('Error registrando cÃ³digo:', error);
      }
    }

    // Mostrar mensaje de Ã©xito para invitados
    function mostrarExitoInvitado(numeroPedido, email) {
      // Ocultar el botÃ³n de "Ver mis pedidos" y mostrar mensaje especial
      const container = document.querySelector('[style*="display: flex; flex-direction: column; gap: 1rem"]');
      if (container) {
        container.innerHTML = `
          <div style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; text-align: center;">
            <p style="color: #065f46; font-size: 1rem; margin: 0 0 0.5rem 0; font-weight: 600;">
              Â¡Gracias por tu compra!
            </p>
            <p style="color: #047857; font-size: 0.9rem; margin: 0;">
              Hemos enviado la confirmaciÃ³n a <strong>${email}</strong>
            </p>
            <p style="color: #047857; font-size: 0.85rem; margin: 0.5rem 0 0 0;">
              NÂº de pedido: <strong>${numeroPedido}</strong>
            </p>
          </div>
          
          <a href="/productos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.125rem;">
            Continuar comprando
          </a>
          
          <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: #f8f7f4; border-radius: 8px;">
            <p style="color: #5c4a3d; font-size: 0.9rem; margin: 0 0 0.5rem 0;">
              Â¿Quieres guardar tus pedidos?
            </p>
            <a href="/registro" style="color: #a89968; font-weight: 600; text-decoration: underline;">
              Crear una cuenta
            </a>
          </div>
        `;
      }

      // Ocultar countdown
      const countdown = document.getElementById('countdown');
      if (countdown && countdown.parentElement) {
        countdown.parentElement.style.display = 'none';
      }
    }

    // Crear el pedido solo si hay sessionId
    const sessionId = new URLSearchParams(window.location.search).get('session_id');
    if (sessionId) {
      crearPedidoDesdeStripe();
    } else {
      // Si no hay session_id pero hay status=success, actualizar contador
      if (location.search.includes('status=success')) {
        let seconds = 5;
        const countdownEl = document.getElementById('countdown');
        
        const interval = setInterval(() => {
          seconds--;
          if (countdownEl) countdownEl.textContent = seconds.toString();
          
          if (seconds <= 0) {
            clearInterval(interval);
            window.location.href = '/mis-pedidos';
          }
        }, 1000);
      }
    }
  </script>
</Layout>
