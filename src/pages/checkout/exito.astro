---
import Layout from '../../layouts/Layout.astro';

const params = Astro.url.searchParams;
const sessionId = params.get('session_id');
const success = params.get('status') === 'success';
---

<style>
  @keyframes scaleIn {
    from {
      transform: scale(0.5);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes progress {
    0%, 100% {
      width: 33%;
    }
    50% {
      width: 66%;
    }
  }
</style>

<Layout>
  <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #faf9f7; padding: 2rem;">
    <div style="width: 100%; max-width: 500px;">
      {success || sessionId ? (
        <div style="display: flex; flex-direction: column; gap: 2rem;">
          <!-- Header con Ã­cono animado -->
          <div style="text-align: center;">
            <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(168, 153, 104, 0.25); animation: scaleIn 0.6s ease-out;">
              <svg style="width: 60px; height: 60px; stroke: #faf9f7; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 700; color: #001a33; margin: 0 0 0.75rem 0;">Â¡Pedido Confirmado!</h1>
            <p style="font-size: 1.125rem; color: #5c4a3d; margin: 0; font-weight: 500;">Tu compra ha sido procesada exitosamente</p>
          </div>

          <!-- Tarjeta principal -->
          <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e0d5c7; box-shadow: 0 2px 8px rgba(0, 26, 51, 0.08);">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <!-- Paso 1 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #faf9f7; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem;">âœ“</div>
                <div>
                  <p style="color: #001a33; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Pago confirmado</p>
                  <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">Tu transacciÃ³n ha sido procesada exitosamente</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #e0d5c7;"></div>

              <!-- Paso 2 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #faf9f7; display: flex; align-items: center; justify-content: center; font-weight: bold; animation: spin 2s linear infinite;">âš™</div>
                <div>
                  <p style="color: #001a33; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Preparando tu pedido</p>
                  <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">Estamos organizando tu compra</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #e0d5c7;"></div>

              <!-- Paso 3 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #d4ccc0; color: #5c4a3d; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                <div>
                  <p style="color: #5c4a3d; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">EnvÃ­o en camino</p>
                  <p style="color: #666; font-size: 0.875rem; margin: 0;">Pronto recibirÃ¡s tu pedido</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/mis-pedidos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(168, 153, 104, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 153, 104, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 153, 104, 0.3)'">
              Ver mis pedidos
            </a>

            <a href="/productos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: white; color: #001a33; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; border: 1px solid #e0d5c7; cursor: pointer;" onmouseover="this.style.background='#faf9f7'" onmouseout="this.style.background='white'">
              Continuar comprando
            </a>
          </div>

          <!-- Info de ayuda -->
          <div style="background: #e0d5c7; border: 1px solid #d4ccc0; border-radius: 8px; padding: 1rem; text-align: center;">
            <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">
              <strong>Â¿Necesitas ayuda?</strong><br/>
              ContÃ¡ctanos en <a href="mailto:ibericosrg@gmail.com" style="color: #a89968; text-decoration: none; font-weight: 600;">ibericosrg@gmail.com</a>
            </p>
          </div>

          <!-- Countdown -->
          <div style="text-align: center; color: #5c4a3d; font-size: 0.875rem;">
            Redirigiendo en <span id="countdown" style="font-weight: bold; color: #a89968;">5</span> segundos...
          </div>
        </div>
      ) : (
        <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e0d5c7; box-shadow: 0 2px 8px rgba(0, 26, 51, 0.08); text-align: center;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; border-radius: 50%; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);">
            <svg style="width: 50px; height: 50px; stroke: white; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
          <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: #001a33; margin: 0 0 0.5rem 0;">Pago Cancelado</h1>
          <p style="font-size: 1rem; color: #5c4a3d; margin: 0 0 2rem 0;">Tu pago no se pudo completar</p>

          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: left;">
            <p style="color: #dc2626; font-size: 0.875rem; margin: 0 0 0.75rem 0; font-weight: 600;">Posibles razones:</p>
            <ul style="color: #5c4a3d; font-size: 0.875rem; margin: 0; padding-left: 1.5rem;">
              <li>Fondos insuficientes</li>
              <li>Tarjeta expirada o bloqueada</li>
              <li>InformaciÃ³n incorrecta</li>
              <li>Problemas de conexiÃ³n</li>
            </ul>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/carrito" style="display: block; text-align: center; padding: 1rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Volver al Carrito
            </a>
            <a href="/productos" style="display: block; text-align: center; padding: 1rem; background: white; color: #001a33; text-decoration: none; border-radius: 8px; font-weight: 600; border: 1px solid #e0d5c7;" onmouseover="this.style.background='#faf9f7'" onmouseout="this.style.background='white'">
              Continuar Comprando
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  <script>
    async function crearPedidoDesdeStripe() {
      try {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const codigoDescuento = params.get('codigo');
        const userId = localStorage.getItem('user_id');

        console.log('=== Creando pedido ===');
        console.log('sessionId:', sessionId);
        console.log('userId:', userId);
        console.log('codigoDescuento:', codigoDescuento);

        if (!sessionId || !userId) {
          console.error('Faltan datos para crear el pedido');
          alert('Faltan datos para crear el pedido. Por favor intenta de nuevo.');
          return;
        }

        // Obtener datos del carrito
        const carritoResponse = await fetch('/api/carrito', {
          credentials: 'include',
          headers: { 'x-user-id': userId }
        });

        if (!carritoResponse.ok) {
          console.error('Error obteniendo carrito:', carritoResponse.status);
          alert('Error al obtener el carrito');
          return;
        }

        const carritoData = await carritoResponse.json();
        const items = carritoData.items || [];

        if (!items.length) {
          console.error('Carrito vacÃ­o');
          // No mostrar alerta, simplemente no crear el pedido
          return;
        }

        console.log('ðŸ“¦ Items en carrito:', items.length);

        // Formatear items para crear el pedido
        const cartItems = items.map(item => ({
          producto_id: item.producto_id,
          producto_variante_id: item.producto_variante_id,
          nombre: item.productos?.nombre,
          precio: item.precio_unitario,
          cantidad: item.cantidad,
          peso_kg: item.peso_kg
        }));

        // Calcular totales
        const SHIPPING_COST = 500; // 5â‚¬ en centimos
        const subtotal = items.reduce((sum, item) => sum + (item.precio_unitario * item.cantidad), 0);
        const envio = SHIPPING_COST;
        const total = subtotal + envio; // Subtotal + envÃ­o

        console.log('ðŸ’° Totales:', { subtotal, envio, total });

        // Obtener email del usuario
        const userDataResponse = await fetch('/api/auth/me', {
          credentials: 'include',
          headers: { 'x-user-id': userId }
        });

        const userDataRaw = await userDataResponse.json();
        const userData = userDataRaw.usuario || userDataRaw;
        console.log('ðŸ‘¤ Email del usuario:', userData.email);
        console.log('Datos del usuario completos:', userData);

        // Si hay cÃ³digo de descuento, obtener el descuento aplicado
        let descuentoAplicado = 0;
        if (codigoDescuento) {
          try {
            const validarResponse = await fetch('/api/codigos/validar', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-user-id': userId
              },
              body: JSON.stringify({
                codigo: codigoDescuento,
                monto_carrito: (subtotal / 100)
              })
            });

            const validarData = await validarResponse.json();
            if (validarData.success) {
              descuentoAplicado = validarData.descuento;
              console.log('Descuento a aplicar:', descuentoAplicado);
            }
          } catch (error) {
            console.error('Error validando descuento:', error);
          }
        }

        // Calcular total con descuento (en centimos)
        const descuentoEnCentimos = Math.round(descuentoAplicado * 100);
        const totalConDescuentoCentimos = (subtotal + envio) - descuentoEnCentimos;

        // Crear el pedido
        const pedidoResponse = await fetch('/api/pedidos', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': userId,
            'x-envio': String(envio)
          },
          body: JSON.stringify({
            stripe_session_id: sessionId,
            cartItems,
            subtotal,
            envio,
            total: totalConDescuentoCentimos,
            descuento_aplicado: descuentoAplicado,
            email: userData.email,
            telefono: userData.telefono || ''
          })
        });

        const pedidoData = await pedidoResponse.json();

        console.log('Respuesta del API:', pedidoData);
        console.log('Status de respuesta:', pedidoResponse.status);

        if (pedidoData.success) {
          console.log('Pedido creado exitosamente:', pedidoData.numero_pedido);

          // Registrar uso del cÃ³digo de descuento si existe
          if (codigoDescuento) {
            try {
              console.log('Registrando uso del cÃ³digo:', codigoDescuento);
              
              const registroResponse = await fetch('/api/codigos/registrar-uso', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-user-id': userId
                },
                body: JSON.stringify({
                  codigo: codigoDescuento,
                  pedido_id: pedidoData.pedido_id,
                  email_usuario: userData.email
                })
              });

              const registroData = await registroResponse.json();
              
              if (registroData.success) {
                console.log('Uso del cÃ³digo registrado correctamente');
              } else {
                console.error('Error registrando uso:', registroData.error);
              }
            } catch (error) {
              console.error('Error al registrar uso del cÃ³digo:', error);
              // No fallar el pedido si no se puede registrar el cÃ³digo
            }
          }

          console.log('Redirigiendo a mis-pedidos en 2 segundos...');
          
          // Las variantes se eliminarÃ¡n automÃ¡ticamente mediante trigger en la BD
          // cuando se inserta el pedido_item
          
          // Limpiar carrito del localStorage tambiÃ©n
          localStorage.removeItem('carrito');
          
          // Redirigir a mis-pedidos despuÃ©s de 2 segundos
          setTimeout(() => {
            console.log('Redirigiendo ahora...');
            window.location.href = '/mis-pedidos';
          }, 2000);
        } else {
          console.error('Error del API:', pedidoData.error);
          alert('Error al crear el pedido: ' + pedidoData.error);
        }
      } catch (error) {
        console.error('Error creando pedido:', error);
        alert('Error inesperado: ' + String(error));
      }
    }

    // Crear el pedido solo si hay sessionId
    const sessionId = new URLSearchParams(window.location.search).get('session_id');
    if (sessionId) {
      crearPedidoDesdeStripe();
    } else {
      // Si no hay session_id pero hay status=success, actualizar contador
      if (location.search.includes('status=success')) {
        let seconds = 5;
        const countdownEl = document.getElementById('countdown');
        
        const interval = setInterval(() => {
          seconds--;
          if (countdownEl) countdownEl.textContent = seconds.toString();
          
          if (seconds <= 0) {
            clearInterval(interval);
            window.location.href = '/mis-pedidos';
          }
        }, 1000);
      }
    }
  </script>
</Layout>
