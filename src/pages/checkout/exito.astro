---
import Layout from '../../layouts/Layout.astro';

const params = Astro.url.searchParams;
const sessionId = params.get('session_id');
const success = params.get('status') === 'success';
---

<style>
  @keyframes scaleIn {
    from {
      transform: scale(0.5);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes progress {
    0%, 100% {
      width: 33%;
    }
    50% {
      width: 66%;
    }
  }
</style>

<Layout>
  <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #0f0f0f; padding: 2rem;">
    <div style="width: 100%; max-width: 500px;">
      {success || sessionId ? (
        <div style="display: flex; flex-direction: column; gap: 2rem;">
          <!-- Header con Ã­cono animado -->
          <div style="text-align: center;">
            <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(168, 153, 104, 0.35); animation: scaleIn 0.6s ease-out;">
              <svg style="width: 60px; height: 60px; stroke: #fff; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 700; color: #fff; margin: 0 0 0.75rem 0;">Â¡Pedido Confirmado!</h1>
            <p style="font-size: 1.125rem; color: #a89968; margin: 0; font-weight: 500;">Tu compra ha sido procesada exitosamente</p>
          </div>

          <!-- Tarjeta principal -->
          <div style="background: #1a1a1a; border-radius: 12px; padding: 2rem; border: 1px solid #333333; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <!-- Paso 1 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem;">âœ“</div>
                <div>
                  <p style="color: #fff; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Pago confirmado</p>
                  <p style="color: #aaa; font-size: 0.875rem; margin: 0;">Tu transacciÃ³n ha sido procesada exitosamente</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #333333;"></div>

              <!-- Paso 2 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; animation: spin 2s linear infinite;">âš™</div>
                <div>
                  <p style="color: #fff; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Preparando tu pedido</p>
                  <p style="color: #aaa; font-size: 0.875rem; margin: 0;">Estamos organizando tu compra</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #333333;"></div>

              <!-- Paso 3 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #333333; color: #aaa; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                <div>
                  <p style="color: #ccc; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">EnvÃ­o en camino</p>
                  <p style="color: #aaa; font-size: 0.875rem; margin: 0;">Pronto recibirÃ¡s tu pedido</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/mis-pedidos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(168, 153, 104, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 153, 104, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 153, 104, 0.4)'">
              Ver mis pedidos
            </a>

            <a href="/productos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: #2a2a2a; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; border: 1px solid #333333; cursor: pointer;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='#2a2a2a'">
              Continuar comprando
            </a>
          </div>

          <!-- Info de ayuda -->
          <div style="background: #1a1a1a; border: 1px solid #333333; border-radius: 8px; padding: 1rem; text-align: center;">
            <p style="color: #aaa; font-size: 0.875rem; margin: 0;">
              <strong style="color: #fff;">Â¿Necesitas ayuda?</strong><br/>
              ContÃ¡ctanos en <a href="mailto:ibericosrg@gmail.com" style="color: #a89968; text-decoration: none; font-weight: 600;">ibericosrg@gmail.com</a>
            </p>
          </div>

          <!-- Countdown -->
          <div style="text-align: center; color: #aaa; font-size: 0.875rem;">
            Redirigiendo en <span id="countdown" style="font-weight: bold; color: #a89968;">10</span> segundos...
          </div>
        </div>
      ) : (
        <div style="background: #1a1a1a; border-radius: 12px; padding: 2rem; border: 1px solid #333333; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); text-align: center;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; border-radius: 50%; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(220, 38, 38, 0.4);">
            <svg style="width: 50px; height: 50px; stroke: white; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
          <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: #fff; margin: 0 0 0.5rem 0;">Pago Cancelado</h1>
          <p style="font-size: 1rem; color: #aaa; margin: 0 0 2rem 0;">Tu pago no se pudo completar</p>

          <div style="background: #2a1a1a; border: 1px solid #5c2c2c; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: left;">
            <p style="color: #ff6b6b; font-size: 0.875rem; margin: 0 0 0.75rem 0; font-weight: 600;">Posibles razones:</p>
            <ul style="color: #aaa; font-size: 0.875rem; margin: 0; padding-left: 1.5rem;">
              <li>Fondos insuficientes</li>
              <li>Tarjeta expirada o bloqueada</li>
              <li>InformaciÃ³n incorrecta</li>
              <li>Problemas de conexiÃ³n</li>
            </ul>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/carrito" style="display: block; text-align: center; padding: 1rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Volver al Carrito
            </a>
            <a href="/productos" style="display: block; text-align: center; padding: 1rem; background: #2a2a2a; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600; border: 1px solid #333333;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='#2a2a2a'">
              Continuar Comprando
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  <script>
    async function crearPedidoDesdeStripe() {
      try {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const userId = localStorage.getItem('user_id');
        const userEmail = localStorage.getItem('user_email');

        console.log('\nðŸŸ¢ ======= INICIO: Crear Pedido desde Stripe =======');
        console.log('sessionId:', sessionId);
        console.log('userId:', userId);
        console.log('userEmail:', userEmail);

        // Si es invitado, autenticarse anÃ³nimamente para que RLS funcione
        let finalUserId = userId;

        if (!sessionId) {
          console.error('âŒ Falta session_id');
          return;
        }

        function mostrarNotificacion(mensaje, tipo = 'error') {
          console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
          const notificacion = document.createElement('div');
          notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${tipo === 'exito' || tipo === 'success' ? '#28a745' : '#dc3545'};
            color: white;
            border-radius: 4px;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
          `;
          notificacion.textContent = mensaje;
          document.body.appendChild(notificacion);

          setTimeout(() => {
            notificacion.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notificacion.remove(), 300);
          }, 4000);
        }

        let cartItems = [];

        // Si es usuario logueado, obtener carrito de BD
        if (userId) {
          console.log('ðŸ“¦ Obteniendo carrito desde BD...');
          try {
            const carritoResponse = await fetch('/api/carrito', {
              credentials: 'include',
              headers: { 'x-user-id': userId }
            });

            if (carritoResponse.ok) {
              const carritoData = await carritoResponse.json();
              if (carritoData.items && carritoData.items.length > 0) {
                // Formatear items de la BD
                cartItems = carritoData.items.map((item: any) => ({
                  producto_id: item.producto_id,
                  producto_variante_id: item.producto_variante_id,
                  nombre: item.productos?.nombre || 'Producto sin nombre',
                  precio: item.precio_unitario, // Ya en centimos
                  precio_unitario: item.precio_unitario,
                  cantidad: item.cantidad,
                  peso_kg: item.peso_kg
                }));
                console.log(`âœ… ${cartItems.length} items obtenidos de BD`);
              }
            }
          } catch (error) {
            console.warn('âš ï¸ No se pudo obtener carrito de BD:', error);
          }
        }

        // Si no hay items de BD, usar localStorage (para invitados)
        if (cartItems.length === 0) {
          console.log('ðŸ“¦ Obteniendo carrito desde localStorage...');
          const carritoData = localStorage.getItem('carrito');
          const carritoInvitado = localStorage.getItem('carrito_invitado');
          
          if (carritoInvitado) {
            cartItems = JSON.parse(carritoInvitado).map((item: any) => ({
              producto_id: item.producto_id,
              producto_variante_id: item.producto_variante_id,
              nombre: item.nombre,
              precio: item.precio_unitario || item.precio,
              precio_unitario: item.precio_unitario || item.precio,
              cantidad: item.cantidad,
              peso_kg: item.peso_kg
            }));
          } else if (carritoData) {
            cartItems = JSON.parse(carritoData).map((item: any) => ({
              producto_id: item.producto_id,
              producto_variante_id: item.producto_variante_id,
              nombre: item.nombre,
              precio: item.precio_unitario || item.precio,
              precio_unitario: item.precio_unitario || item.precio,
              cantidad: item.cantidad,
              peso_kg: item.peso_kg
            }));
          }
          console.log(`âœ… ${cartItems.length} items desde localStorage`);
        }

        console.log('ðŸ“¦ Items totales a crear:', cartItems.length);
        if (cartItems.length > 0) {
          console.log('Primer item:', cartItems[0]);
        }

        // Llamar al nuevo endpoint que valida y crea el pedido
        const response = await fetch('/api/checkout/validar-y-crear-pedido', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            userId: finalUserId || null,
            userEmail: userEmail || null,
            cartItems,
            codigoDescuento: null,
            descuentoAplicado: 0,
            datosInvitado: JSON.parse(localStorage.getItem('checkout_invitado') || 'null')
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          console.log('âœ… Pedido creado exitosamente:');
          console.log('  - ID:', data.pedidoId);
          console.log('  - NÃºmero:', data.numeroPedido);
          console.log('  - CÃ³digo Seguimiento:', data.codigoSeguimiento);
          console.log('  - Total:', data.total);

          // Limpiar localStorage
          localStorage.removeItem('carrito');
          localStorage.removeItem('carrito_invitado');
          localStorage.removeItem('checkout_data');
          
          console.log('âœ… Carrito limpiado de localStorage');

          // Mostrar cÃ³digo de seguimiento en la pÃ¡gina
          if (data.codigoSeguimiento) {
            mostrarCodigoSeguimiento(data.codigoSeguimiento, data.numeroPedido);
          }

          // Iniciar redirecciÃ³n automÃ¡tica con countdown
          console.log('ðŸŸ¢ Pedido completado. Redirigiendo en 10 segundos...\n');
          iniciarCountdownRedireccion();
        } else {
          console.error('âŒ Error del API:', data.error);
          console.error('Detalles:', data.details);
          console.error('ðŸ”´ ======= ERROR: Crear Pedido desde Stripe =======\n');
          mostrarNotificacion(data.error || 'Error creando el pedido', 'error');
        }

      } catch (error) {
        console.error('âŒ Error en crearPedidoDesdeStripe:', error);
        mostrarNotificacion('Error al procesar tu pedido. Por favor, contacta soporte.', 'error');
      }
      console.log('ðŸ”„ ======= FIN: Validar y crear pedido =======\n');
    }

    function mostrarCodigoSeguimiento(codigo, numeroPedido) {
      // CÃ³digo de seguimiento se muestra en /mis-pedidos
      console.log('âœ“ CÃ³digo de seguimiento:', codigo);
    }

    function iniciarCountdownRedireccion() {
      let segundos = 10;
      const countdownElement = document.getElementById('countdown');
      const countdownContainer = countdownElement?.parentElement;
      
      // Mostrar el countdown si estaba oculto
      if (countdownContainer) {
        countdownContainer.style.display = 'block';
      }
      
      // Actualizar el valor inicial
      if (countdownElement) {
        countdownElement.textContent = segundos;
      }
      
      const intervalo = setInterval(() => {
        segundos--;
        if (countdownElement) {
          countdownElement.textContent = segundos;
        }
        
        if (segundos <= 0) {
          clearInterval(intervalo);
          window.location.href = '/mis-pedidos';
        }
      }, 1000);
    }


    // Crear el pedido solo si hay sessionId
    const sessionId = new URLSearchParams(window.location.search).get('session_id');
    console.log('ðŸ” Detectado sessionId:', sessionId ? 'SÃ­' : 'No');
    
    if (sessionId) {
      crearPedidoDesdeStripe();
    } else {
      console.log('âš ï¸ No hay sessionId, mostrando estado');
    }
  </script>
</Layout>
