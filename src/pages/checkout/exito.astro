---
import Layout from '../../layouts/Layout.astro';

const params = Astro.url.searchParams;
const sessionId = params.get('session_id');
const success = params.get('status') === 'success';
---

<style>
  @keyframes scaleIn {
    from {
      transform: scale(0.5);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes progress {
    0%, 100% {
      width: 33%;
    }
    50% {
      width: 66%;
    }
  }
</style>

<Layout>
  <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #faf9f7; padding: 2rem;">
    <div style="width: 100%; max-width: 500px;">
      {success || sessionId ? (
        <div style="display: flex; flex-direction: column; gap: 2rem;">
          <!-- Header con √≠cono animado -->
          <div style="text-align: center;">
            <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(168, 153, 104, 0.25); animation: scaleIn 0.6s ease-out;">
              <svg style="width: 60px; height: 60px; stroke: #faf9f7; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
            <h1 style="font-family: 'Playfair Display', serif; font-size: 3rem; font-weight: 700; color: #001a33; margin: 0 0 0.75rem 0;">¬°Pedido Confirmado!</h1>
            <p style="font-size: 1.125rem; color: #5c4a3d; margin: 0; font-weight: 500;">Tu compra ha sido procesada exitosamente</p>
          </div>

          <!-- Tarjeta principal -->
          <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e0d5c7; box-shadow: 0 2px 8px rgba(0, 26, 51, 0.08);">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <!-- Paso 1 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #faf9f7; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem;">‚úì</div>
                <div>
                  <p style="color: #001a33; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Pago confirmado</p>
                  <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">Tu transacci√≥n ha sido procesada exitosamente</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #e0d5c7;"></div>

              <!-- Paso 2 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #a89968; color: #faf9f7; display: flex; align-items: center; justify-content: center; font-weight: bold; animation: spin 2s linear infinite;">‚öô</div>
                <div>
                  <p style="color: #001a33; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Preparando tu pedido</p>
                  <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">Estamos organizando tu compra</p>
                </div>
              </div>

              <!-- Divisor -->
              <div style="height: 1px; background: #e0d5c7;"></div>

              <!-- Paso 3 -->
              <div style="display: flex; gap: 1rem;">
                <div style="width: 40px; height: 40px; min-width: 40px; border-radius: 50%; background: #d4ccc0; color: #5c4a3d; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                <div>
                  <p style="color: #5c4a3d; font-weight: 600; font-size: 1.125rem; margin: 0 0 0.25rem 0;">Env√≠o en camino</p>
                  <p style="color: #666; font-size: 0.875rem; margin: 0;">Pronto recibir√°s tu pedido</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/mis-pedidos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1.125rem; transition: all 0.3s ease; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(168, 153, 104, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 153, 104, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(168, 153, 104, 0.3)'">
              Ver mis pedidos
            </a>

            <a href="/productos" style="display: block; text-align: center; padding: 1rem 1.5rem; background: white; color: #001a33; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; border: 1px solid #e0d5c7; cursor: pointer;" onmouseover="this.style.background='#faf9f7'" onmouseout="this.style.background='white'">
              Continuar comprando
            </a>
          </div>

          <!-- Info de ayuda -->
          <div style="background: #e0d5c7; border: 1px solid #d4ccc0; border-radius: 8px; padding: 1rem; text-align: center;">
            <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0;">
              <strong>¬øNecesitas ayuda?</strong><br/>
              Cont√°ctanos en <a href="mailto:ibericosrg@gmail.com" style="color: #a89968; text-decoration: none; font-weight: 600;">ibericosrg@gmail.com</a>
            </p>
          </div>

          <!-- Countdown -->
          <div style="text-align: center; color: #5c4a3d; font-size: 0.875rem;">
            Redirigiendo en <span id="countdown" style="font-weight: bold; color: #a89968;">10</span> segundos...
          </div>
        </div>
      ) : (
        <div style="background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e0d5c7; box-shadow: 0 2px 8px rgba(0, 26, 51, 0.08); text-align: center;">
          <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; border-radius: 50%; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(220, 38, 38, 0.3);">
            <svg style="width: 50px; height: 50px; stroke: white; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </div>
          <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; color: #001a33; margin: 0 0 0.5rem 0;">Pago Cancelado</h1>
          <p style="font-size: 1rem; color: #5c4a3d; margin: 0 0 2rem 0;">Tu pago no se pudo completar</p>

          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 2rem; text-align: left;">
            <p style="color: #dc2626; font-size: 0.875rem; margin: 0 0 0.75rem 0; font-weight: 600;">Posibles razones:</p>
            <ul style="color: #5c4a3d; font-size: 0.875rem; margin: 0; padding-left: 1.5rem;">
              <li>Fondos insuficientes</li>
              <li>Tarjeta expirada o bloqueada</li>
              <li>Informaci√≥n incorrecta</li>
              <li>Problemas de conexi√≥n</li>
            </ul>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <a href="/carrito" style="display: block; text-align: center; padding: 1rem; background: linear-gradient(135deg, #a89968 0%, #8b7355 100%); color: #faf9f7; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
              Volver al Carrito
            </a>
            <a href="/productos" style="display: block; text-align: center; padding: 1rem; background: white; color: #001a33; text-decoration: none; border-radius: 8px; font-weight: 600; border: 1px solid #e0d5c7;" onmouseover="this.style.background='#faf9f7'" onmouseout="this.style.background='white'">
              Continuar Comprando
            </a>
          </div>
        </div>
      )}
    </div>
  </div>

  <script>
    async function crearPedidoDesdeStripe() {
      try {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const userId = localStorage.getItem('user_id');
        const userEmail = localStorage.getItem('user_email');

        console.log('\nüü¢ ======= INICIO: Crear Pedido desde Stripe =======');
        console.log('sessionId:', sessionId);
        console.log('userId:', userId);
        console.log('userEmail:', userEmail);

        // Si es invitado, autenticarse an√≥nimamente para que RLS funcione
        let finalUserId = userId;

        if (!sessionId) {
          console.error('‚ùå Falta session_id');
          return;
        }

        function mostrarNotificacion(mensaje, tipo = 'error') {
          console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
          const notificacion = document.createElement('div');
          notificacion.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${tipo === 'exito' || tipo === 'success' ? '#28a745' : '#dc3545'};
            color: white;
            border-radius: 4px;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
          `;
          notificacion.textContent = mensaje;
          document.body.appendChild(notificacion);

          setTimeout(() => {
            notificacion.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notificacion.remove(), 300);
          }, 4000);
        }

        let cartItems = [];

        // Si es usuario logueado, obtener carrito de BD
        if (userId) {
          console.log('üì¶ Obteniendo carrito desde BD...');
          try {
            const carritoResponse = await fetch('/api/carrito', {
              credentials: 'include',
              headers: { 'x-user-id': userId }
            });

            if (carritoResponse.ok) {
              const carritoData = await carritoResponse.json();
              if (carritoData.items && carritoData.items.length > 0) {
                // Formatear items de la BD
                cartItems = carritoData.items.map((item: any) => ({
                  producto_id: item.producto_id,
                  producto_variante_id: item.producto_variante_id,
                  nombre: item.productos?.nombre || 'Producto sin nombre',
                  precio: item.precio_unitario, // Ya en centimos
                  precio_unitario: item.precio_unitario,
                  cantidad: item.cantidad,
                  peso_kg: item.peso_kg
                }));
                console.log(`‚úÖ ${cartItems.length} items obtenidos de BD`);
              }
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è No se pudo obtener carrito de BD:', error);
          }
        }

        // Si no hay items de BD, usar localStorage (para invitados)
        if (cartItems.length === 0) {
          console.log('üì¶ Obteniendo carrito desde localStorage...');
          const carritoData = localStorage.getItem('carrito');
          const carritoInvitado = localStorage.getItem('carrito_invitado');
          
          if (carritoInvitado) {
            cartItems = JSON.parse(carritoInvitado).map((item: any) => ({
              producto_id: item.producto_id,
              producto_variante_id: item.producto_variante_id,
              nombre: item.nombre,
              precio: item.precio_unitario || item.precio,
              precio_unitario: item.precio_unitario || item.precio,
              cantidad: item.cantidad,
              peso_kg: item.peso_kg
            }));
          } else if (carritoData) {
            cartItems = JSON.parse(carritoData).map((item: any) => ({
              producto_id: item.producto_id,
              producto_variante_id: item.producto_variante_id,
              nombre: item.nombre,
              precio: item.precio_unitario || item.precio,
              precio_unitario: item.precio_unitario || item.precio,
              cantidad: item.cantidad,
              peso_kg: item.peso_kg
            }));
          }
          console.log(`‚úÖ ${cartItems.length} items desde localStorage`);
        }

        console.log('üì¶ Items totales a crear:', cartItems.length);
        if (cartItems.length > 0) {
          console.log('Primer item:', cartItems[0]);
        }

        // Llamar al nuevo endpoint que valida y crea el pedido
        const response = await fetch('/api/checkout/validar-y-crear-pedido', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            userId: finalUserId || null,
            userEmail: userEmail || null,
            cartItems,
            codigoDescuento: null,
            descuentoAplicado: 0,
            datosInvitado: null
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          console.log('‚úÖ Pedido creado exitosamente:');
          console.log('  - ID:', data.pedidoId);
          console.log('  - N√∫mero:', data.numeroPedido);
          console.log('  - C√≥digo Seguimiento:', data.codigoSeguimiento);
          console.log('  - Total:', data.total);

          // Limpiar localStorage
          localStorage.removeItem('carrito');
          localStorage.removeItem('carrito_invitado');
          localStorage.removeItem('checkout_data');
          
          console.log('‚úÖ Carrito limpiado de localStorage');

          // Mostrar c√≥digo de seguimiento en la p√°gina
          if (data.codigoSeguimiento) {
            mostrarCodigoSeguimiento(data.codigoSeguimiento, data.numeroPedido);
          }

          // Iniciar redirecci√≥n autom√°tica con countdown
          console.log('üü¢ Pedido completado. Redirigiendo en 10 segundos...\n');
          iniciarCountdownRedireccion();
        } else {
          console.error('‚ùå Error del API:', data.error);
          console.error('Detalles:', data.details);
          console.error('üî¥ ======= ERROR: Crear Pedido desde Stripe =======\n');
          mostrarNotificacion(data.error || 'Error creando el pedido', 'error');
        }

      } catch (error) {
        console.error('‚ùå Error en crearPedidoDesdeStripe:', error);
        mostrarNotificacion('Error al procesar tu pedido. Por favor, contacta soporte.', 'error');
      }
      console.log('üîÑ ======= FIN: Validar y crear pedido =======\n');
    }

    function mostrarCodigoSeguimiento(codigo, numeroPedido) {
      // Crear el elemento del c√≥digo de seguimiento
      const seguimientoBox = document.createElement('div');
      seguimientoBox.id = 'seguimientoBox';
      seguimientoBox.style.cssText = `
        background: linear-gradient(135deg, #f8f7f4 0%, #ede7dd 100%);
        border: 2px solid #a89968;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        text-align: center;
        animation: slideIn 0.5s ease;
      `;
      seguimientoBox.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem;">
          <svg style="width: 24px; height: 24px; color: #a89968;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
          <span style="font-weight: 600; color: #5c4a3d; font-size: 1rem;">C√≥digo de Seguimiento</span>
        </div>
        <div style="
          background: white;
          padding: 1rem;
          border-radius: 8px;
          font-family: monospace;
          font-size: 1.5rem;
          font-weight: 700;
          color: #001a33;
          letter-spacing: 2px;
          margin-bottom: 0.75rem;
          border: 1px dashed #a89968;
          cursor: pointer;
          transition: all 0.3s ease;
        " 
        onclick="navigator.clipboard.writeText('${codigo}'); this.style.background='#e8f5e9'; setTimeout(() => this.style.background='white', 1000);"
        title="Clic para copiar"
        >
          ${codigo}
        </div>
        <p style="color: #5c4a3d; font-size: 0.875rem; margin: 0 0 1rem 0;">
          Guarda este c√≥digo para rastrear tu pedido en cualquier momento
        </p>
        <a href="/seguimiento?codigo=${codigo}" style="
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.75rem 1.5rem;
          background: linear-gradient(135deg, #a89968 0%, #8b7355 100%);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.9rem;
          transition: all 0.3s ease;
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          <svg style="width: 18px; height: 18px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          Ver estado del pedido
        </a>
      `;

      // Insertar despu√©s del paso 3 (antes de los botones)
      const botones = document.querySelector('a[href="/mis-pedidos"]')?.parentElement;
      if (botones) {
        botones.parentElement?.insertBefore(seguimientoBox, botones);
      }
    }

    function iniciarCountdownRedireccion() {
      let segundos = 10;
      const countdownElement = document.getElementById('countdown');
      const countdownContainer = countdownElement?.parentElement;
      
      // Mostrar el countdown si estaba oculto
      if (countdownContainer) {
        countdownContainer.style.display = 'block';
      }
      
      // Actualizar el valor inicial
      if (countdownElement) {
        countdownElement.textContent = segundos;
      }
      
      const intervalo = setInterval(() => {
        segundos--;
        if (countdownElement) {
          countdownElement.textContent = segundos;
        }
        
        if (segundos <= 0) {
          clearInterval(intervalo);
          window.location.href = '/mis-pedidos';
        }
      }, 1000);
    }


    // Crear el pedido solo si hay sessionId
    const sessionId = new URLSearchParams(window.location.search).get('session_id');
    console.log('üîç Detectado sessionId:', sessionId ? 'S√≠' : 'No');
    
    if (sessionId) {
      crearPedidoDesdeStripe();
    } else {
      console.log('‚ö†Ô∏è No hay sessionId, mostrando estado');
    }
  </script>
</Layout>
