---
import Layout from '../../layouts/Layout.astro';

const params = Astro.url.searchParams;
const sessionId = params.get('session_id');
const success = params.get('status') === 'success';
---

<Layout>
  <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
      {success || sessionId ? (
        <>
          <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
              <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Â¡Pago realizado!</h1>
            <p class="text-gray-600 mb-6">Tu pedido ha sido procesado exitosamente.</p>
            
            <p id="mensajeRedireccion" class="text-gray-600 text-sm mb-6">
              Redireccionando a tus pedidos en unos segundos...
            </p>

            <a 
              href="/mis-pedidos" 
              class="inline-block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition"
            >
              Ver Mis Pedidos
            </a>
          </div>
        </>
      ) : (
        <>
          <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
              <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Pago cancelado</h1>
            <p class="text-gray-600 mb-6">Tu pago no se completÃ³. Puedes volver al carrito e intentar nuevamente.</p>

            <a 
              href="/carrito" 
              class="inline-block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition"
            >
              Volver al carrito
            </a>
          </div>
        </>
      )}
    </div>
  </div>

  <script>
    async function crearPedidoDesdeStripe() {
      try {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        const codigoDescuento = params.get('codigo');
        const userId = localStorage.getItem('user_id');

        console.log('=== Creando pedido ===');
        console.log('sessionId:', sessionId);
        console.log('userId:', userId);
        console.log('codigoDescuento:', codigoDescuento);

        if (!sessionId || !userId) {
          console.error('Faltan datos para crear el pedido');
          alert('Faltan datos para crear el pedido. Por favor intenta de nuevo.');
          return;
        }

        // Obtener datos del carrito
        const carritoResponse = await fetch('/api/carrito', {
          credentials: 'include',
          headers: { 'x-user-id': userId }
        });

        if (!carritoResponse.ok) {
          console.error('Error obteniendo carrito:', carritoResponse.status);
          alert('Error al obtener el carrito');
          return;
        }

        const carritoData = await carritoResponse.json();
        const items = carritoData.items || [];

        if (!items.length) {
          console.error('Carrito vacÃ­o');
          alert('El carrito estÃ¡ vacÃ­o');
          return;
        }

        console.log('ðŸ“¦ Items en carrito:', items.length);

        // Formatear items para crear el pedido
        const cartItems = items.map(item => ({
          producto_id: item.producto_id,
          producto_variante_id: item.producto_variante_id,
          nombre: item.productos?.nombre,
          precio: item.precio_unitario,
          cantidad: item.cantidad,
          peso_kg: item.peso_kg
        }));

        // Calcular totales
        const SHIPPING_COST = 500; // 5â‚¬ en centimos
        const subtotal = items.reduce((sum, item) => sum + (item.precio_unitario * item.cantidad), 0);
        const envio = SHIPPING_COST;
        const total = subtotal + envio; // Subtotal + envÃ­o

        console.log('ðŸ’° Totales:', { subtotal, envio, total });

        // Obtener email del usuario
        const userDataResponse = await fetch('/api/auth/me', {
          credentials: 'include',
          headers: { 'x-user-id': userId }
        });

        const userDataRaw = await userDataResponse.json();
        const userData = userDataRaw.usuario || userDataRaw;
        console.log('ðŸ‘¤ Email del usuario:', userData.email);
        console.log('Datos del usuario completos:', userData);

        // Si hay cÃ³digo de descuento, obtener el descuento aplicado
        let descuentoAplicado = 0;
        if (codigoDescuento) {
          try {
            const validarResponse = await fetch('/api/codigos/validar', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-user-id': userId
              },
              body: JSON.stringify({
                codigo: codigoDescuento,
                monto_carrito: (subtotal / 100)
              })
            });

            const validarData = await validarResponse.json();
            if (validarData.success) {
              descuentoAplicado = validarData.descuento;
              console.log('Descuento a aplicar:', descuentoAplicado);
            }
          } catch (error) {
            console.error('Error validando descuento:', error);
          }
        }

        // Calcular total con descuento (en centimos)
        const descuentoEnCentimos = Math.round(descuentoAplicado * 100);
        const totalConDescuentoCentimos = (subtotal + envio) - descuentoEnCentimos;

        // Crear el pedido
        const pedidoResponse = await fetch('/api/pedidos', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': userId,
            'x-envio': String(envio)
          },
          body: JSON.stringify({
            stripe_session_id: sessionId,
            cartItems,
            subtotal,
            envio,
            total: totalConDescuentoCentimos,
            descuento_aplicado: descuentoAplicado,
            email: userData.email,
            telefono: userData.telefono || ''
          })
        });

        const pedidoData = await pedidoResponse.json();

        console.log('Respuesta del API:', pedidoData);
        console.log('Status de respuesta:', pedidoResponse.status);

        if (pedidoData.success) {
          console.log('Pedido creado exitosamente:', pedidoData.numero_pedido);

          // Registrar uso del cÃ³digo de descuento si existe
          if (codigoDescuento) {
            try {
              console.log('Registrando uso del cÃ³digo:', codigoDescuento);
              
              const registroResponse = await fetch('/api/codigos/registrar-uso', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-user-id': userId
                },
                body: JSON.stringify({
                  codigo: codigoDescuento,
                  pedido_id: pedidoData.pedido_id,
                  email_usuario: userData.email
                })
              });

              const registroData = await registroResponse.json();
              
              if (registroData.success) {
                console.log('Uso del cÃ³digo registrado correctamente');
              } else {
                console.error('Error registrando uso:', registroData.error);
              }
            } catch (error) {
              console.error('Error al registrar uso del cÃ³digo:', error);
              // No fallar el pedido si no se puede registrar el cÃ³digo
            }
          }

          console.log('Redirigiendo a mis-pedidos en 2 segundos...');
          
          // Las variantes se eliminarÃ¡n automÃ¡ticamente mediante trigger en la BD
          // cuando se inserta el pedido_item
          
          // Limpiar carrito del localStorage tambiÃ©n
          localStorage.removeItem('carrito');
          
          // Redirigir a mis-pedidos despuÃ©s de 2 segundos
          setTimeout(() => {
            console.log('Redirigiendo ahora...');
            window.location.href = '/mis-pedidos';
          }, 2000);
        } else {
          console.error('Error del API:', pedidoData.error);
          alert('Error al crear el pedido: ' + pedidoData.error);
        }
      } catch (error) {
        console.error('Error creando pedido:', error);
        alert('Error inesperado: ' + String(error));
      }
    }

    // Crear el pedido solo si hay sessionId
    const sessionId = new URLSearchParams(window.location.search).get('session_id');
    if (sessionId) {
      crearPedidoDesdeStripe();
    }
  </script>
</Layout>
