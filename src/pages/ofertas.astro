---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <style>
    .ofertas-page {
      min-height: 100vh;
      background: var(--bg-primary);
    }
    
    /* ===== HERO HEADER ===== */
    .ofertas-hero {
      text-align: center;
      padding: 2.5rem 1.5rem 3rem;
      margin-bottom: 2.5rem;
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%);
      border-radius: 0;
      position: relative;
      overflow: hidden;
    }

    .ofertas-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
    }

    .ofertas-badge {
      display: inline-block;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 3px;
      padding: 8px 20px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 30px;
      margin-bottom: 1.25rem;
      position: relative;
    }

    .ofertas-title {
      font-size: clamp(2rem, 6vw, 3.5rem);
      margin: 0 0 1rem 0;
      color: #fff;
      font-weight: 700;
      letter-spacing: -1px;
      line-height: 1.1;
      position: relative;
    }

    .ofertas-subtitle {
      color: rgba(255,255,255,0.85);
      font-size: 1rem;
      max-width: 500px;
      margin: 0 auto;
      font-weight: 400;
      line-height: 1.6;
      position: relative;
    }

    /* ===== GRID CENTRADO ===== */
    .ofertas-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem 4rem;
    }

    .ofertas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 320px));
      gap: 24px;
      justify-content: center;
      min-height: 300px;
    }

    .loading-text {
      grid-column: 1 / -1;
      text-align: center;
      color: var(--text-muted);
      padding: 3rem;
    }

    @media (max-width: 768px) {
      .ofertas-hero {
        padding: 2rem 1.25rem 2.5rem;
        border-radius: 0 0 20px 20px;
      }
      .ofertas-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      .ofertas-container {
        padding: 0 1rem 3rem;
      }
    }

    @media (max-width: 480px) {
      .ofertas-hero {
        padding: 1.5rem 1rem 2rem;
      }
      .ofertas-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
    }
  </style>

  <div class="ofertas-page">
    <!-- Hero Header -->
    <div class="ofertas-hero">
      <span class="ofertas-badge">OFERTAS ESPECIALES</span>
      <h1 class="ofertas-title">Todas Nuestras Ofertas</h1>
      <p class="ofertas-subtitle">
        Descubre nuestros mejores precios en productos premium seleccionados
      </p>
    </div>

    <!-- Contenedor de ofertas -->
    <div class="ofertas-container">
      <div id="ofertasContainer" class="ofertas-grid">
        <p class="loading-text">Cargando ofertas...</p>
      </div>
    </div>
  </div>

  <script>
    async function cargarOfertas() {
      try {
        const response = await fetch('/api/ofertas?limit=100');
        const { success, data: ofertas } = await response.json();

        const container = document.getElementById('ofertasContainer') as HTMLDivElement;

        if (!success || !ofertas || ofertas.length === 0) {
          container.innerHTML = '<p class="loading-text">No hay ofertas disponibles en este momento</p>';
          return;
        }

        let html = '';
        ofertas.forEach((oferta: any) => {
          const precioOriginal = (oferta.precio_original_centimos / 100).toFixed(2);
          const precioDescuento = (oferta.precio_descuento_centimos / 100).toFixed(2);
          const descuento = oferta.porcentaje_descuento || 0;
          const imagenUrl = oferta.imagen_url || oferta.producto?.imagen_url || '';
          const nombreProducto = oferta.producto?.nombre || oferta.nombre_oferta || 'Producto en oferta';
          const productoId = oferta.producto?.id || '#';

          html += `
            <article class="producto-card">
              <div class="producto-oferta-badge">-${descuento}%</div>
              
              <div class="producto-img-container">
                <a href="/productos/${productoId}" class="producto-img-link">
                  ${imagenUrl ? `
                    <img src="${imagenUrl}" alt="${nombreProducto}" loading="lazy" class="producto-img" />
                  ` : `
                    <div class="sin-imagen">Sin imagen</div>
                  `}
                </a>
              </div>
              
              <div class="producto-info">
                <a href="/productos/${productoId}" class="producto-nombre-link">
                  <h3 class="producto-nombre">${nombreProducto}</h3>
                </a>
                
                <div class="producto-stock-row">
                  <span class="stock-info">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Oferta activa
                  </span>
                  <span class="stock-label stock-label-oferta">-${descuento}% dto.</span>
                </div>
                
                <div class="producto-footer">
                  <div class="producto-precio-wrap">
                    <span class="producto-precio-original">${precioOriginal}€</span>
                    <span class="producto-precio producto-precio-oferta">${precioDescuento}€</span>
                  </div>
                  
                  <a href="/productos/${productoId}" class="product-btn btn-ver-oferta">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>
                    </svg>
                    <span>Ver Oferta</span>
                  </a>
                </div>
              </div>
            </article>
          `;
        });

        container.innerHTML = html;
      } catch (error) {
        console.error('Error cargando ofertas:', error);
        const container = document.getElementById('ofertasContainer') as HTMLDivElement;
        container.innerHTML = '<p class="loading-text" style="color: #dc2626;">Error al cargar las ofertas</p>';
      }
    }

    cargarOfertas();
  </script>

  <style>
    /* ====== ESTILOS TARJETAS IDÉNTICOS AL CATÁLOGO ====== */
    :global(.producto-card) {
      background: var(--bg-card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      position: relative;
      border: 1px solid var(--border-color);
    }

    :global(.producto-card:hover) {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    :global(.producto-oferta-badge) {
      position: absolute;
      top: 12px;
      left: 12px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 800;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    :global(.producto-img-container) {
      position: relative;
      padding-top: 80%;
      overflow: hidden;
      background: linear-gradient(145deg, #f8f5f0, #f0ebe3);
    }

    :global([data-theme="dark"] .producto-img-container) {
      background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
    }

    :global(.producto-img-link) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    :global(.producto-img) {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    :global(.producto-card:hover .producto-img) {
      transform: scale(1.08);
    }

    :global(.sin-imagen) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    :global(.producto-info) {
      padding: 16px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    :global(.producto-nombre-link) {
      text-decoration: none;
      color: inherit;
    }

    :global(.producto-nombre) {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 10px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.3s;
    }

    :global(.producto-nombre-link:hover .producto-nombre) {
      color: var(--color-accent);
    }

    :global(.producto-stock-row) {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    :global(.stock-info) {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    :global(.stock-label) {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    :global(.stock-label-oferta) {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
    }

    :global(.producto-footer) {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      gap: 10px;
    }

    :global(.producto-precio-wrap) {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    :global(.producto-precio) {
      font-size: 1.15rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    :global(.producto-precio-oferta) {
      color: #dc2626;
    }

    :global(.producto-precio-original) {
      text-decoration: line-through;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
    }

    :global(.product-btn) {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    :global(.btn-ver-oferta) {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    }

    :global(.product-btn:hover) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      :global(.producto-card) {
        border-radius: 14px;
      }
      
      :global(.producto-info) {
        padding: 12px;
      }
      
      :global(.producto-nombre) {
        font-size: 0.85rem;
        margin-bottom: 8px;
      }
      
      :global(.producto-stock-row) {
        margin-bottom: 8px;
      }
      
      :global(.stock-label) {
        display: none;
      }
      
      :global(.producto-footer) {
        padding-top: 10px;
      }
      
      :global(.producto-precio) {
        font-size: 1rem;
      }
      
      :global(.product-btn) {
        padding: 8px 12px;
        font-size: 0.65rem;
      }
      
      :global(.product-btn span) {
        display: none;
      }
      
      :global(.producto-oferta-badge) {
        top: 8px;
        left: 8px;
        padding: 4px 8px;
        font-size: 0.65rem;
      }
    }

    @media (max-width: 480px) {
      :global(.producto-info) {
        padding: 10px;
      }
      
      :global(.producto-nombre) {
        font-size: 0.8rem;
        -webkit-line-clamp: 2;
      }
      
      :global(.producto-precio) {
        font-size: 0.95rem;
      }
      
      :global(.producto-precio-original) {
        font-size: 0.7rem;
      }
    }
  </style>
</Layout>
