---
import Layout from '../../layouts/Layout.astro';

// Los productos se cargar√°n din√°micamente desde Supabase con JavaScript
---

<Layout>
  <!-- Hero Header del Cat√°logo -->
  <div class="catalog-hero">
    <span class="catalog-badge">PRODUCTOS IB√âRICOS</span>
    <h1 class="catalog-title">Nuestro Cat√°logo</h1>
    <p class="catalog-subtitle">Selecci√≥n premium de los mejores ib√©ricos, directos de la dehesa a tu mesa</p>
  </div>
  
  <style>
    /* ===== HERO DEL CAT√ÅLOGO ===== */
    .catalog-hero {
      text-align: center;
      padding: 2.5rem 1.5rem 3rem;
      margin-bottom: 2.5rem;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-radius: 0;
      position: relative;
      overflow: hidden;
    }

    .catalog-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
    }

    .catalog-badge {
      display: inline-block;
      color: #a89968;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 3px;
      padding: 8px 20px;
      background: rgba(168, 153, 104, 0.15);
      border: 1px solid rgba(168, 153, 104, 0.3);
      border-radius: 30px;
      margin-bottom: 1.25rem;
      position: relative;
    }

    .catalog-title {
      font-size: clamp(2rem, 6vw, 3.5rem);
      margin: 0 0 1rem 0;
      color: #fff;
      font-weight: 700;
      letter-spacing: -1px;
      line-height: 1.1;
      position: relative;
    }

    .catalog-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 1rem;
      max-width: 500px;
      margin: 0 auto;
      font-weight: 400;
      line-height: 1.6;
      position: relative;
    }

    @media (max-width: 768px) {
      .catalog-hero {
        padding: 2rem 1.25rem 2.5rem;
        margin-bottom: 2rem;
        border-radius: 20px;
      }
      .catalog-badge {
        font-size: 0.6rem;
        letter-spacing: 2px;
        padding: 6px 16px;
      }
      .catalog-subtitle {
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .catalog-hero {
        padding: 1.5rem 1rem 2rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
      }
      .catalog-badge {
        font-size: 0.55rem;
        padding: 5px 12px;
        margin-bottom: 1rem;
      }
      .catalog-title {
        margin-bottom: 0.75rem;
      }
      .catalog-subtitle {
        font-size: 0.85rem;
      }
    }
  </style>
  
  <!-- Barra de Filtros -->
  <div class="filters-bar">
    <div class="filters-container">
      <select id="filterCategoria" class="filter-select">
        <option value="">Todas las categor√≠as</option>
        <option value="jamones">Jamones</option>
        <option value="quesos">Quesos</option>
        <option value="embutidos">Embutidos</option>
        <option value="aceites">Aceites</option>
        <option value="conservas">Conservas</option>
      </select>

      <!-- NUEVA SECCI√ìN DE FILTRO DE PRECIO CON SLIDER -->
      <div class="filtro-precio-container">
        <div class="precio-header">
          <label class="precio-label">Rango de Precio</label>
          <div class="precio-values">
            <span class="precio-value" id="precioMinDisplay">0 ‚Ç¨</span>
            <span class="precio-separator">‚Äî</span>
            <span class="precio-value" id="precioMaxDisplay">1000 ‚Ç¨</span>
          </div>
        </div>
        
        <div class="slider-container">
          <!-- L√≠nea de track de fondo -->
          <div class="slider-track"></div>
          
          <!-- Sliders -->
          <input type="range" id="sliderPrecioMin" min="0" max="1000" value="0" class="price-slider" />
          <input type="range" id="sliderPrecioMax" min="0" max="1000" value="1000" class="price-slider" />
        </div>
      </div>

      <select id="filterOrden" class="filter-select">
        <option value="nombre">Ordenar por nombre</option>
        <option value="precio-asc">Precio: menor a mayor</option>
        <option value="precio-desc">Precio: mayor a menor</option>
        <option value="nuevo">M√°s recientes</option>
      </select>

      <button id="resetFilters" class="btn-reset-filters">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
          <path d="M21 3v5h-5"/>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
          <path d="M3 21v-5h5"/>
        </svg>
        Limpiar filtros
      </button>
    </div>
  </div>
  
  <!-- Grid de Productos -->
  <div id="productosGrid" class="productos-grid-container">
    <!-- Cargar√° con JavaScript -->
  </div>

  <!-- Modal para seleccionar variante -->
  <div id="varianteModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 id="varianteModalTitle" class="modal-title">Selecciona el Peso</h2>
        <button id="varianteModalClose" class="modal-close-btn" aria-label="Cerrar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="variantesList" class="variantes-list"></div>
    </div>
  </div>

  <!-- Modal para seleccionar cantidad -->
  <div id="cantidadModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">¬øCu√°ntas unidades?</h2>
        <button id="cantidadModalClose" class="modal-close-btn" aria-label="Cerrar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="cantidad-input-wrapper">
        <button type="button" class="cantidad-btn cantidad-minus" disabled>‚àí</button>
        <input type="number" id="cantidadInput" min="1" value="1" class="cantidad-input" readonly />
        <button type="button" class="cantidad-btn cantidad-plus">+</button>
      </div>
      <div class="modal-actions">
        <button id="cantidadConfirm" class="btn-modal-primary">
          Agregar al carrito
        </button>
        <button id="cantidadCancel" class="btn-modal-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <style>
    /* ===== FILTERS BAR ===== */
    .filters-bar {
      background: var(--bg-secondary);
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-light);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .filters-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.75rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      min-width: 180px;
    }

    .filter-select:hover {
      border-color: var(--color-accent);
      background: var(--bg-card);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(168, 153, 104, 0.1);
    }

    .filter-select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .btn-reset-filters {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }

    .btn-reset-filters:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
      background: var(--bg-tertiary);
    }

    /* ===== FILTER PRECIO SLIDER ===== */
    .filtro-precio-container {
      padding: 1rem 0;
      background: transparent;
      border-radius: 0;
      border: none;
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 100%;
      max-width: 350px;
    }

    .filtro-precio-container label {
      color: var(--text-primary) !important;
    }

    .filtro-precio-container span {
      color: var(--text-primary) !important;
    }

    .filtro-precio-container .precio-separator {
      color: var(--color-accent) !important;
    }

    .precio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .precio-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .precio-values {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .precio-value {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .precio-separator {
      color: var(--color-accent);
      font-weight: 400;
    }

    .slider-container {
      position: relative;
      width: 100%;
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 4px;
    }

    .slider-track {
      position: absolute;
      width: 100%;
      height: 2px;
      background: var(--border-color);
      border-radius: 1px;
      top: 50%;
      transform: translateY(-50%);
      left: 0;
    }

    .price-slider {
      position: absolute;
      width: 100%;
      height: 50px;
      outline: none;
      -webkit-appearance: none;
      pointer-events: auto;
      background: transparent;
      padding: 0;
      margin: 0;
      left: 0;
    }

    #sliderPrecioMin {
      z-index: 5;
    }

    #sliderPrecioMax {
      z-index: 6;
    }

    #sliderPrecioMin::-webkit-slider-thumb, #sliderPrecioMax::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a89968 0%, #8b7d52 100%);
      cursor: grab;
      border: 2px solid white;
      box-shadow: 0 3px 10px rgba(0, 26, 51, 0.25), inset 0 1px 2px rgba(255, 255, 255, 0.5);
      transition: all 0.2s ease;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-webkit-slider-thumb:hover, #sliderPrecioMax::-webkit-slider-thumb:hover {
      background: linear-gradient(135deg, #b8a978 0%, #9a8a62 100%);
      box-shadow: 0 4px 14px rgba(168, 153, 104, 0.35), inset 0 1px 2px rgba(255, 255, 255, 0.6);
      transform: translateY(-50%) scale(1.1);
    }

    #sliderPrecioMin::-webkit-slider-thumb:active, #sliderPrecioMax::-webkit-slider-thumb:active {
      cursor: grabbing;
      background: linear-gradient(135deg, #987d52 0%, #7a6d42 100%);
      box-shadow: 0 2px 8px rgba(0, 26, 51, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.4);
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-moz-range-thumb, #sliderPrecioMax::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a89968 0%, #8b7d52 100%);
      cursor: grab;
      border: 2px solid white;
      box-shadow: 0 3px 10px rgba(0, 26, 51, 0.25), inset 0 1px 2px rgba(255, 255, 255, 0.5);
      transition: all 0.2s ease;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-moz-range-thumb:hover, #sliderPrecioMax::-moz-range-thumb:hover {
      background: linear-gradient(135deg, #b8a978 0%, #9a8a62 100%);
      box-shadow: 0 4px 14px rgba(168, 153, 104, 0.35), inset 0 1px 2px rgba(255, 255, 255, 0.6);
      transform: translateY(-50%) scale(1.1);
    }

    #sliderPrecioMin::-moz-range-thumb:active, #sliderPrecioMax::-moz-range-thumb:active {
      cursor: grabbing;
      background: linear-gradient(135deg, #987d52 0%, #7a6d42 100%);
      box-shadow: 0 2px 8px rgba(0, 26, 51, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.4);
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-webkit-slider-runnable-track, #sliderPrecioMax::-webkit-slider-runnable-track {
      background: transparent;
      border: none;
      height: 50px;
    }

    #sliderPrecioMin::-moz-range-track, #sliderPrecioMax::-moz-range-track {
      background: transparent;
      border: none;
    }

    #sliderPrecioMin::-moz-focus-outer, #sliderPrecioMax::-moz-focus-outer {
      border: none;
    }

    @media (max-width: 1024px) {
      .filtro-precio-container {
        min-width: 100%;
        width: 100%;
        margin-bottom: 1rem;
      }

      .btn-reset-filters {
        margin-left: 0;
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .filters-container {
        padding: 0 1rem;
        gap: 0.75rem;
      }

      .filter-select {
        min-width: 140px;
        font-size: 0.85rem;
      }

      .btn-reset-filters {
        margin-left: 0;
        margin-top: 0.5rem;
        flex-basis: 100%;
        justify-content: center;
      }
    }

    /* ===== MODAL STYLES ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 26, 51, 0.6);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 0;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
      animation: modalSlideIn 0.3s ease-out;
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .modal-title {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 700;
      transition: color 0.3s ease;
    }

    .modal-close-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-close-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--color-accent);
    }

    .variantes-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1.25rem 1.5rem;
      max-height: 350px;
      overflow-y: auto;
      background: var(--bg-card);
    }

    :global(.variante-option) {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      padding: 14px 16px !important;
      background: var(--bg-tertiary) !important;
      border: 2px solid var(--border-color) !important;
      border-radius: 12px !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      width: 100% !important;
      font-family: Inter, sans-serif !important;
    }

    :global(.variante-option:hover) {
      border-color: var(--color-accent) !important;
      background: var(--bg-secondary) !important;
      transform: translateX(4px) !important;
      box-shadow: 0 4px 12px rgba(168, 153, 104, 0.2) !important;
    }

    :global(.variante-info) {
      display: flex !important;
      flex-direction: column !important;
      gap: 4px !important;
      text-align: left !important;
    }

    :global(.variante-peso) {
      font-size: 0.95rem !important;
      font-weight: 700 !important;
      color: var(--text-primary) !important;
    }

    :global(.variante-tipo) {
      font-size: 0.7rem !important;
      color: var(--text-muted) !important;
      text-transform: uppercase !important;
      letter-spacing: 0.3px !important;
      font-weight: 500 !important;
    }

    :global(.variante-precio-wrap) {
      display: flex !important;
      flex-direction: column !important;
      align-items: flex-end !important;
      gap: 2px !important;
    }

    :global(.variante-precio) {
      font-size: 1.2rem !important;
      font-weight: 800 !important;
      color: var(--color-accent) !important;
    }

    :global(.variante-arrow) {
      color: var(--color-accent) !important;
      margin-top: 2px;
    }

    .variante-empty {
      color: var(--text-muted);
      text-align: center;
      padding: 1rem;
    }

    /* ===== STOCK INFO & LABELS ===== */
    :global(.stock-info) {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 5px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    :global(.stock-info svg) {
      color: var(--color-accent);
    }

    :global(.stock-info.stock-agotado) {
      color: #999;
      background: #f5f5f5;
    }

    :global(.stock-info.stock-agotado svg) {
      color: #999;
    }

    :global(.stock-label) {
      display: inline-flex;
      align-items: center;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    :global(.stock-label-disponible) {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    :global(.stock-label-agotandose) {
      background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
      color: #92400e;
    }

    :global(.stock-label-ultima) {
      background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);
      color: #991b1b;
      animation: pulse-stock 2s ease-in-out infinite;
    }

    @keyframes pulse-stock {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ====== ESTILOS TARJETAS DE PRODUCTO ====== */
    :global(.producto-card) {
      background: var(--bg-card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      position: relative;
      border: 1px solid var(--border-color);
    }

    :global(.producto-card:hover) {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    :global(.producto-oferta-badge) {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 800;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    :global(.producto-img-container) {
      position: relative;
      padding-top: 80%;
      overflow: hidden;
      background: linear-gradient(145deg, #f8f5f0, #f0ebe3);
    }

    [data-theme="dark"] :global(.producto-img-container) {
      background: linear-gradient(145deg, #2a2a2a, #1f1f1f);
    }

    :global(.producto-img-link) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    :global(.producto-img) {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    :global(.producto-card:hover .producto-img) {
      transform: scale(1.08);
    }

    :global(.producto-agotado-overlay) {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    :global(.producto-agotado-text) {
      background: rgba(255,255,255,0.95);
      color: #1a1a1a;
      padding: 10px 24px;
      border-radius: 30px;
      font-weight: 800;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    :global(.producto-info) {
      padding: 16px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    :global(.producto-nombre-link) {
      text-decoration: none;
      color: inherit;
    }

    :global(.producto-nombre) {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.3s;
    }

    :global(.producto-nombre-link:hover .producto-nombre) {
      color: var(--color-accent);
    }

    :global(.producto-stock-row) {
      margin-bottom: 10px;
    }

    :global(.producto-footer) {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      padding-top: 8px;
      gap: 8px;
    }

    :global(.producto-precio-wrap) {
      display: flex;
      align-items: baseline;
      gap: 6px;
      flex-wrap: wrap;
    }

    :global(.producto-precio) {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    :global(.producto-precio-original) {
      text-decoration: line-through;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
    }

    :global(.producto-precio-oferta) {
      color: #dc2626;
    }

    :global(.product-btn) {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 10px;
      background: linear-gradient(135deg, #a89968 0%, #9a8a5c 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.65rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(168, 153, 104, 0.3);
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    :global(.product-btn:hover:not(:disabled)) {
      background: linear-gradient(135deg, #9a8a5c 0%, #8a7a4c 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(168, 153, 104, 0.4);
    }

    :global(.product-btn.btn-agotado) {
      background: #d0d0d0 !important;
      color: #888 !important;
      cursor: not-allowed;
      box-shadow: none !important;
    }

    [data-theme="dark"] :global(.product-btn.btn-agotado) {
      background: #404040 !important;
      color: #777 !important;
    }

    .cantidad-input-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      padding: 1.5rem;
      background: var(--bg-card);
    }

    .cantidad-btn {
      width: 48px;
      height: 48px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .cantidad-minus {
      border-radius: 8px 0 0 8px;
    }

    .cantidad-plus {
      border-radius: 0 8px 8px 0;
    }

    .cantidad-btn:hover {
      background: var(--color-accent);
      color: white;
      border-color: var(--color-accent);
    }

    .cantidad-input {
      width: 80px;
      height: 48px;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      border: 1px solid var(--border-color);
      border-left: none;
      border-right: none;
      color: var(--text-primary);
      background: var(--bg-card);
      transition: all 0.2s;
    }

    .cantidad-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0 1.5rem 1.5rem;
      background: var(--bg-card);
    }

    .btn-modal-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.9rem 1.5rem;
      background: linear-gradient(135deg, #a89968 0%, #9a8a5c 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(168, 153, 104, 0.3);
    }

    .btn-modal-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168, 153, 104, 0.4);
    }

    .btn-modal-secondary {
      width: 100%;
      padding: 0.75rem 1.5rem;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-modal-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--color-accent);
      color: var(--text-primary);
    }

    /* ===== GRID LAYOUT ===== */
    .productos-grid-container {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 24px;
      padding: 0;
      max-width: 100%;
    }

    @media (max-width: 1400px) {
      .productos-grid-container {
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
      }
    }

    @media (max-width: 1024px) {
      #productosGrid,
      .productos-grid-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 16px !important;
      }
    }

    @media (max-width: 640px) {
      #productosGrid,
      .productos-grid-container {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      #productosGrid article {
        border-radius: 16px !important;
      }
      
      #productosGrid article > div:last-child {
        padding: 14px !important;
      }
      
      #productosGrid article h3 {
        font-size: 0.9rem !important;
      }
      
      #productosGrid article button {
        padding: 10px 14px !important;
        font-size: 0.75rem !important;
        border-radius: 10px !important;
      }
      
      #productosGrid article button span {
        display: none !important;
      }

      /* Apilar precio y boton verticalmente en 640px */
      :global(.producto-footer) {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
      }

      :global(.producto-precio-wrap) {
        text-align: center !important;
        justify-content: center !important;
      }

      :global(.product-btn) {
        width: 100% !important;
        justify-content: center !important;
        text-align: center !important;
      }
    }

    @media (max-width: 480px) {
      #productosGrid,
      .productos-grid-container {
        gap: 10px !important;
      }
      
      #productosGrid article {
        border-radius: 14px !important;
      }
      
      #productosGrid article > div:last-child {
        padding: 12px !important;
        gap: 6px !important;
      }
      
      #productosGrid article h3 {
        font-size: 0.85rem !important;
        -webkit-line-clamp: 1 !important;
      }
      
      #productosGrid article button {
        padding: 10px 12px !important;
      }

      /* Apilar precio y boton verticalmente en 480px - usando clases */
      :global(.producto-footer) {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
        padding-top: 8px !important;
      }

      :global(.producto-precio-wrap) {
        justify-content: center !important;
        text-align: center !important;
        order: 1 !important;
        margin-bottom: 4px !important;
      }

      :global(.producto-precio) {
        font-size: 1.2rem !important;
      }

      :global(.product-btn) {
        order: 2 !important;
        width: 100% !important;
        text-align: center !important;
        justify-content: center !important;
        padding: 12px 14px !important;
        font-size: 0.75rem !important;
      }
    }
  </style>

  <script type="text/javascript">
    let variantesMap = {}; // Mapeo de producto_id -> variantes
    let productoEnModal = null; // Producto seleccionado para el modal
    let productosGlobal = []; // Array global de productos para acceso desde funciones invitado

    // Funci√≥n para renderizar productos en el grid
    function renderizarProductos(productos, variantesReservadas = []) {
      const grid = document.getElementById('productosGrid');
      
      if (productos.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;"><p style="opacity: 0.6; font-size: 1.1rem; margin: 0;">No hay productos disponibles</p></div>';
        return;
      }

      // Obtener variantes en el carrito local para filtrarlas
      const carritoLocal = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');

      // MOSTRAR todos los productos (no filtrar)
      // Los productos variables sin variantes disponibles se mostrar√°n como "Agotado"

      // Ordenar: productos disponibles primero, agotados al final
      const productosOrdenados = productos.sort((a, b) => {
        const todasLasVariantesA = variantesMap[a.id] || [];
        const variantesEnCarritoA = carritoLocal.filter(item => item.producto_id === a.id && item.producto_variante_id).map(item => parseInt(item.producto_variante_id));
        const variantesConStockA = todasLasVariantesA.filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0 && !variantesEnCarritoA.includes(parseInt(v.id)));
        const agotadoA = (!a.es_variable && a.stock <= 0) || (a.es_variable && variantesConStockA.length === 0);
        
        const todasLasVariantesB = variantesMap[b.id] || [];
        const variantesEnCarritoB = carritoLocal.filter(item => item.producto_id === b.id && item.producto_variante_id).map(item => parseInt(item.producto_variante_id));
        const variantesConStockB = todasLasVariantesB.filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0 && !variantesEnCarritoB.includes(parseInt(v.id)));
        const agotadoB = (!b.es_variable && b.stock <= 0) || (b.es_variable && variantesConStockB.length === 0);
        
        // Si uno est√° agotado y otro no, el disponible va primero
        if (agotadoA && !agotadoB) return 1;
        if (!agotadoA && agotadoB) return -1;
        return 0;
      });

      grid.innerHTML = productosOrdenados.map((p) => {
        const botonText = p.es_variable ? 'Seleccionar Peso' : 'A√±adir al Carrito';
        const botonClass = p.es_variable ? 'btn-seleccionar-variante' : 'btn-agregar-carrito';
        
        // Verificar si es producto variable y tiene variantes con stock disponible (filtrando las del carrito local)
        const todasLasVariantes = variantesMap[p.id] || [];
        const variantesEnCarrito = carritoLocal.filter(item => item.producto_id === p.id && item.producto_variante_id).map(item => parseInt(item.producto_variante_id));
        const variantesConStock = todasLasVariantes.filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0 && !variantesEnCarrito.includes(parseInt(v.id)));
        
        // El producto est√° agotado si: (no es variable y no tiene stock) O (es variable y no tiene variantes con stock)
        const productoAgotado = (!p.es_variable && p.stock <= 0) || (p.es_variable && variantesConStock.length === 0);
        
        // Calcular cantidad disponible (para productos variables cuenta las variantes, para normales el stock)
        const cantidadDisponible = p.es_variable ? variantesConStock.length : p.stock;
        
        // Determinar etiqueta de estado de stock
        let stockLabel = '';
        let stockLabelClass = '';
        if (!productoAgotado) {
          if (cantidadDisponible === 1) {
            stockLabel = '¬°√öLTIMA UNIDAD!';
            stockLabelClass = 'stock-label-ultima';
          } else if (cantidadDisponible <= 5) {
            stockLabel = 'Agot√°ndose';
            stockLabelClass = 'stock-label-agotandose';
          } else {
            stockLabel = 'Disponible';
            stockLabelClass = 'stock-label-disponible';
          }
        }
        
        // Texto de stock a mostrar
        const stockText = p.es_variable 
          ? `${variantesConStock.length} opci√≥n${variantesConStock.length !== 1 ? 'es' : ''}`
          : `${p.stock} unidad${p.stock !== 1 ? 'es' : ''}`;

        return `
          <article data-id="${p.id}" class="producto-card">
            ${p.tieneOferta ? `
              <div class="producto-oferta-badge">-${p.oferta.porcentaje_descuento}%</div>
            ` : ''}
            
            <div class="producto-img-container">
              <a href="/productos/${p.id}" class="producto-img-link">
                <img src="${p.imagen}" alt="${p.nombre}" loading="lazy" class="producto-img" />
              </a>
              ${productoAgotado ? `
                <div class="producto-agotado-overlay">
                  <span class="producto-agotado-text">Agotado</span>
                </div>
              ` : ''}
            </div>
            
            <div class="producto-info">
              <a href="/productos/${p.id}" class="producto-nombre-link">
                <h3 class="producto-nombre">${p.nombre}</h3>
              </a>
              
              <div class="producto-stock-row">
                <span class="stock-info ${productoAgotado ? 'stock-agotado' : ''}">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                  ${productoAgotado ? 'Agotado' : stockText}
                </span>
                ${!productoAgotado ? `<span class="stock-label ${stockLabelClass}">${stockLabel}</span>` : ''}
              </div>
              
              <div class="producto-footer">
                <div class="producto-precio-wrap">
                  ${p.tieneOferta ? `<span class="producto-precio-original">${p.precioOriginal}‚Ç¨</span>` : ''}
                  <span class="producto-precio ${p.tieneOferta ? 'producto-precio-oferta' : ''}">${p.precio}‚Ç¨</span>
                </div>
                
                <button 
                  class="${botonClass} product-btn ${productoAgotado ? 'btn-agotado' : ''}" 
                  data-id="${p.id}" 
                  ${productoAgotado ? 'disabled' : ''}
                >
                  ${productoAgotado ? `
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <circle cx="12" cy="12" r="10"/><path d="M8 8l8 8M16 8l-8 8"/>
                    </svg>
                    <span>Agotado</span>
                  ` : `
                    <span>${botonText}</span>
                  `}
                </button>
              </div>
            </div>
          </article>
        `;
      }).join('');

      // Agregar event listeners a los botones
      const botonesAgregar = document.querySelectorAll('.btn-agregar-carrito:not([disabled])');
      const botonesVariante = document.querySelectorAll('.btn-seleccionar-variante:not([disabled])');
      
      botonesAgregar.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const productoId = btn.getAttribute('data-id');
          abrirModalCantidad(productoId);
        });
      });

      botonesVariante.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const productoId = btn.getAttribute('data-id');
          
          // Actualizar variantes reservadas antes de abrir el modal
          console.log('üîÑ Actualizando variantes reservadas antes de abrir modal...');
          try {
            const reservadosResponse = await fetch('/api/productos/reservados');
            if (reservadosResponse.ok) {
              const data = await reservadosResponse.json();
              variantesReservadas = data.variantesReservadas || {};
              console.log('‚úÖ Variantes reservadas actualizadas:', variantesReservadas);
            }
          } catch (error) {
            console.error('‚ùå Error actualizando variantes reservadas:', error);
          }
          
          abrirModalVariantes(productoId, variantesReservadas);
        });
      });

      // Hover effects
      document.querySelectorAll('.product-image').forEach(img => {
        img.addEventListener('mouseover', () => img.style.transform = 'scale(1.08)');
        img.addEventListener('mouseout', () => img.style.transform = 'scale(1)');
      });

      document.querySelectorAll('.product-title').forEach(title => {
        title.addEventListener('mouseover', () => title.style.color = '#a89968');
        title.addEventListener('mouseout', () => title.style.color = '');
      });

      document.querySelectorAll('.product-btn').forEach(btn => {
        btn.addEventListener('mouseover', () => {
          btn.style.transform = 'translateY(-3px)';
          btn.style.boxShadow = '0 8px 20px rgba(168, 153, 104, 0.4)';
        });
        btn.addEventListener('mouseout', () => {
          btn.style.transform = 'translateY(0)';
          btn.style.boxShadow = '0 4px 12px rgba(168, 153, 104, 0.3)';
        });
      });
    }

    // Cargar productos desde Supabase
    async function cargarProductos() {
      console.log('üîÑ cargarProductos() ejecut√°ndose');
      try {
        // Primero obtener ofertas activas
        let ofertasMap = new Map(); // {producto_id -> oferta}
        try {
          const ofertasResponse = await fetch('/api/ofertas');
          const ofertasData = await ofertasResponse.json();
          if (ofertasData.success && ofertasData.data) {
            console.log('üìä Ofertas obtenidas:', ofertasData.data);
            ofertasData.data.forEach(oferta => {
              ofertasMap.set(oferta.producto_id, oferta);
              console.log('‚úÖ Oferta para producto ' + oferta.producto_id + ': ' + oferta.nombre_oferta + ' (' + oferta.porcentaje_descuento + '% descuento)');
            });
            console.log('üéâ Ofertas cargadas:', ofertasMap.size);
          }
        } catch (error) {
          console.error('‚ùå Error cargando ofertas:', error);
        }

        // Primero obtener items en el carrito
        const userId = localStorage.getItem('user_id');
        let productosEnCarrito = new Map(); // {producto_id -> [variante_ids]}
        
        if (userId) {
          try {
            const carritoResponse = await fetch('/api/carrito', {
              headers: { 'x-user-id': userId }
            });
            if (carritoResponse.ok) {
              const carritoData = await carritoResponse.json();
              if (carritoData.items && carritoData.items.length > 0) {
                carritoData.items.forEach(item => {
                  const key = item.producto_id;
                  if (!productosEnCarrito.has(key)) {
                    productosEnCarrito.set(key, []);
                  }
                  if (item.producto_variante_id) {
                    productosEnCarrito.get(key).push(item.producto_variante_id);
                  }
                });
                console.log('üõí Productos en carrito:', Array.from(productosEnCarrito.entries()));
              }
            }
          } catch (error) {
            console.error('‚ùå Error cargando carrito:', error);
          }
        }

        const response = await fetch('/api/productos/lista');
        console.log('üì° Response status:', response.status, response.ok);
        const data = await response.json();
        console.log('üì° Data recibida:', data);
        
        // Obtener variantes reservadas
        const reservadosResponse = await fetch('/api/productos/reservados');
        const { variantesReservadas: variantesReservFetch } = await reservadosResponse.json();
        variantesReservadas = variantesReservFetch;  // Asignar a la variable global
        console.log('üîí Variantes reservadas:', variantesReservadas);
        
        let productos = [];
        
        if (data.success && data.productos && data.productos.length > 0) {
          // Convertir productos de Supabase al formato esperado
          productos = data.productos.map((p) => {
            const oferta = ofertasMap.get(p.id);
            // Los precios en BD est√°n en centimos
            const precioCentimos = oferta ? oferta.precio_descuento_centimos : p.precio_centimos;
            const precioOriginalCentimos = p.precio_centimos;
            
            return {
              id: p.id,
              nombre: p.nombre,
              precio: (precioCentimos / 100).toFixed(2),  // Para mostrar en euros
              precioOriginal: (precioOriginalCentimos / 100).toFixed(2),  // Para mostrar en euros
              precio_centimos: precioCentimos,  // Para guardar en carrito
              tieneOferta: !!oferta,
              oferta: oferta,
              categoria: p.categorias?.nombre || 'desconocida',
              categorias: { nombre: p.categorias?.nombre || 'desconocida', slug: p.categorias?.slug || 'desconocida' },
              imagen: p.imagen_url || 'https://images.unsplash.com/photo-1557803104268-0ef0f060e15f?w=500&h=500&fit=crop',
              descripcion: p.descripcion || 'Sin descripci√≥n',
              rating: p.rating || 4.8,
              es_variable: p.es_variable || false,
              precio_por_kg: p.precio_por_kg || null,
              stock: p.stock ?? 0  // Agregar stock
            };
          });

          // Cargar variantes para productos variables
          console.log('üì¶ Total de productos:', productos.length);
          console.log('üì¶ Productos variables:', productos.filter(p => p.es_variable).length);
          
          // Asignar a la variable global para que sea accesible desde funciones invitado
          productosGlobal = productos;
          console.log('‚úÖ productosGlobal asignado:', productosGlobal.length, 'productos');
          
          for (const producto of productos) {
            if (producto.es_variable) {
              console.log('‚è≥ Cargando variantes para producto:', producto.id, producto.nombre);
              try {
                await cargarVariantesProducto(producto.id);
                const cargsadas = variantesMap[producto.id] || [];
                const disponibles = cargsadas.filter(v => v.disponible);
                console.log('‚úÖ Variantes cargadas para producto ' + producto.id + ': total=' + cargsadas.length + ', disponibles=' + disponibles.length);
                cargsadas.forEach(v => {
                  console.log(`   - Variante ${v.id}: peso=${v.peso_kg}, disponible=${v.disponible}`);
                });
              } catch (error) {
                console.error('‚ùå Error cargando variantes para producto:', producto.id, error);
              }
            }
          }
          console.log('‚úÖ Todas las variantes cargadas, re-renderizando grid...');
        }

        // Guardar los productos originales para filtros
        productosOriginales = [...productos];
        productosCompleto = [...productos];
        
        // Inicializar sliders de precio AQU√ç, despu√©s de cargar productos
        const sliderPrecioMin = document.getElementById('sliderPrecioMin');
        const sliderPrecioMax = document.getElementById('sliderPrecioMax');
        const precioMinDisplay = document.getElementById('precioMinDisplay');
        const precioMaxDisplay = document.getElementById('precioMaxDisplay');
        
        const preciosProductos = productosCompleto.map(p => parseFloat(p.precio)).sort((a, b) => a - b);
        const precioMaxReal = Math.ceil(preciosProductos[preciosProductos.length - 1]) || 1000;
        
        console.log('Precios encontrados:', preciosProductos);
        console.log('Precio m√°ximo real:', precioMaxReal);
        
        sliderPrecioMin.value = 0;
        sliderPrecioMax.value = precioMaxReal;
        sliderPrecioMin.max = precioMaxReal;
        sliderPrecioMax.max = precioMaxReal;
        precioMinDisplay.textContent = `0 ‚Ç¨`;
        precioMaxDisplay.textContent = `${precioMaxReal} ‚Ç¨`;
        
        // Renderizar los productos
        renderizarProductos(productos, variantesReservadas);

      } catch (error) {
        console.error('Error cargando productos:', error);
        const grid = document.getElementById('productosGrid');
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;"><p style="color: #999;">Error al cargar los productos</p></div>';
      }
    }

    async function cargarVariantesProducto(productoId) {
      try {
        console.log(`üîÑ Iniciando fetch de variantes para producto ${productoId}`);
        const response = await fetch(`/api/variantes/${productoId}`);
        console.log(`üì° Response status: ${response.status}`);
        
        const data = await response.json();
        console.log(`üì¶ Data recibida:`, data);
        
        if (data.success && data.variantes) {
          console.log('‚úÖ Variantes cargadas para producto:', productoId, data.variantes);
          console.log('   - Total: ' + data.variantes.length);
          console.log('   - Disponibles (disponible=true): ' + data.variantes.filter(v => v.disponible === true).length);
          data.variantes.forEach(v => {
            console.log('     ‚Ä¢ Variante ' + v.id + ': peso=' + v.peso_kg + 'kg, disponible=' + v.disponible);
          });
          variantesMap[productoId] = data.variantes;
          console.log('‚úÖ variantesMap[' + productoId + '] actualizado. Total en map:', Object.keys(variantesMap).length);
        } else {
          console.warn('‚ö†Ô∏è Respuesta sin success o sin variantes:', data);
          variantesMap[productoId] = [];
        }
      } catch (error) {
        console.error('‚ùå Error cargando variantes del producto ' + productoId + ':', error);
        variantesMap[productoId] = [];
      }
    }

    function abrirModalVariantes(productoId, variantesReservadas = {}) {
      const producto = document.querySelector("article[data-id='" + productoId + "'] .product-name")?.textContent || 'Producto';
      
      // Obtener variantes que tengan stock disponible
      let variantes = (variantesMap[productoId] || []).filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0);
      
      console.log('Abriendo modal para producto:' + productoId);
      console.log('Variantes con stock:', variantes);
      console.log('Variantes reservadas pasadas al modal:', variantesReservadas);
      
      // Filtrar variantes reservadas del servidor
      const variantesReservadasDelProducto = (variantesReservadas && variantesReservadas[productoId]) ? variantesReservadas[productoId] : [];
      variantes = variantes.filter(v => !variantesReservadasDelProducto.includes(parseInt(v.id)));
      
      // Tambi√©n filtrar las variantes que ya est√°n en el carrito local del invitado
      const carritoLocal = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
      const variantesEnCarritoLocal = carritoLocal
        .filter(item => item.producto_id === parseInt(productoId) && item.producto_variante_id)
        .map(item => parseInt(item.producto_variante_id));
      variantes = variantes.filter(v => (v.cantidad_disponible || 0) > 0 && !variantesEnCarritoLocal.includes(parseInt(v.id)));
      
      console.log('Variantes disponibles despu√©s de filtrar reservadas y carrito local:', variantes.length);
      console.log('Variantes reservadas del producto:', variantesReservadasDelProducto);
      console.log('Variantes en carrito local:', variantesEnCarritoLocal);
      
      const modal = document.getElementById('varianteModal');
      const title = document.getElementById('varianteModalTitle');
      const variantesList = document.getElementById('variantesList');

      title.textContent = producto + ' - Selecciona el Peso';

      if (variantes.length === 0) {
        variantesList.innerHTML = '<p class="variante-empty">No hay variantes disponibles en este momento</p>';
      } else {
        // Mostrar solo las variantes disponibles con el nuevo dise√±o
        variantesList.innerHTML = '';
        
        variantes.forEach((v, index) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'variante-option';
          btn.setAttribute('data-variante-id', v.id);
          btn.setAttribute('data-producto-id', productoId);
          btn.setAttribute('data-peso', v.peso_kg);
          btn.setAttribute('data-precio', v.precio_total);
          btn.setAttribute('data-cantidad', v.cantidad_disponible);
          
          const peso = v.peso_kg.toFixed(3);
          const precioEnEuros = (v.precio_total / 100).toFixed(2);
          
          btn.innerHTML = '<div class="variante-info"><span class="variante-peso">' + peso + ' kg</span><span class="variante-tipo">Pieza √∫nica</span></div><div class="variante-precio-wrap"><span class="variante-precio">' + precioEnEuros + '‚Ç¨</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="variante-arrow"><polyline points="9 18 15 12 9 6"></polyline></svg></div>';
          
          btn.addEventListener('click', async () => {
            const varianteId = btn.getAttribute('data-variante-id');
            const productoIdBtn = btn.getAttribute('data-producto-id');
            const peso = parseFloat(btn.getAttribute('data-peso'));
            await agregarAlCarritoConVariante(productoIdBtn, varianteId, peso);
            cerrarModalVariantes();
          });
          
          variantesList.appendChild(btn);
        });
      }

      modal.style.display = 'flex';
    }

    function cerrarModalVariantes() {
      document.getElementById('varianteModal').style.display = 'none';
    }

    // Funci√≥n para actualizar el estado visual del producto en la tarjeta
    function actualizarEstadoProducto(productoId, variantesDisponibles) {
      console.log(`üîç Buscando tarjeta para producto ${productoId}...`);
      const card = document.querySelector(`.producto-card[data-id="${productoId}"]`) || 
                   document.querySelector(`article[data-id="${productoId}"]`);
      if (!card) {
        console.log(`‚ùå No se encontr√≥ tarjeta para producto ${productoId}`);
        return;
      }
      console.log(`‚úÖ Tarjeta encontrada para producto ${productoId}`);
      
      console.log(`üìä Actualizando estado producto ${productoId}: ${variantesDisponibles} variantes disponibles`);
      
      // Encontrar elementos a actualizar
      const stockInfo = card.querySelector('.stock-info');
      const stockLabel = card.querySelector('.stock-label');
      const imgContainer = card.querySelector('.producto-img-container');
      const button = card.querySelector('.product-btn');
      
      if (variantesDisponibles === 0) {
        // PRODUCTO AGOTADO
        console.log('üö´ Producto agotado - actualizando UI');
        
        // Actualizar stock-info
        if (stockInfo) {
          stockInfo.classList.add('stock-agotado');
          stockInfo.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            Agotado
          `;
        }
        
        // Eliminar stock-label
        if (stockLabel) {
          stockLabel.remove();
        }
        
        // A√±adir overlay de agotado en el contenedor de imagen
        if (imgContainer) {
          const existingOverlay = imgContainer.querySelector('.producto-agotado-overlay');
          if (!existingOverlay) {
            const overlay = document.createElement('div');
            overlay.className = 'producto-agotado-overlay';
            overlay.innerHTML = `<span class="producto-agotado-text">Agotado</span>`;
            imgContainer.appendChild(overlay);
            console.log('‚úÖ Overlay de agotado a√±adido');
          }
        }
        
        // Deshabilitar bot√≥n y cambiar su contenido
        if (button) {
          button.disabled = true;
          button.classList.add('btn-agotado');
          button.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <circle cx="12" cy="12" r="10"/><path d="M8 8l8 8M16 8l-8 8"/>
            </svg>
            <span>Agotado</span>
          `;
          console.log('‚úÖ Bot√≥n actualizado a Agotado');
        }
      } else {
        // PRODUCTO CON STOCK - actualizar cantidad
        console.log(`‚úÖ Producto con ${variantesDisponibles} variantes disponibles`);
        
        // Actualizar texto de stock-info
        if (stockInfo) {
          stockInfo.classList.remove('stock-agotado');
          stockInfo.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            ${variantesDisponibles} opci√≥n${variantesDisponibles !== 1 ? 'es' : ''}
          `;
        }
        
        // Actualizar stock-label
        let newLabel = '';
        let newLabelClass = '';
        if (variantesDisponibles === 1) {
          newLabel = '¬°√öLTIMA UNIDAD!';
          newLabelClass = 'stock-label stock-label-ultima';
        } else if (variantesDisponibles <= 5) {
          newLabel = 'Agot√°ndose';
          newLabelClass = 'stock-label stock-label-agotandose';
        } else {
          newLabel = 'Disponible';
          newLabelClass = 'stock-label stock-label-disponible';
        }
        
        if (stockLabel) {
          stockLabel.textContent = newLabel;
          stockLabel.className = newLabelClass;
        } else if (stockInfo && stockInfo.parentElement) {
          const newSpan = document.createElement('span');
          newSpan.className = newLabelClass;
          newSpan.textContent = newLabel;
          stockInfo.parentElement.appendChild(newSpan);
        }
        
        // Remover overlay si existe
        if (imgContainer) {
          const existingOverlay = imgContainer.querySelector('.producto-agotado-overlay');
          if (existingOverlay) {
            existingOverlay.remove();
          }
        }
        
        // Habilitar bot√≥n
        if (button) {
          button.disabled = false;
          button.classList.remove('btn-agotado');
        }
      }
    }

    async function agregarAlCarritoConVariante(productoId, varianteId, peso) {
      try {
        console.log('üõí agregarAlCarritoConVariante llamada con:', { productoId, varianteId, peso });
        const userId = localStorage.getItem('user_id');
        console.log('üë§ User ID:', userId);
        
        // Si es invitado, guardar en localStorage
        if (!userId) {
          console.log('üëª Invitado detectado - guardando en localStorage');
          await agregarAlCarritoLocal(productoId, varianteId, peso);
          return;
        }

        // Si est√° logueado, usar API del servidor
        const response = await fetch('/api/carrito', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            producto_id: parseInt(productoId), 
            cantidad: 1,
            user_id: userId,
            producto_variante_id: parseInt(varianteId),
            peso_kg: peso
          })
        });

        console.log('üì° Respuesta del API:', { status: response.status, ok: response.ok });

        if (!response.ok) {
          if (response.status === 401) {
            console.log('‚ùå No autorizado');
            mostrarNotificacion('Por favor, inicia sesi√≥n para agregar productos al carrito', 'info');
            setTimeout(() => {
              window.location.href = '/login';
            }, 1500);
            return;
          }
          const errorData = await response.json();
          const mensajeError = errorData.error || 'Error agregando al carrito';
          console.log('‚ùå Error:', mensajeError);
          mostrarNotificacion(mensajeError, 'error');
          return;
        }

        const result = await response.json();
        console.log('‚úÖ Resultado del API:', result);
        if (result.success) {
          console.log('‚úÖ Producto agregado exitosamente');
          mostrarNotificacion(`Jam√≥n de ${peso.toFixed(3)} kg agregado al carrito`, 'exito');
          
          // Recargar variantes para actualizar la UI
          const variantesRes = await fetch(`/api/variantes/obtener-disponibles?producto_id=${productoId}`);
          const variantesData = await variantesRes.json();
          if (variantesData.success) {
            variantesMap[parseInt(productoId)] = variantesData.variantes;
            actualizarEstadoProducto(parseInt(productoId), variantesData.variantes.length);
          }
          
          // Disparar evento para actualizar stock en tiempo real
          window.dispatchEvent(new CustomEvent('carritoActualizado'));
        }
      } catch (error) {
        console.error('‚ùå Error en agregarAlCarritoConVariante:', error);
        mostrarNotificacion('Error al agregar el producto al carrito', 'error');
      }
    }

    // Agregar al carrito local para invitados
    async function agregarAlCarritoLocal(productoId, varianteId, peso) {
      try {
        // Buscar el producto en el array global
        const producto = productosGlobal.find(p => p.id === parseInt(productoId));
        if (!producto) {
          mostrarNotificacion('Error: Producto no encontrado', 'error');
          return;
        }

        // Buscar la variante
        const variantes = variantesMap[parseInt(productoId)] || [];
        const variante = variantes.find(v => v.id === parseInt(varianteId));
        if (!variante) {
          mostrarNotificacion('Error: Variante no encontrada', 'error');
          return;
        }

        // Reservar stock en la base de datos (para invitados)
        const reservaRes = await fetch('/api/carrito/reservar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: parseInt(productoId),
            producto_variante_id: parseInt(varianteId),
            cantidad: 1
          })
        });

        const reservaData = await reservaRes.json();
        if (!reservaData.success) {
          console.error('‚ùå Error reservando stock:', reservaData.error);
          mostrarNotificacion(reservaData.error || 'Error al reservar stock', 'error');
          return;
        }
        console.log('‚úÖ Stock reservado:', reservaData);

        // Obtener carrito actual de localStorage
        let carrito = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');

        // Convertir precio a centimos si es necesario
        // Si precio < 1000, est√° en euros ‚Üí multiplicar por 100
        // Si precio >= 1000, ya est√° en centimos ‚Üí usar tal cual
        let precioCentimos = variante.precio_total;
        if (precioCentimos < 1000) {
          precioCentimos = Math.round(precioCentimos * 100);
        }
        
        console.log('üí∞ Precio guardado:', {
          precio_original: variante.precio_total,
          precio_centimos: precioCentimos,
          en_carrito_mostrara: (precioCentimos / 100).toFixed(2) + '‚Ç¨'
        });

        // Crear item
        const item = {
          id: Date.now(),
          producto_id: parseInt(productoId),
          producto_variante_id: parseInt(varianteId),
          nombre: producto.nombre,
          precio_unitario: precioCentimos,
          cantidad: 1,
          peso_kg: peso,
          imagen: producto.imagen,
          fecha_agregado: new Date().toISOString()
        };

        // Verificar si ya existe
        const existe = carrito.find(c => c.producto_variante_id === parseInt(varianteId));
        if (existe) {
          existe.cantidad += 1;
          mostrarNotificacion(`Jam√≥n actualizado en carrito (${existe.cantidad}x)`, 'exito');
        } else {
          carrito.push(item);
          mostrarNotificacion(`Jam√≥n de ${peso.toFixed(3)} kg agregado al carrito`, 'exito');
        }

        // Guardar en localStorage
        localStorage.setItem('carrito_invitado', JSON.stringify(carrito));
        // Guardar/actualizar fecha de expiraci√≥n (se resetea cada vez que se a√±ade)
        localStorage.setItem('carrito_invitado_fecha', String(Date.now()));
        console.log('‚úÖ Carrito invitado actualizado:', carrito.length, 'items');
        
        // Recargar variantes desde el servidor para actualizar el mapa
        console.log('üîÑ Recargando variantes...');
        const variantesRes = await fetch(`/api/variantes/obtener-disponibles?producto_id=${productoId}`);
        const variantesData = await variantesRes.json();
        if (variantesData.success) {
          // Actualizar el mapa de variantes
          variantesMap[parseInt(productoId)] = variantesData.variantes;
          console.log('‚úÖ Variantes del servidor:', variantesData.variantes.length);
          console.log('üìã Detalle variantes:', variantesData.variantes.map(v => ({
            id: v.id,
            disponible: v.disponible,
            cantidad: v.cantidad_disponible
          })));
          
          // Filtrar las variantes que ya est√°n en el carrito local
          // IMPORTANTE: Leer el carrito ACTUALIZADO (ya incluye la variante reci√©n a√±adida)
          const carritoLocalActualizado = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
          const variantesEnCarrito = carritoLocalActualizado
            .filter(item => item.producto_id === parseInt(productoId) && item.producto_variante_id)
            .map(item => parseInt(item.producto_variante_id)); // Asegurar que son n√∫meros
          
          // Asegurarse de que la variante reci√©n a√±adida est√© en la lista
          const varianteRecienAnadida = parseInt(varianteId);
          if (!variantesEnCarrito.includes(varianteRecienAnadida)) {
            variantesEnCarrito.push(varianteRecienAnadida);
          }
          console.log('üõí Variantes en carrito local (incluyendo reci√©n a√±adida):', variantesEnCarrito);
          
          // Filtrar variantes que est√©n disponibles Y no est√©n en el carrito
          const variantesRealmenteDisponibles = variantesData.variantes.filter(v => {
            const varianteIdNum = parseInt(v.id);
            const estaDisponible = v.disponible === true;
            const tieneStock = (v.cantidad_disponible || 0) > 0;
            const estaEnCarrito = variantesEnCarrito.includes(varianteIdNum);
            console.log(`  Variante ${varianteIdNum}: disponible=${estaDisponible}, stock=${v.cantidad_disponible}, enCarrito=${estaEnCarrito}`);
            // NO incluir si: no est√° disponible, no tiene stock, O ya est√° en el carrito
            return estaDisponible && tieneStock && !estaEnCarrito;
          });
          console.log('‚úÖ Variantes realmente disponibles:', variantesRealmenteDisponibles.length);
          
          // Actualizar la UI de la tarjeta del producto
          actualizarEstadoProducto(parseInt(productoId), variantesRealmenteDisponibles.length);
        }
        
        // Actualizar cantidad disponible de la variante (antes de cerrar modal)
        if (variante && typeof variante.cantidad_disponible === 'number') {
          variante.cantidad_disponible -= 1;
          console.log('üìâ Variante ' + varianteId + ' ahora tiene ' + variante.cantidad_disponible + ' unidades disponibles');
        }
        
        // Siempre cerrar el modal despu√©s de a√±adir
        cerrarModalVariantes();
        
        // Disparar evento para actualizar stock en tiempo real
        window.dispatchEvent(new CustomEvent('carritoActualizado'));
      } catch (error) {
        console.error('‚ùå Error en agregarAlCarritoLocal:', error);
        mostrarNotificacion('Error al agregar al carrito local', 'error');
      }
    }

    // Sistema de notificaciones toast
    function mostrarNotificacion(mensaje, tipo = 'exito') {
      const container = document.getElementById('notificacionesContainer') || crearContainerNotificaciones();
      
      const notif = document.createElement('div');
      notif.style.cssText = `
        background: ${tipo === 'exito' ? '#a89968' : tipo === 'error' ? '#f5576c' : '#001a33'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-weight: 500;
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      `;

      // Icono seg√∫n tipo
      let icono = '';
      if (tipo === 'exito') {
        icono = '‚úì';
      } else if (tipo === 'error') {
        icono = '‚úï';
      }

      notif.innerHTML = `
        <span style="font-size: 1.2rem; font-weight: bold;">${icono}</span>
        <span>${mensaje}</span>
      `;

      container.appendChild(notif);

      // Auto-eliminar despu√©s de 3 segundos
      setTimeout(() => {
        notif.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    function crearContainerNotificaciones() {
      const container = document.createElement('div');
      container.id = 'notificacionesContainer';
      container.style.cssText = `
        position: fixed;
        top: 80px;
        right: 2rem;
        z-index: 1000;
        max-width: 400px;
        pointer-events: none;
      `;
      document.body.appendChild(container);

      // Agregar estilos de animaci√≥n
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateX(400px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
        @keyframes slideOut {
          from {
            opacity: 1;
            transform: translateX(0);
          }
          to {
            opacity: 0;
            transform: translateX(400px);
          }
        }
        #notificacionesContainer > div {
          pointer-events: auto;
        }
      `;
      document.head.appendChild(style);

      return container;
    }

    async function agregarAlCarrito(productoId, cantidad = 1, cortado = false) {
      try {
        console.log('üõí agregarAlCarrito llamada con:', { productoId, cantidad, cortado });
        // Obtener user_id del localStorage
        const userId = localStorage.getItem('user_id');
        console.log('üë§ User ID:', userId);
        
        // Guardar stock anterior para revertir en caso de error
        const productoEnGrilla = productosGlobal.find(p => p.id === parseInt(productoId));
        const stockAnterior = productoEnGrilla?.stock || 0;
        
        // Si es invitado, guardar en localStorage
        if (!userId) {
          console.log('üëª Invitado detectado - guardando en localStorage');
          agregarAlCarritoLocalSimple(productoId, cantidad, cortado);
          return;
        }

        // ACTUALIZACI√ìN OPTIMISTA: Actualizar stock inmediatamente en la UI
        if (productoEnGrilla) {
          const nuevoStock = Math.max(0, stockAnterior - cantidad);
          productoEnGrilla.stock = nuevoStock;
          actualizarStockVisualEnGrilla(parseInt(productoId), nuevoStock);
          console.log(`‚úÖ Stock actualizado localmente: ${stockAnterior} ‚Üí ${nuevoStock}`);
        }

        // Si est√° logueado, usar API del servidor
        const response = await fetch('/api/carrito', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            producto_id: parseInt(productoId), 
            cantidad,
            user_id: userId,
            cortado: cortado
          })
        });

        console.log('üì° Respuesta del API:', { status: response.status, ok: response.ok });

        if (!response.ok) {
          if (response.status === 401) {
            console.log('‚ùå No autorizado, redirigiendo a login');
            mostrarNotificacion('Por favor, inicia sesi√≥n para agregar productos al carrito', 'info');
            setTimeout(() => {
              window.location.href = '/login';
            }, 1500);
            return;
          }
          throw new Error('Error agregando al carrito');
        }

        const result = await response.json();
        console.log('‚úÖ Resultado del API:', result);
        if (result.success) {
          console.log('‚úÖ Producto agregado exitosamente');
          
          // Usar el stock que devuelve la BD (es la fuente de verdad)
          if (result.stockRestante !== null && result.stockRestante !== undefined && productoEnGrilla) {
            productoEnGrilla.stock = result.stockRestante;
            actualizarStockVisualEnGrilla(parseInt(productoId), result.stockRestante);
            console.log(`üìä Stock sincronizado desde BD: ${result.stockRestante}`);
          }
          
          const msg = cortado ? 'Producto agregado al carrito (cortado)' : 'Producto agregado al carrito';
          mostrarNotificacion(msg, 'exito');
          // Disparar evento para actualizar stock en tiempo real
          window.dispatchEvent(new CustomEvent('carritoActualizado'));
        } else {
          // Revertir cambio en caso de error
          if (productoEnGrilla) {
            productoEnGrilla.stock = stockAnterior;
            actualizarStockVisualEnGrilla(parseInt(productoId), stockAnterior);
            console.log(`‚ö†Ô∏è Stock revertido: ${stockAnterior}`);
          }
          mostrarNotificacion('Error: ' + (result.error || 'No se pudo agregar al carrito'), 'error');
        }
      } catch (error) {
        console.error('‚ùå Error en agregarAlCarrito:', error);
        // Revertir cambio en caso de error
        const productoEnGrilla = productosGlobal.find(p => p.id === parseInt(productoId));
        if (productoEnGrilla) {
          const stockAnterior = parseInt(document.querySelector(`article[data-id="${productoId}"] .stock-info`)?.textContent?.match(/\d+/) || 0) + cantidad;
          productoEnGrilla.stock = stockAnterior;
          actualizarStockVisualEnGrilla(parseInt(productoId), stockAnterior);
        }
        mostrarNotificacion('Error al agregar el producto al carrito', 'error');
      }
    }

    // Funci√≥n para actualizar stock visual en la grilla
    function actualizarStockVisualEnGrilla(productoId, nuevoStock) {
      const article = document.querySelector(`article[data-id="${productoId}"]`);
      if (!article) {
        console.log('‚ùå No se encontr√≥ art√≠culo con ID:', productoId);
        return;
      }

      const stockSpan = article.querySelector('.stock-info');
      if (!stockSpan) {
        console.log('‚ùå No se encontr√≥ .stock-info en art√≠culo:', productoId);
        return;
      }

      console.log(`‚úÖ Actualizando stock visual de producto ${productoId} a ${nuevoStock} unidades`);
      
      if (nuevoStock <= 0) {
        stockSpan.innerHTML = `
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
          </svg>
          Agotado
        `;
        stockSpan.classList.add('stock-agotado');
      } else {
        stockSpan.classList.remove('stock-agotado');
        stockSpan.innerHTML = `
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
          </svg>
          ${nuevoStock} unidad${nuevoStock !== 1 ? 'es' : ''}
        `;
      }
    }

    // Agregar al carrito local para invitados (productos simples sin variantes)
    async function agregarAlCarritoLocalSimple(productoId, cantidad = 1, cortado = false) {
      try {
        // Buscar el producto en el array de productos cargados
        const producto = productosGlobal.find(p => p.id === parseInt(productoId));
        
        if (!producto) {
          mostrarNotificacion('Error: Producto no encontrado', 'error');
          return;
        }

        // Validar stock antes de intentar
        if (!producto.es_variable && producto.stock <= 0) {
          mostrarNotificacion('Este producto est√° agotado', 'error');
          return;
        }

        // Reservar stock en la base de datos (para invitados) - ESPERAR respuesta
        const reservaRes = await fetch('/api/carrito/reservar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: parseInt(productoId),
            cantidad: cantidad
          })
        });
        const reservaData = await reservaRes.json();
        
        if (!reservaData.success) {
          console.error('‚ùå Error reservando stock:', reservaData.error);
          mostrarNotificacion(reservaData.error || 'No hay suficiente stock disponible', 'error');
          return;
        }

        // Obtener carrito actual de localStorage
        let carrito = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');

        // Usar precio en centimos
        let precioUnitario = producto.precio_centimos;

        // Crear item
        const item = {
          id: Date.now(),
          producto_id: parseInt(productoId),
          nombre: producto.nombre,
          precio_unitario: precioUnitario,
          cantidad,
          imagen: producto.imagen,
          fecha_agregado: new Date().toISOString()
        };

        // Verificar si ya existe
        const existe = carrito.find(c => c.producto_id === parseInt(productoId) && !c.producto_variante_id);
        if (existe) {
          existe.cantidad += cantidad;
          mostrarNotificacion(`Producto actualizado en carrito (${existe.cantidad}x)`, 'exito');
        } else {
          carrito.push(item);
          mostrarNotificacion('Producto agregado al carrito', 'exito');
        }

        // Guardar en localStorage
        localStorage.setItem('carrito_invitado', JSON.stringify(carrito));
        localStorage.setItem('carrito_invitado_fecha', String(Date.now()));
        
        // Actualizar stock local en productosGlobal (con validaci√≥n)
        if (typeof producto.stock === 'number') {
          producto.stock -= cantidad;
        }
        
        // Actualizar stock en el DOM inmediatamente
        const article = document.querySelector(`article[data-id="${productoId}"]`);
        if (article) {
          // Actualizar elemento de stock
          const stockElements = article.querySelectorAll('span');
          for (let elem of stockElements) {
            const html = elem.innerHTML;
            if (html.includes('unidad') || html.includes('Agotado')) {
              const nuevoStock = Math.max(0, producto.stock);
              const stockText = `${nuevoStock} unidad${nuevoStock !== 1 ? 'es' : ''}`;
              const stockDisplay = producto.stock <= 0 ? 'Agotado' : stockText;
              const svg = elem.querySelector('svg');
              elem.innerHTML = `
                ${svg ? svg.outerHTML : ''}
                ${stockDisplay}
              `;
              console.log('‚úÖ Stock actualizado en DOM para producto ' + productoId + ': ' + stockDisplay);
              break;
            }
          }
          
          // Actualizar bot√≥n si el stock se agot√≥
          if (producto.stock <= 0) {
            const button = article.querySelector('button[class*="btn-"]');
            if (button) {
              button.disabled = true;
              button.style.background = '#d0d0d0';
              button.style.color = '#888';
              button.style.cursor = 'not-allowed';
              button.textContent = '‚úñ Agotado';
            }
          }
        }
        
        // Disparar evento para actualizar contador
        window.dispatchEvent(new CustomEvent('carritoActualizado'));
      } catch (error) {
        console.error('‚ùå Error en agregarAlCarritoLocalSimple:', error);
        mostrarNotificacion('Error al agregar al carrito local', 'error');
      }
    }

    // Funciones para modal de cantidad
    let productoIdParaCarrito = null; // Almacena el producto_id mientras el modal est√° abierto
    let stockMaximoModal = 99; // Stock m√°ximo del producto seleccionado

    function abrirModalCantidad(productoId) {
      productoIdParaCarrito = productoId;
      const modal = document.getElementById('cantidadModal');
      const input = document.getElementById('cantidadInput');
      const btnMenos = document.querySelector('.cantidad-minus');
      const btnMas = document.querySelector('.cantidad-plus');
      
      // Obtener stock del producto
      const producto = productosGlobal.find(p => p.id === parseInt(productoId));
      stockMaximoModal = producto?.stock ?? 0;
      
      // No abrir el modal si no hay stock
      if (stockMaximoModal <= 0) {
        mostrarNotificacion('Este producto est√° agotado', 'error');
        return;
      }
      
      input.value = '1';
      input.max = stockMaximoModal;
      if (btnMenos) btnMenos.disabled = true;
      if (btnMas) btnMas.disabled = stockMaximoModal <= 1;

      
      modal.style.display = 'flex';
    }

    function actualizarBotonesModal() {
      const input = document.getElementById('cantidadInput');
      const valor = parseInt(input.value) || 1;
      const btnMenos = document.querySelector('.cantidad-minus');
      const btnMas = document.querySelector('.cantidad-plus');
      if (btnMenos) btnMenos.disabled = valor <= 1;
      if (btnMas) btnMas.disabled = valor >= stockMaximoModal;
    }

    function cerrarModalCantidad() {
      const modal = document.getElementById('cantidadModal');
      modal.style.display = 'none';
      productoIdParaCarrito = null;
    }

    async function confirmarCantidad() {
      const input = document.getElementById('cantidadInput');
      const cantidad = parseInt(input.value);
      
      if (isNaN(cantidad) || cantidad <= 0) {
        alert('Por favor ingresa una cantidad v√°lida');
        return;
      }

      if (cantidad > stockMaximoModal) {
        alert(`Solo hay ${stockMaximoModal} unidades disponibles`);
        input.value = stockMaximoModal;
        actualizarBotonesModal();
        return;
      }

      if (productoIdParaCarrito) {
        await agregarAlCarrito(productoIdParaCarrito, cantidad);
        cerrarModalCantidad();
      }
    }

    // Event listeners del modal de cantidad
    document.getElementById('cantidadConfirm').addEventListener('click', confirmarCantidad);
    document.getElementById('cantidadCancel').addEventListener('click', cerrarModalCantidad);
    
    // Botones +/-
    document.querySelector('.cantidad-minus').addEventListener('click', () => {
      const input = document.getElementById('cantidadInput');
      const value = parseInt(input.value) || 1;
      if (value > 1) input.value = value - 1;
      actualizarBotonesModal();
    });
    
    document.querySelector('.cantidad-plus').addEventListener('click', () => {
      const input = document.getElementById('cantidadInput');
      const value = parseInt(input.value) || 1;
      if (value < stockMaximoModal) input.value = value + 1;
      actualizarBotonesModal();
    });
    
    document.getElementById('cantidadInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        confirmarCantidad();
      }
    });

    document.getElementById('cantidadModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('cantidadModal')) {
        cerrarModalCantidad();
      }
    });

    // Event listeners del modal de variantes
    document.getElementById('varianteModalClose').addEventListener('click', cerrarModalVariantes);
    document.getElementById('varianteModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('varianteModal')) {
        cerrarModalVariantes();
      }
    });

    // Escuchar evento de actualizaci√≥n del carrito (cuando se elimina un item o expira)
    window.addEventListener('carritoActualizado', () => {
      console.log('üîî Evento carritoActualizado recibido, actualizando stock en tiempo real...');
      actualizarStockEnTiempoReal();
    });

    async function actualizarStockEnTiempoReal() {
      try {
        console.log('üîÑ Iniciando actualizaci√≥n de stock en tiempo real...');
        
        // Obtener carrito local del invitado
        const carritoLocal = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
        console.log('üõí Carrito local:', carritoLocal.length, 'items');
        
        // Obtener variantes reservadas actuales
        const reservadosResponse = await fetch('/api/productos/reservados');
        if (!reservadosResponse.ok) {
          console.error('‚ùå Error en respuesta del API reservados:', reservadosResponse.status);
          return;
        }
        
        const dataReservados = await reservadosResponse.json();
        const variantesReservadas = dataReservados.variantesReservadas || {};
        console.log('üîÑ Variantes reservadas actualizadas:', variantesReservadas);

        // Obtener stocks actuales de la BD
        const stocksResponse = await fetch('/api/productos/stocks');
        if (!stocksResponse.ok) {
          console.error('‚ùå Error en respuesta del API stocks:', stocksResponse.status);
          return;
        }
        
        const dataStocks = await stocksResponse.json();
        const stocksActuales = dataStocks.stocks || {};
        console.log('üîÑ Stocks actualizados:', stocksActuales);

        // Actualizar cada tarjeta de producto
        const articulos = document.querySelectorAll('article[data-id]');
        console.log('üì¶ Encontrados ' + articulos.length + ' productos para actualizar');
        
        articulos.forEach(article => {
          const productoId = parseInt(article.getAttribute('data-id'));
          const producto = productosGlobal.find(p => p.id === productoId);
          
          if (!producto) {
            console.log('‚ö†Ô∏è  Producto ' + productoId + ' no encontrado en productosGlobal');
            return;
          }

          // Obtener stock actual de la BD
          const stockActual = stocksActuales[productoId] !== undefined ? stocksActuales[productoId] : producto.stock;
          console.log('üìä Stock actual para producto ' + productoId + ': ' + stockActual);

          // Recalcular estado del producto - INCLUYENDO CARRITO LOCAL
          const todasLasVariantes = variantesMap[productoId] || [];
          
          // Obtener variantes en carrito local para este producto
          const variantesEnCarritoLocal = carritoLocal
            .filter(item => item.producto_id === productoId && item.producto_variante_id)
            .map(item => parseInt(item.producto_variante_id));
          
          const variantesConStock = todasLasVariantes.filter(v => {
            const reservadas = variantesReservadas[productoId] || [];
            const varianteId = parseInt(v.id);
            const estaReservada = reservadas.includes(varianteId);
            const estaEnCarritoLocal = variantesEnCarritoLocal.includes(varianteId);
            const tieneStock = v.disponible === true && (v.cantidad_disponible || 0) > 0;
            // NO contar si: est√° reservada, est√° en carrito local, o no tiene stock
            return tieneStock && !estaReservada && !estaEnCarritoLocal;
          });
          
          // Para productos variables, usar cantidad de variantes disponibles
          // Para productos normales, usar el stock actual
          const cantidadDisponible = producto.es_variable ? variantesConStock.length : stockActual;
          const productoAgotado = cantidadDisponible <= 0;
          
          console.log('üìä Producto ' + productoId + ' (es_variable=' + producto.es_variable + '): disponible=' + cantidadDisponible + ', agotado: ' + productoAgotado);

          // Usar la funci√≥n centralizada para actualizar el estado
          if (producto.es_variable) {
            actualizarEstadoProducto(productoId, variantesConStock.length);
          } else {
            // Para productos normales, actualizar la tarjeta directamente
            const article = document.querySelector(`article[data-id="${productoId}"]`);
            if (!article) return;

            // Actualizar stock-info text
            const stockInfo = article.querySelector('.stock-info');
            if (stockInfo) {
              if (productoAgotado) {
                stockInfo.classList.add('stock-agotado');
              } else {
                stockInfo.classList.remove('stock-agotado');
              }
              stockInfo.innerHTML = `
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                  <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
                ${productoAgotado ? 'Agotado' : stockActual + ' unidad' + (stockActual !== 1 ? 'es' : '')}
              `;
            }

            // Actualizar stock-label badge
            const stockLabel = article.querySelector('.stock-label');
            if (productoAgotado) {
              if (stockLabel) stockLabel.remove();
            } else {
              let newLabelText = '';
              let newLabelClass = 'stock-label ';
              if (cantidadDisponible === 1) {
                newLabelText = '¬°√öLTIMA UNIDAD!';
                newLabelClass += 'stock-label-ultima';
              } else if (cantidadDisponible <= 5) {
                newLabelText = 'Agot√°ndose';
                newLabelClass += 'stock-label-agotandose';
              } else {
                newLabelText = 'Disponible';
                newLabelClass += 'stock-label-disponible';
              }
              if (stockLabel) {
                stockLabel.textContent = newLabelText;
                stockLabel.className = newLabelClass;
              } else if (stockInfo && stockInfo.parentElement) {
                const newSpan = document.createElement('span');
                newSpan.className = newLabelClass;
                newSpan.textContent = newLabelText;
                stockInfo.parentElement.appendChild(newSpan);
              }
            }

            // Actualizar bot√≥n
            const button = article.querySelector('.product-btn');
            if (button) {
              if (productoAgotado) {
                button.disabled = true;
                button.classList.add('btn-agotado');
                button.innerHTML = `
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/><path d="M8 8l8 8M16 8l-8 8"/>
                  </svg>
                  <span>Agotado</span>
                `;
              } else {
                button.disabled = false;
                button.classList.remove('btn-agotado');
              }
            }

            // Actualizar overlay
            const link = article.querySelector('a[href*="/productos/"]');
            if (link) {
              const existingOverlay = link.querySelector('div[style*="position: absolute"]');
              if (productoAgotado && !existingOverlay) {
                const overlay = document.createElement('div');
                overlay.style.cssText = "position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;";
                const badge = document.createElement('span');
                badge.style.cssText = "background: rgba(255,255,255,0.95); color: #1a1a1a; padding: 10px 24px; border-radius: 30px; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px;";
                badge.textContent = 'Agotado';
                overlay.appendChild(badge);
                link.appendChild(overlay);
              } else if (!productoAgotado && existingOverlay) {
                existingOverlay.remove();
              }
            }

            // Actualizar stock en productosGlobal
            producto.stock = stockActual;
          }
        });
        
        console.log('‚úÖ Actualizaci√≥n de stock completada');
      } catch (error) {
        console.error('‚ùå Error actualizando stock:', error);
        // Si hay error, recarga todo como fallback
        cargarProductos();
      }
    }

    // Cargar al iniciar
    console.log('üìÑ Script iniciando, llamando a cargarProductos()');
    
    // Variables de filtrado
    let productosOriginales = [];
    let variantesReservadas = [];
    let productosCompleto = [];
    const filterCategoria = document.getElementById('filterCategoria');
    const filterOrden = document.getElementById('filterOrden');
    const resetBtn = document.getElementById('resetFilters');

    // Funci√≥n para aplicar filtros
    function aplicarFiltros() {
      let productosFiltrados = [...productosOriginales];

      // Filtro por categor√≠a
      const categoriaSeleccionada = filterCategoria.value;
      if (categoriaSeleccionada) {
        productosFiltrados = productosFiltrados.filter(p => 
          p.categorias.slug === categoriaSeleccionada
        );
      }

      // Filtro por precio
      const sliderPrecioMin = document.getElementById('sliderPrecioMin');
      const sliderPrecioMax = document.getElementById('sliderPrecioMax');
      const precioMin = sliderPrecioMin ? parseFloat(sliderPrecioMin.value) || 0 : 0;
      const precioMax = sliderPrecioMax ? parseFloat(sliderPrecioMax.value) || 1000 : 1000;
      
      productosFiltrados = productosFiltrados.filter(p => {
        const precio = parseFloat(p.precio);
        return precio >= precioMin && precio <= precioMax;
      });

      // Ordenar
      const ordenSeleccionado = filterOrden.value;
      if (ordenSeleccionado === 'precio-asc') {
        productosFiltrados.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio));
      } else if (ordenSeleccionado === 'precio-desc') {
        productosFiltrados.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio));
      } else if (ordenSeleccionado === 'nombre') {
        productosFiltrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
      } else if (ordenSeleccionado === 'nuevo') {
        productosFiltrados.sort((a, b) => b.id - a.id);
      }

      // Re-renderizar grid
      renderizarProductos(productosFiltrados, variantesReservadas);
    }

    // Event listeners de filtros
    function actualizarSliders() {
      const sliderPrecioMin = document.getElementById('sliderPrecioMin');
      const sliderPrecioMax = document.getElementById('sliderPrecioMax');
      const precioMinDisplay = document.getElementById('precioMinDisplay');
      const precioMaxDisplay = document.getElementById('precioMaxDisplay');
      
      if (!sliderPrecioMin || !sliderPrecioMax) return;
      
      const min = parseFloat(sliderPrecioMin.value) || 0;
      const max = parseFloat(sliderPrecioMax.value) || 1000;

      if (min > max) {
        sliderPrecioMin.value = max;
      }
      if (max < min) {
        sliderPrecioMax.value = min;
      }

      // Actualizar displays
      const minVal = Math.round(sliderPrecioMin.value) || 0;
      const maxVal = Math.round(sliderPrecioMax.value) || 1000;
      
      precioMinDisplay.textContent = `${minVal} ‚Ç¨`;
      precioMaxDisplay.textContent = `${maxVal} ‚Ç¨`;
      
      aplicarFiltros();
    }

    // Agregar event listeners despu√©s de que los sliders se inicialicen en cargarProductos()
    setTimeout(() => {
      const sliderPrecioMin = document.getElementById('sliderPrecioMin');
      const sliderPrecioMax = document.getElementById('sliderPrecioMax');
      if (sliderPrecioMin && sliderPrecioMax) {
        sliderPrecioMin.addEventListener('input', actualizarSliders);
        sliderPrecioMax.addEventListener('input', actualizarSliders);
      }
    }, 100);

    filterCategoria.addEventListener('change', aplicarFiltros);
    filterOrden.addEventListener('change', aplicarFiltros);
    
    resetBtn.addEventListener('click', () => {
      filterCategoria.value = '';
      sliderPrecioMin.value = 0;
      sliderPrecioMax.value = precioMaxReal;
      precioMinDisplay.textContent = `0 ‚Ç¨`;
      precioMaxDisplay.textContent = `${precioMaxReal} ‚Ç¨`;
      filterOrden.value = 'nombre';
      aplicarFiltros();
    });

    // Cargar productos al iniciar
    cargarProductos();
    console.log('üìÑ cargarProductos() llamada');
  </script>
</Layout>
