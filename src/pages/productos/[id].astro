---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;
---

<Layout>
  <style>
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .breadcrumb a {
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 600;
    }

    .breadcrumb a:hover {
      color: var(--color-accent-light);
    }

    .product-hero {
      display: grid;
      grid-template-columns: 1fr 1.3fr;
      gap: 3rem;
      align-items: flex-start;
    }

    .image-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .image-container {
      position: relative;
      width: 100%;
      height: 500px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 40px var(--shadow-color);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 1rem;
      transition: transform 0.3s ease;
    }

    .image-container:hover img {
      transform: scale(1.02);
    }

    .badge {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: #dc2626;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 0.75rem;
      z-index: 10;
    }

    .thumbnail-gallery {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .thumbnail {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .thumbnail:hover,
    .thumbnail.active {
      border-color: var(--color-accent);
      transform: scale(1.05);
    }

    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.5rem;
    }

    .product-info {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .product-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }

    .category-label {
      color: var(--color-accent);
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: 1.5px;
    }

    .product-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      margin: 0.8rem 0;
    }

    .stock-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #22c55e;
      font-weight: 600;
    }

    .rating {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
      margin-top: 0.75rem;
    }

    .stars {
      color: var(--color-accent);
      font-size: 1rem;
    }

    .rating-text {
      color: var(--text-muted);
      font-weight: 600;
    }

    .price-section {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }

    .current-price {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .original-price {
      font-size: 1rem;
      color: var(--text-muted);
      text-decoration: line-through;
      margin-bottom: 1rem;
    }

    .description {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .options-section {
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      border-radius: 8px;
      background: var(--bg-secondary);
    }

    .option-group {
      margin-bottom: 1.5rem;
    }

    .option-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .option-required {
      color: #dc2626;
    }

    .option-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .radio-option:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-light);
    }

    .radio-option input {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: var(--color-accent);
    }

    .radio-label {
      flex: 1;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .price-modifier {
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .quantity-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .quantity-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .quantity-input {
      width: 80px;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      text-align: center;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .quantity-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .btn-add-cart {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #a89968, #9a8560);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 20px rgba(168, 153, 104, 0.25);
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    .btn-add-cart:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(168, 153, 104, 0.35);
    }

    .btn-add-cart:active {
      transform: translateY(0);
    }

    .btn-add-cart::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .btn-add-cart:active::after {
      animation: expandCircle 0.6s ease-out;
    }

    @keyframes expandCircle {
      0% {
        width: 0;
        height: 0;
        opacity: 0.8;
      }
      100% {
        width: 300px;
        height: 300px;
        opacity: 0;
      }
    }

    .benefits {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .benefit-item {
      display: flex;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--color-accent);
    }

    .benefit-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .benefit-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .benefit-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.8rem;
    }

    .benefit-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 1.5rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: var(--text-muted);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Desktop Grande (1536px+) */
    @media (min-width: 1536px) {
      .product-hero {
        grid-template-columns: 1.2fr 1fr;
        gap: 4rem;
      }

      .image-container {
        height: 600px;
      }

      .product-title {
        font-size: 2.5rem;
        margin: 1.2rem 0;
      }

      .current-price {
        font-size: 3rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Desktop Mediano (1280px - 1536px) */
    @media (min-width: 1280px) and (max-width: 1535px) {
      .product-hero {
        grid-template-columns: 1.1fr 1fr;
        gap: 3.5rem;
      }

      .image-container {
        height: 550px;
      }

      .product-title {
        font-size: 2.2rem;
      }

      .current-price {
        font-size: 2.8rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    /* Desktop Peque√±o (1024px - 1280px) */
    @media (min-width: 1024px) and (max-width: 1279px) {
      .product-hero {
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
      }

      .image-container {
        height: 480px;
      }

      .product-title {
        font-size: 2rem;
      }

      .current-price {
        font-size: 2.4rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
      }
    }

    /* Tablet Grande (768px - 1024px) */
    @media (min-width: 768px) and (max-width: 1023px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .image-container {
        height: 420px;
      }

      .product-title {
        font-size: 1.8rem;
        margin: 0.8rem 0;
      }

      .current-price {
        font-size: 2.2rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.8rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .benefit-item {
        padding: 1rem;
      }

      .benefit-icon {
        font-size: 1.4rem;
      }

      .benefit-title {
        font-size: 0.85rem;
      }

      .benefit-desc {
        font-size: 0.8rem;
      }

      .options-section {
        padding: 1.5rem;
      }

      .product-header {
        padding-bottom: 1.2rem;
      }
    }

    /* M√≥vil Grande (480px - 768px) */
    @media (min-width: 480px) and (max-width: 767px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .image-container {
        height: 380px;
      }

      .product-title {
        font-size: 1.6rem;
        margin: 0.6rem 0;
      }

      .current-price {
        font-size: 1.9rem;
      }

      .original-price {
        font-size: 1rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.6rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .benefit-item {
        padding: 0.8rem;
        border-left-width: 3px;
      }

      .benefit-icon {
        font-size: 1.2rem;
      }

      .benefit-title {
        font-size: 0.8rem;
      }

      .benefit-desc {
        font-size: 0.75rem;
      }

      .price-section {
        padding: 1.25rem;
      }

      .options-section {
        padding: 1.25rem;
      }

      .option-label {
        font-size: 0.95rem;
      }

      .radio-label {
        font-size: 0.95rem;
      }

      .btn-add-cart {
        padding: 1.1rem;
        font-size: 1rem;
      }

      .quantity-input {
        width: 75px;
      }
    }

    /* M√≥vil Mediano (376px - 480px) */
    @media (min-width: 376px) and (max-width: 479px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 1.2rem;
      }

      .image-container {
        height: 340px;
      }

      .product-title {
        font-size: 1.4rem;
        margin: 0.5rem 0;
      }

      .current-price {
        font-size: 1.7rem;
      }

      .original-price {
        font-size: 0.95rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }

      .thumbnail {
        border-radius: 6px;
      }

      .benefits {
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }

      .benefit-item {
        padding: 0.7rem;
        border-left-width: 2px;
      }

      .benefit-icon {
        font-size: 1rem;
      }

      .benefit-title {
        font-size: 0.75rem;
      }

      .benefit-desc {
        font-size: 0.7rem;
      }

      .price-section {
        padding: 1rem;
      }

      .options-section {
        padding: 1rem;
        border-radius: 6px;
      }

      .option-label {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .radio-label {
        font-size: 0.9rem;
      }

      .price-modifier {
        font-size: 0.85rem;
      }

      .btn-add-cart {
        padding: 1rem;
        font-size: 0.95rem;
        margin-top: 0.75rem;
      }

      .quantity-input {
        width: 70px;
        padding: 0.6rem;
      }

      .category-label {
        font-size: 0.7rem;
      }

      .breadcrumb {
        font-size: 0.8rem;
        gap: 0.25rem;
      }
    }

    /* M√≥vil Peque√±o (320px - 376px) */
    @media (max-width: 375px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .image-container {
        height: 300px;
        width: 100%;
      }

      .product-title {
        font-size: 1.2rem;
        margin: 0.4rem 0;
      }

      .current-price {
        font-size: 1.5rem;
      }

      .original-price {
        font-size: 0.9rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
      }

      .thumbnail {
        border-radius: 5px;
      }

      .benefits {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .benefit-item {
        padding: 0.6rem;
        border-left-width: 2px;
      }

      .benefit-icon {
        font-size: 0.95rem;
      }

      .benefit-title {
        font-size: 0.7rem;
      }

      .benefit-desc {
        font-size: 0.65rem;
      }

      .price-section {
        padding: 0.9rem;
      }

      .options-section {
        padding: 0.9rem;
        border-radius: 5px;
      }

      .option-label {
        font-size: 0.85rem;
        margin-bottom: 0.4rem;
      }

      .radio-label {
        font-size: 0.85rem;
      }

      .price-modifier {
        font-size: 0.8rem;
      }

      .radio-option {
        padding: 0.6rem;
        gap: 0.6rem;
      }

      .radio-option input {
        width: 16px;
        height: 16px;
      }

      .quantity-section {
        flex-direction: column;
        gap: 0.6rem;
        align-items: flex-start;
      }

      .quantity-label {
        font-size: 0.85rem;
      }

      .quantity-input {
        width: 65px;
        padding: 0.5rem;
      }

      .btn-add-cart {
        padding: 0.9rem;
        font-size: 0.9rem;
        margin-top: 0.6rem;
      }

      .category-label {
        font-size: 0.65rem;
        letter-spacing: 1px;
      }

      .breadcrumb {
        font-size: 0.75rem;
        gap: 0.2rem;
        margin-bottom: 1rem;
      }

      .stock-status {
        font-size: 0.85rem;
      }

      .rating {
        font-size: 0.85rem;
      }

      .stars {
        font-size: 0.95rem;
      }

      .loading {
        min-height: 50vh;
        gap: 1rem;
      }

      .loading-spinner {
        width: 35px;
        height: 35px;
        border-width: 2px;
      }
    }
  </style>

  <!-- Estilos globales para HTML generado din√°micamente por JavaScript -->
  <style is:global>
    /* ===== ESTILOS PARA HTML GENERADO POR JS ===== */
    .js-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
    }

    .js-breadcrumb-link {
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 600;
    }

    .js-breadcrumb-link:hover {
      text-decoration: underline;
    }

    .js-breadcrumb-sep {
      color: var(--text-muted);
    }

    .js-breadcrumb-current {
      color: var(--text-secondary);
    }

    .js-main-grid {
      display: grid;
      grid-template-columns: 1fr 1.3fr;
      gap: 3rem;
      align-items: flex-start;
    }

    .js-images-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .js-main-image-container {
      position: relative;
      width: 100%;
      height: 500px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 40px var(--shadow-color);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .js-discount-badge {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: #dc2626;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 0.75rem;
      z-index: 10;
    }

    .js-main-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 1rem;
      transition: transform 0.3s ease;
    }

    .js-thumbnails-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .js-thumbnail {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid var(--border-color);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .js-thumbnail.active,
    .js-thumbnail:hover {
      border-color: var(--color-accent);
    }

    .js-thumb-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.5rem;
    }

    .js-details-column {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .js-product-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }

    .js-category-badge {
      color: var(--color-accent);
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: 1.5px;
    }

    .js-product-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      margin: 0.8rem 0;
    }

    .js-stock-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #22c55e;
      font-weight: 600;
    }

    .js-rating {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
      margin-top: 0.75rem;
    }

    .js-rating-stars {
      color: var(--color-accent);
      font-size: 1rem;
    }

    .js-rating-text {
      color: var(--text-muted);
      font-weight: 600;
    }

    .js-price-section {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }

    .js-price-main {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .js-price-original {
      font-size: 1rem;
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .js-description {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .js-options-section {
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      border-radius: 8px;
      background: var(--bg-secondary);
    }

    .js-option-group {
      margin-bottom: 1.5rem;
    }

    .js-option-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .js-required {
      color: #dc2626;
    }

    .js-radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .js-radio-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .js-radio-option:hover {
      background: var(--bg-tertiary);
    }

    .js-radio-input {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: var(--color-accent);
    }

    .js-radio-label {
      flex: 1;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-primary);
      margin: 0;
    }

    .js-price-extra {
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .js-quantity-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .js-quantity-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .js-quantity-selector {
      display: flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-input);
    }

    .js-quantity-btn {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-primary);
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .js-quantity-btn:hover:not(:disabled) {
      background: var(--color-accent);
      color: white;
    }

    .js-quantity-btn:disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .js-quantity-input {
      width: 60px;
      padding: 0.6rem 0;
      border: none;
      border-left: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      font-size: 1.05rem;
      text-align: center;
      background: var(--bg-input);
      color: var(--text-primary);
      font-weight: 600;
      -moz-appearance: textfield;
    }

    .js-quantity-input::-webkit-outer-spin-button,
    .js-quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .js-quantity-input:focus {
      outline: none;
    }

    .js-add-to-cart {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #a89968, #9a8560);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 20px rgba(168, 153, 104, 0.25);
      margin-top: 1rem;
    }

    .js-add-to-cart:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(168, 153, 104, 0.35);
    }

    .js-benefits-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .js-benefit-item {
      display: flex;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--color-accent);
    }

    .js-benefit-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
      font-weight: 700;
      color: var(--color-accent);
    }

    .js-benefit-content {
      flex: 1;
    }

    .js-benefit-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.8rem;
    }

    .js-benefit-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Responsive para contenido generado por JS */
    @media (max-width: 1024px) {
      .js-main-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .js-main-image-container {
        height: 400px;
      }

      .js-benefits-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .js-thumbnails-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
      }

      .js-product-title {
        font-size: 1.5rem;
      }

      .js-price-main {
        font-size: 2rem;
      }
    }
  </style>

  <div id="productDetails" style="display: none; padding: 2rem;">
    <!-- Se llena con JavaScript -->
  </div>

  <div id="loadingMessage" class="loading">
    <div class="loading-spinner"></div>
    <p class="loading-text" style="font-size: 1.1rem; font-weight: 600;">Cargando producto...</p>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
  </style>

  <script>
    // Variables globales para el producto actual
    let productoActual = null;
    let variantesDisponibles = [];
    let varianteSeleccionada = null;
    let precioActual = 0;

    async function cargarProducto() {
      try {
        const productoId = window.location.pathname.split('/').pop();

        const response = await fetch(`/api/admin/productos`);
        const data = await response.json();

        if (!data.success || !data.productos) {
          mostrarError('Error al cargar el producto');
          return;
        }

        const producto = data.productos.find(p => p.id === parseInt(productoId));
        if (!producto) {
          mostrarError('Producto no encontrado');
          return;
        }

        productoActual = producto;

        // Si es producto variable, cargar las variantes disponibles
        if (producto.es_variable) {
          await cargarVariantes(producto.id);
        }

        let oferta = null;
        try {
          const ofertasResponse = await fetch('/api/ofertas');
          const ofertasData = await ofertasResponse.json();
          if (ofertasData.success && ofertasData.data) {
            oferta = ofertasData.data.find(o => o.producto_id === producto.id);
          }
        } catch (error) {
          console.error('Error cargando ofertas:', error);
        }

        const precioOriginal = producto.precio_centimos / 100;
        const precioFinal = oferta ? (oferta.precio_descuento_centimos / 100) : precioOriginal;
        const porcentajeDescuento = oferta ? oferta.porcentaje_descuento : 0;
        precioActual = precioFinal;

        // Determinar disponibilidad y estado del stock
        let stockDisponible = 0;
        let estaDisponible = false;
        let textoStock = '';
        let estadoStock = 'agotado'; // agotado, ultima, agotandose, disponible
        let colorStock = '#dc2626';

        if (producto.es_variable) {
          // Producto con variantes de peso
          stockDisponible = variantesDisponibles.length;
          estaDisponible = stockDisponible > 0;
          
          if (stockDisponible === 0) {
            estadoStock = 'agotado';
            textoStock = 'Sin stock disponible';
            colorStock = '#dc2626';
          } else if (stockDisponible === 1) {
            estadoStock = 'ultima';
            textoStock = '¬°√öltima unidad!';
            colorStock = '#dc2626';
          } else if (stockDisponible <= 3) {
            estadoStock = 'agotandose';
            textoStock = `¬°Solo ${stockDisponible} disponibles!`;
            colorStock = '#f59e0b';
          } else {
            estadoStock = 'disponible';
            textoStock = `${stockDisponible} pesos disponibles`;
            colorStock = '#22c55e';
          }
        } else {
          // Producto simple con stock
          stockDisponible = producto.stock || 0;
          estaDisponible = stockDisponible > 0;
          
          if (stockDisponible === 0) {
            estadoStock = 'agotado';
            textoStock = 'Agotado';
            colorStock = '#dc2626';
          } else if (stockDisponible === 1) {
            estadoStock = 'ultima';
            textoStock = '¬°√öltima unidad!';
            colorStock = '#dc2626';
          } else if (stockDisponible <= 5) {
            estadoStock = 'agotandose';
            textoStock = `¬°Solo ${stockDisponible} unidades!`;
            colorStock = '#f59e0b';
          } else {
            estadoStock = 'disponible';
            textoStock = `${stockDisponible} en stock`;
            colorStock = '#22c55e';
          }
        }

        const html = generarHTMLProducto(producto, oferta, precioOriginal, precioFinal, porcentajeDescuento, estaDisponible, textoStock, stockDisponible, colorStock, estadoStock);

        document.getElementById('productDetails').innerHTML = html;
        document.getElementById('productDetails').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';

        // Configurar eventos despu√©s de renderizar
        configurarEventos(producto, estaDisponible);

      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error al cargar el producto');
      }
    }

    async function cargarVariantes(productoId) {
      try {
        const response = await fetch(`/api/variantes/${productoId}`);
        const data = await response.json();
        
        if (data.success && data.variantes) {
          // Solo variantes disponibles del servidor
          let disponibles = data.variantes.filter(v => v.disponible === true);
          
          // Tambi√©n filtrar las variantes que ya est√°n en el carrito local del invitado
          const carritoLocal = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
          const variantesEnCarritoLocal = carritoLocal
            .filter(item => item.producto_id === parseInt(productoId) && item.producto_variante_id)
            .map(item => item.producto_variante_id);
          
          variantesDisponibles = disponibles.filter(v => !variantesEnCarritoLocal.includes(v.id));
          console.log('‚úÖ Variantes del servidor:', disponibles.length);
          console.log('‚úÖ Variantes en carrito local:', variantesEnCarritoLocal);
          console.log('‚úÖ Variantes realmente disponibles:', variantesDisponibles.length);
        }
      } catch (error) {
        console.error('Error cargando variantes:', error);
        variantesDisponibles = [];
      }
    }

    function generarHTMLProducto(producto, oferta, precioOriginal, precioFinal, porcentajeDescuento, estaDisponible, textoStock, stockDisponible, colorStock, estadoStock) {
      // Precio por kg para productos variables
      const precioPorKg = producto.precio_por_kg || (producto.precio_centimos / 100);
      
      // Generar opciones de variantes o cantidad
      let opcionesHTML = '';
      
      if (producto.es_variable && variantesDisponibles.length > 0) {
        // Producto con variantes de peso - precio_total est√° en c√©ntimos
        opcionesHTML = `
          <div class="js-option-group">
            <label class="js-option-label">Seleccionar peso <span class="js-required">*</span></label>
            <div class="js-radio-group" id="variantesContainer">
              ${variantesDisponibles.map((v, index) => `
                <label class="js-radio-option">
                  <input 
                    type="radio" 
                    name="variante" 
                    value="${v.id}" 
                    data-peso="${v.peso_kg}"
                    data-precio="${v.precio_total}"
                    class="js-radio-input"
                    ${index === 0 ? 'checked' : ''}
                  />
                  <span class="js-radio-label">${v.peso_kg} kg</span>
                  <span class="js-price-extra">${(Number(v.precio_total) / 100).toFixed(2)} ‚Ç¨</span>
                </label>
              `).join('')}
            </div>
          </div>
        `;
      } else if (!producto.es_variable && stockDisponible > 0) {
        // Producto simple con stock - selector de cantidad con botones +/-
        opcionesHTML = `
          <div class="js-quantity-row">
            <label class="js-quantity-label">Cantidad:</label>
            <div class="js-quantity-selector">
              <button type="button" id="btnMenos" class="js-quantity-btn" disabled>‚àí</button>
              <input 
                type="number" 
                id="cantidad" 
                value="1" 
                min="1" 
                max="${stockDisponible}" 
                class="js-quantity-input"
                readonly
              />
              <button type="button" id="btnMas" class="js-quantity-btn" ${stockDisponible <= 1 ? 'disabled' : ''}>+</button>
            </div>
            <span class="js-stock-info" style="font-size: 0.85rem; color: var(--text-muted);">
              (M√°x. ${stockDisponible})
            </span>
          </div>
        `;
      }

      return `
        <!-- BREADCRUMB -->
        <div class="js-breadcrumb">
          <a href="/productos" class="js-breadcrumb-link">Cat√°logo</a>
          <span class="js-breadcrumb-sep">/</span>
          <span class="js-breadcrumb-current">${producto.nombre}</span>
        </div>

        <!-- MAIN CONTAINER -->
        <div class="js-main-grid">
          
          <!-- LEFT: IMAGES -->
          <div class="js-images-column">
            
            <!-- MAIN IMAGE -->
            <div class="js-main-image-container">
              ${oferta ? `<div class="js-discount-badge">-${porcentajeDescuento}% OFF</div>` : ''}
              <img id="mainImage" src="${producto.imagen_url}" alt="${producto.nombre}" class="js-main-image" />
            </div>

            <!-- THUMBNAILS -->
            <div class="js-thumbnails-grid">
              <div class="thumbnail js-thumbnail active" onclick="cambiarImagen('${producto.imagen_url}', this)">
                <img src="${producto.imagen_url}" alt="Vista 1" class="js-thumb-img" />
              </div>
              <div class="thumbnail js-thumbnail" onclick="cambiarImagen('${producto.imagen_url}', this)">
                <img src="${producto.imagen_url}" alt="Vista 2" class="js-thumb-img" />
              </div>
              <div class="thumbnail js-thumbnail" onclick="cambiarImagen('${producto.imagen_url}', this)">
                <img src="${producto.imagen_url}" alt="Vista 3" class="js-thumb-img" />
              </div>
              <div class="thumbnail js-thumbnail" onclick="cambiarImagen('${producto.imagen_url}', this)">
                <img src="${producto.imagen_url}" alt="Vista 4" class="js-thumb-img" />
              </div>
            </div>
          </div>

          <!-- RIGHT: DETAILS -->
          <div class="js-details-column">
            
            <!-- HEADER -->
            <div class="js-product-header">
              <span class="js-category-badge">${producto.categorias?.nombre || 'Producto Premium'}</span>
              <h1 class="js-product-title">${producto.nombre}</h1>
              <div class="js-stock-badge" id="stockBadge" data-estado="${estadoStock}" style="color: ${colorStock};">
                <span id="stockTexto">${textoStock}</span>
              </div>
              <div class="js-rating">
                <span class="js-rating-stars">‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ</span>
                <span class="js-rating-text">${producto.rating || 4.9}/5 (${Math.floor(Math.random() * 100) + 50} rese√±as)</span>
              </div>
            </div>

            <!-- PRICE -->
            <div class="js-price-section">
              ${producto.es_variable ? `
                <div class="js-price-main" style="font-size: 1.8rem;">${Number(precioPorKg).toFixed(2)} ‚Ç¨/kg</div>
                <div id="precioDisplay" style="font-size: 1.4rem; color: var(--text-secondary); margin-top: 0.5rem;">
                  ${variantesDisponibles.length > 0 
                    ? `Pieza seleccionada: ${(Number(variantesDisponibles[0].precio_total) / 100).toFixed(2)} ‚Ç¨` 
                    : 'Sin piezas disponibles'}
                </div>
              ` : `
                <div class="js-price-main" id="precioDisplay">${precioFinal.toFixed(2)} ‚Ç¨</div>
                ${oferta ? `<div class="js-price-original">${precioOriginal.toFixed(2)} ‚Ç¨</div>` : ''}
              `}
            </div>

            <!-- DESCRIPTION -->
            <p class="js-description">${producto.descripcion || 'Producto de calidad premium seleccionado especialmente para usted.'}</p>

            <!-- OPTIONS SECTION -->
            ${estaDisponible ? `
              <div class="js-options-section">
                ${opcionesHTML}
                
                <button 
                  type="button" 
                  class="js-add-to-cart" 
                  id="btnAgregarCarrito"
                  data-producto-id="${producto.id}"
                >
                  A√±adir al carrito
                </button>
              </div>
            ` : `
              <div class="js-options-section" style="text-align: center;">
                <div style="padding: 2rem; color: var(--text-muted);">
                  <p style="margin-top: 1rem; font-weight: 600;">Producto no disponible</p>
                  <p style="font-size: 0.9rem;">Lo sentimos, este producto est√° agotado actualmente.</p>
                </div>
              </div>
            `}

            <!-- BENEFITS -->
            <div class="js-benefits-grid">
              <div class="js-benefit-item">
                <div class="js-benefit-icon">G</div>
                <div class="js-benefit-content">
                  <div class="js-benefit-title">Garantizado</div>
                  <div class="js-benefit-desc">Frescura asegurada</div>
                </div>
              </div>
              <div class="js-benefit-item">
                <div class="js-benefit-icon">E</div>
                <div class="js-benefit-content">
                  <div class="js-benefit-title">Entrega R√°pida</div>
                  <div class="js-benefit-desc">2-3 d√≠as laborales</div>
                </div>
              </div>
              <div class="js-benefit-item">
                <div class="js-benefit-icon">P</div>
                <div class="js-benefit-content">
                  <div class="js-benefit-title">Pago Seguro</div>
                  <div class="js-benefit-desc">100% protegido</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function configurarEventos(producto, estaDisponible) {
      if (!estaDisponible) return;

      // Evento para cambio de variante (productos con peso)
      if (producto.es_variable) {
        const radios = document.querySelectorAll('input[name="variante"]');
        radios.forEach(radio => {
          radio.addEventListener('change', function() {
            const precioCentimos = this.getAttribute('data-precio');
            const peso = this.getAttribute('data-peso');
            varianteSeleccionada = {
              id: parseInt(this.value),
              peso_kg: parseFloat(peso),
              precio_total: parseFloat(precioCentimos) // Guardamos en c√©ntimos
            };
            document.getElementById('precioDisplay').textContent = `Pieza seleccionada: ${(Number(precioCentimos) / 100).toFixed(2)} ‚Ç¨`;
            console.log('Variante seleccionada:', varianteSeleccionada);
          });
        });

        // Seleccionar primera variante por defecto
        if (radios.length > 0) {
          const primeraVariante = radios[0];
          varianteSeleccionada = {
            id: parseInt(primeraVariante.value),
            peso_kg: parseFloat(primeraVariante.getAttribute('data-peso')),
            precio_total: parseFloat(primeraVariante.getAttribute('data-precio'))
          };
        }
      } else {
        // Producto simple - botones +/- y validaci√≥n
        const inputCantidad = document.getElementById('cantidad');
        const btnMenos = document.getElementById('btnMenos');
        const btnMas = document.getElementById('btnMas');
        
        if (inputCantidad && btnMenos && btnMas) {
          function actualizarBotones() {
            const valor = parseInt(inputCantidad.value) || 1;
            const max = parseInt(inputCantidad.getAttribute('max')) || 1;
            btnMenos.disabled = valor <= 1;
            btnMas.disabled = valor >= max;
          }

          btnMenos.addEventListener('click', () => {
            let valor = parseInt(inputCantidad.value) || 1;
            if (valor > 1) {
              inputCantidad.value = valor - 1;
              actualizarBotones();
            }
          });

          btnMas.addEventListener('click', () => {
            let valor = parseInt(inputCantidad.value) || 1;
            const max = parseInt(inputCantidad.getAttribute('max')) || 1;
            if (valor < max) {
              inputCantidad.value = valor + 1;
              actualizarBotones();
            }
          });

          actualizarBotones();
        }
      }

      // Evento del bot√≥n agregar al carrito
      const btnAgregar = document.getElementById('btnAgregarCarrito');
      if (btnAgregar) {
        btnAgregar.addEventListener('click', function() {
          agregarAlCarrito(producto.id);
        });
      }
    }

    function cambiarImagen(url, thumbElement) {
      document.getElementById('mainImage').src = url;
      document.querySelectorAll('.js-thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
      });
      thumbElement.classList.add('active');
    }

    function mostrarNotificacion(mensaje, esError = false) {
      const notificacion = document.createElement('div');
      notificacion.textContent = mensaje;
      notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${esError ? '#dc2626' : '#16a34a'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      `;
      document.body.appendChild(notificacion);
      setTimeout(() => {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notificacion.remove(), 300);
      }, 3000);
    }

    // Agregar estilos para animaciones
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    function mostrarError(mensaje) {
      document.getElementById('loadingMessage').innerHTML = `
        <h2 style="color: #dc2626; margin: 0 0 1rem 0;">${mensaje}</h2>
        <a href="/productos" style="
          display: inline-block;
          padding: 0.75rem 1.5rem;
          background: #a89968;
          color: white;
          text-decoration: none;
          border-radius: 6px;
          font-weight: 600;
        ">Volver al Cat√°logo</a>
      `;
    }

    // Variable para bloquear mientras se procesa
    let procesandoCarrito = false;

    async function agregarAlCarrito(productoId) {
      if (procesandoCarrito) {
        console.log('‚è≥ Ya hay una operaci√≥n en curso...');
        return;
      }

      procesandoCarrito = true;
      const btnAgregar = document.getElementById('btnAgregarCarrito');
      if (btnAgregar) {
        btnAgregar.disabled = true;
        btnAgregar.style.opacity = '0.5';
      }

      try {
        const userId = localStorage.getItem('user_id');
        
        // Si es invitado, guardar en localStorage
        if (!userId) {
          await agregarAlCarritoLocal(productoId);
          return;
        }

        let bodyData = {
          producto_id: productoId,
          user_id: userId
        };

        if (productoActual.es_variable) {
          // Producto con variantes de peso
          if (!varianteSeleccionada) {
            mostrarNotificacion('Selecciona un peso', true);
            return;
          }
          bodyData.producto_variante_id = varianteSeleccionada.id;
          bodyData.peso_kg = varianteSeleccionada.peso_kg;
          bodyData.cantidad = 1; // Las variantes son √∫nicas
        } else {
          // Producto simple
          const cantidad = parseInt(document.getElementById('cantidad')?.value) || 1;
          const stockActual = productoActual.stock || 0;
          
          // Validar stock antes de enviar
          if (cantidad > stockActual) {
            mostrarNotificacion(`Solo hay ${stockActual} unidades disponibles`, true);
            return;
          }
          
          bodyData.cantidad = cantidad;
          bodyData.producto_variante_id = null;
          bodyData.peso_kg = null;
        }

        console.log('Enviando al carrito:', bodyData);

        // ACTUALIZACI√ìN OPTIMISTA: Actualizar stock inmediatamente
        // Guardar stock original para revertir en caso de error
        const stockOriginal = productoActual.stock;
        const variantesOriginales = [...variantesDisponibles];
        
        if (!productoActual.es_variable) {
          const cantidadAgregada = parseInt(document.getElementById('cantidad')?.value) || 1;
          productoActual.stock = Math.max(0, (productoActual.stock || 0) - cantidadAgregada);
          actualizarStockProductoSimple();
        } else if (varianteSeleccionada) {
          variantesDisponibles = variantesDisponibles.filter(v => v.id !== varianteSeleccionada.id);
          actualizarVariantesUI();
        }

        mostrarNotificacion('‚úì Producto agregado al carrito');

        // Enviar petici√≥n a la API de forma asincr√≥nica
        const response = await fetch('/api/carrito', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': userId
          },
          body: JSON.stringify(bodyData)
        });

        const data = await response.json();
        console.log('üì¶ Respuesta de API:', data);
        
        if (data.success || response.ok) {
          // SIEMPRE usar el stock que devuelve la BD (es la fuente de verdad)
          if (!productoActual.es_variable && data.stockRestante !== null && data.stockRestante !== undefined) {
            console.log(`üìä Stock desde BD: ${data.stockRestante}`);
            productoActual.stock = data.stockRestante;
            actualizarStockProductoSimple();
          } else if (productoActual.es_variable && data.variantes) {
            console.log(`üìä Variantes desde BD: ${data.variantes.length}`);
            variantesDisponibles = data.variantes;
            actualizarVariantesUI();
          }
          
          window.dispatchEvent(new CustomEvent('carritoActualizado'));
        } else {
          // Si hay error, revertir al stock original
          if (!productoActual.es_variable) {
            productoActual.stock = stockOriginal;
            actualizarStockProductoSimple();
          } else if (varianteSeleccionada) {
            variantesDisponibles = variantesOriginales;
            actualizarVariantesUI();
          }
          mostrarNotificacion('‚ùå Error: ' + (data.message || data.error), true);
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('‚ùå Error al agregar al carrito', true);
      } finally {
        procesandoCarrito = false;
        const btnAgregar = document.getElementById('btnAgregarCarrito');
        if (btnAgregar && (productoActual.stock > 0 || productoActual.es_variable)) {
          btnAgregar.disabled = false;
          btnAgregar.style.opacity = '1';
        }
      }
    }

    // Funci√≥n para actualizar UI de producto simple
    function actualizarStockProductoSimple() {
      const stockDisponible = productoActual.stock || 0;
      
      // Actualizar el badge de stock
      actualizarEstadoStock(stockDisponible, false);
      
      // Actualizar el input de cantidad (m√°ximo)
      const inputCantidad = document.getElementById('cantidad');
      if (inputCantidad) {
        inputCantidad.max = stockDisponible;
        if (parseInt(inputCantidad.value) > stockDisponible) {
          inputCantidad.value = Math.max(stockDisponible, 1);
        }
        
        // Actualizar botones +/-
        const btnMenos = document.getElementById('btnMenos');
        const btnMas = document.getElementById('btnMas');
        const valor = parseInt(inputCantidad.value) || 1;
        if (btnMenos) btnMenos.disabled = valor <= 1;
        if (btnMas) btnMas.disabled = valor >= stockDisponible;
        
        // Actualizar texto de m√°ximo
        const stockInfo = inputCantidad.closest('.js-quantity-row')?.querySelector('.js-stock-info');
        if (stockInfo) {
          stockInfo.textContent = stockDisponible > 0 ? `(M√°x. ${stockDisponible})` : '(Agotado)';
        }
      }
      
      // Si se agot√≥, deshabilitar todo
      if (stockDisponible === 0) {
        const btnAgregar = document.getElementById('btnAgregarCarrito');
        if (btnAgregar) {
          btnAgregar.disabled = true;
          btnAgregar.style.opacity = '0.5';
          btnAgregar.style.cursor = 'not-allowed';
        }
        if (inputCantidad) {
          inputCantidad.disabled = true;
        }
        const btnMenos = document.getElementById('btnMenos');
        const btnMas = document.getElementById('btnMas');
        if (btnMenos) btnMenos.disabled = true;
        if (btnMas) btnMas.disabled = true;
      }
    }

    function actualizarVariantesUI() {
      const container = document.getElementById('variantesContainer');
      if (!container) return;

      if (variantesDisponibles.length === 0) {
        // No quedan variantes disponibles
        container.innerHTML = `
          <div style="padding: 1rem; text-align: center; color: var(--text-muted);">
            No hay m√°s pesos disponibles
          </div>
        `;
        const btnAgregar = document.getElementById('btnAgregarCarrito');
        if (btnAgregar) {
          btnAgregar.disabled = true;
          btnAgregar.style.opacity = '0.5';
          btnAgregar.style.cursor = 'not-allowed';
        }
        // Actualizar badge de stock a agotado
        actualizarEstadoStock(0, true);
        return;
      }

      // Actualizar estado del stock
      actualizarEstadoStock(variantesDisponibles.length, true);

      // Actualizar lista de variantes
      container.innerHTML = variantesDisponibles.map((v, index) => `
        <label class="js-radio-option">
          <input 
            type="radio" 
            name="variante" 
            value="${v.id}" 
            data-peso="${v.peso_kg}"
            data-precio="${v.precio_total}"
            class="js-radio-input"
            ${index === 0 ? 'checked' : ''}
          />
          <span class="js-radio-label">${v.peso_kg} kg</span>
          <span class="js-price-extra">${(Number(v.precio_total) / 100).toFixed(2)} ‚Ç¨</span>
        </label>
      `).join('');

      // Reconfigurar eventos
      const radios = container.querySelectorAll('input[name="variante"]');
      radios.forEach(radio => {
        radio.addEventListener('change', function() {
          const precioCentimos = this.getAttribute('data-precio');
          const peso = this.getAttribute('data-peso');
          varianteSeleccionada = {
            id: parseInt(this.value),
            peso_kg: parseFloat(peso),
            precio_total: parseFloat(precioCentimos)
          };
          document.getElementById('precioDisplay').textContent = `Pieza seleccionada: ${(Number(precioCentimos) / 100).toFixed(2)} ‚Ç¨`;
        });
      });

      // Seleccionar primera variante
      if (radios.length > 0) {
        const primeraVariante = radios[0];
        varianteSeleccionada = {
          id: parseInt(primeraVariante.value),
          peso_kg: parseFloat(primeraVariante.getAttribute('data-peso')),
          precio_total: parseFloat(primeraVariante.getAttribute('data-precio'))
        };
        document.getElementById('precioDisplay').textContent = `Pieza seleccionada: ${(varianteSeleccionada.precio_total / 100).toFixed(2)} ‚Ç¨`;
      }
    }

    // Funci√≥n para actualizar el estado del stock en tiempo real
    function actualizarEstadoStock(cantidad, esVariable = false) {
      const badge = document.getElementById('stockBadge');
      const textoEl = document.getElementById('stockTexto');
      if (!badge || !textoEl) return;

      let textoStock = '';
      let colorStock = '#22c55e';
      let estadoStock = 'disponible';

      if (esVariable) {
        // Producto con variantes
        if (cantidad === 0) {
          estadoStock = 'agotado';
          textoStock = 'Sin stock disponible';
          colorStock = '#dc2626';
        } else if (cantidad === 1) {
          estadoStock = 'ultima';
          textoStock = '¬°√öltima unidad!';
          colorStock = '#dc2626';
        } else if (cantidad <= 3) {
          estadoStock = 'agotandose';
          textoStock = `¬°Solo ${cantidad} disponibles!`;
          colorStock = '#f59e0b';
        } else {
          estadoStock = 'disponible';
          textoStock = `${cantidad} pesos disponibles`;
          colorStock = '#22c55e';
        }
      } else {
        // Producto simple
        if (cantidad === 0) {
          estadoStock = 'agotado';
          textoStock = 'Agotado';
          colorStock = '#dc2626';
        } else if (cantidad === 1) {
          estadoStock = 'ultima';
          textoStock = '¬°√öltima unidad!';
          colorStock = '#dc2626';
        } else if (cantidad <= 5) {
          estadoStock = 'agotandose';
          textoStock = `¬°Solo ${cantidad} unidades!`;
          colorStock = '#f59e0b';
        } else {
          estadoStock = 'disponible';
          textoStock = `${cantidad} en stock`;
          colorStock = '#22c55e';
        }
      }

      // Actualizar UI
      badge.style.color = colorStock;
      badge.dataset.estado = estadoStock;
      badge.innerHTML = `<span id="stockTexto">${textoStock}</span>`;
    }

    // Agregar al carrito local para invitados
    async function agregarAlCarritoLocal(productoId) {
      try {
        let cantidad = 1;
        let varianteId = null;
        let pesoKg = null;
        let precioUnitario = 0;

        if (productoActual.es_variable) {
          if (!varianteSeleccionada) {
            mostrarNotificacion('Selecciona un peso', true);
            return;
          }
          varianteId = varianteSeleccionada.id;
          pesoKg = varianteSeleccionada.peso_kg;
          // precio_total ya est√° en c√©ntimos
          precioUnitario = Math.round(varianteSeleccionada.precio_total);
        } else {
          cantidad = parseInt(document.getElementById('cantidad')?.value) || 1;
          precioUnitario = productoActual.precio_centimos;
        }

        // PRIMERO: Reservar stock en la base de datos
        const reservaRes = await fetch('/api/carrito/reservar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: parseInt(productoId),
            cantidad: cantidad,
            producto_variante_id: varianteId
          })
        });
        
        const reservaData = await reservaRes.json();
        if (!reservaData.success) {
          console.error('‚ùå Error reservando stock:', reservaData.error);
          mostrarNotificacion(reservaData.error || 'No hay suficiente stock', true);
          return;
        }
        console.log('‚úÖ Stock reservado en BD:', reservaData);

        // DESPU√âS: Obtener carrito actual
        let carrito = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');

        // Crear item
        const item = {
          id: Date.now(),
          producto_id: parseInt(productoId),
          nombre: productoActual.nombre,
          precio_unitario: precioUnitario,
          cantidad,
          imagen: productoActual.imagen_url,
          fecha_agregado: new Date().toISOString(),
          producto_variante_id: varianteId,
          peso_kg: pesoKg
        };

        // Verificar si ya existe (solo para productos simples)
        if (!productoActual.es_variable) {
          const existe = carrito.find(c => c.producto_id === parseInt(productoId) && !c.producto_variante_id);
          if (existe) {
            existe.cantidad += cantidad;
            mostrarNotificacion(`‚úì Producto actualizado (${existe.cantidad}x)`);
          } else {
            carrito.push(item);
            mostrarNotificacion('‚úì Producto agregado al carrito');
          }
          
          // Usar stock que devuelve la BD (m√°s preciso)
          productoActual.stock = reservaData.stockRestante;
          actualizarStockProductoSimple();
        } else {
          // Las variantes son √∫nicas
          carrito.push(item);
          mostrarNotificacion('‚úì Producto agregado al carrito');
          
          // Actualizar UI de variantes
          variantesDisponibles = variantesDisponibles.filter(v => v.id !== varianteSeleccionada.id);
          actualizarVariantesUI();
        }

        // Guardar en localStorage
        localStorage.setItem('carrito_invitado', JSON.stringify(carrito));
        localStorage.setItem('carrito_invitado_fecha', String(Date.now()));
        console.log('‚úÖ Carrito invitado actualizado');
        
        // Disparar evento
        window.dispatchEvent(new CustomEvent('carritoActualizado'));
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('‚ùå Error al agregar al carrito', true);
      } finally {
        procesandoCarrito = false;
        const btnAgregar = document.getElementById('btnAgregarCarrito');
        if (btnAgregar && (productoActual.stock > 0 || productoActual.es_variable)) {
          btnAgregar.disabled = false;
          btnAgregar.style.opacity = '1';
        }
      }
    }

    cargarProducto();

    // Escuchar evento de carrito actualizado para recargar stock
    window.addEventListener('carritoActualizado', async () => {
      console.log('üîî Evento carritoActualizado recibido, actualizando stock en tiempo real...');
      try {
        const productoId = window.location.pathname.split('/').pop();
        console.log(`üîÑ Iniciando actualizaci√≥n de stock en tiempo real para producto ${productoId}...`);
        
        if (productoActual.es_variable) {
          console.log('üì¶ Producto variable - recargando variantes...');
          await cargarVariantes(productoId);
          actualizarVariantesUI();
        } else {
          console.log('üì¶ Producto simple - recargando stock...');
          // Para productos simples, hacer un fetch r√°pido del stock
          const response = await fetch(`/api/admin/productos`);
          const data = await response.json();
          if (data.success && data.productos) {
            const productoActualizado = data.productos.find(p => p.id === parseInt(productoId));
            if (productoActualizado) {
              productoActual.stock = productoActualizado.stock;
              actualizarStockProductoSimple();
              console.log(`‚úÖ Stock actualizado: ${productoActual.stock} unidades`);
            }
          }
        }
      } catch (error) {
        console.error('‚ùå Error al recargar stock:', error);
      }
    });
  </script>
</Layout>
