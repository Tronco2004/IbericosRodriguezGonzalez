---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;
---

<Layout>
  <style>
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .breadcrumb a {
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 600;
    }

    .breadcrumb a:hover {
      color: var(--color-accent-light);
    }

    .product-hero {
      display: grid;
      grid-template-columns: 1fr 1.3fr;
      gap: 3rem;
      align-items: flex-start;
    }

    .image-section {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .image-container {
      position: relative;
      width: 100%;
      height: 500px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 40px var(--shadow-color);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 1rem;
      transition: transform 0.3s ease;
    }

    .image-container:hover img {
      transform: scale(1.02);
    }

    .badge {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: #dc2626;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 0.75rem;
      z-index: 10;
    }

    .thumbnail-gallery {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .thumbnail {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .thumbnail:hover,
    .thumbnail.active {
      border-color: var(--color-accent);
      transform: scale(1.05);
    }

    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.5rem;
    }

    .product-info {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .product-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }

    .category-label {
      color: var(--color-accent);
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: 1.5px;
    }

    .product-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      margin: 0.8rem 0;
    }

    .stock-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #22c55e;
      font-weight: 600;
    }

    .rating {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
      margin-top: 0.75rem;
    }

    .stars {
      color: var(--color-accent);
      font-size: 1rem;
    }

    .rating-text {
      color: var(--text-muted);
      font-weight: 600;
    }

    .price-section {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }

    .current-price {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .original-price {
      font-size: 1rem;
      color: var(--text-muted);
      text-decoration: line-through;
      margin-bottom: 1rem;
    }

    .description {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .options-section {
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      border-radius: 8px;
      background: var(--bg-secondary);
    }

    .option-group {
      margin-bottom: 1.5rem;
    }

    .option-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .option-required {
      color: #dc2626;
    }

    .option-items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .radio-option:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-light);
    }

    .radio-option input {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: var(--color-accent);
    }

    .radio-label {
      flex: 1;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .price-modifier {
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .quantity-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .quantity-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .quantity-input {
      width: 80px;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      text-align: center;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .quantity-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .btn-add-cart {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #a89968, #9a8560);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 20px rgba(168, 153, 104, 0.25);
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    .btn-add-cart:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(168, 153, 104, 0.35);
    }

    .btn-add-cart:active {
      transform: translateY(0);
    }

    .btn-add-cart::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .btn-add-cart:active::after {
      animation: expandCircle 0.6s ease-out;
    }

    @keyframes expandCircle {
      0% {
        width: 0;
        height: 0;
        opacity: 0.8;
      }
      100% {
        width: 300px;
        height: 300px;
        opacity: 0;
      }
    }

    .benefits {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .benefit-item {
      display: flex;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--color-accent);
    }

    .benefit-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .benefit-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .benefit-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.8rem;
    }

    .benefit-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 1.5rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: var(--text-muted);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Desktop Grande (1536px+) */
    @media (min-width: 1536px) {
      .product-hero {
        grid-template-columns: 1.2fr 1fr;
        gap: 4rem;
      }

      .image-container {
        height: 600px;
      }

      .product-title {
        font-size: 2.5rem;
        margin: 1.2rem 0;
      }

      .current-price {
        font-size: 3rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Desktop Mediano (1280px - 1536px) */
    @media (min-width: 1280px) and (max-width: 1535px) {
      .product-hero {
        grid-template-columns: 1.1fr 1fr;
        gap: 3.5rem;
      }

      .image-container {
        height: 550px;
      }

      .product-title {
        font-size: 2.2rem;
      }

      .current-price {
        font-size: 2.8rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    /* Desktop Pequeño (1024px - 1280px) */
    @media (min-width: 1024px) and (max-width: 1279px) {
      .product-hero {
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
      }

      .image-container {
        height: 480px;
      }

      .product-title {
        font-size: 2rem;
      }

      .current-price {
        font-size: 2.4rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
      }
    }

    /* Tablet Grande (768px - 1024px) */
    @media (min-width: 768px) and (max-width: 1023px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .image-container {
        height: 420px;
      }

      .product-title {
        font-size: 1.8rem;
        margin: 0.8rem 0;
      }

      .current-price {
        font-size: 2.2rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.8rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .benefit-item {
        padding: 1rem;
      }

      .benefit-icon {
        font-size: 1.4rem;
      }

      .benefit-title {
        font-size: 0.85rem;
      }

      .benefit-desc {
        font-size: 0.8rem;
      }

      .options-section {
        padding: 1.5rem;
      }

      .product-header {
        padding-bottom: 1.2rem;
      }
    }

    /* Móvil Grande (480px - 768px) */
    @media (min-width: 480px) and (max-width: 767px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .image-container {
        height: 380px;
      }

      .product-title {
        font-size: 1.6rem;
        margin: 0.6rem 0;
      }

      .current-price {
        font-size: 1.9rem;
      }

      .original-price {
        font-size: 1rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.6rem;
      }

      .benefits {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .benefit-item {
        padding: 0.8rem;
        border-left-width: 3px;
      }

      .benefit-icon {
        font-size: 1.2rem;
      }

      .benefit-title {
        font-size: 0.8rem;
      }

      .benefit-desc {
        font-size: 0.75rem;
      }

      .price-section {
        padding: 1.25rem;
      }

      .options-section {
        padding: 1.25rem;
      }

      .option-label {
        font-size: 0.95rem;
      }

      .radio-label {
        font-size: 0.95rem;
      }

      .btn-add-cart {
        padding: 1.1rem;
        font-size: 1rem;
      }

      .quantity-input {
        width: 75px;
      }
    }

    /* Móvil Mediano (376px - 480px) */
    @media (min-width: 376px) and (max-width: 479px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 1.2rem;
      }

      .image-container {
        height: 340px;
      }

      .product-title {
        font-size: 1.4rem;
        margin: 0.5rem 0;
      }

      .current-price {
        font-size: 1.7rem;
      }

      .original-price {
        font-size: 0.95rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }

      .thumbnail {
        border-radius: 6px;
      }

      .benefits {
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }

      .benefit-item {
        padding: 0.7rem;
        border-left-width: 2px;
      }

      .benefit-icon {
        font-size: 1rem;
      }

      .benefit-title {
        font-size: 0.75rem;
      }

      .benefit-desc {
        font-size: 0.7rem;
      }

      .price-section {
        padding: 1rem;
      }

      .options-section {
        padding: 1rem;
        border-radius: 6px;
      }

      .option-label {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .radio-label {
        font-size: 0.9rem;
      }

      .price-modifier {
        font-size: 0.85rem;
      }

      .btn-add-cart {
        padding: 1rem;
        font-size: 0.95rem;
        margin-top: 0.75rem;
      }

      .quantity-input {
        width: 70px;
        padding: 0.6rem;
      }

      .category-label {
        font-size: 0.7rem;
      }

      .breadcrumb {
        font-size: 0.8rem;
        gap: 0.25rem;
      }
    }

    /* Móvil Pequeño (320px - 376px) */
    @media (max-width: 375px) {
      .product-hero {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .image-container {
        height: 300px;
        width: 100%;
      }

      .product-title {
        font-size: 1.2rem;
        margin: 0.4rem 0;
      }

      .current-price {
        font-size: 1.5rem;
      }

      .original-price {
        font-size: 0.9rem;
      }

      .thumbnail-gallery {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
      }

      .thumbnail {
        border-radius: 5px;
      }

      .benefits {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .benefit-item {
        padding: 0.6rem;
        border-left-width: 2px;
      }

      .benefit-icon {
        font-size: 0.95rem;
      }

      .benefit-title {
        font-size: 0.7rem;
      }

      .benefit-desc {
        font-size: 0.65rem;
      }

      .price-section {
        padding: 0.9rem;
      }

      .options-section {
        padding: 0.9rem;
        border-radius: 5px;
      }

      .option-label {
        font-size: 0.85rem;
        margin-bottom: 0.4rem;
      }

      .radio-label {
        font-size: 0.85rem;
      }

      .price-modifier {
        font-size: 0.8rem;
      }

      .radio-option {
        padding: 0.6rem;
        gap: 0.6rem;
      }

      .radio-option input {
        width: 16px;
        height: 16px;
      }

      .quantity-section {
        flex-direction: column;
        gap: 0.6rem;
        align-items: flex-start;
      }

      .quantity-label {
        font-size: 0.85rem;
      }

      .quantity-input {
        width: 65px;
        padding: 0.5rem;
      }

      .btn-add-cart {
        padding: 0.9rem;
        font-size: 0.9rem;
        margin-top: 0.6rem;
      }

      .category-label {
        font-size: 0.65rem;
        letter-spacing: 1px;
      }

      .breadcrumb {
        font-size: 0.75rem;
        gap: 0.2rem;
        margin-bottom: 1rem;
      }

      .stock-status {
        font-size: 0.85rem;
      }

      .rating {
        font-size: 0.85rem;
      }

      .stars {
        font-size: 0.95rem;
      }

      .loading {
        min-height: 50vh;
        gap: 1rem;
      }

      .loading-spinner {
        width: 35px;
        height: 35px;
        border-width: 2px;
      }
    }
  </style>

  <!-- Estilos globales para HTML generado dinámicamente por JavaScript -->
  <style is:global>
    /* ===== ESTILOS PARA HTML GENERADO POR JS ===== */
    .js-breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
    }

    .js-breadcrumb-link {
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 600;
    }

    .js-breadcrumb-link:hover {
      text-decoration: underline;
    }

    .js-breadcrumb-sep {
      color: var(--text-muted);
    }

    .js-breadcrumb-current {
      color: var(--text-secondary);
    }

    .js-main-grid {
      display: grid;
      grid-template-columns: 1fr 1.3fr;
      gap: 3rem;
      align-items: flex-start;
    }

    .js-images-column {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .js-main-image-container {
      position: relative;
      width: 100%;
      height: 500px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 40px var(--shadow-color);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .js-discount-badge {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: #dc2626;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 800;
      font-size: 0.75rem;
      z-index: 10;
    }

    .js-main-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 1rem;
      transition: transform 0.3s ease;
    }

    .js-thumbnails-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
    }

    .js-thumbnail {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid var(--border-color);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .js-thumbnail.active,
    .js-thumbnail:hover {
      border-color: var(--color-accent);
    }

    .js-thumb-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.5rem;
    }

    .js-details-column {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .js-product-header {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 1.5rem;
    }

    .js-category-badge {
      color: var(--color-accent);
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: 1.5px;
    }

    .js-product-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.2;
      margin: 0.8rem 0;
    }

    .js-stock-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #22c55e;
      font-weight: 600;
    }

    .js-rating {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
      margin-top: 0.75rem;
    }

    .js-rating-stars {
      color: var(--color-accent);
      font-size: 1rem;
    }

    .js-rating-text {
      color: var(--text-muted);
      font-weight: 600;
    }

    .js-price-section {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-light);
    }

    .js-price-main {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .js-price-original {
      font-size: 1rem;
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .js-description {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .js-options-section {
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      border-radius: 8px;
      background: var(--bg-secondary);
    }

    .js-option-group {
      margin-bottom: 1.5rem;
    }

    .js-option-label {
      display: block;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }

    .js-required {
      color: #dc2626;
    }

    .js-radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .js-radio-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .js-radio-option:hover {
      background: var(--bg-tertiary);
    }

    .js-radio-input {
      cursor: pointer;
      width: 18px;
      height: 18px;
      accent-color: var(--color-accent);
    }

    .js-radio-label {
      flex: 1;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-primary);
      margin: 0;
    }

    .js-price-extra {
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .js-quantity-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .js-quantity-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .js-quantity-input {
      width: 80px;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      text-align: center;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    .js-quantity-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .js-add-to-cart {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #a89968, #9a8560);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 6px 20px rgba(168, 153, 104, 0.25);
      margin-top: 1rem;
    }

    .js-add-to-cart:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(168, 153, 104, 0.35);
    }

    .js-benefits-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .js-benefit-item {
      display: flex;
      gap: 0.75rem;
      padding: 1rem;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border-left: 3px solid var(--color-accent);
    }

    .js-benefit-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
      font-weight: 700;
      color: var(--color-accent);
    }

    .js-benefit-content {
      flex: 1;
    }

    .js-benefit-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.8rem;
    }

    .js-benefit-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Responsive para contenido generado por JS */
    @media (max-width: 1024px) {
      .js-main-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .js-main-image-container {
        height: 400px;
      }

      .js-benefits-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .js-thumbnails-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
      }

      .js-product-title {
        font-size: 1.5rem;
      }

      .js-price-main {
        font-size: 2rem;
      }
    }
  </style>

  <div id="productDetails" style="display: none; padding: 2rem;">
    <!-- Se llena con JavaScript -->
  </div>

  <div id="loadingMessage" class="loading">
    <div class="loading-spinner"></div>
    <p class="loading-text" style="font-size: 1.1rem; font-weight: 600;">Cargando producto...</p>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    async function cargarProducto() {
      try {
        const productoId = window.location.pathname.split('/').pop();

        const response = await fetch(`/api/admin/productos`);
        const data = await response.json();

        if (!data.success || !data.productos) {
          mostrarError('Error al cargar el producto');
          return;
        }

        const producto = data.productos.find(p => p.id === parseInt(productoId));
        if (!producto) {
          mostrarError('Producto no encontrado');
          return;
        }

        let oferta = null;
        try {
          const ofertasResponse = await fetch('/api/ofertas');
          const ofertasData = await ofertasResponse.json();
          if (ofertasData.success && ofertasData.data) {
            oferta = ofertasData.data.find(o => o.producto_id === producto.id);
          }
        } catch (error) {
          console.error('Error cargando ofertas:', error);
        }

        const precioOriginal = producto.precio_centimos / 100;
        const precioFinal = oferta ? (oferta.precio_descuento_centimos / 100) : precioOriginal;
        const porcentajeDescuento = oferta ? oferta.porcentaje_descuento : 0;

        const html = `
          <!-- BREADCRUMB -->
          <div class="js-breadcrumb">
            <a href="/productos" class="js-breadcrumb-link">Catálogo</a>
            <span class="js-breadcrumb-sep">/</span>
            <span class="js-breadcrumb-current">${producto.nombre}</span>
          </div>

          <!-- MAIN CONTAINER -->
          <div class="js-main-grid">
            
            <!-- LEFT: IMAGES -->
            <div class="js-images-column">
              
              <!-- MAIN IMAGE -->
              <div class="js-main-image-container">
                ${oferta ? `<div class="js-discount-badge">-${porcentajeDescuento}% OFF</div>` : ''}
                <img id="mainImage" src="${producto.imagen_url}" alt="${producto.nombre}" class="js-main-image" />
              </div>

              <!-- THUMBNAILS -->
              <div class="js-thumbnails-grid">
                <div class="thumbnail js-thumbnail active" onclick="cambiarImagen('${producto.imagen_url}', this)">
                  <img src="${producto.imagen_url}" alt="Vista 1" class="js-thumb-img" />
                </div>
                <div class="thumbnail js-thumbnail" onclick="cambiarImagen('${producto.imagen_url}', this)">
                  <img src="${producto.imagen_url}" alt="Vista 2" class="js-thumb-img" />
                </div>
                <div class="thumbnail js-thumbnail" onclick="cambiarImagen('${producto.imagen_url}', this)">
                  <img src="${producto.imagen_url}" alt="Vista 3" class="js-thumb-img" />
                </div>
                <div class="thumbnail js-thumbnail" onclick="cambiarImagen('${producto.imagen_url}', this)">
                  <img src="${producto.imagen_url}" alt="Vista 4" class="js-thumb-img" />
                </div>
              </div>
            </div>

            <!-- RIGHT: DETAILS -->
            <div class="js-details-column">
              
              <!-- HEADER -->
              <div class="js-product-header">
                <span class="js-category-badge">${producto.categorias?.nombre || 'Producto Premium'}</span>
                <h1 class="js-product-title">${producto.nombre}</h1>
                <div class="js-stock-badge">✓ En stock</div>
                <div class="js-rating">
                  <span class="js-rating-stars">★ ★ ★ ★ ★</span>
                  <span class="js-rating-text">${producto.rating || 4.9}/5 (${Math.floor(Math.random() * 100) + 50} reseñas)</span>
                </div>
              </div>

              <!-- PRICE -->
              <div class="js-price-section">
                <div class="js-price-main">€${precioFinal.toFixed(2)}</div>
                ${oferta ? `<div class="js-price-original">€${precioOriginal.toFixed(2)}</div>` : ''}
              </div>

              <!-- DESCRIPTION -->
              <p class="js-description">${producto.descripcion || 'Producto de calidad premium seleccionado especialmente para usted.'}</p>

              <!-- BENEFITS -->
              <div class="js-benefits-grid">
                <div class="js-benefit-item">
                  <div class="js-benefit-icon">G</div>
                  <div class="js-benefit-content">
                    <div class="js-benefit-title">Garantizado</div>
                    <div class="js-benefit-desc">Frescura asegurada</div>
                  </div>
                </div>
                <div class="js-benefit-item">
                  <div class="js-benefit-icon">E</div>
                  <div class="js-benefit-content">
                    <div class="js-benefit-title">Entrega Rápida</div>
                    <div class="js-benefit-desc">2-3 días laborales</div>
                  </div>
                </div>
                <div class="js-benefit-item">
                  <div class="js-benefit-icon">P</div>
                  <div class="js-benefit-content">
                    <div class="js-benefit-title">Pago Seguro</div>
                    <div class="js-benefit-desc">100% protegido</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.getElementById('productDetails').innerHTML = html;
        document.getElementById('productDetails').style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';

      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error al cargar el producto');
      }
    }

    function cambiarImagen(url, thumbElement) {
      document.getElementById('mainImage').src = url;
      document.querySelectorAll('.js-thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
      });
      thumbElement.classList.add('active');
    }

    function mostrarNotificacion(mensaje, esError = false) {
      const notificacion = document.createElement('div');
      notificacion.textContent = mensaje;
      notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${esError ? '#dc2626' : '#16a34a'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      `;
      document.body.appendChild(notificacion);
      setTimeout(() => {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notificacion.remove(), 300);
      }, 3000);
    }

    // Agregar estilos para animaciones
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    function mostrarError(mensaje) {
      document.getElementById('loadingMessage').innerHTML = `
        <h2 style="color: #dc2626; margin: 0 0 1rem 0;">${mensaje}</h2>
        <a href="/productos" style="
          display: inline-block;
          padding: 0.75rem 1.5rem;
          background: #a89968;
          color: white;
          text-decoration: none;
          border-radius: 6px;
          font-weight: 600;
        ">Volver al Catálogo</a>
      `;
    }

    async function agregarAlCarrito(productoId) {
      try {
        const userId = localStorage.getItem('user_id');
        
        // Si es invitado, guardar en localStorage
        if (!userId) {
          agregarAlCarritoLocal(productoId);
          return;
        }

        const cantidad = parseInt(document.getElementById('cantidad').value) || 1;
        const corte = document.querySelector('input[name="corte"]:checked').value;

        const response = await fetch('/api/carrito', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': userId
          },
          body: JSON.stringify({
            producto_id: productoId,
            cantidad: cantidad,
            user_id: userId,
            producto_variante_id: null,
            peso_kg: null
          })
        });

        const data = await response.json();
        if (data.success || response.ok) {
          mostrarNotificacion('✓ Producto agregado al carrito');
          // Disparar evento para actualizar el carrito
          window.dispatchEvent(new CustomEvent('carritoActualizado'));
        } else {
          mostrarNotificacion('❌ Error: ' + (data.message || data.error), true);
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('❌ Error al agregar al carrito', true);
      }
    }

    // Agregar al carrito local para invitados
    function agregarAlCarritoLocal(productoId) {
      try {
        const cantidad = parseInt(document.getElementById('cantidad').value) || 1;
        const nombre = document.querySelector('h1')?.textContent || 'Producto';
        const precioElement = document.querySelector('[data-product-price]');
        const precio = parseInt(precioElement?.getAttribute('data-product-price') || '0');
        const imagenElement = document.querySelector('img[alt*="Jamón"]');
        const imagen = imagenElement?.src || '';

        // Obtener carrito actual
        let carrito = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');

        // Crear item
        const item = {
          id: Date.now(),
          producto_id: parseInt(productoId),
          nombre,
          precio_unitario: precio,
          cantidad,
          imagen,
          fecha_agregado: new Date().toISOString()
        };

        // Verificar si ya existe
        const existe = carrito.find(c => c.producto_id === parseInt(productoId));
        if (existe) {
          existe.cantidad += cantidad;
          mostrarNotificacion(`✓ Producto actualizado (${existe.cantidad}x)`);
        } else {
          carrito.push(item);
          mostrarNotificacion('✓ Producto agregado al carrito');
        }

        // Guardar en localStorage
        localStorage.setItem('carrito_invitado', JSON.stringify(carrito));
        localStorage.setItem('carrito_invitado_fecha', String(Date.now()));
        console.log('✅ Carrito invitado actualizado');
        
        // Disparar evento
        window.dispatchEvent(new CustomEvent('carritoActualizado'));
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('❌ Error al agregar al carrito', true);
      }
    }

    cargarProducto();
  </script>
</Layout>
