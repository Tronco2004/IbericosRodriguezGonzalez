---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <style is:global>
    /* Estilos para tabla de categor√≠as en modo oscuro */
    .cat-nombre {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .cat-descripcion {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .cat-count {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* Botones de acci√≥n para tablas */
    .admin-table-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .admin-btn-edit {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .admin-btn-edit:hover {
      background: var(--color-accent);
      color: white;
      border-color: var(--color-accent);
    }
    
    .admin-btn-delete {
      background: var(--bg-tertiary);
      color: #ef4444;
      border: 1px solid var(--border-color);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .admin-btn-delete:hover {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
  </style>
  
  <div class="admin-page">
    <div class="admin-container">
      <!-- Header -->
      <div class="admin-header">
        <a href="/admin/dashboard" class="admin-back-btn">‚Üê</a>
        <h1 class="admin-title">Gesti√≥n de Categor√≠as</h1>
        <p class="admin-subtitle">Administra las categor√≠as de productos de tu tienda</p>
      </div>

      <!-- Action Bar -->
      <div class="admin-action-bar">
        <div class="admin-filters">
          <input type="text" id="searchInput" placeholder="Buscar categor√≠as..." class="admin-search-input" />
        </div>

        <button id="btnNuevaCategoria" class="admin-btn-primary">
          + Nueva Categor√≠a
        </button>
      </div>

      <!-- Tabla de Categor√≠as -->
      <div class="admin-table-container">
        <div class="admin-table-scroll">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Descripci√≥n</th>
                <th class="center">Productos</th>
                <th class="center">Estado</th>
                <th class="center">Acciones</th>
              </tr>
            </thead>
            <tbody id="categoriasTable">
              <!-- Cargar√° con JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" class="admin-empty-state" style="display: none;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
          <p>No hay categor√≠as que mostrar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar categor√≠a -->
  <div id="categoriaModal" class="admin-modal-overlay" style="display: none;">
    <div class="admin-modal">
      <h2 id="modalTitle" class="admin-modal-title">Nueva Categor√≠a</h2>
      
      <form id="categoriaForm" class="admin-form">
        <div class="admin-form-group">
          <label class="admin-label">Nombre de la Categor√≠a</label>
          <input type="text" id="nombre" placeholder="Ej: Jamones Ib√©ricos" class="admin-input" required />
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Slug (para URL)</label>
          <input type="text" id="slug" placeholder="Ej: jamones-ibericos" class="admin-input" required />
          <p class="admin-hint">Se usa en las URLs de la tienda</p>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Descripci√≥n</label>
          <textarea id="descripcion" placeholder="Describe la categor√≠a..." class="admin-textarea"></textarea>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Estado</label>
          <select id="estado" class="admin-input">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>

        <div class="admin-form-actions">
          <button type="submit" class="admin-btn-primary">
            Guardar Categor√≠a
          </button>
          <button type="button" id="btnCancelar" class="admin-btn-secondary">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'ibericosRG_categorias';
    
    // Categor√≠as por defecto
    const categoriasDefault = [
      { id: 1, nombre: 'Jamones', slug: 'jamones', descripcion: 'Jamones ib√©ricos de bellota curados tradicionalmente', activa: true },
      { id: 2, nombre: 'Quesos', slug: 'quesos', descripcion: 'Quesos artesanales de la regi√≥n ib√©rica', activa: true },
      { id: 3, nombre: 'Embutidos', slug: 'embutidos', descripcion: 'Chorizos, morcillas y embutidos de bellota', activa: true }
    ];

    let categorias = [];
    let editandoId = null;

    // Cargar categor√≠as desde Supabase
    async function cargarCategorias() {
      try {
        const response = await fetch('/api/admin/categorias');
        const data = await response.json();
        
        if (data.success && data.categorias.length > 0) {
          categorias = data.categorias;
        } else {
          // Si no hay categor√≠as en BD, crear las por defecto
          categorias = [...categoriasDefault];
          for (const cat of categoriasDefault) {
            await guardarCategoria(cat);
          }
        }
      } catch (error) {
        console.error('Error cargando categor√≠as:', error);
        categorias = [...categoriasDefault];
      }
      renderizarTabla();
    }

    async function guardarCategoria(categoria) {
      try {
        const response = await fetch('/api/admin/categorias', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nombre: categoria.nombre,
            slug: categoria.slug,
            descripcion: categoria.descripcion,
            imagen_url: categoria.imagen_url || 'https://via.placeholder.com/500'
          })
        });
        const data = await response.json();
        
        if (!data.success) {
          console.error('Error del servidor:', data.message, data.details);
          alert('Error: ' + (data.message || 'Error al guardar la categor√≠a'));
          return false;
        }
        
        return data.success;
      } catch (error) {
        console.error('Error guardando categor√≠a:', error);
        alert('Error de conexi√≥n: ' + error.message);
        return false;
      }
    }

    async function actualizarCategoria(id, categoria) {
      try {
        const response = await fetch('/api/admin/categorias', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id,
            nombre: categoria.nombre,
            slug: categoria.slug,
            descripcion: categoria.descripcion,
            imagen_url: categoria.imagen_url || 'https://via.placeholder.com/500',
            activa: categoria.activa
          })
        });
        const data = await response.json();
        return data.success;
      } catch (error) {
        console.error('Error actualizando categor√≠a:', error);
        return false;
      }
    }

    async function eliminarCategoriaAPI(id) {
      try {
        const response = await fetch(`/api/admin/categorias?id=${id}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        return data.success;
      } catch (error) {
        console.error('Error eliminando categor√≠a:', error);
        return false;
      }
    }

    function renderizarTabla() {
      const tabla = document.getElementById('categoriasTable');
      const emptyState = document.getElementById('emptyState');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      const filtradas = categorias.filter(c => 
        c.nombre.toLowerCase().includes(searchTerm) ||
        c.descripcion.toLowerCase().includes(searchTerm)
      );

      if (filtradas.length === 0) {
        tabla.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      tabla.innerHTML = filtradas.map(cat => `
        <tr>
          <td>
            <div class="cat-nombre">${cat.nombre}</div>
          </td>
          <td>
            <div class="cat-descripcion">${cat.descripcion.substring(0, 50)}${cat.descripcion.length > 50 ? '...' : ''}</div>
          </td>
          <td class="center">
            <div class="cat-count" id="count-${cat.id}">0</div>
          </td>
          <td class="center">
            <span class="admin-badge ${cat.activa ? 'success' : 'danger'}">${cat.activa ? '‚úì Activo' : '‚úó Inactivo'}</span>
          </td>
          <td class="center">
            <div class="admin-table-actions">
              <button onclick="editarCategoria(${cat.id})" class="admin-btn-edit">
                Editar
              </button>
              <button onclick="eliminarCategoria(${cat.id})" class="admin-btn-delete">
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      // Contar productos por categor√≠a
      const productosStored = localStorage.getItem('ibericosRG_productos');
      if (productosStored) {
        try {
          const productos = JSON.parse(productosStored);
          filtradas.forEach(cat => {
            const count = productos.filter(p => p.categoria === cat.slug).length;
            const elem = document.getElementById(`count-${cat.id}`);
            if (elem) elem.textContent = count;
          });
        } catch (e) {
          console.error('Error contando productos:', e);
        }
      }
    }

    function editarCategoria(id) {
      editandoId = id;
      const cat = categorias.find(c => c.id === id);
      if (cat) {
        document.getElementById('modalTitle').textContent = 'Editar Categor√≠a';
        document.getElementById('nombre').value = cat.nombre;
        document.getElementById('slug').value = cat.slug;
        document.getElementById('descripcion').value = cat.descripcion;
        document.getElementById('estado').value = cat.activa ? 'true' : 'false';
        document.getElementById('categoriaModal').style.display = 'flex';
      }
    }

    async function eliminarCategoria(id) {
      if (confirm('¬øEst√° seguro de que desea eliminar esta categor√≠a?')) {
        const success = await eliminarCategoriaAPI(id);
        if (success) {
          categorias = categorias.filter(c => c.id !== id);
          renderizarTabla();
        } else {
          alert('Error al eliminar la categor√≠a');
        }
      }
    }

    // Event Listeners
    document.getElementById('btnNuevaCategoria').addEventListener('click', () => {
      editandoId = null;
      document.getElementById('modalTitle').textContent = 'Nueva Categor√≠a';
      document.getElementById('categoriaForm').reset();
      document.getElementById('categoriaModal').style.display = 'flex';
    });

    document.getElementById('btnCancelar').addEventListener('click', () => {
      document.getElementById('categoriaModal').style.display = 'none';
    });

    document.getElementById('categoriaModal').addEventListener('click', (e) => {
      if (e.target.id === 'categoriaModal') {
        document.getElementById('categoriaModal').style.display = 'none';
      }
    });

    document.getElementById('categoriaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nombre = document.getElementById('nombre').value;
      const slug = document.getElementById('slug').value;
      const descripcion = document.getElementById('descripcion').value;
      const activa = document.getElementById('estado').value === 'true';

      let success = false;

      if (editandoId) {
        success = await actualizarCategoria(editandoId, { nombre, slug, descripcion, activa });
        if (success) {
          const cat = categorias.find(c => c.id === editandoId);
          if (cat) {
            cat.nombre = nombre;
            cat.slug = slug;
            cat.descripcion = descripcion;
            cat.activa = activa;
          }
        }
      } else {
        success = await guardarCategoria({ nombre, slug, descripcion, activa });
        if (success) {
          // Recargar categor√≠as para obtener el ID de la BD
          await cargarCategorias();
        }
      }

      if (success) {
        document.getElementById('categoriaModal').style.display = 'none';
        renderizarTabla();
      } else {
        alert('Error al guardar la categor√≠a');
      }
    });

    document.getElementById('searchInput').addEventListener('input', renderizarTabla);

    // Cargar al iniciar
    cargarCategorias();
  </script>
</ProtectedLayout>
