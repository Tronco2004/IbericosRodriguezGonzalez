---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <div style="min-height: 100vh; background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%); padding: 3rem 2rem;">
    <div style="max-width: 1400px; margin: 0 auto;">
      <!-- Header -->
      <div style="margin-bottom: 3rem;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
          <a href="/admin/dashboard" style="
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #0f172a;
            text-decoration: none;
            font-size: 1.2rem;
            transition: all 0.3s;
          " onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#cbd5e1'" onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0'">‚Üê</a>
        </div>
        <h1 style="color: #0f172a; font-size: 2.5rem; margin: 0; font-weight: 900; letter-spacing: -0.5px;">Gesti√≥n de Categor√≠as</h1>
        <p style="color: #64748b; margin: 0.5rem 0 0 0; font-size: 1rem;">Administra las categor√≠as de productos de tu tienda</p>
      </div>

      <!-- Action Bar -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; gap: 1rem; flex-wrap: wrap;">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <input type="text" id="searchInput" placeholder="Buscar categor√≠as..." style="
            padding: 0.75rem 1.25rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            min-width: 250px;
            transition: all 0.3s;
            background: white;
          " onmouseover="this.style.borderColor='#cbd5e1'" onmouseout="this.style.borderColor='#e2e8f0'" />
        </div>

        <button id="btnNuevaCategoria" style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 0.75rem 1.5rem;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          font-size: 0.95rem;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
          + Nueva Categor√≠a
        </button>
      </div>

      <!-- Tabla de Categor√≠as -->
      <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 1px solid #e2e8f0; overflow: hidden;">
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <th style="padding: 1.25rem; text-align: left; color: #0f172a; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Nombre</th>
                <th style="padding: 1.25rem; text-align: left; color: #0f172a; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Descripci√≥n</th>
                <th style="padding: 1.25rem; text-align: center; color: #0f172a; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Productos</th>
                <th style="padding: 1.25rem; text-align: center; color: #0f172a; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Estado</th>
                <th style="padding: 1.25rem; text-align: center; color: #0f172a; font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="categoriasTable">
              <!-- Cargar√° con JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" style="display: none; padding: 3rem; text-align: center;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
          <p style="color: #64748b; font-size: 1rem;">No hay categor√≠as que mostrar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar categor√≠a -->
  <div id="categoriaModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
      <h2 id="modalTitle" style="color: #0f172a; font-size: 1.5rem; margin: 0 0 1.5rem 0; font-weight: 700;">Nueva Categor√≠a</h2>
      
      <form id="categoriaForm" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div>
          <label style="display: block; color: #0f172a; font-weight: 600; margin-bottom: 0.5rem;">Nombre de la Categor√≠a</label>
          <input type="text" id="nombre" placeholder="Ej: Jamones Ib√©ricos" style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-sizing: border-box;
          " required />
        </div>

        <div>
          <label style="display: block; color: #0f172a; font-weight: 600; margin-bottom: 0.5rem;">Slug (para URL)</label>
          <input type="text" id="slug" placeholder="Ej: jamones-ibericos" style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-sizing: border-box;
          " required />
          <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.85rem;">Se usa en las URLs de la tienda</p>
        </div>

        <div>
          <label style="display: block; color: #0f172a; font-weight: 600; margin-bottom: 0.5rem;">Descripci√≥n</label>
          <textarea id="descripcion" placeholder="Describe la categor√≠a..." style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-sizing: border-box;
            min-height: 100px;
            font-family: inherit;
            resize: vertical;
          "></textarea>
        </div>

        <div>
          <label style="display: block; color: #0f172a; font-weight: 600; margin-bottom: 0.5rem;">Estado</label>
          <select id="estado" style="
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-sizing: border-box;
          ">
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" style="
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
          " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
            Guardar Categor√≠a
          </button>
          <button type="button" id="btnCancelar" style="
            flex: 1;
            background: white;
            color: #0f172a;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
          " onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'ibericosRG_categorias';
    
    // Categor√≠as por defecto
    const categoriasDefault = [
      { id: 1, nombre: 'Jamones', slug: 'jamones', descripcion: 'Jamones ib√©ricos de bellota y otros tipos', estado: 'activo' },
      { id: 2, nombre: 'Quesos', slug: 'quesos', descripcion: 'Quesos artesanales y premium', estado: 'activo' },
      { id: 3, nombre: 'Embutidos', slug: 'embutidos', descripcion: 'Chorizos, salchichones y embutidos ib√©ricos', estado: 'activo' }
    ];

    let categorias = [];
    let editandoId = null;

    // Cargar categor√≠as
    function cargarCategorias() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          categorias = JSON.parse(stored);
        } catch {
          categorias = [...categoriasDefault];
          guardarCategoriasLocales();
        }
      } else {
        categorias = [...categoriasDefault];
        guardarCategoriasLocales();
      }
      renderizarTabla();
    }

    function guardarCategoriasLocales() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(categorias));
    }

    function renderizarTabla() {
      const tabla = document.getElementById('categoriasTable');
      const emptyState = document.getElementById('emptyState');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      const filtradas = categorias.filter(c => 
        c.nombre.toLowerCase().includes(searchTerm) ||
        c.descripcion.toLowerCase().includes(searchTerm)
      );

      if (filtradas.length === 0) {
        tabla.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      tabla.innerHTML = filtradas.map(cat => `
        <tr style="border-bottom: 1px solid #e2e8f0; transition: all 0.3s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
          <td style="padding: 1.25rem; text-align: left;">
            <div style="font-weight: 600; color: #0f172a;">${cat.nombre}</div>
          </td>
          <td style="padding: 1.25rem; text-align: left;">
            <div style="color: #64748b; font-size: 0.9rem;">${cat.descripcion.substring(0, 50)}${cat.descripcion.length > 50 ? '...' : ''}</div>
          </td>
          <td style="padding: 1.25rem; text-align: center;">
            <div style="color: #0f172a; font-weight: 600;" id="count-${cat.id}">0</div>
          </td>
          <td style="padding: 1.25rem; text-align: center;">
            <span style="
              display: inline-block;
              padding: 0.4rem 0.8rem;
              border-radius: 20px;
              font-size: 0.8rem;
              font-weight: 600;
              ${cat.estado === 'activo' ? 'background: #dcfce7; color: #166534;' : 'background: #fee2e2; color: #991b1b;'}
            ">${cat.estado === 'activo' ? '‚úì Activo' : '‚úó Inactivo'}</span>
          </td>
          <td style="padding: 1.25rem; text-align: center;">
            <div style="display: flex; gap: 0.5rem; justify-content: center;">
              <button onclick="editarCategoria(${cat.id})" style="
                padding: 0.5rem 1rem;
                background: #e0e7ff;
                color: #3730a3;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.85rem;
                transition: all 0.3s;
              " onmouseover="this.style.background='#c7d2fe'" onmouseout="this.style.background='#e0e7ff'">
                ‚úèÔ∏è Editar
              </button>
              <button onclick="eliminarCategoria(${cat.id})" style="
                padding: 0.5rem 1rem;
                background: #fee2e2;
                color: #991b1b;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.85rem;
                transition: all 0.3s;
              " onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#fee2e2'">
                üóëÔ∏è Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      // Contar productos por categor√≠a
      const productosStored = localStorage.getItem('ibericosRG_productos');
      if (productosStored) {
        try {
          const productos = JSON.parse(productosStored);
          filtradas.forEach(cat => {
            const count = productos.filter(p => p.categoria === cat.slug).length;
            const elem = document.getElementById(`count-${cat.id}`);
            if (elem) elem.textContent = count;
          });
        } catch (e) {
          console.error('Error contando productos:', e);
        }
      }
    }

    function editarCategoria(id) {
      editandoId = id;
      const cat = categorias.find(c => c.id === id);
      if (cat) {
        document.getElementById('modalTitle').textContent = 'Editar Categor√≠a';
        document.getElementById('nombre').value = cat.nombre;
        document.getElementById('slug').value = cat.slug;
        document.getElementById('descripcion').value = cat.descripcion;
        document.getElementById('estado').value = cat.estado;
        document.getElementById('categoriaModal').style.display = 'flex';
      }
    }

    function eliminarCategoria(id) {
      if (confirm('¬øEst√° seguro de que desea eliminar esta categor√≠a?')) {
        categorias = categorias.filter(c => c.id !== id);
        guardarCategoriasLocales();
        renderizarTabla();
      }
    }

    // Event Listeners
    document.getElementById('btnNuevaCategoria').addEventListener('click', () => {
      editandoId = null;
      document.getElementById('modalTitle').textContent = 'Nueva Categor√≠a';
      document.getElementById('categoriaForm').reset();
      document.getElementById('categoriaModal').style.display = 'flex';
    });

    document.getElementById('btnCancelar').addEventListener('click', () => {
      document.getElementById('categoriaModal').style.display = 'none';
    });

    document.getElementById('categoriaModal').addEventListener('click', (e) => {
      if (e.target.id === 'categoriaModal') {
        document.getElementById('categoriaModal').style.display = 'none';
      }
    });

    document.getElementById('categoriaForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const nombre = document.getElementById('nombre').value;
      const slug = document.getElementById('slug').value;
      const descripcion = document.getElementById('descripcion').value;
      const estado = document.getElementById('estado').value;

      if (editandoId) {
        const cat = categorias.find(c => c.id === editandoId);
        if (cat) {
          cat.nombre = nombre;
          cat.slug = slug;
          cat.descripcion = descripcion;
          cat.estado = estado;
        }
      } else {
        const newId = Math.max(...categorias.map(c => c.id), 0) + 1;
        categorias.push({ id: newId, nombre, slug, descripcion, estado });
      }

      guardarCategoriasLocales();
      document.getElementById('categoriaModal').style.display = 'none';
      renderizarTabla();
    });

    document.getElementById('searchInput').addEventListener('input', renderizarTabla);

    // Cargar al iniciar
    cargarCategorias();
  </script>
</ProtectedLayout>
