---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <style is:global>
    /* Estilos para tabla de categor√≠as en modo oscuro */
    .cat-nombre {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .cat-descripcion {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .cat-count {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* Botones de acci√≥n para tablas */
    .admin-table-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .admin-btn-edit {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .admin-btn-edit:hover {
      background: var(--color-accent);
      color: white;
      border-color: var(--color-accent);
    }
    
    .admin-btn-delete {
      background: var(--bg-tertiary);
      color: #ef4444;
      border: 1px solid var(--border-color);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .admin-btn-delete:hover {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
  </style>
  
  <div class="admin-page">
    <div class="admin-container">
      <!-- Header -->
      <div class="admin-header">
        <a href="/admin/dashboard" class="admin-back-btn">‚Üê</a>
        <h1 class="admin-title">Gesti√≥n de Categor√≠as</h1>
        <p class="admin-subtitle">Administra las categor√≠as de productos de tu tienda</p>
      </div>

      <!-- Action Bar -->
      <div class="admin-action-bar">
        <div class="admin-filters">
          <input type="text" id="searchInput" placeholder="Buscar categor√≠as..." class="admin-search-input" />
        </div>

        <button id="btnNuevaCategoria" class="admin-btn-primary">
          + Nueva Categor√≠a
        </button>
      </div>

      <!-- Tabla de Categor√≠as -->
      <div class="admin-table-container">
        <div class="admin-table-scroll">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Descripci√≥n</th>
                <th class="center">Subcategor√≠as</th>
                <th class="center">Estado</th>
                <th class="center">Acciones</th>
              </tr>
            </thead>
            <tbody id="categoriasTable">
              <!-- Cargar√° con JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" class="admin-empty-state" style="display: none;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
          <p>No hay categor√≠as que mostrar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n para eliminar -->
  <div id="modalEliminar" class="admin-modal-overlay" style="display: none;">
    <div class="admin-modal" style="max-width: 400px;">
      <h2 class="admin-modal-title">Confirmar Eliminaci√≥n</h2>
      <p style="color: var(--text-muted); margin: 1.5rem 0;">
        ¬øEst√° seguro de que desea eliminar esta categor√≠a? Esta acci√≥n no se puede deshacer.
      </p>
      <div class="admin-form-actions" style="gap: 1rem;">
        <button id="btnConfirmarEliminar" class="admin-btn-primary" style="background: #ef4444;">
          Eliminar
        </button>
        <button id="btnCancelarEliminar" class="admin-btn-secondary">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para crear/editar categor√≠a -->
  <div id="categoriaModal" class="admin-modal-overlay" style="display: none;">
    <div class="admin-modal">
      <h2 id="modalTitle" class="admin-modal-title">Nueva Categor√≠a</h2>
      
      <form id="categoriaForm" class="admin-form">
        <div class="admin-form-group">
          <label class="admin-label">Nombre de la Categor√≠a</label>
          <input type="text" id="nombre" placeholder="Ej: Jamones Ib√©ricos" class="admin-input" required />
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Slug (para URL)</label>
          <input type="text" id="slug" placeholder="Ej: jamones-ibericos" class="admin-input" required />
          <p class="admin-hint">Se usa en las URLs de la tienda</p>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Descripci√≥n</label>
          <textarea id="descripcion" placeholder="Describe la categor√≠a..." class="admin-textarea"></textarea>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Categor√≠a Padre (Subcategor√≠a de)</label>
          <select id="categoria_padre" class="admin-input">
            <option value="">Ninguna (Categor√≠a principal)</option>
          </select>
          <p class="admin-hint">Dejar vac√≠o si es una categor√≠a principal</p>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Orden de Visualizaci√≥n</label>
          <input type="number" id="orden" placeholder="Ej: 1" class="admin-input" value="0" />
          <p class="admin-hint">Menor n√∫mero = m√°s arriba en el men√∫</p>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Estado</label>
          <select id="estado" class="admin-input">
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </div>

        <div class="admin-form-actions">
          <button type="submit" class="admin-btn-primary">
            Guardar Categor√≠a
          </button>
          <button type="button" id="btnCancelar" class="admin-btn-secondary">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- PopUp de notificaciones -->
  <div id="popupNotificacion" class="popup-notificacion" style="display: none;">
    <div class="popup-icono" id="popupIcono"></div>
    <span class="popup-mensaje" id="popupMensaje"></span>
  </div>

  <script>
    let popupTimeout;
    function showPopup(mensaje, tipo = 'success') {
      const popup = document.getElementById('popupNotificacion');
      const icono = document.getElementById('popupIcono');
      const msg = document.getElementById('popupMensaje');
      if (popupTimeout) clearTimeout(popupTimeout);
      icono.textContent = tipo === 'success' ? '\u2713' : '\u2715';
      msg.textContent = mensaje;
      popup.className = `popup-notificacion popup-${tipo} popup-visible`;
      popup.style.display = 'flex';
      popupTimeout = setTimeout(() => {
        popup.classList.remove('popup-visible');
        popup.classList.add('popup-hide');
        setTimeout(() => { popup.style.display = 'none'; popup.classList.remove('popup-hide'); }, 400);
      }, 3000);
    }

    const STORAGE_KEY = 'ibericosRG_categorias';
    
    // Categor√≠as por defecto
    const categoriasDefault = [
      { id: 1, nombre: 'Jamones', slug: 'jamones', descripcion: 'Jamones ib√©ricos de bellota curados tradicionalmente', activa: true },
      { id: 2, nombre: 'Quesos', slug: 'quesos', descripcion: 'Quesos artesanales de la regi√≥n ib√©rica', activa: true },
      { id: 3, nombre: 'Embutidos', slug: 'embutidos', descripcion: 'Chorizos, morcillas y embutidos de bellota', activa: true }
    ];

    let categorias = [];
    let editandoId = null;
    let eliminandoId = null;

    // Actualizar el select de categor√≠a padre
    function actualizarSelectCategoriaPadre() {
      const select = document.getElementById('categoria_padre');
      const currentId = select.value;
      
      // Obtener categor√≠as sin la actual (si estamos editando)
      const categoriasDisponibles = editandoId 
        ? categorias.filter(c => c.id !== editandoId)
        : categorias;
      
      // Crear opciones
      const opciones = '<option value="">Ninguna (Categor√≠a principal)</option>' +
        categoriasDisponibles.map(cat => 
          `<option value="${cat.id}">${cat.nombre}</option>`
        ).join('');
      
      select.innerHTML = opciones;
      if (currentId) select.value = currentId;
    }

    // Cargar categor√≠as desde Supabase
    async function cargarCategorias() {
      try {
        const response = await fetch('/api/admin/categorias');
        const data = await response.json();
        
        if (data.success && data.categorias.length > 0) {
          categorias = data.categorias;
        } else {
          // Si no hay categor√≠as en BD, crear las por defecto
          categorias = [...categoriasDefault];
          for (const cat of categoriasDefault) {
            await guardarCategoria(cat);
          }
        }
      } catch (error) {
        console.error('Error cargando categor√≠as:', error);
        categorias = [...categoriasDefault];
      }
      renderizarTabla();
      actualizarSelectCategoriaPadre();
    }

    async function guardarCategoria(categoria) {
      try {
        const response = await fetch('/api/admin/categorias', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nombre: categoria.nombre,
            slug: categoria.slug,
            descripcion: categoria.descripcion,
            imagen_url: categoria.imagen_url || 'https://via.placeholder.com/500',
            categoria_padre: categoria.categoria_padre || null,
            orden: categoria.orden || 0
          })
        });
        const data = await response.json();
        
        if (!data.success) {
          console.error('Error del servidor:', data.message, data.details);
          showPopup('Error: ' + (data.message || 'Error al guardar la categor√≠a'), 'error');
          return false;
        }
        
        return data.success;
      } catch (error) {
        console.error('Error guardando categor√≠a:', error);
        showPopup('Error de conexi√≥n: ' + error.message, 'error');
        return false;
      }
    }

    async function actualizarCategoria(id, categoria) {
      try {
        const response = await fetch('/api/admin/categorias', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id,
            nombre: categoria.nombre,
            slug: categoria.slug,
            descripcion: categoria.descripcion,
            imagen_url: categoria.imagen_url || 'https://via.placeholder.com/500',
            activa: categoria.activa !== undefined ? categoria.activa : true,
            categoria_padre: categoria.categoria_padre || null,
            orden: categoria.orden || 0
          })
        });
        const data = await response.json();
        
        if (!data.success) {
          console.error('Error actualizando categor√≠a:', data.message);
          showPopup('Error: ' + (data.message || 'Error al actualizar la categor√≠a'), 'error');
          return false;
        }
        
        return data.success;
      } catch (error) {
        console.error('Error actualizando categor√≠a:', error);
        showPopup('Error de conexi√≥n: ' + error.message, 'error');
        return false;
      }
    }

    async function eliminarCategoriaAPI(id) {
      try {
        const response = await fetch(`/api/admin/categorias?id=${id}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        return data.success;
      } catch (error) {
        console.error('Error eliminando categor√≠a:', error);
        return false;
      }
    }

    function renderizarTabla() {
      const tabla = document.getElementById('categoriasTable');
      const emptyState = document.getElementById('emptyState');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      const filtradas = categorias.filter(c => 
        c.nombre.toLowerCase().includes(searchTerm) ||
        c.descripcion.toLowerCase().includes(searchTerm)
      );

      if (filtradas.length === 0) {
        tabla.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      tabla.innerHTML = filtradas.map(cat => {
        const categoriaPadre = cat.categoria_padre 
          ? categorias.find(c => c.id === cat.categoria_padre)?.nombre 
          : null;
        const subcategorias = categorias.filter(c => c.categoria_padre === cat.id).length;
        
        return `
        <tr>
          <td>
            <div class="cat-nombre">
              ${cat.nombre}
              ${categoriaPadre ? `<br><small style="color: var(--text-muted);">Subcategor√≠a de: ${categoriaPadre}</small>` : ''}
            </div>
          </td>
          <td>
            <div class="cat-descripcion">${cat.descripcion.substring(0, 50)}${cat.descripcion.length > 50 ? '...' : ''}</div>
          </td>
          <td class="center">
            <div class="cat-count">${subcategorias > 0 ? `${subcategorias} sub.` : '-'}</div>
          </td>
          <td class="center">
            <span class="admin-badge ${cat.activa ? 'success' : 'danger'}">${cat.activa ? '‚úì Activo' : '‚úó Inactivo'}</span>
          </td>
          <td class="center">
            <div class="admin-table-actions">
              <button onclick="window.editarCategoria(${cat.id})" class="admin-btn-edit" title="Editar categor√≠a">
                Editar
              </button>
              <button onclick="window.eliminarCategoria(${cat.id})" class="admin-btn-delete" title="Eliminar categor√≠a">
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      `}).join('');

      // Contar productos por categor√≠a
      const productosStored = localStorage.getItem('ibericosRG_productos');
      if (productosStored) {
        try {
          const productos = JSON.parse(productosStored);
          filtradas.forEach(cat => {
            const count = productos.filter(p => p.categoria === cat.slug).length;
            const elem = document.getElementById(`count-${cat.id}`);
            if (elem) elem.textContent = count;
          });
        } catch (e) {
          console.error('Error contando productos:', e);
        }
      }
    }

    function editarCategoria(id) {
      editandoId = id;
      const cat = categorias.find(c => c.id === id);
      if (cat) {
        document.getElementById('modalTitle').textContent = 'Editar Categor√≠a';
        document.getElementById('nombre').value = cat.nombre;
        document.getElementById('slug').value = cat.slug;
        document.getElementById('descripcion').value = cat.descripcion;
        document.getElementById('categoria_padre').value = cat.categoria_padre || '';
        document.getElementById('orden').value = cat.orden || 0;
        document.getElementById('estado').value = cat.activa ? 'true' : 'false';
        document.getElementById('categoriaModal').style.display = 'flex';
      }
    }

    async function eliminarCategoria(id) {
      eliminandoId = id;
      document.getElementById('modalEliminar').style.display = 'flex';
    }

    // Exponemos las funciones globalmente
    window.editarCategoria = editarCategoria;
    window.eliminarCategoria = eliminarCategoria;

    // Event Listeners para modal de eliminar
    document.getElementById('btnConfirmarEliminar').addEventListener('click', async () => {
      if (eliminandoId) {
        const success = await eliminarCategoriaAPI(eliminandoId);
        if (success) {
          categorias = categorias.filter(c => c.id !== eliminandoId);
          renderizarTabla();
          document.getElementById('modalEliminar').style.display = 'none';
          eliminandoId = null;
        } else {
          showPopup('Error al eliminar la categor√≠a', 'error');
        }
      }
    });

    document.getElementById('btnCancelarEliminar').addEventListener('click', () => {
      document.getElementById('modalEliminar').style.display = 'none';
      eliminandoId = null;
    });

    document.getElementById('modalEliminar').addEventListener('click', (e) => {
      if (e.target.id === 'modalEliminar') {
        document.getElementById('modalEliminar').style.display = 'none';
        eliminandoId = null;
      }
    });

    // Event Listeners
    document.getElementById('btnNuevaCategoria').addEventListener('click', () => {
      editandoId = null;
      document.getElementById('modalTitle').textContent = 'Nueva Categor√≠a';
      document.getElementById('categoriaForm').reset();
      document.getElementById('orden').value = '0';
      actualizarSelectCategoriaPadre();
      document.getElementById('categoriaModal').style.display = 'flex';
    });

    document.getElementById('btnCancelar').addEventListener('click', () => {
      document.getElementById('categoriaModal').style.display = 'none';
    });

    document.getElementById('categoriaModal').addEventListener('click', (e) => {
      if (e.target.id === 'categoriaModal') {
        document.getElementById('categoriaModal').style.display = 'none';
      }
    });

    document.getElementById('categoriaForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nombre = document.getElementById('nombre').value;
      const slug = document.getElementById('slug').value;
      const descripcion = document.getElementById('descripcion').value;
      const categoria_padre = document.getElementById('categoria_padre').value || null;
      const orden = parseInt(document.getElementById('orden').value) || 0;
      const activa = document.getElementById('estado').value === 'true';

      let success = false;

      if (editandoId) {
        success = await actualizarCategoria(editandoId, { nombre, slug, descripcion, activa, categoria_padre, orden });
        if (success) {
          const cat = categorias.find(c => c.id === editandoId);
          if (cat) {
            cat.nombre = nombre;
            cat.slug = slug;
            cat.descripcion = descripcion;
            cat.activa = activa;
            cat.categoria_padre = categoria_padre;
            cat.orden = orden;
          }
        }
      } else {
        success = await guardarCategoria({ nombre, slug, descripcion, activa, categoria_padre, orden });
        if (success) {
          // Recargar categor√≠as para obtener el ID de la BD
          await cargarCategorias();
        }
      }

      if (success) {
        document.getElementById('categoriaModal').style.display = 'none';
        renderizarTabla();
      } else {
        showPopup('Error al guardar la categor√≠a', 'error');
      }
    });

    document.getElementById('searchInput').addEventListener('input', renderizarTabla);

    // Cargar al iniciar
    cargarCategorias();
  </script>

  <style>
    .popup-notificacion { position: fixed; top: 2rem; right: 2rem; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-radius: 12px; font-size: 0.95rem; font-weight: 600; z-index: 10000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.22,1,0.36,1); }
    .popup-visible { opacity: 1; transform: translateX(0); }
    .popup-hide { opacity: 0; transform: translateX(100%); }
    .popup-success { background: linear-gradient(135deg, #065f46 0%, #047857 100%); color: white; border: 1px solid rgba(255,255,255,0.15); }
    .popup-error { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); color: white; border: 1px solid rgba(255,255,255,0.15); }
    .popup-icono { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; flex-shrink: 0; background: rgba(255,255,255,0.2); }
    .popup-mensaje { max-width: 300px; }
  </style>
</ProtectedLayout>
