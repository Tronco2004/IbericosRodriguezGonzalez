---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <style is:global>
    /* Estilos para tarjetas de pedidos en modo oscuro */
    .pedido-card {
      background: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: var(--theme-transition);
    }
    
    .pedido-header {
      padding: 1.5rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 2rem;
      align-items: center;
    }
    
    .pedido-numero {
      color: var(--text-primary);
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    .pedido-fecha {
      color: var(--text-muted);
      margin: 0;
      font-size: 0.9rem;
    }
    
    .pedido-contacto {
      color: var(--text-muted);
      margin: 0;
      font-size: 0.9rem;
    }
    
    .pedido-total {
      color: var(--color-accent);
      font-weight: 700;
      font-size: 1.2rem;
      margin: 0;
    }
    
    .pedido-body {
      padding: 1.5rem;
    }
    
    .pedido-productos-title {
      color: var(--text-primary);
      margin: 0 0 1rem 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .pedido-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-light);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: center;
    }
    
    .pedido-item:last-child {
      border-bottom: none;
    }
    
    .pedido-item-nombre {
      color: var(--text-primary);
      font-weight: 600;
      margin: 0 0 0.25rem 0;
    }
    
    .pedido-item-peso {
      color: var(--color-accent);
      font-weight: 400;
      font-size: 0.9rem;
    }
    
    .pedido-item-cantidad {
      color: var(--text-muted);
      margin: 0;
      font-size: 0.9rem;
    }
    
    .pedido-item-precio {
      color: var(--text-primary);
      font-weight: 600;
      margin: 0;
    }
    
    .pedido-totales {
      padding: 1rem 0;
      border-top: 2px solid var(--border-color);
      margin-top: 1rem;
    }
    
    .pedido-totales-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .pedido-totales-label {
      color: var(--text-muted);
    }
    
    .pedido-totales-value {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    .pedido-totales-final {
      border-top: 1px solid var(--border-color);
      padding-top: 0.75rem;
      margin-top: 0.75rem;
    }
    
    .pedido-totales-final .pedido-totales-label {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    .pedido-totales-final .pedido-totales-value {
      color: var(--color-accent);
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .pedido-sin-pedidos {
      background: var(--bg-card);
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid var(--color-accent);
    }
    
    .pedido-sin-pedidos h2 {
      color: var(--text-primary);
      margin: 0 0 1rem 0;
    }
    
    .pedido-sin-pedidos p {
      color: var(--text-muted);
      margin: 0;
    }
    
    .pedido-error {
      background: var(--bg-card);
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid #ef4444;
    }
    
    .pedido-error h2 {
      color: var(--text-primary);
      margin: 0 0 1rem 0;
    }
    
    .pedido-error p {
      color: var(--text-muted);
      margin: 0;
    }
    
    .pedido-btn-validar {
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }
    
    .pedido-btn-validar:hover {
      box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
      transform: translateY(-2px);
    }
    
    @media (max-width: 900px) {
      .pedido-header {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
    }
  </style>
  
  <div class="admin-page">
    <div class="admin-container" style="max-width: 1200px;">
      <!-- Header with Back Button -->
      <div class="admin-header">
        <a href="/admin/dashboard" class="admin-back-btn">‚Üê</a>
        <h1 class="admin-title">Gesti√≥n de Pedidos</h1>
        <p class="admin-subtitle">Administra los pedidos de tus clientes</p>
      </div>
      
      <!-- Notification Toast -->
      <div id="notificationToast" class="admin-toast">
        <div class="admin-toast-content">
          <div id="notificationIcon" class="admin-toast-icon"></div>
          <div>
            <div id="notificationTitle" class="admin-toast-title"></div>
            <div id="notificationMessage" class="admin-toast-message"></div>
          </div>
        </div>
      </div>
      
      <div class="admin-filters">
        <button id="filtro-todos" class="admin-btn-secondary active">
          Todos los Pedidos
        </button>
        <button id="filtro-dia" class="admin-btn-secondary">
          Hoy
        </button>
        <button id="filtro-semana" class="admin-btn-secondary">
          Esta Semana
        </button>
        <button id="filtro-mes" class="admin-btn-secondary">
          Este Mes
        </button>
      </div>

      <p id="loadingMessage" class="admin-loading">Cargando pedidos...</p>
      <div id="pedidosContent"></div>
    </div>
  </div>

  <script>
    let filtroActual = 'todos';

    // Validar que es admin
    const userRole = localStorage.getItem('user_role');
    if (userRole !== 'admin') {
      window.location.href = '/sin-acceso';
    }

    // Funci√≥n para mostrar notificaci√≥n toast
    function mostrarNotificacion(tipo, titulo, mensaje) {
      const toast = document.getElementById('notificationToast');
      const icon = document.getElementById('notificationIcon');
      const titleEl = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');

      // Definir estilos seg√∫n el tipo
      const estilos = {
        success: {
          icon: '‚úì',
          color: '#10b981',
          background: '#ecfdf5'
        },
        error: {
          icon: '‚úï',
          color: '#ef4444',
          background: '#fef2f2'
        }
      };

      const estilo = estilos[tipo] || estilos.success;

      icon.textContent = estilo.icon;
      icon.style.color = estilo.color;
      titleEl.textContent = titulo;
      titleEl.style.color = estilo.color;
      messageEl.textContent = mensaje;

      toast.style.display = 'flex';
      toast.style.background = estilo.background;

      // Auto ocultar despu√©s de 3 segundos
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
          toast.style.display = 'none';
          toast.style.animation = 'slideIn 0.3s ease-out';
        }, 300);
      }, 3000);
    }

    async function cargarPedidos(filtro = 'todos') {
      try {
        filtroActual = filtro;
        
        // Actualizar clases de botones
        document.querySelectorAll('button[id^="filtro-"]').forEach(btn => {
          btn.classList.remove('active');
        });
        const activeBtn = document.getElementById(`filtro-${filtro}`);
        activeBtn.classList.add('active');

        const response = await fetch(`/api/admin/pedidos?filtro=${filtro}`, {
          credentials: 'include'
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('Error del API:', errorData);
          throw new Error('Error cargando pedidos: ' + errorData.error);
        }

        const data = await response.json();
        const pedidos = data.pedidos || [];

        if (!pedidos || pedidos.length === 0) {
          document.getElementById('loadingMessage').style.display = 'none';
          document.getElementById('pedidosContent').innerHTML = `
            <div class="pedido-sin-pedidos">
              <h2>Sin pedidos</h2>
              <p>No hay pedidos en este per√≠odo.</p>
            </div>
          `;
          return;
        }

        let html = '<div style="display: grid; gap: 1.5rem;">';

        pedidos.forEach(pedido => {
          const estadoColor = {
            'pagado': '#28a745',
            'preparando': '#ffc107',
            'enviado': '#17a2b8',
            'entregado': '#6c757d',
            'cancelado': '#dc3545',
            'devolucion_solicitada': '#ff9800',
            'devolucion_recibida': '#9c27b0'
          };

          html += `
            <div class="pedido-card">
              <div class="pedido-header">
                <div>
                  <h3 class="pedido-numero">Pedido #${pedido.numero_pedido}</h3>
                  ${pedido.codigo_seguimiento ? `
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--color-accent);">
                      üì¶ Seguimiento: <code style="background: var(--bg-tertiary); padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600;">${pedido.codigo_seguimiento}</code>
                    </p>
                  ` : ''}
                  <p class="pedido-fecha">
                    ${new Date(pedido.fecha_creacion).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                  </p>
                </div>
                <div>
                  <p class="pedido-contacto">üìß ${pedido.email_cliente || 'N/A'}</p>
                  <p class="pedido-contacto">üì± ${pedido.telefono_cliente || 'N/A'}</p>
                </div>
                <div style="display: flex; gap: 0.75rem; align-items: center;">
                  <select class="cambiar-estado" data-pedido-id="${pedido.id}" style="
                    background: ${estadoColor[pedido.estado] || '#6c757d'};
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 4px;
                    border: none;
                    font-weight: 600;
                    font-size: 0.85rem;
                    cursor: pointer;
                    min-width: 140px;
                  ">
                    <option value="pagado" ${pedido.estado === 'pagado' ? 'selected' : ''}>Pagado</option>
                    <option value="preparando" ${pedido.estado === 'preparando' ? 'selected' : ''}>Preparado</option>
                    <option value="enviado" ${pedido.estado === 'enviado' ? 'selected' : ''}>Enviado</option>
                    <option value="entregado" ${pedido.estado === 'entregado' ? 'selected' : ''}>Entregado</option>
                    <option value="cancelado" ${pedido.estado === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                    <option value="devolucion_solicitada" ${pedido.estado === 'devolucion_solicitada' ? 'selected' : ''}>Devoluci√≥n Solicitada</option>
                    <option value="devolucion_recibida" ${pedido.estado === 'devolucion_recibida' ? 'selected' : ''}>Devoluci√≥n Recibida</option>
                  </select>
                  ${pedido.estado === 'devolucion_solicitada' ? `
                    <button class="validar-devolucion pedido-btn-validar" data-pedido-id="${pedido.id}">
                      ‚úì Validar
                    </button>
                  ` : ''}
                </div>
                <div style="text-align: right;">
                  <p class="pedido-total">
                    ${parseFloat(pedido.total).toFixed(2)}‚Ç¨
                  </p>
                </div>
              </div>

              <div class="pedido-body">
                <h4 class="pedido-productos-title">Productos (${pedido.pedido_items.length})</h4>
                ${pedido.pedido_items.map((item, index) => {
                  const precioUnitario = parseFloat(item.precio_unitario) || (parseFloat(item.subtotal) / item.cantidad);
                  const subtotal = parseFloat(item.subtotal) || (precioUnitario * item.cantidad);
                  return `
                  <div class="pedido-item">
                    <div>
                      <p class="pedido-item-nombre">
                        ${item.nombre_producto}
                        ${item.peso_kg ? `<span class="pedido-item-peso">(${item.peso_kg.toFixed(3)} kg)</span>` : ''}
                      </p>
                      <p class="pedido-item-cantidad">Cantidad: ${item.cantidad} x ${precioUnitario.toFixed(2)}‚Ç¨</p>
                    </div>
                    <div style="text-align: right;">
                      <p class="pedido-item-precio">
                        ${subtotal.toFixed(2)}‚Ç¨
                      </p>
                    </div>
                  </div>
                `;}).join('')}

                <div class="pedido-totales">
                  <div class="pedido-totales-row">
                    <span class="pedido-totales-label">Subtotal</span>
                    <span class="pedido-totales-value">${parseFloat(pedido.subtotal).toFixed(2)}‚Ç¨</span>
                  </div>
                  ${pedido.envio > 0 ? `
                    <div class="pedido-totales-row">
                      <span class="pedido-totales-label">Env√≠o</span>
                      <span class="pedido-totales-value">${parseFloat(pedido.envio).toFixed(2)}‚Ç¨</span>
                    </div>
                  ` : ''}
                  ${pedido.impuestos > 0 ? `
                    <div class="pedido-totales-row">
                      <span class="pedido-totales-label">Impuestos</span>
                      <span class="pedido-totales-value">${parseFloat(pedido.impuestos).toFixed(2)}‚Ç¨</span>
                    </div>
                  ` : ''}
                  <div class="pedido-totales-row pedido-totales-final">
                    <span class="pedido-totales-label">Total</span>
                    <span class="pedido-totales-value">${parseFloat(pedido.total).toFixed(2)}‚Ç¨</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';

        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('pedidosContent').innerHTML = html;

      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('pedidosContent').innerHTML = `
          <div class="pedido-error">
            <h2>Error</h2>
            <p>No se pudieron cargar los pedidos.</p>
          </div>
        `;
      }
    }

    // Event listeners para botones
    document.getElementById('filtro-todos').addEventListener('click', () => cargarPedidos('todos'));
    document.getElementById('filtro-dia').addEventListener('click', () => cargarPedidos('dia'));
    document.getElementById('filtro-semana').addEventListener('click', () => cargarPedidos('semana'));
    document.getElementById('filtro-mes').addEventListener('click', () => cargarPedidos('mes'));

    // Event listeners para validar devoluci√≥n
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('validar-devolucion')) {
        const pedidoId = e.target.dataset.pedidoId;
        const userRole = localStorage.getItem('user_role');

        if (!confirm('¬øConfirmar que la devoluci√≥n ha llegado correctamente? Se notificar√° al cliente y se procesar√° el reembolso.')) {
          return;
        }

        try {
          e.target.disabled = true;
          e.target.textContent = '‚è≥ Procesando...';

          const response = await fetch('/api/pedidos/validar-devolucion', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-user-role': userRole || 'admin'
            },
            body: JSON.stringify({
              pedido_id: pedidoId
            })
          });

          if (!response.ok) {
            const error = await response.json();
            mostrarNotificacion('error', 'Error al validar', error.error || 'No se pudo validar la devoluci√≥n');
            e.target.disabled = false;
            e.target.textContent = '‚úì Validar';
            return;
          }

          mostrarNotificacion('success', '‚úì Devoluci√≥n Validada', 'El cliente ha sido notificado. Reembolso autorizado.');
          // Recargar los pedidos
          cargarPedidos(filtroActual);
        } catch (error) {
          console.error('Error:', error);
          mostrarNotificacion('error', 'Error', 'No se pudo validar la devoluci√≥n');
          e.target.disabled = false;
          e.target.textContent = '‚úì Validar';
        }
      }
    });

    // Event listeners para cambiar estado
    document.addEventListener('change', async (e) => {
      if (e.target.classList.contains('cambiar-estado')) {
        const pedidoId = e.target.dataset.pedidoId;
        const nuevoEstado = e.target.value;

        try {
          const response = await fetch('/api/admin/pedidos/actualizar-estado', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              pedido_id: pedidoId,
              estado: nuevoEstado
            })
          });

          if (!response.ok) {
            const error = await response.json();
            mostrarNotificacion('error', 'Error al actualizar', error.error || 'No se pudo actualizar el estado');
            // Recargar los pedidos para restaurar el estado anterior
            cargarPedidos(filtroActual);
            return;
          }

          // Mostrar notificaci√≥n de √©xito
          const estadoTexto = {
            'pagado': 'Pagado',
            'preparando': 'Preparando',
            'enviado': 'Enviado',
            'entregado': 'Entregado',
            'cancelado': 'Cancelado'
          }[nuevoEstado] || nuevoEstado;
          
          mostrarNotificacion('success', '¬°Perfecto!', `El pedido ha sido actualizado a ${estadoTexto}`);
          // Recargar los pedidos
          cargarPedidos(filtroActual);

        } catch (error) {
          console.error('Error:', error);
          mostrarNotificacion('error', 'Error', 'Algo sali√≥ mal al actualizar el pedido');
          cargarPedidos(filtroActual);
        }
      }
    });

    // Cargar pedidos al iniciar
    cargarPedidos('todos');
  </script>
</ProtectedLayout>
