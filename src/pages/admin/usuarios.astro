---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <div class="admin-page">
    <!-- Header -->
    <div class="admin-header">
      <a href="/admin/dashboard" class="admin-back-btn">←</a>
      <h1 class="admin-title">Gestionar Usuarios</h1>
      <p class="admin-subtitle">Administra los usuarios del sistema</p>
    </div>

    <!-- Tabla de usuarios -->
    <div class="admin-table-container">
      <table id="usuariosTable" class="admin-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTableBody">
          <tr>
            <td colspan="5" class="admin-loading">
              Cargando usuarios...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal confirmar eliminación -->
  <div id="modalEliminarUsuario" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-card); border-radius: 12px; padding: 2rem; max-width: 420px; width: 90%; border: 1px solid var(--border-color); box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalIn 0.3s ease;">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="width: 56px; height: 56px; border-radius: 50%; background: #fef2f2; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.8rem;">⚠️</div>
        <h2 style="color: var(--text-primary); margin: 0 0 0.5rem; font-size: 1.25rem;">Eliminar Usuario</h2>
        <p id="modalEliminarMsg" style="color: var(--text-muted); margin: 0; line-height: 1.5; font-size: 0.95rem;">¿Estás seguro de que deseas eliminar este usuario? Esta acción no se puede deshacer.</p>
      </div>
      <div style="display: flex; gap: 0.75rem; justify-content: center;">
        <button id="btnCancelarEliminar" style="padding: 0.65rem 1.5rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;">Cancelar</button>
        <button id="btnConfirmarEliminar" style="padding: 0.65rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; box-shadow: 0 2px 8px rgba(239,68,68,0.3);">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Toast notificación -->
  <div id="toastUsuarios" style="display: none; position: fixed; top: 2rem; right: 2rem; z-index: 9999; min-width: 300px; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.25); align-items: center; gap: 0.75rem; animation: toastIn 0.4s ease;">
    <div style="flex: 1;">
      <div id="toastUsuariosTitulo" style="font-weight: 700; font-size: 0.95rem; margin-bottom: 0.1rem;"></div>
      <div id="toastUsuariosMsg" style="font-size: 0.85rem; opacity: 0.85;"></div>
    </div>
  </div>

  <style>
    @keyframes modalIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100px); } }
  </style>

  <script>
    let eliminandoUsuarioId = null;

    function mostrarToast(tipo, titulo, mensaje) {
      const toast = document.getElementById('toastUsuarios');
      const titleEl = document.getElementById('toastUsuariosTitulo');
      const msgEl = document.getElementById('toastUsuariosMsg');
      const estilos = {
        success: { bg: '#ecfdf5', color: '#065f46', border: '#10b981' },
        error: { bg: '#fef2f2', color: '#991b1b', border: '#ef4444' }
      };
      const s = estilos[tipo] || estilos.success;
      titleEl.textContent = titulo; titleEl.style.color = s.color;
      msgEl.textContent = mensaje; msgEl.style.color = s.color;
      toast.style.display = 'flex'; toast.style.background = s.bg; toast.style.borderLeft = '4px solid ' + s.border;
      setTimeout(() => {
        toast.style.animation = 'toastOut 0.4s ease';
        setTimeout(() => { toast.style.display = 'none'; toast.style.animation = 'toastIn 0.4s ease'; }, 400);
      }, 3000);
    }

    async function cargarUsuarios() {
      try {
        const response = await fetch('/api/admin/usuarios');
        const data = await response.json();

        if (data.success && data.usuarios) {
          const tableBody = document.getElementById('usuariosTableBody');
          tableBody.innerHTML = data.usuarios.map(usuario => `
            <tr>
              <td><strong>${usuario.nombre}</strong></td>
              <td>${usuario.email}</td>
              <td>
                <span class="admin-badge ${usuario.rol === 'admin' ? 'danger' : 'info'}">${usuario.rol}</span>
              </td>
              <td>
                <select id="activo-${usuario.id}" onchange="cambiarEstado('${usuario.id}', this.value)" class="admin-select">
                  <option value="true" ${usuario.activo === true ? 'selected' : ''}>Activo</option>
                  <option value="false" ${usuario.activo === false ? 'selected' : ''}>Inactivo</option>
                </select>
              </td>
              <td>
                <button onclick="eliminarUsuario('${usuario.id}')" class="admin-btn-danger">
                  Eliminar
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          const tableBody = document.getElementById('usuariosTableBody');
          tableBody.innerHTML = '<tr><td colspan="5" class="admin-empty-state">Error al cargar usuarios</td></tr>';
        }
      } catch (error) {
        console.error('Error cargando usuarios:', error);
        const tableBody = document.getElementById('usuariosTableBody');
        tableBody.innerHTML = '<tr><td colspan="5" class="admin-empty-state">Error al cargar usuarios</td></tr>';
      }
    }

    async function cambiarEstado(usuarioId, nuevoEstado) {
      try {
        const activo = nuevoEstado === 'true';
        
        const response = await fetch('/api/admin/usuarios/actualizar-estado', {
          method: 'POST',
          body: JSON.stringify({ usuarioId, activo }),
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        
        if (data.success) {
          mostrarToast('success', '✓ Estado actualizado', `Usuario ${activo ? 'activado' : 'desactivado'} correctamente`);
        } else {
          mostrarToast('error', 'Error', 'No se pudo actualizar el estado');
          cargarUsuarios();
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarToast('error', 'Error', 'Error al actualizar el estado');
        cargarUsuarios();
      }
    }

    function eliminarUsuario(usuarioId) {
      eliminandoUsuarioId = usuarioId;
      document.getElementById('modalEliminarUsuario').style.display = 'flex';
    }

    async function confirmarEliminacion() {
      if (!eliminandoUsuarioId) return;
      try {
        const response = await fetch('/api/admin/usuarios/eliminar', {
          method: 'POST',
          body: JSON.stringify({ usuarioId: eliminandoUsuarioId }),
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        document.getElementById('modalEliminarUsuario').style.display = 'none';
        if (data.success) {
          mostrarToast('success', '✓ Usuario eliminado', 'El usuario ha sido eliminado correctamente');
          cargarUsuarios();
        } else {
          mostrarToast('error', 'Error', 'No se pudo eliminar el usuario');
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('modalEliminarUsuario').style.display = 'none';
        mostrarToast('error', 'Error', 'Error al eliminar el usuario');
      }
      eliminandoUsuarioId = null;
    }

    // Eventos modal
    document.getElementById('btnConfirmarEliminar').addEventListener('click', confirmarEliminacion);
    document.getElementById('btnCancelarEliminar').addEventListener('click', () => {
      document.getElementById('modalEliminarUsuario').style.display = 'none';
      eliminandoUsuarioId = null;
    });
    document.getElementById('modalEliminarUsuario').addEventListener('click', (e) => {
      if (e.target.id === 'modalEliminarUsuario') {
        document.getElementById('modalEliminarUsuario').style.display = 'none';
        eliminandoUsuarioId = null;
      }
    });

    // Exponer funciones globalmente para onclick dinámico
    window.eliminarUsuario = eliminarUsuario;
    window.cambiarEstado = cambiarEstado;

    // Cargar usuarios al iniciar
    cargarUsuarios();
  </script>
</ProtectedLayout>
