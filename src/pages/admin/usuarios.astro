---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
      <h1 style="color: #001a33; font-size: 2rem; margin: 0;">Gestionar Usuarios</h1>
      <p style="color: #666; margin: 0.5rem 0 0 0;">Administra los usuarios del sistema</p>
    </div>

    <!-- Tabla de usuarios -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
      <table id="usuariosTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
            <th style="padding: 1rem; text-align: left; color: #001a33; font-weight: 600;">Nombre</th>
            <th style="padding: 1rem; text-align: left; color: #001a33; font-weight: 600;">Email</th>
            <th style="padding: 1rem; text-align: left; color: #001a33; font-weight: 600;">Rol</th>
            <th style="padding: 1rem; text-align: left; color: #001a33; font-weight: 600;">Estado</th>
            <th style="padding: 1rem; text-align: left; color: #001a33; font-weight: 600;">Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTableBody">
          <tr>
            <td colspan="5" style="padding: 2rem; text-align: center; color: #999;">
              Cargando usuarios...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function cargarUsuarios() {
      try {
        const response = await fetch('/api/admin/usuarios');
        const data = await response.json();

        if (data.success && data.usuarios) {
          const tableBody = document.getElementById('usuariosTableBody');
          tableBody.innerHTML = data.usuarios.map(usuario => `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 1rem; color: #333; font-weight: 600;">${usuario.nombre}</td>
              <td style="padding: 1rem; color: #666;">${usuario.email}</td>
              <td style="padding: 1rem;">
                <span style="
                  background: ${usuario.rol === 'admin' ? '#ff6b6b' : '#a89968'};
                  color: white;
                  padding: 0.25rem 0.75rem;
                  border-radius: 4px;
                  font-size: 0.85rem;
                  font-weight: 600;
                ">${usuario.rol}</span>
              </td>
              <td style="padding: 1rem;">
                <select id="activo-${usuario.id}" onchange="cambiarEstado('${usuario.id}', this.value)" style="
                  padding: 0.5rem;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  background: white;
                  cursor: pointer;
                  font-size: 0.9rem;
                ">
                  <option value="true" ${usuario.activo === true ? 'selected' : ''}>Activo</option>
                  <option value="false" ${usuario.activo === false ? 'selected' : ''}>Inactivo</option>
                </select>
              </td>
              <td style="padding: 1rem;">
                <button onclick="eliminarUsuario('${usuario.id}')" style="
                  background: #ff6b6b;
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85rem;
                  transition: background 0.3s;
                " onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                  Eliminar
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          const tableBody = document.getElementById('usuariosTableBody');
          tableBody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #999;">Error al cargar usuarios</td></tr>';
        }
      } catch (error) {
        console.error('Error cargando usuarios:', error);
        const tableBody = document.getElementById('usuariosTableBody');
        tableBody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #999;">Error al cargar usuarios</td></tr>';
      }
    }

    async function cambiarEstado(usuarioId, nuevoEstado) {
      try {
        const activo = nuevoEstado === 'true';
        
        const response = await fetch('/api/admin/usuarios', {
          method: 'PUT',
          body: JSON.stringify({ id: usuarioId, activo }),
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Estado actualizado');
        } else {
          alert('Error al actualizar el estado');
          cargarUsuarios();
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el estado');
        cargarUsuarios();
      }
    }

    async function eliminarUsuario(usuarioId) {
      if (!confirm('¿Está seguro de que desea eliminar este usuario?')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/usuarios/eliminar?id=${usuarioId}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Usuario eliminado');
          cargarUsuarios();
        } else {
          alert('Error al eliminar el usuario');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el usuario');
      }
    }

    // Cargar usuarios al iniciar
    cargarUsuarios();
  </script>
</ProtectedLayout>
