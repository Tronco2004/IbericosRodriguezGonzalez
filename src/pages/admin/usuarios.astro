---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <div class="admin-page">
    <!-- Header -->
    <div class="admin-header">
      <h1 class="admin-title">Gestionar Usuarios</h1>
      <p class="admin-subtitle">Administra los usuarios del sistema</p>
    </div>

    <!-- Tabla de usuarios -->
    <div class="admin-table-container">
      <table id="usuariosTable" class="admin-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTableBody">
          <tr>
            <td colspan="5" class="admin-loading">
              Cargando usuarios...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    async function cargarUsuarios() {
      try {
        const response = await fetch('/api/admin/usuarios');
        const data = await response.json();

        if (data.success && data.usuarios) {
          const tableBody = document.getElementById('usuariosTableBody');
          tableBody.innerHTML = data.usuarios.map(usuario => `
            <tr>
              <td><strong>${usuario.nombre}</strong></td>
              <td>${usuario.email}</td>
              <td>
                <span class="admin-badge ${usuario.rol === 'admin' ? 'danger' : 'info'}">${usuario.rol}</span>
              </td>
              <td>
                <select id="activo-${usuario.id}" onchange="cambiarEstado('${usuario.id}', this.value)" class="admin-select">
                  <option value="true" ${usuario.activo === true ? 'selected' : ''}>Activo</option>
                  <option value="false" ${usuario.activo === false ? 'selected' : ''}>Inactivo</option>
                </select>
              </td>
              <td>
                <button onclick="eliminarUsuario('${usuario.id}')" class="admin-btn-danger">
                  Eliminar
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          const tableBody = document.getElementById('usuariosTableBody');
          tableBody.innerHTML = '<tr><td colspan="5" class="admin-empty-state">Error al cargar usuarios</td></tr>';
        }
      } catch (error) {
        console.error('Error cargando usuarios:', error);
        const tableBody = document.getElementById('usuariosTableBody');
        tableBody.innerHTML = '<tr><td colspan="5" class="admin-empty-state">Error al cargar usuarios</td></tr>';
      }
    }

    async function cambiarEstado(usuarioId, nuevoEstado) {
      try {
        const activo = nuevoEstado === 'true';
        
        const response = await fetch('/api/admin/usuarios', {
          method: 'PUT',
          body: JSON.stringify({ id: usuarioId, activo }),
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Estado actualizado');
        } else {
          alert('Error al actualizar el estado');
          cargarUsuarios();
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el estado');
        cargarUsuarios();
      }
    }

    async function eliminarUsuario(usuarioId) {
      if (!confirm('¿Está seguro de que desea eliminar este usuario?')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/usuarios/eliminar?id=${usuarioId}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        
        if (data.success) {
          console.log('✅ Usuario eliminado');
          cargarUsuarios();
        } else {
          alert('Error al eliminar el usuario');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el usuario');
      }
    }

    // Cargar usuarios al iniciar
    cargarUsuarios();
  </script>
</ProtectedLayout>
