---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout requireAdmin={true}>
  <div class="admin-page">
    <div class="admin-container">
      <!-- Header -->
      <div class="admin-header">
        <a href="/admin/dashboard" class="admin-back-btn">←</a>
        <h1 class="admin-title">Clientes Empresariales</h1>
        <p class="admin-subtitle">Gestiona bares, restaurantes, tiendas y otros clientes empresariales</p>
      </div>

      <!-- Action Bar -->
      <div class="admin-action-bar">
        <input type="text" id="searchInput" placeholder="Buscar cliente..." class="admin-search-input" />
        <button id="btnNuevoCliente" class="admin-btn-primary">+ Nuevo Cliente</button>
      </div>

      <!-- Tabla de Clientes -->
      <div class="admin-table-container">
        <div class="admin-table-scroll">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Empresa</th>
                <th>Identificación</th>
                <th>Tipo</th>
                <th>Contacto</th>
                <th>Representante</th>
                <th class="center">Estado</th>
                <th class="center">Acciones</th>
              </tr>
            </thead>
            <tbody id="clientesTable">
              <!-- Cargará con JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" class="admin-empty-state" style="display: none;">
          <p>No hay clientes que mostrar</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="clienteModal" class="admin-modal-overlay" style="display: none;">
    <div class="admin-modal" style="max-width: 700px;">
      <h2 id="modalTitle" class="admin-modal-title">Nuevo Cliente</h2>

      <form id="clienteForm" class="admin-form">
        <div class="admin-form-row">
          <div class="admin-form-group">
            <label class="admin-label">Nombre de Empresa</label>
            <input type="text" id="nombre_empresa" placeholder="Ej: Bar La Esquina" class="admin-input" required />
          </div>

          <div class="admin-form-group">
            <label class="admin-label">Tipo de Identificación</label>
            <select id="tipo_identificacion" class="admin-select">
              <option value="NIF">NIF</option>
              <option value="RUT">RUT</option>
              <option value="RFC">RFC</option>
              <option value="CUIT">CUIT</option>
              <option value="OTRO">Otro</option>
            </select>
          </div>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Número de Identificación Fiscal</label>
          <input type="text" id="numero_identificacion" placeholder="Ej: 12345678A" class="admin-input" required />
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Dirección Fiscal</label>
          <input type="text" id="direccion_fiscal" placeholder="Calle, número, ciudad, provincia" class="admin-input" required />
        </div>

        <div class="admin-form-row">
          <div class="admin-form-group">
            <label class="admin-label">Nombre del Representante</label>
            <input type="text" id="nombre_representante" placeholder="Nombre completo" class="admin-input" required />
          </div>

          <div class="admin-form-group">
            <label class="admin-label">Tipo de Cliente</label>
            <select id="tipo_cliente" class="admin-select" required>
              <option value="">Selecciona tipo</option>
              <option value="Bar">Bar</option>
              <option value="Restaurante">Restaurante</option>
              <option value="Tienda">Tienda</option>
              <option value="Particular">Particular</option>
              <option value="Mayorista">Mayorista</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
        </div>

        <div class="admin-form-row">
          <div class="admin-form-group">
            <label class="admin-label">Email</label>
            <input type="email" id="email_contacto" placeholder="email@empresa.com" class="admin-input" required />
          </div>

          <div class="admin-form-group">
            <label class="admin-label">Teléfono</label>
            <input type="tel" id="telefono_contacto" placeholder="+34 600 000 000" class="admin-input" />
          </div>
        </div>

        <div class="admin-form-group">
          <label class="admin-label">Notas</label>
          <textarea id="notas" placeholder="Notas adicionales..." rows="3" class="admin-textarea"></textarea>
        </div>

        <div class="admin-form-actions">
          <button type="button" id="cancelBtn" class="admin-btn-secondary">Cancelar</button>
          <button type="submit" class="admin-btn-primary">Guardar Cliente</button>
        </div>
      </form>
    </div>
  </div>

  <!-- PopUp de notificaciones -->
  <div id="popupNotificacion" class="popup-notificacion" style="display: none;">
    <div class="popup-icono" id="popupIcono"></div>
    <span class="popup-mensaje" id="popupMensaje"></span>
  </div>

  <script>
    let popupTimeout;
    function showPopup(mensaje, tipo = 'success') {
      const popup = document.getElementById('popupNotificacion');
      const icono = document.getElementById('popupIcono');
      const msg = document.getElementById('popupMensaje');
      if (popupTimeout) clearTimeout(popupTimeout);
      icono.textContent = tipo === 'success' ? '\u2713' : '\u2715';
      msg.textContent = mensaje;
      popup.className = `popup-notificacion popup-${tipo} popup-visible`;
      popup.style.display = 'flex';
      popupTimeout = setTimeout(() => {
        popup.classList.remove('popup-visible');
        popup.classList.add('popup-hide');
        setTimeout(() => { popup.style.display = 'none'; popup.classList.remove('popup-hide'); }, 400);
      }, 3000);
    }

    let clientes = [];
    let editingId = null;

    // Cargar clientes
    async function cargarClientes() {
      try {
        const response = await fetch('/api/admin/clientes-empresariales');
        const data = await response.json();
        
        if (data.success && data.clientes && data.clientes.length > 0) {
          clientes = data.clientes;
        } else {
          clientes = [];
        }
        renderizarClientes();
      } catch (error) {
        console.error('Error cargando clientes:', error);
        clientes = [];
        renderizarClientes();
      }
    }

    function renderizarClientes() {
      const tabla = document.getElementById('clientesTable');
      const emptyState = document.getElementById('emptyState');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      let filtrados = clientes.filter(c => {
        const matchSearch = 
          c.nombre_empresa.toLowerCase().includes(searchTerm) ||
          c.numero_identificacion.toLowerCase().includes(searchTerm) ||
          c.nombre_representante.toLowerCase().includes(searchTerm) ||
          c.email_contacto.toLowerCase().includes(searchTerm);
        return matchSearch;
      });

      if (filtrados.length === 0) {
        tabla.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      tabla.innerHTML = filtrados.map(c => `
        <tr>
          <td class="font-semibold">${c.nombre_empresa}</td>
          <td class="text-secondary">${c.tipo_identificacion}: ${c.numero_identificacion}</td>
          <td class="text-secondary capitalize">${c.tipo_cliente}</td>
          <td class="text-secondary">${c.email_contacto}</td>
          <td class="text-secondary">${c.nombre_representante}</td>
          <td class="center">
            <span class="admin-badge ${c.estado ? 'success' : 'danger'}">
              ${c.estado ? 'Activo' : 'Inactivo'}
            </span>
          </td>
          <td class="center">
            <div class="actions-cell">
              <button class="btn-editar admin-btn-primary small" data-id="${c.id}">Editar</button>
              <button class="btn-eliminar admin-btn-danger small" data-id="${c.id}">Eliminar</button>
            </div>
          </td>
        </tr>
      `).join('');

      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', () => abrirEditar(parseInt(btn.dataset.id)));
      });
      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', () => eliminarCliente(parseInt(btn.dataset.id)));
      });
    }

    function abrirNuevo() {
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Nuevo Cliente';
      document.getElementById('clienteForm').reset();
      document.getElementById('clienteModal').style.display = 'flex';
    }

    function abrirEditar(id) {
      const cliente = clientes.find(c => c.id === id);
      if (!cliente) return;

      editingId = id;
      document.getElementById('modalTitle').textContent = 'Editar Cliente';
      document.getElementById('nombre_empresa').value = cliente.nombre_empresa;
      document.getElementById('tipo_identificacion').value = cliente.tipo_identificacion;
      document.getElementById('numero_identificacion').value = cliente.numero_identificacion;
      document.getElementById('direccion_fiscal').value = cliente.direccion_fiscal;
      document.getElementById('nombre_representante').value = cliente.nombre_representante;
      document.getElementById('tipo_cliente').value = cliente.tipo_cliente;
      document.getElementById('email_contacto').value = cliente.email_contacto;
      document.getElementById('telefono_contacto').value = cliente.telefono_contacto || '';
      document.getElementById('notas').value = cliente.notas || '';
      
      document.getElementById('clienteModal').style.display = 'flex';
    }

    function cerrarModal() {
      document.getElementById('clienteModal').style.display = 'none';
      editingId = null;
    }

    async function guardarCliente(e) {
      e.preventDefault();
      
      const nuevoCliente = {
        nombre_empresa: document.getElementById('nombre_empresa').value,
        tipo_identificacion: document.getElementById('tipo_identificacion').value,
        numero_identificacion: document.getElementById('numero_identificacion').value,
        direccion_fiscal: document.getElementById('direccion_fiscal').value,
        nombre_representante: document.getElementById('nombre_representante').value,
        tipo_cliente: document.getElementById('tipo_cliente').value,
        email_contacto: document.getElementById('email_contacto').value,
        telefono_contacto: document.getElementById('telefono_contacto').value,
        notas: document.getElementById('notas').value
      };

      try {
        if (editingId) {
          const response = await fetch('/api/admin/clientes-empresariales', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...nuevoCliente, id: editingId })
          });
          
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message || 'Error al actualizar');
          }
        } else {
          const response = await fetch('/api/admin/clientes-empresariales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(nuevoCliente)
          });
          
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message || 'Error al crear');
          }
        }
        
        cerrarModal();
        cargarClientes();
      } catch (error) {
        console.error('Error guardando cliente:', error);
        showPopup('Error: ' + (error instanceof Error ? error.message : 'Error desconocido'), 'error');
      }
    }

    async function eliminarCliente(id) {
      if (confirm('¿Estás seguro de que quieres eliminar este cliente?')) {
        try {
          const response = await fetch(`/api/admin/clientes-empresariales?id=${id}`, {
            method: 'DELETE'
          });
          
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.message || 'Error al eliminar');
          }
          
          showPopup('Cliente eliminado exitosamente', 'success');
          cargarClientes();
        } catch (error) {
          console.error('Error eliminando cliente:', error);
          showPopup('Error: ' + (error instanceof Error ? error.message : 'Error desconocido'), 'error');
        }
      }
    }

    // Event listeners
    document.getElementById('btnNuevoCliente').addEventListener('click', abrirNuevo);
    document.getElementById('cancelBtn').addEventListener('click', cerrarModal);
    
    const clienteForm = document.getElementById('clienteForm');
    if (clienteForm) {
      clienteForm.addEventListener('submit', guardarCliente);
    }
    
    document.getElementById('searchInput').addEventListener('input', renderizarClientes);

    // Cerrar modal al clickear fuera
    document.getElementById('clienteModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('clienteModal')) {
        cerrarModal();
      }
    });

    // Cargar al iniciar
    cargarClientes();
  </script>

  <style is:global>
    /* Estilos específicos para clientes */
    .admin-table td.font-semibold {
      font-weight: 600;
      color: #0f172a;
    }
    .admin-table td.text-secondary {
      color: #64748b;
      font-size: 0.9rem;
    }
    .admin-table td.capitalize {
      text-transform: capitalize;
    }
    .admin-table .actions-cell {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    .admin-btn-primary.small,
    .admin-btn-danger.small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
  </style>

  <style>
    .popup-notificacion { position: fixed; top: 2rem; right: 2rem; display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-radius: 12px; font-size: 0.95rem; font-weight: 600; z-index: 10000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.22,1,0.36,1); }
    .popup-visible { opacity: 1; transform: translateX(0); }
    .popup-hide { opacity: 0; transform: translateX(100%); }
    .popup-success { background: linear-gradient(135deg, #065f46 0%, #047857 100%); color: white; border: 1px solid rgba(255,255,255,0.15); }
    .popup-error { background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%); color: white; border: 1px solid rgba(255,255,255,0.15); }
    .popup-icono { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; flex-shrink: 0; background: rgba(255,255,255,0.2); }
    .popup-mensaje { max-width: 300px; }
  </style>
</ProtectedLayout>
