---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
---

<ProtectedLayout title="Gestionar Variantes">
  <div class="admin-page">
    <div class="admin-container">
      <header class="admin-header">
        <a href="/admin/productos" class="admin-back-btn">← Volver a Productos</a>
        <h1 class="admin-title">Gestionar Variantes de Productos</h1>
      </header>

      <div class="variantes-grid">
        <!-- Selector de Producto -->
        <div class="variantes-card">
          <h2 class="variantes-card-title">Seleccionar Producto</h2>
          <select id="productoSelect" class="admin-select">
            <option value="">-- Selecciona un producto --</option>
          </select>
          
          <div id="productoInfo" class="producto-info">
            <p><strong>Precio por kg:</strong> <span id="precioKg">-</span>€</p>
            <p><strong>Es variable:</strong> <span id="esVariable">-</span></p>
          </div>
        </div>

        <!-- Agregar Nueva Variante -->
        <div class="variantes-card">
          <h2 class="variantes-card-title">Agregar Variante</h2>
          <form id="formVariante" class="admin-form" style="display: none;">
            <div class="admin-form-group">
              <label class="admin-label">Peso (kg)</label>
              <input type="number" id="pesoInput" step="0.001" placeholder="4.650" class="admin-input" required />
            </div>

            <div class="admin-form-group">
              <label class="admin-label">Precio Total (€)</label>
              <input type="number" id="precioInput" step="0.01" placeholder="162.75" class="admin-input" required />
              <small class="form-hint">Se calcula automáticamente si dejas vacío</small>
            </div>

            <button type="submit" class="admin-btn-primary full-width">
              Agregar Variante
            </button>
          </form>

          <div id="sinProducto" class="admin-empty-state">
            Selecciona un producto primero
          </div>
        </div>
      </div>

      <!-- Lista de Variantes -->
      <div class="variantes-card" style="margin-top: 2rem;">
        <h2 class="variantes-card-title">Variantes del Producto</h2>
        
        <div id="listVariantes" style="display: none;">
          <div class="admin-table-scroll">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Peso</th>
                  <th>Precio</th>
                  <th>Disponible</th>
                  <th>Stock</th>
                  <th class="center">Acciones</th>
                </tr>
              </thead>
              <tbody id="variantesTableBody"></tbody>
            </table>
          </div>
        </div>

        <div id="sinVariantes" class="admin-empty-state">
          No hay variantes para este producto
        </div>
      </div>
    </div>
  </div>

  <style>
    .variantes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    @media (max-width: 768px) {
      .variantes-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .variantes-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e0d5c7;
    }
    
    .variantes-card-title {
      color: #001a33;
      margin-top: 0;
      margin-bottom: 1rem;
    }
    
    .producto-info {
      display: none;
      padding: 1rem;
      background: #f8f4f0;
      border-radius: 4px;
      margin-top: 1rem;
    }
    
    .producto-info p {
      margin: 0.5rem 0;
    }
    
    .form-hint {
      color: #999;
      display: block;
      margin-top: 0.25rem;
      font-size: 0.85rem;
    }
    
    .full-width {
      width: 100%;
    }
    
    .btn-toggle {
      padding: 0.5rem 1rem;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: opacity 0.3s;
    }
    
    .btn-toggle:hover {
      opacity: 0.9;
    }
    
    .btn-toggle.disponible {
      background: #f59e0b;
    }
    
    .btn-toggle.no-disponible {
      background: #10b981;
    }
    
    .btn-eliminar {
      padding: 0.5rem 1rem;
      background: #f5576c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: opacity 0.3s;
    }
    
    .btn-eliminar:hover {
      opacity: 0.9;
    }
    
    .acciones-cell {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    
    /* Notificaciones */
    .notificaciones-container {
      position: fixed;
      top: 80px;
      right: 2rem;
      z-index: 1000;
      max-width: 400px;
    }
    
    .notificacion {
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      animation: slideIn 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-weight: 500;
    }
    
    .notificacion.exito {
      background: #a89968;
    }
    
    .notificacion.error {
      background: #f5576c;
    }
    
    .notificacion.saliendo {
      animation: slideOut 0.3s ease-out forwards;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(400px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(400px); }
    }
  </style>

  <script>
    let productoActual = null;
    let variantes = [];

    // Cargar productos
    async function cargarProductos() {
      try {
        const response = await fetch('/api/admin/productos-list');
        const data = await response.json();
        const productos = data.productos || [];

        const select = document.getElementById('productoSelect');
        select.innerHTML = '<option value="">-- Selecciona un producto --</option>';
        
        productos.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = `${p.nombre} (${p.categoria})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error cargando productos:', error);
      }
    }

    // Seleccionar producto
    document.getElementById('productoSelect').addEventListener('change', async (e) => {
      const productoId = e.target.value;
      if (!productoId) {
        productoActual = null;
        document.getElementById('formVariante').style.display = 'none';
        document.getElementById('sinProducto').style.display = 'block';
        document.getElementById('productoInfo').style.display = 'none';
        document.getElementById('listVariantes').style.display = 'none';
        document.getElementById('sinVariantes').style.display = 'block';
        return;
      }

      // Obtener datos del producto
      try {
        const response = await fetch('/api/admin/productos-list');
        const data = await response.json();
        const producto = data.productos.find(p => p.id == productoId);
        
        if (producto) {
          productoActual = producto;
          document.getElementById('precioKg').textContent = producto.precio_por_kg || '0';
          document.getElementById('esVariable').textContent = producto.es_variable ? 'Sí' : 'No';
          document.getElementById('productoInfo').style.display = 'block';
          document.getElementById('formVariante').style.display = 'block';
          document.getElementById('sinProducto').style.display = 'none';
          
          // Cargar variantes
          await cargarVariantes(productoId);
        }
      } catch (error) {
        console.error('Error cargando producto:', error);
      }
    });

    // Cargar variantes del producto seleccionado
    async function cargarVariantes(productoId) {
      try {
        const response = await fetch(`/api/admin/variantes?producto_id=${productoId}`);
        const data = await response.json();
        variantes = data.variantes || [];

        const tbody = document.getElementById('variantesTableBody');
        tbody.innerHTML = '';

        if (variantes.length === 0) {
          document.getElementById('listVariantes').style.display = 'none';
          document.getElementById('sinVariantes').style.display = 'block';
          return;
        }

        document.getElementById('listVariantes').style.display = 'block';
        document.getElementById('sinVariantes').style.display = 'none';

        variantes.forEach(v => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${v.peso_kg.toFixed(3)}kg</td>
            <td>${(v.precio_total / 100).toFixed(2)}€</td>
            <td>
              <span class="admin-badge ${v.disponible ? 'success' : 'danger'}">
                ${v.disponible ? '✓ Disponible' : '✗ No disponible'}
              </span>
            </td>
            <td>${v.cantidad_disponible}</td>
            <td class="center">
              <div class="acciones-cell">
                <button class="btn-toggle ${v.disponible ? 'disponible' : 'no-disponible'}" data-id="${v.id}" data-disponible="${v.disponible}">
                  ${v.disponible ? 'Agotar' : 'Disponible'}
                </button>
                <button class="btn-eliminar" data-id="${v.id}">
                  Eliminar
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Agregar event listeners a botones eliminar y toggle
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (confirm('¿Estás seguro de que deseas eliminar esta variante?')) {
              await eliminarVariante(id);
            }
          });
        });

        document.querySelectorAll('.btn-toggle').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            const disponibleActual = btn.getAttribute('data-disponible') === 'true';
            await toggleDisponible(id, !disponibleActual);
          });
        });
      } catch (error) {
        console.error('Error cargando variantes:', error);
      }
    }

    // Agregar variante
    document.getElementById('formVariante').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!productoActual) {
        alert('Selecciona un producto primero');
        return;
      }

      const pesoInput = parseFloat(document.getElementById('pesoInput').value);
      let precioInput = document.getElementById('precioInput').value;

      if (!pesoInput) {
        alert('Ingresa el peso');
        return;
      }

      // Calcular precio si está vacío
      if (!precioInput && productoActual.precio_por_kg) {
        precioInput = (pesoInput * productoActual.precio_por_kg).toFixed(2);
      } else if (!precioInput) {
        alert('Ingresa el precio o establece el precio/kg del producto');
        return;
      }

      try {
        const response = await fetch('/api/admin/variantes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: productoActual.id,
            peso_kg: pesoInput,
            precio_total: parseFloat(precioInput)
          }),
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          mostrarNotificacion('Variante agregada correctamente', 'exito');
          document.getElementById('pesoInput').value = '';
          document.getElementById('precioInput').value = '';
          await cargarVariantes(productoActual.id);
        } else {
          mostrarNotificacion(data.error || 'Error al agregar variante', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('Error al agregar variante', 'error');
      }
    });

    // Eliminar variante
    async function eliminarVariante(varianteId) {
      try {
        const response = await fetch(`/api/admin/variantes?id=${varianteId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          mostrarNotificacion('Variante eliminada correctamente', 'exito');
          await cargarVariantes(productoActual.id);
        } else {
          mostrarNotificacion('Error al eliminar variante', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('Error al eliminar variante', 'error');
      }
    }

    async function toggleDisponible(varianteId, nuevoEstado) {
      try {
        const response = await fetch(`/api/admin/variantes/${varianteId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ disponible: nuevoEstado }),
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          const estadoTexto = nuevoEstado ? 'disponible' : 'agotada';
          mostrarNotificacion(`Variante marcada como ${estadoTexto}`, 'exito');
          await cargarVariantes(productoActual.id);
        } else {
          mostrarNotificacion('Error al actualizar disponibilidad', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion('Error al actualizar disponibilidad', 'error');
      }
    }

    // Sistema de notificaciones
    function mostrarNotificacion(mensaje, tipo = 'exito') {
      const container = document.getElementById('notificacionesContainer') || crearContainerNotificaciones();
      
      const notif = document.createElement('div');
      notif.className = `notificacion ${tipo}`;
      notif.textContent = mensaje;
      container.appendChild(notif);

      setTimeout(() => {
        notif.classList.add('saliendo');
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    function crearContainerNotificaciones() {
      const container = document.createElement('div');
      container.id = 'notificacionesContainer';
      container.className = 'notificaciones-container';
      document.body.appendChild(container);
      return container;
    }

    // Cargar productos al iniciar
    cargarProductos();
  </script>
</ProtectedLayout>
