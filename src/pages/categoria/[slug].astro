---
import Layout from '../../layouts/Layout.astro';

export const prerender = false;

const { slug } = Astro.params;

const categoryInfo: Record<string, { title: string; subtitle: string; badge: string }> = {
  jamones: { 
    title: 'Jamones Ib√©ricos', 
    subtitle: 'Selecci√≥n exclusiva de jamones ib√©ricos de bellota, curados con tradici√≥n y pasi√≥n',
    badge: 'JAMONES'
  },
  quesos: { 
    title: 'Quesos Artesanales', 
    subtitle: 'Quesos de denominaci√≥n de origen elaborados con t√©cnicas tradicionales',
    badge: 'QUESOS'
  },
  embutidos: { 
    title: 'Embutidos Selectos', 
    subtitle: 'Embutidos ib√©ricos elaborados siguiendo recetas ancestrales',
    badge: 'EMBUTIDOS'
  },
  aceites: {
    title: 'Aceites de Oliva',
    subtitle: 'Aceites de oliva virgen extra de las mejores almazaras',
    badge: 'ACEITES'
  },
  conservas: {
    title: 'Conservas Gourmet',
    subtitle: 'Conservas artesanales elaboradas con ingredientes premium',
    badge: 'CONSERVAS'
  }
};

const info = categoryInfo[slug as string] || {
  title: 'Productos',
  subtitle: 'Nuestros productos de calidad',
  badge: 'PRODUCTOS'
};
---

<Layout>
  <!-- Hero Header de Categor√≠a -->
  <div class="category-hero">
    <span class="category-badge">{info.badge}</span>
    <h1 class="category-title">{info.title}</h1>
    <p class="category-subtitle">{info.subtitle}</p>
  </div>

  <!-- Contador de productos -->
  <div class="products-count-bar">
    <span id="productsCount">Cargando productos...</span>
    <a href="/productos" class="back-to-catalog">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Ver todo el cat√°logo
    </a>
  </div>

  <!-- Barra de Filtros -->
  <div class="filters-bar">
    <div class="filters-container">
      <!-- NUEVA SECCI√ìN DE FILTRO DE PRECIO CON SLIDER -->
      <div class="filtro-precio-container">
        <div class="filtro-precio-header">
          <label class="filtro-precio-label">Rango de Precio</label>
          <div class="filtro-precio-values">
            <span class="filtro-precio-value">
              <span id="precioMinDisplay">‚Ç¨0</span>
            </span>
            <span class="filtro-precio-separator">‚Äî</span>
            <span class="filtro-precio-value">
              <span id="precioMaxDisplay">‚Ç¨1000</span>
            </span>
          </div>
        </div>
        
        <div class="filtro-slider-wrapper">
          <!-- L√≠nea de track de fondo -->
          <div class="filtro-slider-track"></div>
          
          <!-- Sliders -->
          <input type="range" id="sliderPrecioMin" min="0" max="1000" value="0" />
          <input type="range" id="sliderPrecioMax" min="0" max="1000" value="1000" />
        </div>
      </div>

      <select id="filtro-orden" class="filter-select">
        <option value="">Ordenar por nombre</option>
        <option value="nombre">Nombre: A a Z</option>
        <option value="precio-asc">Precio: menor a mayor</option>
        <option value="precio-desc">Precio: mayor a menor</option>
        <option value="nuevos">M√°s recientes</option>
      </select>

      <button id="btn-reset-filtros" class="btn-reset-filters">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
          <path d="M21 3v5h-5"/>
          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
          <path d="M3 21v-5h5"/>
        </svg>
        Limpiar filtros
      </button>
    </div>
  </div>

  <!-- Grid de Productos -->
  <div id="productosGrid" data-categoria={slug} class="productos-grid"></div>

  <!-- Modal para seleccionar variante -->
  <div id="varianteModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 id="varianteModalTitle" class="modal-title">Selecciona el Peso</h2>
        <button id="varianteModalClose" class="modal-close-btn" aria-label="Cerrar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="variantesList" class="variantes-list"></div>
    </div>
  </div>

  <!-- Modal para seleccionar cantidad -->
  <div id="cantidadModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">¬øCu√°ntas unidades?</h2>
        <button id="cantidadModalClose" class="modal-close-btn" aria-label="Cerrar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="cantidad-input-wrapper">
        <button type="button" class="cantidad-btn cantidad-minus">‚àí</button>
        <input type="number" id="cantidadInput" min="1" value="1" class="cantidad-input" />
        <button type="button" class="cantidad-btn cantidad-plus">+</button>
      </div>
      <div class="modal-actions">
        <button id="cantidadConfirm" class="btn-modal-primary">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>
          </svg>
          Agregar al carrito
        </button>
        <button id="cantidadCancel" class="btn-modal-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <style>
    /* ===== HERO DE CATEGOR√çA ===== */
    .category-hero {
      text-align: center;
      padding: 2.5rem 1.5rem 3rem;
      margin: 0 -1.5rem 1.5rem -1.5rem;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-radius: 0;
      position: relative;
      overflow: hidden;
    }

    .category-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
    }

    .category-badge {
      display: inline-block;
      color: #a89968;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 3px;
      padding: 8px 20px;
      background: rgba(168, 153, 104, 0.15);
      border: 1px solid rgba(168, 153, 104, 0.3);
      border-radius: 30px;
      margin-bottom: 1.25rem;
      position: relative;
    }

    .category-title {
      font-size: clamp(2rem, 6vw, 3.5rem);
      margin: 0 0 1rem 0;
      color: #fff;
      font-weight: 700;
      letter-spacing: -1px;
      line-height: 1.1;
      position: relative;
    }

    .category-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 1rem;
      max-width: 550px;
      margin: 0 auto;
      font-weight: 400;
      line-height: 1.6;
      position: relative;
    }

    /* ===== BARRA DE CONTADOR ===== */
    .products-count-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-color, #eee);
    }

    .products-count-bar span {
      color: var(--text-muted, #666);
      font-size: 0.9rem;
    }

    .back-to-catalog {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #a89968;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .back-to-catalog:hover {
      color: #8b7d52;
      gap: 8px;
    }

    /* ===== FILTERS BAR ===== */
    .filters-bar {
      background: var(--bg-card, #fff);
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color, #eee);
    }

    .filters-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.75rem 1rem;
      background: var(--bg-tertiary, #f5f5f5);
      border: 1px solid var(--border-color, #ddd);
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--text-primary, #333);
      cursor: pointer;
      transition: all 0.2s;
      min-width: 180px;
    }

    .filter-select:hover {
      border-color: var(--color-accent, #a89968);
      background: var(--bg-secondary, #faf9f7);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--color-accent, #a89968);
      box-shadow: 0 0 0 3px rgba(168, 153, 104, 0.1);
    }

    .filter-select option {
      background: var(--bg-card, #fff);
      color: var(--text-primary, #333);
    }

    .btn-reset-filters {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: 1px solid var(--border-color, #ddd);
      border-radius: 8px;
      color: var(--text-muted, #666);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }

    .btn-reset-filters:hover {
      border-color: var(--color-accent, #a89968);
      color: var(--color-accent, #a89968);
      background: var(--bg-tertiary, #faf9f7);
    }

    /* ===== FILTER PRECIO SLIDER ===== */
    .filtro-precio-container {
      padding: 1rem 0;
      background: transparent;
      border-radius: 0;
      border: none;
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 100%;
      max-width: 350px;
    }

    .filtro-precio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .filtro-precio-label {
      font-weight: 700;
      color: var(--text-primary, #001a33);
      font-size: 0.9rem;
    }

    .filtro-precio-values {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .filtro-precio-value {
      color: var(--text-primary, #001a33);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .filtro-precio-separator {
      color: var(--color-accent, #a89968);
      font-weight: 400;
    }

    .filtro-slider-wrapper {
      position: relative;
      width: 100%;
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 4px;
    }

    .filtro-slider-track {
      position: absolute;
      width: 100%;
      height: 2px;
      background: var(--border-color, #d4c4b0);
      border-radius: 1px;
      top: 50%;
      transform: translateY(-50%);
      left: 0;
    }

    #sliderPrecioMin, #sliderPrecioMax {
      position: absolute;
      width: 100%;
      height: 50px;
      outline: none;
      -webkit-appearance: none;
      pointer-events: auto;
      background: transparent;
      padding: 0;
      margin: 0;
      left: 0;
      cursor: pointer;
    }

    #sliderPrecioMin {
      z-index: 5;
    }

    #sliderPrecioMax {
      z-index: 6;
    }

    #sliderPrecioMin::-webkit-slider-thumb, #sliderPrecioMax::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a89968 0%, #8b7d52 100%);
      cursor: grab;
      border: 2px solid white;
      box-shadow: 0 3px 10px rgba(0, 26, 51, 0.25), inset 0 1px 2px rgba(255, 255, 255, 0.5);
      transition: all 0.2s ease;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-webkit-slider-thumb:hover, #sliderPrecioMax::-webkit-slider-thumb:hover {
      background: linear-gradient(135deg, #b8a978 0%, #9a8a62 100%);
      box-shadow: 0 4px 14px rgba(168, 153, 104, 0.35), inset 0 1px 2px rgba(255, 255, 255, 0.6);
      transform: translateY(-50%) scale(1.1);
    }

    #sliderPrecioMin::-webkit-slider-thumb:active, #sliderPrecioMax::-webkit-slider-thumb:active {
      cursor: grabbing;
      background: linear-gradient(135deg, #987d52 0%, #7a6d42 100%);
      box-shadow: 0 2px 8px rgba(0, 26, 51, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.4);
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-moz-range-thumb, #sliderPrecioMax::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a89968 0%, #8b7d52 100%);
      cursor: grab;
      border: 2px solid white;
      box-shadow: 0 3px 10px rgba(0, 26, 51, 0.25), inset 0 1px 2px rgba(255, 255, 255, 0.5);
      transition: all 0.2s ease;
      position: relative;
      top: 50%;
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-moz-range-thumb:hover, #sliderPrecioMax::-moz-range-thumb:hover {
      background: linear-gradient(135deg, #b8a978 0%, #9a8a62 100%);
      box-shadow: 0 4px 14px rgba(168, 153, 104, 0.35), inset 0 1px 2px rgba(255, 255, 255, 0.6);
      transform: translateY(-50%) scale(1.1);
    }

    #sliderPrecioMin::-moz-range-thumb:active, #sliderPrecioMax::-moz-range-thumb:active {
      cursor: grabbing;
      background: linear-gradient(135deg, #987d52 0%, #7a6d42 100%);
      box-shadow: 0 2px 8px rgba(0, 26, 51, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.4);
      transform: translateY(-50%);
    }

    #sliderPrecioMin::-webkit-slider-runnable-track, #sliderPrecioMax::-webkit-slider-runnable-track {
      background: transparent;
      border: none;
      height: 50px;
    }

    #sliderPrecioMin::-moz-range-track, #sliderPrecioMax::-moz-range-track {
      background: transparent;
      border: none;
    }

    #sliderPrecioMin::-moz-focus-outer, #sliderPrecioMax::-moz-focus-outer {
      border: none;
    }

    @media (max-width: 1024px) {
      .filtro-precio-container {
        min-width: 100%;
        width: 100%;
        margin-bottom: 1rem;
      }

      .btn-reset-filters {
        margin-left: 0;
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      .filters-container {
        padding: 0 1rem;
        gap: 0.75rem;
      }

      .filter-select {
        min-width: 140px;
        font-size: 0.85rem;
      }

      .btn-reset-filters {
        margin-left: 0;
        margin-top: 0.5rem;
        flex-basis: 100%;
        justify-content: center;
      }
    }

    /* ===== GRID DE PRODUCTOS ===== */
    .productos-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
      padding: 0;
      margin-bottom: 4rem;
    }

    /* ===== MODAL STYLES ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 20, 40, 0.6);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 0;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
      animation: modalSlideIn 0.3s ease-out;
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .modal-title {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 700;
      transition: color 0.3s ease;
    }

    .modal-close-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-close-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--color-accent);
    }

    .variantes-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      padding: 1.25rem 1.5rem;
      max-height: 350px;
      overflow-y: auto;
      background: var(--bg-card);
    }

    :global(.variante-option) {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      padding: 14px 16px !important;
      background: var(--bg-tertiary) !important;
      border: 2px solid var(--border-color) !important;
      border-radius: 12px !important;
      cursor: pointer !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      width: 100% !important;
      font-family: Inter, sans-serif !important;
    }

    :global(.variante-option:hover) {
      border-color: var(--color-accent) !important;
      background: var(--bg-secondary) !important;
      transform: translateX(4px) !important;
      box-shadow: 0 4px 12px rgba(168, 153, 104, 0.2) !important;
    }

    :global(.variante-info) {
      display: flex !important;
      flex-direction: column !important;
      gap: 4px !important;
      text-align: left !important;
      pointer-events: none !important;
    }

    :global(.variante-peso) {
      font-size: 0.95rem !important;
      font-weight: 700 !important;
      color: var(--text-primary) !important;
      pointer-events: none !important;
    }

    :global(.variante-tipo) {
      font-size: 0.7rem !important;
      color: var(--text-muted) !important;
      text-transform: uppercase !important;
      letter-spacing: 0.3px !important;
      font-weight: 500 !important;
      pointer-events: none !important;
    }

    :global(.variante-precio-wrap) {
      display: flex !important;
      flex-direction: column !important;
      align-items: flex-end !important;
      gap: 2px !important;
      pointer-events: none !important;
    }

    :global(.variante-precio) {
      font-size: 1.2rem !important;
      font-weight: 800 !important;
      color: var(--color-accent) !important;
      pointer-events: none !important;
    }

    :global(.variante-arrow) {
      color: var(--color-accent) !important;
      margin-top: 2px;
      pointer-events: none !important;
    }

    .variante-empty {
      color: var(--text-muted);
      text-align: center;
      padding: 1rem;
    }

    /* ===== STOCK INFO & LABELS ===== */
    :global(.stock-info) {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 5px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }

    :global(.stock-info svg) {
      color: var(--color-accent);
    }

    :global(.stock-info.stock-agotado) {
      color: #999;
      background: #f5f5f5;
    }

    :global(.stock-info.stock-agotado svg) {
      color: #999;
    }

    :global(.stock-label) {
      display: inline-flex;
      align-items: center;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    :global(.stock-label-disponible) {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    :global(.stock-label-agotandose) {
      background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
      color: #92400e;
    }

    :global(.stock-label-ultima) {
      background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);
      color: #991b1b;
      animation: pulse-stock 2s ease-in-out infinite;
    }

    @keyframes pulse-stock {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .cantidad-input-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      padding: 1.5rem;
      background: var(--bg-card);
    }

    .cantidad-btn {
      width: 48px;
      height: 48px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .cantidad-minus { border-radius: 8px 0 0 8px; }
    .cantidad-plus { border-radius: 0 8px 8px 0; }

    .cantidad-btn:hover {
      background: var(--color-accent);
      color: white;
      border-color: var(--color-accent);
    }

    .cantidad-input {
      width: 80px;
      height: 48px;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      border: 1px solid var(--border-color);
      border-left: none;
      border-right: none;
      color: var(--text-primary);
      background: var(--bg-card);
      transition: all 0.2s;
    }

    .cantidad-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 0 1.5rem 1.5rem;
      background: var(--bg-card);
    }

    .btn-modal-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.9rem 1.5rem;
      background: linear-gradient(135deg, #a89968 0%, #9a8a5c 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(168, 153, 104, 0.3);
    }

    .btn-modal-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168, 153, 104, 0.4);
    }

    .btn-modal-secondary {
      width: 100%;
      padding: 0.75rem 1.5rem;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-modal-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--color-accent);
      color: var(--text-primary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1400px) {
      .productos-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }
    }

    @media (max-width: 1024px) {
      .productos-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 16px !important;
      }
    }

    @media (max-width: 768px) {
      .category-hero {
        padding: 2rem 1.25rem 2.5rem;
        border-radius: 20px;
      }
      .category-badge {
        font-size: 0.6rem;
        letter-spacing: 2px;
        padding: 6px 16px;
      }
      .category-subtitle {
        font-size: 0.9rem;
      }
      .products-count-bar {
        flex-direction: column;
        gap: 0.75rem;
        text-align: center;
      }
    }

    @media (max-width: 640px) {
      .productos-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      .productos-grid article {
        border-radius: 16px !important;
      }
      
      .productos-grid article > div:last-child {
        padding: 14px !important;
      }
      
      .productos-grid article h3 {
        font-size: 0.9rem !important;
      }
      
      .productos-grid article button {
        padding: 10px 14px !important;
        font-size: 0.75rem !important;
        border-radius: 10px !important;
      }
      
      .productos-grid article button span {
        display: none !important;
      }
    }

    @media (max-width: 480px) {
      .category-hero {
        padding: 1.5rem 1rem 2rem;
        border-radius: 16px;
        margin-bottom: 1rem;
      }
      .category-badge {
        font-size: 0.55rem;
        padding: 5px 12px;
        margin-bottom: 1rem;
      }
      .category-title {
        margin-bottom: 0.75rem;
      }
      .category-subtitle {
        font-size: 0.85rem;
      }
      .productos-grid {
        gap: 10px !important;
      }
      
      .productos-grid article {
        border-radius: 14px !important;
      }
      
      .productos-grid article > div:last-child {
        padding: 12px !important;
        gap: 6px !important;
      }
      
      .productos-grid article h3 {
        font-size: 0.85rem !important;
        -webkit-line-clamp: 1 !important;
      }
      
      .productos-grid article > div:last-child > div:last-child {
        padding-top: 10px !important;
      }
      
      .productos-grid article > div:last-child > div:last-child > div span:last-child {
        font-size: 1.2rem !important;
      }
      
      .productos-grid article button {
        padding: 10px 12px !important;
      }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>

  <script type="text/javascript">
    const categoria = document.getElementById('productosGrid').dataset.categoria;
    let variantesMap = {};
    let productosGlobal = [];
    let productoEnModal = null;
    let productosOriginales = [];
    let variantesReservadas = [];

    async function cargarProductos() {
      try {
        // Obtener ofertas activas
        let ofertasMap = new Map();
        try {
          const ofertasResponse = await fetch('/api/ofertas');
          const ofertasData = await ofertasResponse.json();
          if (ofertasData.success && ofertasData.data) {
            ofertasData.data.forEach(oferta => {
              ofertasMap.set(oferta.producto_id, oferta);
            });
          }
        } catch (error) {
          console.error('Error cargando ofertas:', error);
        }

        const response = await fetch('/api/admin/productos');
        const data = await response.json();

        // Obtener variantes reservadas
        const reservadosResponse = await fetch('/api/productos/reservados');
        const { variantesReservadas: varReservadas } = await reservadosResponse.json();
        variantesReservadas = varReservadas || [];

        let productos = [];

        if (data.success && data.productos) {
          // Filtrar por categor√≠a y mapear
          productos = data.productos
            .filter(p => p.categorias?.slug === categoria)
            .map(p => {
              const oferta = ofertasMap.get(p.id);
              const precioCentimos = oferta ? oferta.precio_descuento_centimos : p.precio_centimos;
              const precioOriginalCentimos = p.precio_centimos;

              return {
                id: p.id,
                nombre: p.nombre,
                precio: (precioCentimos / 100).toFixed(2),
                precioOriginal: (precioOriginalCentimos / 100).toFixed(2),
                precio_centimos: precioCentimos,
                tieneOferta: !!oferta,
                oferta: oferta,
                categoria: p.categorias?.nombre || categoria,
                imagen: p.imagen_url || 'https://images.unsplash.com/photo-1557803104268-0ef0f060e15f?w=500&h=500&fit=crop',
                descripcion: p.descripcion || 'Sin descripci√≥n',
                es_variable: p.es_variable || false,
                stock: p.stock ?? 0
              };
            });

          productosGlobal = productos;
          productosOriginales = productos;

          // Cargar variantes para productos variables
          for (const producto of productos) {
            if (producto.es_variable) {
              await cargarVariantesProducto(producto.id);
            }
          }
        }

        // Actualizar contador
        document.getElementById('productsCount').textContent = 
          `${productos.length} producto${productos.length !== 1 ? 's' : ''} encontrado${productos.length !== 1 ? 's' : ''}`;

        // Renderizar productos
        renderizarProductos(productos);

        // Agregar event listeners a los filtros
        const sliderPrecioMin = document.getElementById('sliderPrecioMin');
        const sliderPrecioMax = document.getElementById('sliderPrecioMax');
        const precioMinDisplay = document.getElementById('precioMinDisplay');
        const precioMaxDisplay = document.getElementById('precioMaxDisplay');
        const filtroOrden = document.getElementById('filtro-orden');
        const btnResetFiltros = document.getElementById('btn-reset-filtros');

        // Inicializar con valores reales del cat√°logo
        const preciosProductos = productosOriginales.map(p => parseFloat(p.precio)).sort((a, b) => a - b);
        const precioMinReal = Math.floor(preciosProductos[0]) || 0;
        const precioMaxReal = Math.ceil(preciosProductos[preciosProductos.length - 1]) || 1000;
        
        console.log('Precios encontrados:', preciosProductos);
        console.log('Precio m√°ximo real:', precioMaxReal);
        
        // Actualizar los sliders de visualizaci√≥n
        sliderPrecioMin.value = 0;
        sliderPrecioMax.value = precioMaxReal;
        precioMinDisplay.textContent = `‚Ç¨0`;
        precioMaxDisplay.textContent = `‚Ç¨${precioMaxReal}`;
        
        sliderPrecioMin.max = precioMaxReal;
        sliderPrecioMax.min = 0;
        sliderPrecioMax.max = precioMaxReal;

        function actualizarSliders() {
          const min = parseFloat(sliderPrecioMin.value) || 0;
          const max = parseFloat(sliderPrecioMax.value) || precioMaxReal;

          if (min > max) {
            sliderPrecioMin.value = max;
          }
          if (max < min) {
            sliderPrecioMax.value = min;
          }

          // Actualizar displays
          const minVal = Math.round(sliderPrecioMin.value) || 0;
          const maxVal = Math.round(sliderPrecioMax.value) || precioMaxReal;
          
          precioMinDisplay.textContent = `‚Ç¨${minVal}`;
          precioMaxDisplay.textContent = `‚Ç¨${maxVal}`;
          
          actualizarContadorFiltrado();
          aplicarFiltros();
        }

        sliderPrecioMin.addEventListener('input', actualizarSliders);
        sliderPrecioMax.addEventListener('input', actualizarSliders);

        if (filtroOrden) {
          filtroOrden.addEventListener('change', () => {
            actualizarContadorFiltrado();
            aplicarFiltros();
          });
        }

        if (btnResetFiltros) {
          btnResetFiltros.addEventListener('click', () => {
            sliderPrecioMin.value = 0;
            sliderPrecioMax.value = precioMaxReal;
            precioMinDisplay.textContent = `‚Ç¨0`;
            precioMaxDisplay.textContent = `‚Ç¨${precioMaxReal}`;
            if (filtroOrden) filtroOrden.value = '';
            document.getElementById('productsCount').textContent =
              `${productosOriginales.length} producto${productosOriginales.length !== 1 ? 's' : ''} encontrado${productosOriginales.length !== 1 ? 's' : ''}`;
            renderizarProductos(productosOriginales);
          });
        }

      } catch (error) {
        console.error('Error cargando productos:', error);
        document.getElementById('productosGrid').innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;">
            <p style="color: #e53935;">Error cargando productos. Por favor, recarga la p√°gina.</p>
          </div>
        `;
      }
    }

    async function cargarVariantesProducto(productoId) {
      try {
        const response = await fetch(`/api/variantes/${productoId}`);
        const data = await response.json();
        if (data.success && data.variantes) {
          variantesMap[productoId] = data.variantes;
        }
      } catch (error) {
        console.error('Error cargando variantes:', error);
      }
    }

    function actualizarContadorFiltrado() {
      const precioMin = parseFloat(document.getElementById('precioMin').value) || 0;
      const precioMax = parseFloat(document.getElementById('precioMax').value) || 1000;
      const filtrados = productosOriginales.filter(p => {
        const precio = parseFloat(p.precio);
        return precio >= precioMin && precio <= precioMax;
      });

      document.getElementById('productsCount').textContent = 
        `${filtrados.length} producto${filtrados.length !== 1 ? 's' : ''} encontrado${filtrados.length !== 1 ? 's' : ''}`;
    }

    function aplicarFiltros() {
      const precioMin = parseFloat(document.getElementById('precioMin').value) || 0;
      const precioMax = parseFloat(document.getElementById('precioMax').value) || 1000;
      const ordenSelect = document.getElementById('filtro-orden');
      
      const ordenSeleccionado = ordenSelect.value;

      // Filtrar por precio
      let productosFiltrados = productosOriginales.filter(p => {
        const precio = parseFloat(p.precio);
        return precio >= precioMin && precio <= precioMax;
      });

      // Ordenar
      if (ordenSeleccionado === 'nombre') {
        productosFiltrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
      } else if (ordenSeleccionado === 'precio-asc') {
        productosFiltrados.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio));
      } else if (ordenSeleccionado === 'precio-desc') {
        productosFiltrados.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio));
      }

      // Re-renderizar
      renderizarProductos(productosFiltrados);
    }

    function renderizarProductos(productos) {
      const grid = document.getElementById('productosGrid');

      if (productos.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 4rem 2rem;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" style="margin-bottom: 1rem;">
              <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
            <p style="color: #666; font-size: 1.1rem; margin: 0 0 1rem 0;">No hay productos que coincidan con los filtros</p>
          </div>
        `;
        return;
      }

      // Obtener variantes en el carrito local para filtrarlas
      const carritoLocal = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');

      // MOSTRAR todos los productos (no filtrar)
      // Los productos variables sin variantes disponibles se mostrar√°n como "Agotado"

      // Ordenar: productos disponibles primero, agotados al final
      const productosOrdenados = productos.sort((a, b) => {
        const todasLasVariantesA = variantesMap[a.id] || [];
        const variantesEnCarritoA = carritoLocal.filter(item => item.producto_id === a.id && item.producto_variante_id).map(item => parseInt(item.producto_variante_id));
        const variantesConStockA = todasLasVariantesA.filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0 && !variantesEnCarritoA.includes(parseInt(v.id)));
        const agotadoA = (!a.es_variable && a.stock <= 0) || (a.es_variable && variantesConStockA.length === 0);
        
        const todasLasVariantesB = variantesMap[b.id] || [];
        const variantesEnCarritoB = carritoLocal.filter(item => item.producto_id === b.id && item.producto_variante_id).map(item => parseInt(item.producto_variante_id));
        const variantesConStockB = todasLasVariantesB.filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0 && !variantesEnCarritoB.includes(parseInt(v.id)));
        const agotadoB = (!b.es_variable && b.stock <= 0) || (b.es_variable && variantesConStockB.length === 0);
        
        // Si uno est√° agotado y otro no, el disponible va primero
        if (agotadoA && !agotadoB) return 1;
        if (!agotadoA && agotadoB) return -1;
        return 0;
      });

      grid.innerHTML = productosOrdenados.map(p => {
        const botonText = p.es_variable ? 'Seleccionar Peso' : 'A√±adir al Carrito';
        const botonClass = p.es_variable ? 'btn-seleccionar-variante' : 'btn-agregar-carrito';

        // Verificar stock (teniendo en cuenta las variantes en el carrito local)
        const todasLasVariantes = variantesMap[p.id] || [];
        const variantesEnCarrito = carritoLocal.filter(item => item.producto_id === p.id && item.producto_variante_id).map(item => parseInt(item.producto_variante_id));
        const variantesConStock = todasLasVariantes.filter(v => v.disponible === true && (v.cantidad_disponible || 0) > 0 && !variantesEnCarrito.includes(parseInt(v.id)));
        const productoAgotado = (!p.es_variable && p.stock <= 0) || (p.es_variable && variantesConStock.length === 0);

        // Calcular cantidad disponible (para productos variables cuenta las variantes, para normales el stock)
        const cantidadDisponible = p.es_variable ? variantesConStock.length : p.stock;
        
        // Determinar etiqueta de estado de stock
        let stockLabel = '';
        let stockLabelClass = '';
        if (!productoAgotado) {
          if (cantidadDisponible === 1) {
            stockLabel = '¬°√öLTIMA UNIDAD!';
            stockLabelClass = 'stock-label-ultima';
          } else if (cantidadDisponible <= 5) {
            stockLabel = 'Agot√°ndose';
            stockLabelClass = 'stock-label-agotandose';
          } else {
            stockLabel = 'Disponible';
            stockLabelClass = 'stock-label-disponible';
          }
        }

        const stockText = p.es_variable 
          ? `${variantesConStock.length} opci√≥n${variantesConStock.length !== 1 ? 'es' : ''}`
          : `${p.stock} unidad${p.stock !== 1 ? 'es' : ''}`;

        return `
          <article data-id="${p.id}" class="producto-card" style="
            background: var(--bg-card);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
          ">
            ${p.tieneOferta ? `
              <div style="
                position: absolute;
                top: 16px;
                left: 16px;
                z-index: 10;
                background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
                color: white;
                padding: 6px 14px;
                border-radius: 30px;
                font-weight: 700;
                font-size: 0.8rem;
                box-shadow: 0 4px 15px rgba(229, 57, 53, 0.4);
                letter-spacing: 0.5px;
              ">-${p.oferta.porcentaje_descuento}%</div>
            ` : ''}
            
            <a href="/productos/${p.id}" style="
              display: block;
              width: 100%;
              aspect-ratio: 1/1;
              overflow: hidden;
              background: linear-gradient(145deg, #f5f5f5 0%, #e8e8e8 100%);
              position: relative;
            ">
              <img src="${p.imagen}" alt="${p.nombre}" loading="lazy" style="
                width: 100%;
                height: 100%;
                object-fit: cover;
                object-position: center;
                transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
              " class="product-image" />
              ${productoAgotado ? `
                <div style="
                  position: absolute;
                  inset: 0;
                  background: rgba(0,0,0,0.5);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">
                  <span style="
                    background: rgba(255,255,255,0.95);
                    color: #1a1a1a;
                    padding: 10px 24px;
                    border-radius: 30px;
                    font-weight: 700;
                    font-size: 0.85rem;
                    text-transform: uppercase;
                    letter-spacing: 1.5px;
                  ">Agotado</span>
                </div>
              ` : ''}
            </a>
            
            <div style="
              padding: 20px;
              display: flex;
              flex-direction: column;
              flex-grow: 1;
              gap: 8px;
            ">
              <a href="/productos/${p.id}" style="text-decoration: none;">
                <h3 style="
                  font-size: 1rem;
                  font-weight: 600;
                  color: var(--text-primary);
                  margin: 0;
                  line-height: 1.4;
                  display: -webkit-box;
                  -webkit-line-clamp: 2;
                  -webkit-box-orient: vertical;
                  overflow: hidden;
                  transition: color 0.3s;
                " class="product-title">${p.nombre}</h3>
              </a>
              
              <div style="
                display: flex;
                align-items: center;
                gap: 6px;
                margin-top: 4px;
                flex-wrap: wrap;
              ">
                <span class="stock-info ${productoAgotado ? 'stock-agotado' : ''}">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                  ${productoAgotado ? 'Agotado' : stockText}
                </span>
                ${!productoAgotado ? `<span class="stock-label ${stockLabelClass}">${stockLabel}</span>` : ''}
              </div>
              
              <div style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                padding-top: 12px;
                margin-top: auto;
              ">
                <div style="
                  display: flex;
                  align-items: baseline;
                  gap: 6px;
                ">
                  ${p.tieneOferta ? `
                    <span style="
                      color: #999;
                      text-decoration: line-through;
                      font-size: 0.85rem;
                    ">${p.precioOriginal}‚Ç¨</span>
                  ` : ''}
                  <span style="
                    font-size: 1.25rem;
                    font-weight: 700;
                    color: #a89968;
                  ">${p.precio}‚Ç¨</span>
                </div>
                
                <button 
                  class="product-btn ${botonClass}"
                  data-id="${p.id}"
                  ${productoAgotado ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}
                  style="
                    padding: 6px 10px;
                    background: linear-gradient(135deg, #a89968 0%, #9a8a5c 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 0.65rem;
                    cursor: ${productoAgotado ? 'not-allowed' : 'pointer'};
                    transition: all 0.3s;
                    box-shadow: 0 4px 12px rgba(168, 153, 104, 0.3);
                    flex-shrink: 0;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    white-space: nowrap;
                  "
                >${botonText}</button>
              </div>
            </div>
          </article>
        `;
      }).join('');

      agregarEventListeners(variantesReservadas);
    }

    function agregarEventListeners(variantesReservadas) {
      // Botones agregar al carrito
      document.querySelectorAll('.btn-agregar-carrito:not([disabled])').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const productoId = btn.getAttribute('data-id');
          abrirModalCantidad(productoId);
        });
      });

      // Botones seleccionar variante
      document.querySelectorAll('.btn-seleccionar-variante:not([disabled])').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const productoId = btn.getAttribute('data-id');
          
          // Actualizar variantes reservadas antes de abrir el modal
          console.log('üîÑ Actualizando variantes reservadas antes de abrir modal...');
          try {
            const reservadosResponse = await fetch('/api/productos/reservados');
            if (reservadosResponse.ok) {
              const data = await reservadosResponse.json();
              variantesReservadas = data.variantesReservadas || {};
              console.log('‚úÖ Variantes reservadas actualizadas:', variantesReservadas);
            }
          } catch (error) {
            console.error('‚ùå Error actualizando variantes reservadas:', error);
          }
          
          abrirModalVariantes(productoId, variantesReservadas);
        });
      });

      // Hover effects
      document.querySelectorAll('.product-image').forEach(img => {
        img.addEventListener('mouseover', () => img.style.transform = 'scale(1.08)');
        img.addEventListener('mouseout', () => img.style.transform = 'scale(1)');
      });

      document.querySelectorAll('.product-title').forEach(title => {
        title.addEventListener('mouseover', () => title.style.color = '#a89968');
        title.addEventListener('mouseout', () => title.style.color = '#1a1a1a');
      });

      document.querySelectorAll('.product-btn').forEach(btn => {
        btn.addEventListener('mouseover', () => {
          btn.style.transform = 'translateY(-2px)';
          btn.style.boxShadow = '0 8px 20px rgba(168, 153, 104, 0.4)';
        });
        btn.addEventListener('mouseout', () => {
          btn.style.transform = 'translateY(0)';
          btn.style.boxShadow = '0 4px 12px rgba(168, 153, 104, 0.3)';
        });
      });
    }

    // Funci√≥n para actualizar el estado visual del producto en la tarjeta
    function actualizarEstadoProducto(productoId, variantesDisponibles) {
      console.log(`üîç Buscando tarjeta para producto ${productoId}...`);
      const card = document.querySelector(`.producto-card[data-id="${productoId}"]`) || 
                   document.querySelector(`article[data-id="${productoId}"]`);
      if (!card) {
        console.log(`‚ùå No se encontr√≥ tarjeta para producto ${productoId}`);
        return;
      }
      console.log(`‚úÖ Tarjeta encontrada para producto ${productoId}`);
      
      console.log(`üìä Actualizando estado producto ${productoId}: ${variantesDisponibles} variantes disponibles`);
      
      // Encontrar elementos a actualizar
      const stockInfo = card.querySelector('.stock-info');
      const stockLabel = card.querySelector('.stock-label');
      const imgContainer = card.querySelector('.producto-img-container');
      const button = card.querySelector('.product-btn');
      
      if (variantesDisponibles === 0) {
        // PRODUCTO AGOTADO
        console.log('üö´ Producto agotado - actualizando UI');
        
        // Actualizar stock-info
        if (stockInfo) {
          stockInfo.classList.add('stock-agotado');
          stockInfo.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            Agotado
          `;
        }
        
        // Eliminar stock-label
        if (stockLabel) {
          stockLabel.remove();
        }
        
        // A√±adir overlay de agotado en el contenedor de imagen
        if (imgContainer) {
          const existingOverlay = imgContainer.querySelector('.producto-agotado-overlay');
          if (!existingOverlay) {
            const overlay = document.createElement('div');
            overlay.className = 'producto-agotado-overlay';
            overlay.innerHTML = `<span class="producto-agotado-text">Agotado</span>`;
            imgContainer.appendChild(overlay);
            console.log('‚úÖ Overlay de agotado a√±adido');
          }
        }
        
        // Deshabilitar bot√≥n y cambiar su contenido
        if (button) {
          button.disabled = true;
          button.classList.add('btn-agotado');
          button.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <circle cx="12" cy="12" r="10"/><path d="M8 8l8 8M16 8l-8 8"/>
            </svg>
            <span>Agotado</span>
          `;
          console.log('‚úÖ Bot√≥n actualizado a Agotado');
        }
      } else {
        // PRODUCTO CON STOCK - actualizar cantidad
        console.log(`‚úÖ Producto con ${variantesDisponibles} variantes disponibles`);
        
        // Actualizar texto de stock-info
        if (stockInfo) {
          stockInfo.classList.remove('stock-agotado');
          stockInfo.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            ${variantesDisponibles} opci√≥n${variantesDisponibles !== 1 ? 'es' : ''}
          `;
        }
        
        // Actualizar stock-label
        let newLabel = '';
        let newLabelClass = '';
        if (variantesDisponibles === 1) {
          newLabel = '¬°√öLTIMA UNIDAD!';
          newLabelClass = 'stock-label stock-label-ultima';
        } else if (variantesDisponibles <= 5) {
          newLabel = 'Agot√°ndose';
          newLabelClass = 'stock-label stock-label-agotandose';
        } else {
          newLabel = 'Disponible';
          newLabelClass = 'stock-label stock-label-disponible';
        }
        
        if (stockLabel) {
          stockLabel.textContent = newLabel;
          stockLabel.className = newLabelClass;
        } else if (stockInfo && stockInfo.parentElement) {
          const newSpan = document.createElement('span');
          newSpan.className = newLabelClass;
          newSpan.textContent = newLabel;
          stockInfo.parentElement.appendChild(newSpan);
        }
        
        // Remover overlay si existe
        if (imgContainer) {
          const existingOverlay = imgContainer.querySelector('.producto-agotado-overlay');
          if (existingOverlay) {
            existingOverlay.remove();
          }
        }
        
        // Habilitar bot√≥n
        if (button) {
          button.disabled = false;
          button.classList.remove('btn-agotado');
        }
      }
    }

    function abrirModalCantidad(productoId) {
      productoEnModal = productosGlobal.find(p => p.id === parseInt(productoId));
      if (!productoEnModal) return;

      const modal = document.getElementById('cantidadModal');
      const input = document.getElementById('cantidadInput');
      input.value = '1';
      input.max = productoEnModal.stock;
      modal.style.display = 'flex';
    }

    function abrirModalVariantes(productoId, variantesReservadasParam = {}) {
      const producto = productosGlobal.find(p => p.id === parseInt(productoId));
      if (!producto) return;

      productoEnModal = producto;
      const variantes = variantesMap[productoId] || [];
      
      // variantesReservadasParam puede ser un array o un objeto {productoId: [varianteIds]}
      let reservadasArray = [];
      if (Array.isArray(variantesReservadasParam)) {
        reservadasArray = variantesReservadasParam;
      } else if (typeof variantesReservadasParam === 'object') {
        reservadasArray = variantesReservadasParam[productoId] || [];
      }
      
      // Tambi√©n filtrar las variantes que ya est√°n en el carrito local del invitado
      const carritoLocal = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
      const variantesEnCarritoLocal = carritoLocal
        .filter(item => item.producto_id === parseInt(productoId) && item.producto_variante_id)
        .map(item => parseInt(item.producto_variante_id));
      
      const disponibles = variantes.filter(v => {
        const estaReservada = reservadasArray.includes(parseInt(v.id));
        const estaEnCarritoLocal = variantesEnCarritoLocal.includes(parseInt(v.id));
        return v.disponible === true && (v.cantidad_disponible || 0) > 0 && !estaReservada && !estaEnCarritoLocal;
      });

      if (disponibles.length === 0) {
        alert('No hay variantes disponibles para este producto');
        return;
      }

      const modal = document.getElementById('varianteModal');
      const title = document.getElementById('varianteModalTitle');
      const list = document.getElementById('variantesList');

      title.textContent = `Selecciona el peso - ${producto.nombre}`;

      list.innerHTML = '';
      
      disponibles.forEach(v => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'variante-option';
        btn.setAttribute('data-variante-id', v.id);
        btn.setAttribute('data-peso', v.peso_kg);
        btn.setAttribute('data-precio', v.precio_total);
        btn.setAttribute('data-cantidad', v.cantidad_disponible);
        
        const peso = v.peso_kg.toFixed(3);
        const precioEnEuros = (v.precio_total / 100).toFixed(2);
        
        btn.innerHTML = '<div class="variante-info"><span class="variante-peso">' + peso + ' kg</span><span class="variante-tipo">Pieza √∫nica</span></div><div class="variante-precio-wrap"><span class="variante-precio">' + precioEnEuros + '‚Ç¨</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="variante-arrow"><polyline points="9 18 15 12 9 6"></polyline></svg></div>';
        
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const varianteId = btn.getAttribute('data-variante-id');
          const peso = btn.getAttribute('data-peso');
          const precio = btn.getAttribute('data-precio');
          agregarVarianteAlCarrito(varianteId, peso, precio);
        });
        
        list.appendChild(btn);
      });

      modal.style.display = 'flex';
    }

    async function agregarVarianteAlCarrito(varianteId, peso, precio) {
      const userId = localStorage.getItem('user_id');
      
      if (userId) {
        try {
          const response = await fetch('/api/carrito', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-user-id': userId
            },
            body: JSON.stringify({
              producto_id: productoEnModal.id,
              variante_id: parseInt(varianteId),
              cantidad: 1,
              precio_unitario: parseInt(precio),
              peso_kg: parseFloat(peso)
            })
          });

          const result = await response.json();
          if (result.success) {
            mostrarNotificacion('‚úì A√±adido al carrito');
            
            // Recargar variantes para actualizar la UI
            const variantesRes = await fetch(`/api/variantes/obtener-disponibles?producto_id=${productoEnModal.id}`);
            const variantesData = await variantesRes.json();
            if (variantesData.success) {
              variantesMap[productoEnModal.id] = variantesData.variantes;
              actualizarEstadoProducto(productoEnModal.id, variantesData.variantes.length);
            }
            
            cerrarModales();
            window.dispatchEvent(new CustomEvent('carritoActualizado'));
          } else {
            alert(result.error || 'Error al a√±adir al carrito');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al a√±adir al carrito');
        }
      } else {
        agregarAlCarritoLocalVariante(varianteId, peso, precio);
      }
    }

    async function agregarAlCarritoLocalVariante(varianteId, peso, precio) {
      try {
        // Reservar stock en la base de datos primero
        const reservaRes = await fetch('/api/carrito/reservar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            producto_id: productoEnModal.id,
            producto_variante_id: parseInt(varianteId),
            cantidad: 1
          })
        });
        
        const reservaData = await reservaRes.json();
        if (!reservaData.success) {
          console.error('‚ùå Error reservando stock:', reservaData.error);
          mostrarNotificacion(reservaData.error || 'Este producto ya no est√° disponible', 'error');
          cerrarModales();
          return;
        }
        console.log('‚úÖ Stock reservado:', reservaData);

        const carrito = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
        
        const nuevoItem = {
          id: Date.now(),
          producto_id: productoEnModal.id,
          producto_variante_id: parseInt(varianteId),
          nombre: productoEnModal.nombre,
          imagen: productoEnModal.imagen,
          cantidad: 1,
          precio_unitario: parseInt(precio),
          peso_kg: parseFloat(peso),
          fecha_agregado: new Date().toISOString(),
          categoria: productoEnModal.categoria
        };

        carrito.push(nuevoItem);
        localStorage.setItem('carrito_invitado', JSON.stringify(carrito));
        localStorage.setItem('carrito_invitado_fecha', String(Date.now()));
        
        mostrarNotificacion('‚úì A√±adido al carrito');
        
        // Recargar variantes desde el servidor para actualizar el mapa
        console.log('üîÑ Recargando variantes...');
        const variantesRes = await fetch(`/api/variantes/obtener-disponibles?producto_id=${productoEnModal.id}`);
        const variantesData = await variantesRes.json();
        if (variantesData.success) {
          // Actualizar el mapa de variantes
          variantesMap[productoEnModal.id] = variantesData.variantes;
          console.log('‚úÖ Variantes del servidor:', variantesData.variantes.length);
          
          // Filtrar las variantes que ya est√°n en el carrito local
          // IMPORTANTE: Leer el carrito ACTUALIZADO (ya incluye la variante reci√©n a√±adida)
          const carritoLocalActualizado = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
          const variantesEnCarrito = carritoLocalActualizado
            .filter(item => item.producto_id === productoEnModal.id && item.producto_variante_id)
            .map(item => parseInt(item.producto_variante_id)); // Asegurar que son n√∫meros
          
          // Asegurarse de que la variante reci√©n a√±adida est√© en la lista
          const varianteRecienAnadida = parseInt(varianteId);
          if (!variantesEnCarrito.includes(varianteRecienAnadida)) {
            variantesEnCarrito.push(varianteRecienAnadida);
          }
          console.log('üõí Variantes en carrito local (incluyendo reci√©n a√±adida):', variantesEnCarrito);
          
          // Filtrar variantes que est√©n disponibles Y no est√©n en el carrito
          const variantesRealmenteDisponibles = variantesData.variantes.filter(v => {
            const varianteIdNum = parseInt(v.id);
            const estaDisponible = v.disponible === true;
            const tieneStock = (v.cantidad_disponible || 0) > 0;
            const estaEnCarrito = variantesEnCarrito.includes(varianteIdNum);
            console.log(`  Variante ${varianteIdNum}: disponible=${estaDisponible}, stock=${v.cantidad_disponible}, enCarrito=${estaEnCarrito}`);
            return estaDisponible && tieneStock && !estaEnCarrito;
          });
          console.log('‚úÖ Variantes realmente disponibles:', variantesRealmenteDisponibles.length);
          
          // Actualizar la UI de la tarjeta del producto
          actualizarEstadoProducto(productoEnModal.id, variantesRealmenteDisponibles.length);
        }
        
        // Siempre cerrar el modal despu√©s de a√±adir
        cerrarModales();
        window.dispatchEvent(new CustomEvent('carritoActualizado'));
      } catch (error) {
        console.error('‚ùå Error en agregarAlCarritoLocalVariante:', error);
        mostrarNotificacion('Error al a√±adir al carrito', 'error');
      }
    }

    async function agregarProductoAlCarrito(cantidad) {
      if (!productoEnModal) return;

      const userId = localStorage.getItem('user_id');

      if (userId) {
        try {
          const response = await fetch('/api/carrito', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-user-id': userId
            },
            body: JSON.stringify({
              producto_id: productoEnModal.id,
              cantidad: cantidad,
              precio_unitario: productoEnModal.precio_centimos
            })
          });

          const result = await response.json();
          if (result.success) {
            mostrarNotificacion(`‚úì ${cantidad} ${cantidad > 1 ? 'unidades a√±adidas' : 'unidad a√±adida'}`);
            cerrarModales();
            productoEnModal.stock -= cantidad;
            actualizarStockVisual(productoEnModal.id, productoEnModal.stock);
            window.dispatchEvent(new CustomEvent('carritoActualizado'));
          } else {
            alert(result.error || 'Error al a√±adir al carrito');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al a√±adir al carrito');
        }
      } else {
        agregarAlCarritoLocal(cantidad);
      }
    }

    function agregarAlCarritoLocal(cantidad) {
      const carrito = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
      
      const existente = carrito.find(item => 
        item.producto_id === productoEnModal.id && !item.producto_variante_id
      );

      if (existente) {
        existente.cantidad += cantidad;
      } else {
        carrito.push({
          id: Date.now(),
          producto_id: productoEnModal.id,
          nombre: productoEnModal.nombre,
          imagen: productoEnModal.imagen,
          cantidad: cantidad,
          precio_unitario: productoEnModal.precio_centimos,
          fecha_agregado: new Date().toISOString(),
          categoria: productoEnModal.categoria
        });
      }

      localStorage.setItem('carrito_invitado', JSON.stringify(carrito));
      localStorage.setItem('carrito_invitado_fecha', String(Date.now()));
      
      mostrarNotificacion(`‚úì ${cantidad} ${cantidad > 1 ? 'unidades a√±adidas' : 'unidad a√±adida'}`);
      cerrarModales();
      
      productoEnModal.stock -= cantidad;
      actualizarStockVisual(productoEnModal.id, productoEnModal.stock);
      window.dispatchEvent(new CustomEvent('carritoActualizado'));
    }

    function actualizarStockVisual(productoId, nuevoStock) {
      const article = document.querySelector(`article[data-id="${productoId}"]`);
      if (!article) return;

      const stockSpan = article.querySelector('span[style*="border-radius: 20px"]');
      if (stockSpan) {
        if (nuevoStock <= 0) {
          stockSpan.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color: #999">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            Agotado
          `;
          stockSpan.style.color = '#999';
          stockSpan.style.background = '#f5f5f5';
        } else {
          stockSpan.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color: #a89968">
              <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
            ${nuevoStock} unidad${nuevoStock !== 1 ? 'es' : ''}
          `;
        }
      }
    }

    function cerrarModales() {
      document.getElementById('varianteModal').style.display = 'none';
      document.getElementById('cantidadModal').style.display = 'none';
      productoEnModal = null;
    }

    function mostrarNotificacion(mensaje) {
      const notif = document.createElement('div');
      notif.textContent = mensaje;
      notif.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        color: white;
        padding: 14px 28px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.95rem;
        z-index: 9999;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        animation: slideUp 0.3s ease-out;
      `;
      document.body.appendChild(notif);
      setTimeout(() => {
        notif.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => notif.remove(), 300);
      }, 2500);
    }

    // Inicializar modales
    document.getElementById('varianteModalClose').addEventListener('click', cerrarModales);
    document.getElementById('cantidadModalClose').addEventListener('click', cerrarModales);
    document.getElementById('cantidadCancel').addEventListener('click', cerrarModales);

    document.getElementById('varianteModal').addEventListener('click', (e) => {
      if (e.target.id === 'varianteModal') cerrarModales();
    });
    document.getElementById('cantidadModal').addEventListener('click', (e) => {
      if (e.target.id === 'cantidadModal') cerrarModales();
    });

    // Botones de cantidad
    document.querySelector('.cantidad-minus').addEventListener('click', () => {
      const input = document.getElementById('cantidadInput');
      const val = parseInt(input.value) || 1;
      if (val > 1) input.value = val - 1;
    });

    document.querySelector('.cantidad-plus').addEventListener('click', () => {
      const input = document.getElementById('cantidadInput');
      const val = parseInt(input.value) || 1;
      const max = productoEnModal?.stock || 99;
      if (val < max) input.value = val + 1;
    });

    document.getElementById('cantidadConfirm').addEventListener('click', () => {
      const cantidad = parseInt(document.getElementById('cantidadInput').value) || 1;
      agregarProductoAlCarrito(cantidad);
    });

    // Escuchar evento de actualizaci√≥n del carrito
    window.addEventListener('carritoActualizado', () => {
      console.log('üîî Evento carritoActualizado recibido en categor√≠a, actualizando stock en tiempo real...');
      actualizarStockEnTiempoReal();
    });

    async function actualizarStockEnTiempoReal() {
      try {
        console.log('üîÑ Iniciando actualizaci√≥n de stock en tiempo real en categor√≠a...');
        
        // Obtener variantes reservadas actuales
        const reservadosResponse = await fetch('/api/productos/reservados');
        if (!reservadosResponse.ok) {
          console.error('‚ùå Error en respuesta del API reservados:', reservadosResponse.status);
          return;
        }
        
        const dataReservados = await reservadosResponse.json();
        const variantesReservadas = dataReservados.variantesReservadas || {};
        console.log('üîÑ Variantes reservadas actualizadas:', variantesReservadas);

        // Obtener stocks actuales de la BD
        const stocksResponse = await fetch('/api/productos/stocks');
        if (!stocksResponse.ok) {
          console.error('‚ùå Error en respuesta del API stocks:', stocksResponse.status);
          return;
        }
        
        const dataStocks = await stocksResponse.json();
        const stocksActuales = dataStocks.stocks || {};
        console.log('üîÑ Stocks actualizados:', stocksActuales);

        // Actualizar cada tarjeta de producto
        const articulos = document.querySelectorAll('article[data-id]');
        console.log('üì¶ Encontrados ' + articulos.length + ' productos para actualizar');
        
        articulos.forEach(article => {
          const productoId = parseInt(article.getAttribute('data-id'));
          const producto = productosGlobal.find(p => p.id === productoId);
          
          if (!producto) {
            console.log('‚ö†Ô∏è  Producto ' + productoId + ' no encontrado en productosGlobal');
            return;
          }

          // Obtener stock actual de la BD
          const stockActual = stocksActuales[productoId] !== undefined ? stocksActuales[productoId] : producto.stock;
          console.log('üìä Stock actual para producto ' + productoId + ': ' + stockActual);

          // Recalcular estado del producto
          const todasLasVariantes = variantesMap[productoId] || [];
          const variantesConStock = todasLasVariantes.filter(v => {
            const reservadas = variantesReservadas[productoId] || [];
            return v.disponible === true && !reservadas.includes(v.id);
          });
          
          const productoAgotado = (!producto.es_variable && stockActual <= 0) || (producto.es_variable && variantesConStock.length === 0);
          console.log('üìä Producto ' + productoId + ': ' + variantesConStock.length + ' variantes disponibles, stock=' + stockActual + ', agotado: ' + productoAgotado);

          // Actualizar estado del bot√≥n
          const button = article.querySelector('button[class*="btn-"]');
          if (button) {
            button.disabled = productoAgotado;
            
            // Cambiar visualmente
            if (productoAgotado) {
              button.style.background = '#d0d0d0';
              button.style.color = '#888';
              button.style.boxShadow = 'none';
            } else {
              button.style.background = 'linear-gradient(135deg, #a89968 0%, #9a8a5c 100%)';
              button.style.color = '#fff';
              button.style.boxShadow = '0 4px 12px rgba(168, 153, 104, 0.3)';
            }
          }

          // Actualizar indicador de stock
          const stockElements = article.querySelectorAll('span');
          for (let elem of stockElements) {
            const html = elem.innerHTML;
            if (html.includes('opci√≥n') || html.includes('unidad') || html.includes('Agotado')) {
              const stockText = producto.es_variable 
                ? `${variantesConStock.length} opci√≥n${variantesConStock.length !== 1 ? 'es' : ''}`
                : `${stockActual} unidad${stockActual !== 1 ? 'es' : ''}`;
              
              const stockDisplay = productoAgotado ? 'Agotado' : stockText;
              const svg = elem.querySelector('svg');
              elem.innerHTML = `
                ${svg ? svg.outerHTML : ''}
                ${stockDisplay}
              `;
              console.log('‚úÖ Stock actualizado para producto ' + productoId + ': ' + stockDisplay);
              break;
            }
          }

          // Actualizar overlay de "Agotado"
          const link = article.querySelector('a[href*="/productos/"]');
          if (link) {
            const existingOverlay = link.querySelector('div[style*="position: absolute"]');
            if (productoAgotado && !existingOverlay) {
              // Crear overlay
              const overlay = document.createElement('div');
              overlay.style.cssText = "position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; border-radius: 8px;";
              const badge = document.createElement('span');
              badge.style.cssText = "background: linear-gradient(135deg, #c1121f 0%, #800000 100%); color: white; padding: 12px 24px; border-radius: 6px; font-weight: 700; font-size: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);";
              badge.textContent = 'Agotado';
              overlay.appendChild(badge);
              link.appendChild(overlay);
              console.log('‚úÖ Overlay a√±adido para producto ' + productoId);
            } else if (!productoAgotado && existingOverlay) {
              // Eliminar overlay
              existingOverlay.remove();
              console.log('‚úÖ Overlay eliminado para producto ' + productoId);
            }
          }
        });
        
        console.log('‚úÖ Actualizaci√≥n de stock completada');
      } catch (error) {
        console.error('‚ùå Error actualizando stock:', error);
      }
    }

    // Cargar productos al iniciar
    cargarProductos();
  </script>
</Layout>