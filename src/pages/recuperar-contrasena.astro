---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <style>
    .reset-page {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .reset-container {
      max-width: 450px;
      width: 100%;
    }
    .reset-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .reset-title {
      color: var(--text-primary);
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    .reset-subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.5;
    }
    .reset-form {
      background: var(--bg-tertiary);
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 600;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
      background: var(--bg-input);
      color: var(--text-primary);
    }
    .form-input::placeholder {
      color: var(--text-muted);
    }
    .submit-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--gradient-cta);
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow-medium);
    }
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .back-link {
      display: block;
      text-align: center;
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      margin-top: 1.5rem;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .message {
      display: none;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-top: 1rem;
    }
    .message-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .message-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
  </style>

  <div class="reset-page">
    <div class="reset-container">
      <div class="reset-header">
        <h1 class="reset-title">Recuperar Contraseña</h1>
        <p class="reset-subtitle">Introduce tu correo electrónico y te enviaremos un código de 6 dígitos para restablecer tu contraseña.</p>
      </div>

      <form id="resetForm" class="reset-form">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input 
            type="email" 
            name="email" 
            required 
            placeholder="tu@email.com"
            class="form-input"
            id="emailInput"
          />
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          Enviar código de recuperación
        </button>

        <div id="successMessage" class="message message-success"></div>
        <div id="errorMessage" class="message message-error"></div>
      </form>

      <a href="/login" class="back-link">Volver al inicio de sesión</a>
    </div>
  </div>

  <script>
    const form = document.getElementById('resetForm') as HTMLFormElement | null;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;
    const successMsg = document.getElementById('successMessage');
    const errorMsg = document.getElementById('errorMessage');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const emailInput = document.getElementById('emailInput') as HTMLInputElement | null;
      const email = emailInput?.value.trim() || '';
      
      if (!email) return;

      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';
      }
      if (successMsg) successMsg.style.display = 'none';
      if (errorMsg) errorMsg.style.display = 'none';

      try {
        const res = await fetch('/api/auth/solicitar-recovery', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });

        const data = await res.json();
        if (!res.ok && res.status !== 200) throw new Error(data.message);

        sessionStorage.setItem('recovery_email', email);

        if (successMsg) {
          successMsg.textContent = 'Si existe una cuenta con ese email, recibirás un código de recuperación. Revisa tu bandeja de entrada y la carpeta de spam. Redirigiendo...';
          successMsg.style.display = 'block';
        }
        form?.reset();

        setTimeout(() => {
          window.location.href = '/restablecer-contrasena';
        }, 2000);
      } catch (err) {
        sessionStorage.setItem('recovery_email', email);
        if (successMsg) {
          successMsg.textContent = 'Si existe una cuenta con ese email, recibirás un código de recuperación. Revisa tu bandeja de entrada y la carpeta de spam. Redirigiendo...';
          successMsg.style.display = 'block';
        }
        setTimeout(() => {
          window.location.href = '/restablecer-contrasena';
        }, 2000);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar código de recuperación';
        }
      }
    });
  </script>
</Layout>
