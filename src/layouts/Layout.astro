---
import MegaMenu from '../components/MegaMenu.astro';
import ChatBot from '../components/ChatBot.astro';
import { supabaseClient } from '../lib/supabase';

const title = "IbericosRG - Surtidos Ibéricos Premium";
const description = "Descubre nuestra colección de productos ibéricos de la más alta calidad";

// Obtener categorías para el menú
const { data: categorias } = await supabaseClient
  .from('categorias')
  .select('*')
  .eq('activa', true)
  .order('orden', { ascending: true });
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=5" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="description" content={description} />
    <title>{title}</title>
    
    <!-- Preconectar a Google Fonts (alto prioridad) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Precargar fuentes woff2 directamente para evitar cadena de dependencias -->
    <link 
      rel="preload" 
      as="font" 
      type="font/woff2" 
      href="https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_0ew.woff2" 
      crossorigin 
    />
    <link 
      rel="preload" 
      as="font" 
      type="font/woff2" 
      href="https://fonts.gstatic.com/s/playfairdisplay/v37/nuFvD-vYSZviVYUb_rj3ij__anPXJzDwcbmjWBN2PKdFvXDXbtY.woff2" 
      crossorigin 
    />
    
    <!-- Cargar Google Fonts de forma no bloqueante -->
    <link 
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" 
      rel="stylesheet" 
      media="print" 
      onload="this.media='all'" 
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    </noscript>
    
    <style is:global>
      /* ===== VARIABLES DE TEMA ===== */
      :root {
        /* Colores principales - Modo Claro */
        --bg-primary: #faf9f7;
        --bg-secondary: #fff;
        --bg-tertiary: #f8f7f4;
        --bg-card: #fff;
        --bg-input: #fff;
        
        /* Fuentes con fallback del sistema */
        --font-display: 'Playfair Display', Georgia, 'Times New Roman', serif;
        --font-body: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        
        /* Textos */
        --text-primary: #2d2d2d;
        --text-secondary: #5c4a3d;
        --text-muted: #6b7280;
        --text-inverse: #f8f7f4;
        
        /* Colores de marca */
        --color-accent: #a89968;
        --color-accent-light: #d4a574;
        --color-accent-dark: #8b7355;
        --color-primary: #001a33;
        --color-primary-light: #2d2d2d;
        
        /* Bordes y sombras */
        --border-color: #e0d5c7;
        --border-light: #eee;
        --card-border: #e5e2dd;
        --shadow-color: rgba(0, 0, 0, 0.08);
        --shadow-medium: rgba(0, 0, 0, 0.12);
        --shadow-accent: rgba(168, 153, 104, 0.25);
        
        /* Header y footer */
        --header-bg: #fff;
        --footer-bg: linear-gradient(135deg, #001a33, #2d2d2d);
        
        /* Gradientes */
        --gradient-hero: linear-gradient(135deg, #001a33 0%, #2d2d2d 50%, #5c4a3d 100%);
        --gradient-ofertas: linear-gradient(135deg, #a89968 0%, #8b7355 100%);
        --gradient-cta: linear-gradient(135deg, #001a33, #2d2d2d);
        --gradient-beneficios: linear-gradient(135deg, #f8f7f4 0%, #efefeb 100%);
        
        /* Overlays */
        --overlay-light: rgba(255, 255, 255, 0.1);
        --overlay-dark: rgba(0, 0, 0, 0.5);
        
        /* Transición global */
        --theme-transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
      }

      /* ===== MODO OSCURO ===== */
      [data-theme="dark"] {
        /* Fondos - Modo Oscuro */
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --bg-tertiary: #252525;
        --bg-card: #1e1e1e;
        --bg-input: #2a2a2a;
        
        /* Textos */
        --text-primary: #e8e6e3;
        --text-secondary: #b8b5b0;
        --text-muted: #8a8a8a;
        --text-inverse: #121212;
        
        /* Colores de marca (más brillantes en oscuro) */
        --color-accent: #c4ad78;
        --color-accent-light: #e0c08a;
        --color-accent-dark: #a89968;
        --color-primary: #e8e6e3;
        --color-primary-light: #b8b5b0;
        
        /* Bordes y sombras */
        --border-color: #3a3a3a;
        --border-light: #333;
        --card-border: #444;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --shadow-medium: rgba(0, 0, 0, 0.4);
        --shadow-accent: rgba(196, 173, 120, 0.2);
        
        /* Header y footer */
        --header-bg: #1e1e1e;
        --footer-bg: linear-gradient(135deg, #0a0a0a, #1a1a1a);
        
        /* Gradientes adaptados */
        --gradient-hero: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #3d3530 100%);
        --gradient-ofertas: linear-gradient(135deg, #8b7a55 0%, #6d5a42 100%);
        --gradient-cta: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        --gradient-beneficios: linear-gradient(135deg, #1e1e1e 0%, #252525 100%);
        
        /* Overlays */
        --overlay-light: rgba(255, 255, 255, 0.05);
        --overlay-dark: rgba(0, 0, 0, 0.7);
      }

      /* ===== SCROLLBAR PERSONALIZADA ===== */
      /* Para navegadores Webkit (Chrome, Safari, Edge) */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #a89968, #8b7355);
        border-radius: 5px;
        border: 2px solid var(--bg-tertiary);
        transition: background 0.3s ease;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #c4ad78, #a89968);
      }

      ::-webkit-scrollbar-corner {
        background: var(--bg-tertiary);
      }

      /* Para Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: #a89968 var(--bg-tertiary);
      }

      /* Modo oscuro - Scrollbar */
      [data-theme="dark"] ::-webkit-scrollbar-track {
        background: #252525;
      }

      [data-theme="dark"] ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #8b7a55, #6d5a42);
        border-color: #252525;
      }

      [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #a89968, #8b7a55);
      }

      [data-theme="dark"] * {
        scrollbar-color: #8b7a55 #252525;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        font-family: 'Inter', system-ui, sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        scroll-behavior: smooth;
        transition: var(--theme-transition);
        overflow-x: hidden;
      }
      body {
        line-height: 1.6;
        background-color: var(--bg-primary);
        transition: var(--theme-transition);
        overflow-x: hidden;
        min-height: 100vh;
        min-height: 100dvh; /* Dynamic viewport height para móviles */
        -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
      }
      h1, h2, h3, h4, h5, h6 {
        font-family: 'Playfair Display', Georgia, serif;
        font-weight: 700;
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      button {
        cursor: pointer;
        border: none;
        font-family: 'Inter', system-ui, sans-serif;
      }
      input, select {
        font-family: 'Inter', system-ui, sans-serif;
        background-color: var(--bg-input);
        color: var(--text-primary);
        transition: var(--theme-transition);
      }

      /* Responsive Media Queries */
      @media (max-width: 1024px) {
        header {
          padding: 1rem 0 !important;
        }
        header div {
          padding: 0 1.5rem !important;
          gap: 1.5rem !important;
        }
        main {
          min-height: calc(100vh - 180px) !important;
        }
        footer {
          padding: 2.5rem 1.5rem 1rem !important;
        }
      }

      @media (max-width: 768px) {
        header {
          padding: 0.9rem 0 !important;
        }
        header div {
          padding: 0 1rem !important;
          gap: 1rem !important;
        }
        nav {
          gap: 1rem !important;
        }
        nav a {
          font-size: 0.85rem !important;
        }
        main {
          min-height: calc(100vh - 150px) !important;
        }
        footer {
          padding: 2rem 1rem 0.75rem !important;
        }
      }

      @media (max-width: 480px) {
        header {
          padding: 0.75rem 0 !important;
        }
        header div {
          padding: 0 0.75rem !important;
          gap: 0.75rem !important;
          flex-wrap: nowrap !important;
        }
        nav {
          display: none !important;
        }
        header div > div:nth-child(3) {
          width: 100% !important;
          max-width: 100% !important;
          display: none !important;
        }
        main {
          min-height: calc(100vh - 120px) !important;
        }
        footer {
          padding: 1.5rem 0.75rem 0.5rem !important;
        }
        footer div {
          padding: 0 0.5rem !important;
        }
      }

      /* ===== ESTILOS GLOBALES PARA PANEL ADMIN ===== */
      
      /* Página Admin Base */
      .admin-page {
        min-height: 100vh;
        background: var(--bg-primary);
        padding: 2rem;
        transition: var(--theme-transition);
      }
      
      .admin-container {
        max-width: 1400px;
        margin: 0 auto;
      }
      
      /* Header Admin */
      .admin-header {
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      .admin-back-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        text-decoration: none;
        font-size: 1.2rem;
        transition: all 0.3s;
      }
      
      .admin-back-btn:hover {
        background: var(--bg-tertiary);
        border-color: var(--color-accent);
      }
      
      .admin-title {
        color: var(--text-primary);
        font-size: 2.5rem;
        margin: 0;
        font-weight: 900;
        letter-spacing: -0.5px;
      }
      
      .admin-subtitle {
        color: var(--text-muted);
        margin: 0.5rem 0 0 0;
        font-size: 1rem;
      }
      
      /* Action Bar */
      .admin-action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        gap: 1rem;
        flex-wrap: wrap;
      }
      
      .admin-filters {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      
      .admin-search-input {
        padding: 0.75rem 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        min-width: 250px;
        transition: all 0.3s;
        background: var(--bg-input);
        color: var(--text-primary);
      }
      
      .admin-search-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px var(--shadow-accent);
      }
      
      .admin-search-input::placeholder {
        color: var(--text-muted);
      }
      
      .admin-select {
        padding: 0.75rem 1.25rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.95rem;
        cursor: pointer;
        background: var(--bg-input);
        color: var(--text-primary);
        transition: all 0.3s;
      }
      
      .admin-select:focus {
        outline: none;
        border-color: var(--color-accent);
      }
      
      .admin-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      
      .admin-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }
      
      .admin-btn-secondary {
        padding: 0.75rem 1.5rem;
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }
      
      .admin-btn-secondary:hover {
        background: var(--bg-tertiary);
        border-color: var(--color-accent);
      }
      
      .admin-btn-secondary.active {
        background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
        color: white;
        border: 1px solid transparent;
        box-shadow: 0 2px 8px var(--shadow-accent);
      }
      
      .admin-btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .admin-btn-danger:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }
      
      .admin-btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .admin-btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }
      
      /* Tabla Admin */
      .admin-table-container {
        background: var(--bg-card);
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow-color);
        border: 1px solid var(--border-color);
        overflow: hidden;
      }
      
      .admin-table {
        width: 100%;
        border-collapse: collapse;
      }
      
      .admin-table thead tr {
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
      }
      
      .admin-table th {
        padding: 1.25rem;
        text-align: left;
        color: var(--text-primary);
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .admin-table th.center {
        text-align: center;
      }
      
      .admin-table td {
        padding: 1rem 1.25rem;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-light);
      }
      
      .admin-table td.center {
        text-align: center;
      }
      
      .admin-table tbody tr:hover {
        background: var(--bg-tertiary);
      }
      
      .admin-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      .admin-table-scroll {
        overflow-x: auto;
      }
      
      /* Botones de acción para tablas */
      .admin-table-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
      }
      
      .admin-btn-edit {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .admin-btn-edit:hover {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
      }
      
      .admin-btn-delete {
        background: var(--bg-tertiary);
        color: #ef4444;
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .admin-btn-delete:hover {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }
      
      /* Empty State */
      .admin-empty-state {
        display: none;
        padding: 3rem;
        text-align: center;
      }
      
      .admin-empty-state .icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }
      
      .admin-empty-state p {
        color: var(--text-muted);
        font-size: 1rem;
      }
      
      /* Modal Admin */
      .admin-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--overlay-dark);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .admin-modal {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      
      .admin-modal-title {
        color: var(--text-primary);
        font-size: 1.5rem;
        margin: 0 0 1.5rem 0;
        font-weight: 700;
      }
      
      .admin-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .admin-form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .admin-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      
      .admin-label {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      
      .admin-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95rem;
        box-sizing: border-box;
        background: var(--bg-input);
        color: var(--text-primary);
        transition: all 0.3s;
      }
      
      .admin-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px var(--shadow-accent);
      }
      
      .admin-input::placeholder {
        color: var(--text-muted);
      }
      
      .admin-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95rem;
        box-sizing: border-box;
        min-height: 100px;
        font-family: inherit;
        resize: vertical;
        background: var(--bg-input);
        color: var(--text-primary);
        transition: all 0.3s;
      }
      
      .admin-textarea:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px var(--shadow-accent);
      }
      
      .admin-hint {
        margin: 0.5rem 0 0 0;
        color: var(--text-muted);
        font-size: 0.85rem;
      }
      
      .admin-form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }
      
      .admin-form-actions button {
        flex: 1;
      }
      
      /* Badges y Estados */
      .admin-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      
      .admin-badge.success {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
      }
      
      .admin-badge.warning {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
      }
      
      .admin-badge.danger {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }
      
      .admin-badge.info {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
      }
      
      .admin-badge.neutral {
        background: var(--bg-tertiary);
        color: var(--text-muted);
      }
      
      /* Image Drop Zone */
      .admin-image-drop {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: var(--bg-tertiary);
      }
      
      .admin-image-drop:hover {
        border-color: var(--color-accent);
        background: var(--bg-input);
      }
      
      .admin-image-drop .icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }
      
      .admin-image-drop .title {
        color: var(--text-primary);
        font-weight: 600;
        margin: 0;
      }
      
      .admin-image-drop .subtitle {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin: 0.5rem 0 0 0;
      }
      
      /* Toast Notification */
      .admin-toast {
        display: none;
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--bg-card);
        padding: 1.25rem 1.75rem;
        border-radius: 8px;
        box-shadow: 0 10px 30px var(--shadow-medium);
        z-index: 9999;
        max-width: 400px;
        border: 1px solid var(--border-color);
        animation: slideIn 0.3s ease-out;
      }
      
      .admin-toast.success {
        border-left: 4px solid #10b981;
      }
      
      .admin-toast.error {
        border-left: 4px solid #ef4444;
      }
      
      .admin-toast.warning {
        border-left: 4px solid #f59e0b;
      }
      
      .admin-toast-content {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .admin-toast-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
      }
      
      .admin-toast-title {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
      }
      
      .admin-toast-message {
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      
      /* Loading State */
      .admin-loading {
        color: var(--text-secondary);
        font-size: 1.1rem;
        text-align: center;
        padding: 2rem;
      }
      
      /* Cards Grid */
      .admin-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
      }
      
      .admin-card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color);
        transition: all 0.3s;
      }
      
      .admin-card:hover {
        box-shadow: 0 8px 25px var(--shadow-color);
        transform: translateY(-2px);
      }
      
      /* Admin Responsive */
      @media (max-width: 768px) {
        .admin-page {
          padding: 1rem;
        }
        
        .admin-title {
          font-size: 1.75rem;
        }
        
        .admin-action-bar {
          flex-direction: column;
          align-items: stretch;
        }
        
        .admin-filters {
          flex-direction: column;
        }
        
        .admin-search-input {
          min-width: 100%;
        }
        
        .admin-form-row {
          grid-template-columns: 1fr;
        }
        
        .admin-modal {
          width: 95%;
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Menu movil - FUERA del header para evitar problemas con position sticky -->
    <nav class="main-nav" id="mainNav">
      <button class="mobile-menu-close" id="mobileMenuClose" aria-label="Cerrar menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <a href="/" class="nav-link">Inicio</a>
      <MegaMenu categorias={categorias || []} />
      <a href="/seguimiento" class="nav-link">
        <svg style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        Seguimiento
      </a>
      <a href="/contacto" class="nav-link">Contacto</a>
      
      <!-- Contenedor dinámico para autenticación móvil -->
      <div id="mobileAuthContainer" style="margin-top: auto; width: 100%; padding-top: 2rem; border-top: 1px solid var(--border-color);">
        <!-- Se renderiza dinámicamente por JavaScript -->
      </div>
    </nav>
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Navbar -->
    <header class="main-header">
      <div class="header-container">
        <a href="/" class="logo">Ibéricos RG</a>
        
        <!-- Boton Hamburguesa para movil -->
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        
        <!-- Menu de Navegacion Desktop (duplicado para desktop) -->
        <nav class="desktop-nav">
          <a href="/" class="nav-link">Inicio</a>
          <MegaMenu categorias={categorias || []} />
          <a href="/seguimiento" class="nav-link">
            <svg style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            Seguimiento
          </a>
          <a href="/contacto" class="nav-link">Contacto</a>
        </nav>

        <!-- Barra de Búsqueda -->
        <div class="search-container">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Buscar productos..." 
            class="search-input"
          >
          
          <!-- Dropdown de Resultados -->
          <div id="searchResults" class="search-results"></div>
        </div>

        <!-- Contenedor de acciones (Tema + Carrito + Usuario) -->
        <div class="actions-container">
          <!-- Toggle Modo Oscuro -->
          <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema" title="Cambiar modo claro/oscuro">
            <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>

          <a href="/carrito" class="cart-link">
            Carrito
            <span id="carritoCount" class="cart-count">0</span>
          </a>

          <div id="authContainer"></div>
          
          <div id="carritoTimer" class="cart-timer-inline">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span id="timerText">--:--</span>
          </div>
        </div>
      </div>
    </header>

    <style>
      /* Header Principal */
      .main-header {
        background: var(--header-bg);
        padding: 1.2rem 0;
        box-shadow: 0 2px 8px var(--shadow-color);
        position: sticky;
        top: 0;
        z-index: 1000;
        transition: var(--theme-transition);
      }

      .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 3rem;
      }

      /* Logo */
      .logo {
        font-size: 1.8rem;
        background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        font-family: 'Playfair Display', serif;
        text-decoration: none;
        flex-shrink: 0;
      }

      /* Navegacion Desktop */
      .desktop-nav {
        display: flex;
        gap: 2rem;
        align-items: center;
      }

      /* Menu Movil - Aparece desde la izquierda */
      .main-nav {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: auto !important;
        width: 280px;
        max-width: 85vw;
        height: 100vh !important;
        height: 100dvh !important;
        background: var(--bg-secondary) !important;
        display: flex !important;
        flex-direction: column;
        align-items: flex-start;
        padding: 4.5rem 1.5rem 2rem;
        gap: 0;
        box-shadow: 4px 0 20px var(--shadow-medium);
        transition: transform 0.3s ease;
        transform: translateX(-100%) !important;
        z-index: 10001 !important;
        overflow-y: auto;
        overflow-x: hidden;
        visibility: hidden;
      }

      .main-nav.active {
        transform: translateX(0) !important;
        visibility: visible !important;
      }

      /* Boton cerrar menu movil */
      .mobile-menu-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
      }

      .mobile-menu-close:hover {
        background: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
      }

      /* Overlay movil */
      .mobile-menu-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        height: 100dvh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
      }

      .mobile-menu-overlay.active {
        display: block;
      }

      .nav-link {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-primary);
        padding: 0.5rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid transparent;
        transition: border-color 0.3s ease, color 0.3s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
      }

      .nav-link:hover {
        border-color: var(--color-accent);
      }

      .main-nav .nav-link {
        padding: 1rem 0;
        font-size: 1.1rem;
        width: 100%;
        border-bottom: 1px solid var(--border-light);
      }

      /* Estilos para MegaMenu dentro del menu movil */
      .main-nav .mega-menu-container {
        width: 100%;
      }

      .main-nav .mega-menu-trigger {
        width: 100%;
        justify-content: space-between;
        padding: 1rem 0;
        font-size: 1.1rem;
        border-bottom: 1px solid var(--border-light);
      }

      .main-nav .mega-menu-dropdown {
        position: static !important;
        transform: none !important;
        left: auto !important;
        top: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        background: var(--bg-tertiary);
        border-radius: 0;
        box-shadow: none;
        border: none;
        opacity: 1 !important;
        visibility: visible !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        margin-bottom: 0;
      }

      .main-nav .mega-menu-container.active .mega-menu-dropdown {
        max-height: 800px;
        border-top: 1px solid var(--border-light);
      }

      .main-nav .mega-menu-columns {
        display: flex;
        flex-direction: column;
        padding: 0.5rem 0;
        gap: 0;
      }

      .main-nav .mega-menu-column {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border-light);
        text-align: left;
      }

      .main-nav .mega-menu-banner {
        padding: 1rem;
        border-radius: 0;
      }

      .main-nav .banner-content {
        flex-direction: column;
        gap: 0.75rem;
        text-align: center;
      }

      .main-nav .banner-text {
        flex-direction: column;
        gap: 0.5rem;
      }

      /* Botón hamburguesa */
      .menu-toggle {
        display: none;
        flex-direction: column;
        justify-content: center;
        gap: 5px;
        width: 30px;
        height: 30px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 10000;
        position: relative;
      }

      .hamburger-line {
        width: 100%;
        height: 3px;
        background-color: var(--text-primary);
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .menu-toggle.active .hamburger-line:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
      }

      .menu-toggle.active .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .menu-toggle.active .hamburger-line:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
      }

      /* Búsqueda */
      .search-container {
        position: relative;
        width: 280px;
        flex-shrink: 0;
      }

      .search-input {
        width: 100%;
        padding: 0.6rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.3s;
        background-color: var(--bg-input);
        color: var(--text-primary);
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .search-input:hover,
      .search-input:focus {
        border-color: var(--color-accent);
        outline: none;
      }

      .search-input:focus {
        box-shadow: 0 0 8px var(--shadow-accent);
      }

      .search-results {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 8px 24px var(--shadow-medium);
        z-index: 1001;
      }

      /* Acciones */
      .actions-container {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        flex-shrink: 0;
      }

      .cart-link {
        position: relative;
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--text-primary);
        padding-bottom: 0.5rem;
        border-bottom: 2px solid transparent;
        transition: border-color 0.3s ease;
      }

      .cart-link:hover {
        border-color: var(--color-accent);
      }

      /* Toggle de Tema */
      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .theme-toggle:hover {
        background: var(--color-accent);
        color: var(--text-inverse);
        border-color: var(--color-accent);
        transform: rotate(15deg);
      }

      .theme-toggle .sun-icon {
        display: block;
      }

      .theme-toggle .moon-icon {
        display: none;
      }

      [data-theme="dark"] .theme-toggle .sun-icon {
        display: none;
      }

      [data-theme="dark"] .theme-toggle .moon-icon {
        display: block;
      }

      .cart-count {
        display: none;
        position: absolute;
        top: -8px;
        right: -12px;
        background: #f5576c;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        align-items: center;
        justify-content: center;
      }

      .cart-timer {
        position: absolute;
        top: 100%;
        left: 0;
        font-size: 0.75rem;
        color: #d97706;
        font-weight: 600;
        display: none;
        white-space: nowrap;
        margin-top: 0.2rem;
      }

      /* Timer del carrito en línea (a la derecha) */
      .cart-timer-inline {
        display: none;
        align-items: center;
        gap: 0.4rem;
        background: rgba(217, 119, 6, 0.15);
        color: #d97706;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        border: 1px solid rgba(217, 119, 6, 0.3);
      }

      .cart-timer-inline svg {
        flex-shrink: 0;
      }

      .cart-timer-inline.active {
        display: flex;
      }

      [data-theme="dark"] .cart-timer-inline {
        background: rgba(217, 119, 6, 0.2);
        border-color: rgba(217, 119, 6, 0.4);
      }

      /* Contenedor de autenticacion */
      #authContainer {
        display: flex;
        align-items: center;
      }

      /* Botón de Iniciar Sesión en el menú móvil */
      .nav-login-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 0.8rem 1rem;
        background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        white-space: nowrap;
      }

      .nav-login-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(168, 153, 104, 0.4);
      }

      .nav-login-button:active {
        transform: translateY(0);
      }

      /* ===== PERFIL USUARIO EN MENÚ MÓVIL ===== */
      .mobile-user-profile {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .mobile-user-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 0.5rem;
      }

      .mobile-user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        flex-shrink: 0;
      }

      .mobile-user-info {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        overflow: hidden;
      }

      .mobile-user-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mobile-user-role {
        font-size: 0.75rem;
        color: var(--color-accent);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .mobile-profile-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        color: var(--text-primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        min-height: 44px; /* tap target mínimo */
      }

      .mobile-profile-link:hover,
      .mobile-profile-link:active {
        background: var(--bg-tertiary);
        transform: translateX(4px);
      }

      .mobile-profile-link svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        color: var(--color-accent);
      }

      .mobile-logout-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 0.875rem 1rem;
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
        border-radius: 8px;
        color: #dc3545;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 0.5rem;
        min-height: 44px; /* tap target mínimo */
      }

      .mobile-logout-btn:hover,
      .mobile-logout-btn:active {
        background: rgba(220, 53, 69, 0.2);
      }

      /* ========== RESPONSIVE ========== */

      /* Tablet grande (1200px) */
      @media (max-width: 1200px) {
        .header-container {
          gap: 1.5rem;
        }

        .desktop-nav {
          gap: 1.5rem;
        }

        .search-container {
          width: 220px;
        }
      }

      /* Tablet (1024px) */
      @media (max-width: 1024px) {
        .header-container {
          padding: 0 1.5rem;
          gap: 1rem;
        }

        .desktop-nav {
          gap: 1rem;
        }

        .desktop-nav .nav-link {
          font-size: 0.9rem;
        }

        .search-container {
          width: 180px;
        }

        .logo {
          font-size: 1.5rem;
        }
      }

      /* Tablet pequena (900px) */
      @media (max-width: 900px) {
        .search-container {
          width: 150px;
        }

        .desktop-nav {
          gap: 0.75rem;
        }

        .desktop-nav .nav-link {
          font-size: 0.85rem;
        }
      }

      /* Móvil grande (768px) */
      @media (max-width: 768px) {
        .main-header {
          padding: 0.5rem 0;
          overflow: visible;
        }

        .header-container {
          display: grid;
          grid-template-columns: auto 1fr auto;
          grid-template-rows: auto auto;
          gap: 0.5rem 0.5rem;
          align-items: center;
          padding: 0 0.75rem;
          width: 100%;
          box-sizing: border-box;
        }

        .logo {
          grid-column: 1;
          grid-row: 1;
          font-size: 1.1rem;
          white-space: nowrap;
        }

        .actions-container {
          grid-column: 2;
          grid-row: 1;
          justify-content: flex-end;
          gap: 0.4rem;
          display: flex;
          flex-wrap: nowrap;
          overflow: visible;
        }

        .menu-toggle {
          display: flex;
          grid-column: 3;
          grid-row: 1;
        }

        .search-container {
          grid-column: 1 / -1;
          grid-row: 2;
          width: 100%;
          margin-top: 0;
        }

        /* Ocultar navegacion desktop en movil */
        .desktop-nav {
          display: none !important;
        }

        .cart-link {
          font-size: 0.8rem;
          white-space: nowrap;
        }

        .theme-toggle {
          width: 32px;
          height: 32px;
          flex-shrink: 0;
        }

        .theme-toggle svg {
          width: 16px;
          height: 16px;
        }

        /* Ocultar timer en tablet/móvil para ganar espacio */
        .cart-timer-inline {
          display: none !important;
        }
      }

      /* Móvil (480px) */
      @media (max-width: 480px) {
        .main-header {
          padding: 0.5rem 0;
        }

        .header-container {
          padding: 0 0.5rem;
          gap: 0.4rem;
        }

        .logo {
          font-size: 0.95rem;
        }

        .main-nav {
          width: 100%;
          max-width: 100vw;
        }

        .actions-container {
          gap: 0.35rem;
        }

        .cart-link {
          font-size: 0.75rem;
          padding-bottom: 0.15rem;
        }

        .theme-toggle {
          width: 30px;
          height: 30px;
        }

        .theme-toggle svg {
          width: 14px;
          height: 14px;
        }

        .search-input {
          padding: 0.5rem 0.75rem;
          font-size: 0.85rem;
        }

        .menu-toggle {
          width: 26px;
          height: 26px;
        }

        .hamburger-line {
          height: 2px;
        }
      }

      /* Móvil muy pequeño (360px) */
      @media (max-width: 360px) {
        .header-container {
          padding: 0 0.35rem;
          gap: 0.25rem;
        }

        .logo {
          font-size: 0.85rem;
        }

        .actions-container {
          gap: 0.2rem;
        }

        .theme-toggle {
          width: 26px;
          height: 26px;
        }

        .theme-toggle svg {
          width: 12px;
          height: 12px;
        }

        .cart-link {
          font-size: 0.65rem;
        }

        .cart-count {
          width: 14px;
          height: 14px;
          font-size: 0.55rem;
          top: -5px;
          right: -8px;
        }

        .menu-toggle {
          width: 24px;
          height: 24px;
        }

        .hamburger-line {
          height: 2px;
        }

        .search-input {
          padding: 0.45rem 0.6rem;
          font-size: 0.8rem;
        }
      }
    </style>

    <main class="main-content">
      <slot />
    </main>

    <style>
      .main-content {
        min-height: calc(100vh - 200px);
        min-height: calc(100dvh - 200px);
        padding: 0 1rem;
        max-width: 100%;
        overflow-x: hidden;
      }

      @media (max-width: 480px) {
        .main-content {
          padding: 0 0.75rem;
          min-height: calc(100vh - 150px);
          min-height: calc(100dvh - 150px);
        }
      }
    </style>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="footer-container">
        <div class="footer-grid">
          <div class="footer-col">
            <h4>Empresa</h4>
            <a href="/sobre-nosotros">Sobre Nosotros</a>
            <a href="/contacto">Contacto</a>
            <a href="/terminos">Términos</a>
          </div>
          <div class="footer-col">
            <h4>Productos</h4>
            <a href="/categoria/jamones">Jamones</a>
            <a href="/categoria/quesos">Quesos</a>
            <a href="/categoria/embutidos">Embutidos</a>
          </div>
          <div class="footer-col">
            <h4>Legal</h4>
            <a href="/privacidad">Privacidad</a>
            <a href="/cookies">Cookies</a>
            <a href="/devoluciones">Devoluciones</a>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2026 Ibéricos RG. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <style>
      .site-footer {
        background: linear-gradient(135deg, #001a33, #2d2d2d);
        color: white;
        padding: 3rem 1.5rem 1rem;
        margin-top: 4rem;
      }

      .footer-container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .footer-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .footer-col h4 {
        margin-bottom: 1rem;
        font-size: 1rem;
      }

      .footer-col a {
        display: block;
        margin-bottom: 0.5rem;
        opacity: 0.8;
        font-size: 0.9rem;
        transition: opacity 0.2s;
      }

      .footer-col a:hover {
        opacity: 1;
      }

      .footer-bottom {
        text-align: center;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        opacity: 0.7;
      }

      .footer-bottom p {
        font-size: 0.85rem;
      }

      @media (max-width: 768px) {
        .site-footer {
          padding: 2rem 1rem 1rem;
          margin-top: 2rem;
        }

        .footer-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }

        .footer-col:last-child {
          grid-column: 1 / -1;
          text-align: center;
        }

        .footer-col:last-child a {
          display: inline-block;
          margin: 0 0.5rem 0.5rem;
        }
      }

      @media (max-width: 480px) {
        .site-footer {
          padding: 1.5rem 0.75rem 1rem;
        }

        .footer-grid {
          grid-template-columns: 1fr;
          gap: 1.25rem;
          text-align: center;
        }

        .footer-col h4 {
          font-size: 0.95rem;
          margin-bottom: 0.75rem;
        }

        .footer-col a {
          font-size: 0.85rem;
          margin-bottom: 0.4rem;
        }

        .footer-col:last-child {
          grid-column: auto;
        }

        .footer-col:last-child a {
          display: block;
          margin: 0 0 0.4rem 0;
        }

        .footer-bottom {
          padding-top: 1.5rem;
        }

        .footer-bottom p {
          font-size: 0.75rem;
        }
      }
    </style>
    
    <!-- Script para el Tema (debe ejecutarse lo antes posible) -->
    <script is:inline>
      // Aplicar tema guardado inmediatamente para evitar flash
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = savedTheme || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>

    <!-- Script de cierre de sesión por inactividad -->
    <script is:inline>
      (function() {
        const INACTIVIDAD_MS = 30 * 60 * 1000; // 30 minutos de inactividad
        const CLAVE_ULTIMA_ACTIVIDAD = 'last_activity';

        // Solo aplicar si hay sesión activa
        if (!localStorage.getItem('user_id')) return;

        // Registrar actividad
        function registrarActividad() {
          localStorage.setItem(CLAVE_ULTIMA_ACTIVIDAD, String(Date.now()));
        }

        // Comprobar inactividad
        function comprobarInactividad() {
          const userId = localStorage.getItem('user_id');
          if (!userId) return; // Ya no hay sesión

          const ultimaActividad = parseInt(localStorage.getItem(CLAVE_ULTIMA_ACTIVIDAD) || '0');
          if (ultimaActividad === 0) {
            registrarActividad();
            return;
          }

          const tiempoInactivo = Date.now() - ultimaActividad;
          if (tiempoInactivo >= INACTIVIDAD_MS) {
            // Sesión expirada por inactividad
            console.log('⏰ Sesión cerrada por inactividad (' + Math.round(tiempoInactivo / 60000) + ' min)');
            fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }).catch(() => {});
            // Limpiar cookies accesibles desde JS como respaldo
            ['user_role', 'user_name', 'user_id', 'auth_token', 'sb-access-token', 'sb-refresh-token'].forEach(function(c) {
              document.cookie = c + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Max-Age=0; SameSite=Lax';
            });
            const tema = localStorage.getItem('theme'); // Preservar preferencia de tema
            localStorage.clear();
            if (tema) localStorage.setItem('theme', tema);
            window.location.href = '/login?expired=1';
            return;
          }
        }

        // Registrar actividad inicial (al cargar la página)
        registrarActividad();

        // Registrar actividad en interacciones del usuario
        ['click', 'keydown', 'scroll', 'mousemove', 'touchstart'].forEach(function(evento) {
          document.addEventListener(evento, registrarActividad, { passive: true });
        });

        // Comprobar inactividad cada minuto
        setInterval(comprobarInactividad, 60 * 1000);

        // Comprobar también al volver a la pestaña (usuario que la dejó en segundo plano)
        document.addEventListener('visibilitychange', function() {
          if (document.visibilityState === 'visible') {
            comprobarInactividad();
          }
        });
      })();
    </script>
    
    <script>
      // ========== TOGGLE DE TEMA ==========
      function initThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        
        if (!themeToggle) return;

        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          
          // Animación de rotación
          themeToggle.style.transform = 'rotate(360deg)';
          setTimeout(() => {
            themeToggle.style.transform = '';
          }, 300);
        });
      }

      // Inicializar cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initThemeToggle);
      } else {
        initThemeToggle();
      }

      // Escuchar cambios en preferencias del sistema
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
        }
      });
    </script>
    
    <script>
      // ========== LOGOUT GLOBAL ==========
      // Guard para evitar múltiples invocaciones simultáneas
      let _logoutEnCurso = false;
      (window as any).handleLogout = async function() {
        if (_logoutEnCurso) return;
        _logoutEnCurso = true;
        // Limpiar localStorage PRIMERO (antes del fetch, para que si falla el fetch
        // al menos el estado local quede limpio)
        const tema = localStorage.getItem('theme');
        localStorage.clear();
        if (tema) localStorage.setItem('theme', tema);
        // Marcar en sessionStorage que acabamos de hacer logout
        // Esto evita que la próxima carga de página re-autentique via /api/auth/me
        sessionStorage.setItem('just_logged_out', '1');
        try {
          await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
        } catch (e) {
          // No es crítico — localStorage ya está limpio
        }
        // Limpiar cookies accesibles desde JS
        const cookies = ['user_role', 'user_name', 'user_id', 'auth_token', 'sb-access-token', 'sb-refresh-token'];
        cookies.forEach(c => {
          document.cookie = c + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Max-Age=0; SameSite=Lax';
          document.cookie = c + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Max-Age=0; SameSite=Lax; Secure';
        });
        window.location.href = '/';
      };

      // Event delegation como respaldo
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target && (target.id === 'logoutBtn' || target.id === 'mobileLogoutBtn' || target.closest('[data-logout]'))) {
          e.preventDefault();
          (window as any).handleLogout();
        }
      });

      // ========== MENU HAMBURGUESA MOVIL ==========
      const menuToggle = document.getElementById('menuToggle');
      const mainNav = document.getElementById('mainNav');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      function cerrarMenuMovil() {
        menuToggle?.classList.remove('active');
        mainNav?.classList.remove('active');
        mobileMenuOverlay?.classList.remove('active');
        document.body.style.overflow = '';
      }

      function abrirMenuMovil() {
        menuToggle?.classList.add('active');
        mainNav?.classList.add('active');
        mobileMenuOverlay?.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      if (menuToggle && mainNav && mobileMenuOverlay) {
        menuToggle.addEventListener('click', () => {
          if (mainNav.classList.contains('active')) {
            cerrarMenuMovil();
          } else {
            abrirMenuMovil();
          }
        });

        mobileMenuOverlay.addEventListener('click', cerrarMenuMovil);

        // Boton X para cerrar
        if (mobileMenuClose) {
          mobileMenuClose.addEventListener('click', cerrarMenuMovil);
        }

        // Cerrar menu al hacer click en un enlace
        const navLinks = mainNav.querySelectorAll('a');
        navLinks.forEach(link => {
          link.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
              cerrarMenuMovil();
            }
          });
        });
      }

      const TIEMPO_EXPIRACION_INVITADO_MS = 5 * 60 * 1000; // 5 minutos para invitados
      const TIEMPO_EXPIRACION_USUARIO_MS = 15 * 60 * 1000; // 15 minutos para usuarios logueados
      let fetchEnProgreso = false; // Evitar peticiones simultáneas

      // Función para obtener el tiempo de expiración según el tipo de usuario
      function obtenerTiempoExpiracion() {
        const userId = localStorage.getItem('user_id');
        return userId ? TIEMPO_EXPIRACION_USUARIO_MS : TIEMPO_EXPIRACION_INVITADO_MS;
      }

      // Función para actualizar el contador del carrito (INVITADOS Y USUARIOS)
      async function actualizarContadorCarrito() {
        // Si ya hay una petición en curso, no hacer otra
        if (fetchEnProgreso) return;
        
        try {
          const userId = localStorage.getItem('user_id');
          const contador = document.getElementById('carritoCount');
          const timer = document.getElementById('carritoTimer');
          const TIEMPO_EXPIRACION_MS = obtenerTiempoExpiracion();
          
          let totalItems = 0;
          let fechaMasReciente: number | null = null;

          // Si es INVITADO, usar localStorage
          if (!userId) {
            let carritoInvitado = JSON.parse(localStorage.getItem('carrito_invitado') || '[]');
            
            // Verificar expiración de items
            if (carritoInvitado.length > 0) {
              const ahora = Date.now();
              const fechaCarrito = localStorage.getItem('carrito_invitado_fecha');
              
              if (fechaCarrito) {
                const tiempoTranscurrido = ahora - parseInt(fechaCarrito);
                
                if (tiempoTranscurrido >= TIEMPO_EXPIRACION_MS) {
                  // Carrito expirado - liberar stock de variantes antes de limpiar
                  for (const item of carritoInvitado) {
                    if (item.producto_variante_id) {
                      fetch('/api/carrito/reservar', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          producto_id: item.producto_id,
                          producto_variante_id: item.producto_variante_id,
                          cantidad: item.cantidad || 1
                        })
                      }).catch(err => console.error('Error liberando stock:', err));
                    }
                  }
                  localStorage.removeItem('carrito_invitado');
                  localStorage.removeItem('carrito_invitado_fecha');
                  carritoInvitado = [];
                  if (contador) contador.style.display = 'none';
                  if (timer) timer.classList.remove('active');
                  return;
                }
                
                fechaMasReciente = parseInt(fechaCarrito);
              }
            }
            
            totalItems = carritoInvitado.reduce((sum, item) => sum + (item.cantidad || 1), 0);
            
            if (contador) {
              if (totalItems > 0) {
                contador.textContent = String(totalItems);
                contador.style.display = 'flex';
              } else {
                contador.style.display = 'none';
              }
            }
            
            // Mostrar timer para invitados
            if (timer && totalItems > 0 && fechaMasReciente) {
              const timerText = document.getElementById('timerText');
              const ahora = Date.now();
              const tiempoExpiracion = fechaMasReciente + TIEMPO_EXPIRACION_MS;
              const diff = tiempoExpiracion - ahora;
              
              if (diff <= 0) {
                if (timerText) timerText.textContent = 'Expirado';
                timer.style.borderColor = 'rgba(220, 38, 38, 0.5)';
                timer.style.background = 'rgba(220, 38, 38, 0.15)';
                timer.style.color = '#dc2626';
                timer.classList.add('active');
                // Liberar stock de variantes antes de limpiar
                for (const item of carritoInvitado) {
                  if (item.producto_variante_id) {
                    fetch('/api/carrito/reservar', {
                      method: 'DELETE',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        producto_id: item.producto_id,
                        producto_variante_id: item.producto_variante_id,
                        cantidad: item.cantidad || 1
                      })
                    }).catch(err => console.error('Error liberando stock:', err));
                  }
                }
                // Limpiar carrito expirado
                localStorage.removeItem('carrito_invitado');
                localStorage.removeItem('carrito_invitado_fecha');
              } else {
                const minutos = Math.floor(diff / (1000 * 60));
                const segundos = Math.floor((diff % (1000 * 60)) / 1000);
                if (timerText) timerText.textContent = `${minutos}:${segundos.toString().padStart(2, '0')}`;
                
                // Cambiar color si queda menos de 1 minuto
                if (diff < 60000) {
                  timer.style.borderColor = 'rgba(220, 38, 38, 0.5)';
                  timer.style.background = 'rgba(220, 38, 38, 0.15)';
                  timer.style.color = '#dc2626';
                } else {
                  timer.style.borderColor = 'rgba(217, 119, 6, 0.3)';
                  timer.style.background = 'rgba(217, 119, 6, 0.15)';
                  timer.style.color = '#d97706';
                }
                timer.classList.add('active');
              }
            } else if (timer) {
              timer.classList.remove('active');
            }
            return;
          }

          // Usuario logueado - usar API
          fetchEnProgreso = true;
          const response = await fetch('/api/carrito', {
            credentials: 'include',
            headers: {
              'x-user-id': userId
            }
          });
          fetchEnProgreso = false;
          
          if (response.status === 401 || !response.ok) {
            if (contador) contador.style.display = 'none';
            if (timer) timer.classList.remove('active');
            return;
          }

          const data = await response.json();
          const items = data.items || [];
          totalItems = items.reduce((sum, item) => sum + item.cantidad, 0);
          
          if (contador) {
            if (totalItems > 0) {
              contador.textContent = String(totalItems);
              contador.style.display = 'flex';
            } else {
              contador.style.display = 'none';
            }
          }

          // Actualizar el timer si hay items
          if (timer && totalItems > 0 && items.length > 0) {
            const timerText = document.getElementById('timerText');
            const itemMasReciente = items.reduce((prev, current) => {
              return new Date(current.fecha_agregado) > new Date(prev.fecha_agregado) ? current : prev;
            });
            
            const ahora = new Date();
            const fechaAgregado = new Date(itemMasReciente.fecha_agregado);
            const tiempoExpiracion = fechaAgregado.getTime() + TIEMPO_EXPIRACION_MS;
            const diff = tiempoExpiracion - ahora.getTime();
            
            if (diff <= 0) {
              if (timerText) timerText.textContent = 'Expirado';
              timer.style.borderColor = 'rgba(220, 38, 38, 0.5)';
              timer.style.background = 'rgba(220, 38, 38, 0.15)';
              timer.style.color = '#dc2626';
              timer.classList.add('active');
            } else {
              const minutos = Math.floor(diff / (1000 * 60));
              const segundos = Math.floor((diff % (1000 * 60)) / 1000);
              if (timerText) timerText.textContent = `${minutos}:${segundos.toString().padStart(2, '0')}`;
              
              if (diff < 60000) {
                timer.style.borderColor = 'rgba(220, 38, 38, 0.5)';
                timer.style.background = 'rgba(220, 38, 38, 0.15)';
                timer.style.color = '#dc2626';
              } else {
                timer.style.borderColor = 'rgba(217, 119, 6, 0.3)';
                timer.style.background = 'rgba(217, 119, 6, 0.15)';
                timer.style.color = '#d97706';
              }
              timer.classList.add('active');
            }
          } else if (timer) {
            timer.classList.remove('active');
          }
        } catch (error) {
          fetchEnProgreso = false;
          // Solo mostrar error si no es un problema de red común
          if (error instanceof TypeError && error.message.includes('fetch')) {
            // Error de red - silenciar
          } else {
            console.error('Error actualizando carrito:', error);
          }
        }
      }

      // Actualizar contador al cargar la página
      actualizarContadorCarrito();

      // Actualizar cada segundo (para el timer de TODOS)
      setInterval(actualizarContadorCarrito, 1000);

      // Escuchar eventos de carrito actualizado (desde document Y window)
      document.addEventListener('carritoActualizado', actualizarContadorCarrito);
      window.addEventListener('carritoActualizado', actualizarContadorCarrito);

      // Renderizar navbar dinámicamente
      const authContainer = document.getElementById('authContainer');
      let token = localStorage.getItem('auth_token');
      let userName = localStorage.getItem('user_name');
      let userRole = localStorage.getItem('user_role');

      // Si acabamos de hacer logout, NO intentar re-autenticar via /api/auth/me
      // Mantener el flag para que al navegar a /login no se re-autentique
      const justLoggedOut = sessionStorage.getItem('just_logged_out');
      if (justLoggedOut) {
        token = null;
        userName = null;
        userRole = null;
        renderAuthUI();
      } else if ((!token || !userName) && authContainer) {
        fetch('/api/auth/me', { credentials: 'include' })
          .then(res => res.ok ? res.json() : null)
          .then(data => {
            if (data?.success && data?.usuario) {
              token = data.usuario.id;
              userName = data.usuario.nombre;
              userRole = data.usuario.rol;
              // Guardar en localStorage para próximas visitas
              if (token) localStorage.setItem('auth_token', token);
              if (userName) localStorage.setItem('user_name', userName);
              if (userRole) localStorage.setItem('user_role', userRole);
              if (token) localStorage.setItem('user_id', token);
              localStorage.setItem('user_email', data.usuario.email);
              renderAuthUI();
            } else {
              renderAuthUI();
            }
          })
          .catch(() => {
            renderAuthUI();
          });
      } else {
        renderAuthUI();
      }



      function renderAuthUI() {
        const mobileAuthContainer = document.getElementById('mobileAuthContainer');
        
        if (token && userName && authContainer) {
          // Usuario autenticado - mostrar nombre y menú (DESKTOP)
          authContainer.innerHTML = `
            <div style="position: relative;">
              <button id="userBtn" style="
                background: linear-gradient(135deg, #001a33, #2d2d2d);
                color: white;
                padding: 0.6rem 1rem;
                border-radius: 4px;
                border: none;
                font-weight: 600;
                cursor: pointer;
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              ">
                ${userName} ▼
              </button>

              <div id="menu" style="
                display: none;
                position: absolute;
                top: 110%;
                right: 0;
                background: white;
                border: 1px solid #eee;
                border-radius: 4px;
                min-width: 180px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                z-index: 1000;
              ">
                <div style="padding: 0.75rem 1rem; border-bottom: 1px solid #eee;">
                  <p style="font-weight: 600; margin: 0; color: #001a33; font-size: 0.9rem;">${userName}</p>
                  <span style="background: #a89968; color: white; padding: 0.2rem 0.6rem; border-radius: 3px; font-size: 0.7rem; text-transform: uppercase; display: inline-block; margin-top: 0.3rem;">${userRole}</span>
                </div>
                ${userRole === 'admin' ? `
                  <div id="adminMenuWrapper" style="position: relative;">
                    <button id="adminMenuBtn" style="width: 100%; padding: 0.6rem 1rem; color: #001a33; border-bottom: 1px solid #eee; text-align: left; background: #f8f7f4; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                      Panel Admin
                      <span id="adminArrow" style="transform: rotate(0deg); transition: transform 0.3s;">▼</span>
                    </button>
                    <div id="adminSubMenu" style="display: none; background: #f8f7f4; border-top: 1px solid #eee;">
                      <a href="/admin/dashboard" style="display: block; padding: 0.5rem 1.5rem; color: #001a33; border-bottom: 1px solid #eee; font-size: 0.9rem;">Dashboard</a>
                      <a href="/admin/productos" style="display: block; padding: 0.5rem 1.5rem; color: #001a33; border-bottom: 1px solid #eee; font-size: 0.9rem;">Productos</a>
                      <a href="/admin/pedidos" style="display: block; padding: 0.5rem 1.5rem; color: #001a33; border-bottom: 1px solid #eee; font-size: 0.9rem;">Pedidos</a>
                      <a href="/admin/usuarios" style="display: block; padding: 0.5rem 1.5rem; color: #001a33; border-bottom: 1px solid #eee; font-size: 0.9rem;">Usuarios</a>
                      <a href="/admin/codigos-descuento" style="display: block; padding: 0.5rem 1.5rem; color: #a89968; font-weight: 600; font-size: 0.9rem;">Códigos Descuento</a>
                    </div>
                  </div>
                ` : ''}
                <!-- <a href="/carrito" style="display: block; padding: 0.6rem 1rem; color: #001a33; border-bottom: 1px solid #eee;">Carrito</a> -->
                <a href="/mi-perfil" style="display: block; padding: 0.6rem 1rem; color: #001a33; border-bottom: 1px solid #eee;">Mi Perfil</a>
                <a href="/mis-pedidos" style="display: block; padding: 0.6rem 1rem; color: #001a33; border-bottom: 1px solid #eee;">Mis Pedidos</a>
                <button id="logoutBtn" data-logout onclick="handleLogout()" style="width: 100%; padding: 0.6rem 1rem; background: #fee; color: #c33; text-align: left; font-weight: 600; cursor: pointer; border: none;">Cerrar Sesión</button>
              </div>
            </div>
          `;

          // MENÚ MÓVIL - Usuario autenticado
          if (mobileAuthContainer) {
            const userInitial = userName.charAt(0).toUpperCase();
            mobileAuthContainer.innerHTML = `
              <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 12px; margin-bottom: 0.5rem;">
                  <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #a89968 0%, #8b6f47 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.3rem; flex-shrink: 0;">${userInitial}</div>
                  <div style="display: flex; flex-direction: column; gap: 0.2rem; overflow: hidden;">
                    <span style="font-weight: 600; color: var(--text-primary); font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${userName}</span>
                    <span style="font-size: 0.75rem; color: #a89968; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">${userRole}</span>
                  </div>
                </div>
                
                <a href="/mi-perfil" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; background: var(--bg-secondary); border-radius: 10px; color: var(--text-primary); text-decoration: none; font-weight: 500; font-size: 1rem; border: 1px solid var(--border-color);">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a89968" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  Mi Perfil
                </a>
                
                <a href="/mis-pedidos" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; background: var(--bg-secondary); border-radius: 10px; color: var(--text-primary); text-decoration: none; font-weight: 500; font-size: 1rem; border: 1px solid var(--border-color);">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a89968" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                  Mis Pedidos
                </a>
                
                ${userRole === 'admin' ? `
                  <a href="/admin/dashboard" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; background: linear-gradient(135deg, rgba(168, 153, 104, 0.2), rgba(168, 153, 104, 0.1)); border-radius: 10px; color: var(--text-primary); text-decoration: none; font-weight: 600; font-size: 1rem; border: 1px solid rgba(168, 153, 104, 0.3);">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a89968" stroke-width="2">
                      <rect x="3" y="3" width="7" height="9"></rect>
                      <rect x="14" y="3" width="7" height="5"></rect>
                      <rect x="14" y="12" width="7" height="9"></rect>
                      <rect x="3" y="16" width="7" height="5"></rect>
                    </svg>
                    Panel Admin
                  </a>
                ` : ''}
                
                <button id="mobileLogoutBtn" data-logout onclick="handleLogout()" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; width: 100%; padding: 1rem 1.25rem; background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 10px; color: #dc3545; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 0.5rem;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                  </svg>
                  Cerrar Sesión
                </button>
              </div>
            `;
            
            // Event listener para logout en móvil (ahora usa la función global)
            setTimeout(() => {
              const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
              mobileLogoutBtn?.addEventListener('click', () => (window as any).handleLogout());
            }, 0);
          }

          setTimeout(() => {
            const userBtn = document.getElementById('userBtn');
            const menu = document.getElementById('menu');
            const logoutBtn = document.getElementById('logoutBtn');
            const adminMenuBtn = document.getElementById('adminMenuBtn');
            const adminSubMenu = document.getElementById('adminSubMenu');
            const adminArrow = document.getElementById('adminArrow');

            userBtn?.addEventListener('click', () => {
              if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            });

            adminMenuBtn?.addEventListener('click', (e) => {
              e.preventDefault();
              if (adminSubMenu) adminSubMenu.style.display = adminSubMenu.style.display === 'none' ? 'block' : 'none';
              if (adminArrow && adminSubMenu) adminArrow.style.transform = adminSubMenu.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0deg)';
            });

            logoutBtn?.addEventListener('click', () => (window as any).handleLogout());

            document.addEventListener('click', (e) => {
              const target = e.target as Node;
              if (!userBtn?.contains(target) && !menu?.contains(target)) {
                if (menu) menu.style.display = 'none';
              }
            });
          }, 0);
        } else {
          // No autenticado - DESKTOP
          if (authContainer) authContainer.innerHTML = `
            <a href="/login" style="
              background: linear-gradient(135deg, #a89968, #8b7a5f);
              color: white;
              padding: 0.75rem 2rem;
              border-radius: 6px;
              font-size: 0.85rem;
              font-weight: 700;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              display: inline-flex;
              align-items: center;
              gap: 0.5rem;
              box-shadow: 0 4px 12px rgba(168, 153, 104, 0.3);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(168, 153, 104, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(168, 153, 104, 0.3)'">Iniciar Sesión</a>
          `;
          
          // MENÚ MÓVIL - No autenticado
          if (mobileAuthContainer) {
            mobileAuthContainer.innerHTML = `
              <a href="/login" class="nav-login-button">
                <svg style="width: 18px; height: 18px; margin-right: 6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                  <polyline points="10 17 15 12 10 7"></polyline>
                  <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
                Iniciar Sesión
              </a>
            `;
          }
        }
      }
    </script>



    <script is:inline>
      // Live Search - Búsqueda en tiempo real
      function inicializarBuscador() {
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let timeoutId = null;

        if (!searchInput || !searchResults) {
          console.log('Elementos de búsqueda no encontrados');
          return;
        }

        console.log('Buscador inicializado');

        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          console.log('Búsqueda:', query);

          // Limpiar timeout anterior
          clearTimeout(timeoutId);

          // Si menos de 2 caracteres, ocultar resultados
          if (query.length < 2) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
          }

          // Esperar 300ms antes de buscar
          timeoutId = setTimeout(async () => {
            try {
              console.log('Haciendo búsqueda de:', query);
              const response = await fetch(`/api/productos/buscar?q=${encodeURIComponent(query)}`);
              const data = await response.json();

              console.log('Resultados recibidos:', data);

              if (data.success && data.resultados.length > 0) {
                // Mostrar resultados
                searchResults.innerHTML = data.resultados.map(producto => `
                  <a href="/productos/${producto.id}" style="
                    display: flex;
                    align-items: center;
                    padding: 1rem;
                    border-bottom: 1px solid #f0ede9;
                    text-decoration: none;
                    color: inherit;
                    transition: background 0.2s;
                  " onmouseover="this.style.background='rgba(168, 153, 104, 0.1)'" onmouseout="this.style.background='transparent'">
                    <img src="${producto.imagen}" alt="${producto.nombre}" style="
                      width: 50px;
                      height: 50px;
                      object-fit: cover;
                      border-radius: 4px;
                      margin-right: 1rem;
                    ">
                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${producto.nombre}</div>
                      <div style="font-size: 0.85rem;">
                        ${producto.tieneOferta 
                          ? `<span style="color: #a89968; margin-right: 0.5rem;">${producto.precioDescuento}€</span><span style="color: #94a3b8; text-decoration: line-through; font-size: 0.75rem;">${producto.precio}€</span>` 
                          : `<span style="color: #a89968;">${producto.precio}€</span>`
                        }
                      </div>
                    </div>
                  </a>
                `).join('');
                searchResults.style.display = 'block';
              } else {
                // No hay resultados
                searchResults.innerHTML = `
                  <div style="padding: 1.5rem; text-align: center; color: #94a3b8; font-size: 0.9rem;">
                    No se encontraron productos
                  </div>
                `;
                searchResults.style.display = 'block';
              }
            } catch (error) {
              console.error('Error en búsqueda:', error);
              searchResults.innerHTML = `
                <div style="padding: 1.5rem; text-align: center; color: #f5576c; font-size: 0.9rem;">
                  Error al buscar
                </div>
              `;
              searchResults.style.display = 'block';
            }
          }, 300);
        });

        // Cerrar resultados al hacer clic fuera
        document.addEventListener('click', (e) => {
          if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
          }
        });
      }

      // Ejecutar cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarBuscador);
      } else {
        inicializarBuscador();
      }


    </script>

    <!-- Chatbot flotante -->
    <ChatBot />

    <!-- Popup Completar Perfil OBLIGATORIO (usuarios OAuth con perfil incompleto) -->
    <div id="perfilPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(6px);">
      <div style="background: var(--bg-card); border-radius: 16px; padding: 2.5rem; max-width: 460px; width: 90%; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid var(--border-color); animation: popupSlideIn 0.4s ease-out; max-height: 90vh; overflow-y: auto;">
        <!-- Icono -->
        <div style="text-align: center; margin-bottom: 1.25rem;">
          <div style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light)); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(168, 153, 104, 0.3);">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
        </div>

        <!-- Título -->
        <h2 style="text-align: center; color: var(--text-primary); font-size: 1.4rem; margin: 0 0 0.4rem 0; font-weight: 700;">¡Bienvenido/a!</h2>
        <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin: 0 0 1.25rem 0;">Completa tu perfil para continuar usando la tienda.</p>

        <!-- Aviso obligatorio -->
        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #f59e0b; border-radius: 10px; padding: 0.85rem 1rem; margin-bottom: 1.5rem;">
          <p style="margin: 0; font-weight: 700; color: #92400e; font-size: 0.88rem;">Debes completar estos datos antes de continuar. No podrás navegar por la tienda hasta terminar.</p>
        </div>

        <!-- Formulario -->
        <form id="formCompletarPerfil" style="display: flex; flex-direction: column; gap: 1rem;">

          <!-- Número de teléfono -->
          <div>
            <label for="popupTelefono" style="display: block; font-size: 0.78rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Número de teléfono *</label>
            <input
              id="popupTelefono"
              type="tel"
              placeholder="Ej: 612 345 678"
              required
              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s;"
            />
          </div>

          <!-- Dirección -->
          <div>
            <label for="popupDireccion" style="display: block; font-size: 0.78rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Dirección *</label>
            <input
              id="popupDireccion"
              type="text"
              placeholder="Ej: Calle Mayor 12"
              required
              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s;"
            />
          </div>

          <!-- Código Postal -->
          <div>
            <label for="popupCodigoPostal" style="display: block; font-size: 0.78rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Código Postal *</label>
            <input
              id="popupCodigoPostal"
              type="text"
              placeholder="Ej: 28001"
              required
              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s;"
            />
          </div>

          <!-- Piso -->
          <div>
            <label for="popupPiso" style="display: block; font-size: 0.78rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Piso / Puerta *</label>
            <input
              id="popupPiso"
              type="text"
              placeholder="Ej: 2ºB"
              required
              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s;"
            />
          </div>

          <!-- Contraseña -->
          <div>
            <label for="popupContrasena" style="display: block; font-size: 0.78rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Contraseña *</label>
            <input
              id="popupContrasena"
              type="password"
              placeholder="Mínimo 6 caracteres"
              required
              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s;"
            />
          </div>

          <!-- Confirmar contraseña -->
          <div>
            <label for="popupContrasenaConfirm" style="display: block; font-size: 0.78rem; font-weight: 700; color: var(--color-accent); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.4rem;">Confirmar contraseña *</label>
            <input
              id="popupContrasenaConfirm"
              type="password"
              placeholder="Repite la contraseña"
              required
              style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: var(--bg-input); color: var(--text-primary); transition: border-color 0.2s;"
            />
          </div>

          <!-- Mensaje de estado -->
          <div id="popupMensaje" style="display: none; padding: 0.85rem 1rem; border-radius: 8px; font-size: 0.9rem; border-left: 4px solid;"></div>

          <!-- Botón guardar -->
          <button
            type="submit"
            id="popupBtnGuardar"
            style="width: 100%; padding: 0.9rem; background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark)); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(168, 153, 104, 0.3); margin-top: 0.25rem;"
          >
            Guardar y continuar
          </button>
        </form>
      </div>
    </div>

    <style>
      @keyframes popupSlideIn {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }
      #perfilPopup input:focus {
        outline: none;
        border-color: var(--color-accent) !important;
        box-shadow: 0 0 0 3px rgba(168, 153, 104, 0.12) !important;
      }
      #popupBtnGuardar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(168, 153, 104, 0.4) !important;
      }
      #popupBtnGuardar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
    </style>

    <script>
      // Popup OBLIGATORIO de completar perfil tras login con Google
      function verificarYMostrarPopupPerfil() {
        // Solo mostrar si el flag fue establecido durante el callback de OAuth
        const incompleto = localStorage.getItem('perfil_incompleto');
        if (incompleto === 'true') {
          const popup = document.getElementById('perfilPopup');
          if (popup) popup.style.display = 'flex';
        }
      }

      // NO permitir cerrar el popup haciendo clic fuera
      document.getElementById('perfilPopup')?.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // Enviar formulario
      document.getElementById('formCompletarPerfil')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const telefono = (document.getElementById('popupTelefono') as HTMLInputElement)?.value?.trim();
        const direccion = (document.getElementById('popupDireccion') as HTMLInputElement)?.value?.trim();
        const codigoPostal = (document.getElementById('popupCodigoPostal') as HTMLInputElement)?.value?.trim();
        const piso = (document.getElementById('popupPiso') as HTMLInputElement)?.value?.trim();
        const contrasena = (document.getElementById('popupContrasena') as HTMLInputElement)?.value;
        const contrasenaConfirm = (document.getElementById('popupContrasenaConfirm') as HTMLInputElement)?.value;
        const mensajeEl = document.getElementById('popupMensaje');
        const boton = document.getElementById('popupBtnGuardar') as HTMLButtonElement;

        const mostrarError = (msg: string) => {
          if (!mensajeEl) return;
          mensajeEl.textContent = msg;
          mensajeEl.style.display = 'block';
          mensajeEl.style.background = '#fee2e2';
          mensajeEl.style.color = '#991b1b';
          mensajeEl.style.borderLeftColor = '#ef4444';
        };

        const mostrarExito = (msg: string) => {
          if (!mensajeEl) return;
          mensajeEl.textContent = msg;
          mensajeEl.style.display = 'block';
          mensajeEl.style.background = '#d1fae5';
          mensajeEl.style.color = '#065f46';
          mensajeEl.style.borderLeftColor = '#10b981';
        };

        if (!telefono) return mostrarError('El número de teléfono es obligatorio.');
        if (!direccion) return mostrarError('La dirección es obligatoria.');
        if (!codigoPostal) return mostrarError('El código postal es obligatorio.');
        if (!piso) return mostrarError('El piso/puerta es obligatorio.');
        if (!contrasena) return mostrarError('La contraseña es obligatoria.');
        if (contrasena.length < 6) return mostrarError('La contraseña debe tener al menos 6 caracteres.');
        if (contrasena !== contrasenaConfirm) return mostrarError('Las contraseñas no coinciden.');

        // Concatenar dirección en formato "Dirección | Código Postal | Piso"
        const direccionConcatenada = `${direccion} | ${codigoPostal} | ${piso}`;

        boton.disabled = true;
        boton.textContent = 'Guardando...';
        if (mensajeEl) mensajeEl.style.display = 'none';

        try {
          // Obtener nombre actual para no perderlo al actualizar
          let nombreActual = localStorage.getItem('user_name') || 'Usuario';

          // 1. Guardar teléfono
          const resPerfil = await fetch('/api/auth/actualizar-perfil', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre: nombreActual, telefono, direccion: direccionConcatenada })
          });
          const dataPerfil = await resPerfil.json();
          if (!resPerfil.ok || !dataPerfil.success) {
            throw new Error(dataPerfil.message || 'Error guardando el teléfono');
          }

          // 2. Establecer contraseña
          const resPass = await fetch('/api/auth/establecer-contrasena', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contrasenaNueva: contrasena, contrasenaConfirm: contrasenaConfirm })
          });
          const dataPass = await resPass.json();
          if (!resPass.ok || !dataPass.success) {
            throw new Error(dataPass.message || 'Error estableciendo la contraseña');
          }

          // 3. Limpiar flag y cerrar popup
          localStorage.removeItem('perfil_incompleto');
          localStorage.removeItem('mostrar_popup_perfil');
          mostrarExito('¡Perfil completado! Redirigiendo...');
          setTimeout(() => {
            const popup = document.getElementById('perfilPopup');
            if (popup) popup.style.display = 'none';
          }, 1200);

        } catch (err: any) {
          mostrarError(err.message || 'Error desconocido. Inténtalo de nuevo.');
          boton.disabled = false;
          boton.textContent = 'Guardar y continuar';
        }
      });

      // Mostrar al cargar la página
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', verificarYMostrarPopupPerfil);
      } else {
        verificarYMostrarPopupPerfil();
      }
    </script>
  </body>
</html>
