---
import Layout from './Layout.astro';

interface Props {
  requireAuth?: boolean;
  requireAdmin?: boolean;
}

const { requireAuth = false, requireAdmin = false } = Astro.props;
---

<Layout>
  <script define:vars={{ requireAuth, requireAdmin }}>
    // Verificar autenticaci√≥n en cliente
    const token = localStorage.getItem('auth_token');
    const userRole = localStorage.getItem('user_role');
    const currentPath = window.location.pathname;

    console.log('üîê Verificando autenticaci√≥n del cliente');
    console.log('  Path:', currentPath);
    console.log('  Token:', token ? '‚úÖ S√≠' : '‚ùå No');
    console.log('  Rol:', userRole || '‚ùå No');

    // Rutas protegidas que requieren auth
    const rutasProtegidas = ['/carrito', '/checkout', '/mi-cuenta', '/mis-pedidos'];
    const esRutaProtegida = rutasProtegidas.some(r => currentPath.startsWith(r));
    const esRutaAdmin = currentPath.startsWith('/admin');

    // Redirigir si no hay token y se requiere autenticaci√≥n
    if ((esRutaProtegida || esRutaAdmin) && !token) {
      console.log('‚õî Sin autenticaci√≥n, redirigiendo a login');
      window.location.href = '/login';
    }

    // Redirigir si no es admin pero intenta acceder a /admin
    if (esRutaAdmin && userRole !== 'admin') {
      console.log('‚õî No es admin, redirigiendo a sin-acceso');
      window.location.href = '/sin-acceso';
    }

    // Limpiar localStorage al cerrar sesi√≥n
    if (currentPath === '/api/auth/logout') {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('user_name');
      localStorage.removeItem('user_id');
    }
  </script>

  <slot />
</Layout>
